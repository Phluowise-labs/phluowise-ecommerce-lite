<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TRV3R43NQZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TRV3R43NQZ');
</script>
    <title>Phluowise - Shop Details</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007ACC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Phluowise">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="css/notifications.css" />
    <link rel="stylesheet" href="css/mobile-responsive.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007ACC',
                        tabActive: '#3B74FF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --text-color: #FFFFFF;
            --bottom-sheet-color: #1D1D1D;
            --input-bg: #292B2F;
            --input-border: #40444B;
            --card-bg-dark: #8080804D;
        }

        body.dark-theme {
            --bg-color: #060606;
            --card-bg-dark: #8080804D;
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: 'Inter', sans-serif;
        }

        /* Material Symbols Styles */
        .material-symbols-outlined {
          font-family: 'Material Symbols Outlined';
          font-weight: normal;
          font-style: normal;
          font-size: 24px;
          line-height: 1;
          letter-spacing: normal;
          text-transform: none;
          display: inline-block;
          white-space: nowrap;
          word-wrap: normal;
          direction: ltr;
          -webkit-font-feature-settings: 'liga';
          -webkit-font-smoothing: antialiased;
          font-variation-settings:
          'FILL' 1,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
        
        .verified-checkmark {
            color: #F19E39;
            font-size: 24px;
            vertical-align: middle;
            margin-left: 4px;
        }

        .verified-checkmark-tier2 {
            color: #3B74FF;
            font-size: 24px;
            vertical-align: middle;
            margin-left: 4px;
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .verified-checkmark-tier3 {
            color: #FFD700;
            font-size: 24px;
            vertical-align: middle;
            margin-left: 4px;
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        /* Schedule Pickup Button Mobile Touch Fix */
        .schedule-pickup-btn {
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        .schedule-pickup-btn:active {
            transform: scale(0.98);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Exact blur styling from React Native BlurView */
        .glass-blur-70 {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(20, 20, 20, 0.4);
        }

        .glass-blur-50 {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background-color: rgba(20, 20, 20, 0.3);
        }

        /* Exact shadow from React Native */
        .rn-shadow {
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);
        }

        .rn-shadow-lg {
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Dark mode map styles */
        .leaflet-container {
            background: #1a1a1a !important;
        }

        .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        .leaflet-control-zoom a {
            background-color: rgba(30, 30, 30, 0.9) !important;
            border: 1px solid rgba(59, 116, 255, 0.3) !important;
            color: white !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: rgba(59, 116, 255, 0.2) !important;
            border-color: rgba(59, 116, 255, 0.5) !important;
        }

        .leaflet-popup-content-wrapper {
            background: rgba(16, 16, 16, 0.95) !important;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 116, 255, 0.3);
            border-radius: 12px;
            color: white;
        }

        .leaflet-popup-tip {
            background: rgba(16, 16, 16, 0.95) !important;
            border: 1px solid rgba(59, 116, 255, 0.3);
        }

        .custom-marker {
            background: linear-gradient(135deg, #3B74FF, #007ACC);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(59, 116, 255, 0.4);
            position: relative;
            z-index: 1;
        }

        .user-location-marker {
            background: #00ff88;
            border: 3px solid white;
            border-radius: 50%;
            position: relative;
            z-index: 1;
        }

        /* Map container constraints */
        #scheduleMap {
            position: relative !important;
            z-index: 1 !important;
        }

        #scheduleMap .leaflet-container {
            z-index: 1 !important;
        }

        #scheduleMap .leaflet-control-container {
            z-index: 2 !important;
        }

        #scheduleMap .leaflet-pane {
            z-index: 1 !important;
        }

        /* Bottom sheet animation classes */
        .bottom-sheet-container {
            background: rgba(29, 29, 31, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .bottom-sheet-container.active {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet-content {
            background: rgba(29, 29, 31, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px 28px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.3);
        }

        .bottom-sheet-content.active {
            transform: translateY(0);
        }

        .sheet-drag-handle {
            width: 40px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 0 auto 16px auto;
        }

        .section-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .section-subheader {
            font-size: 18px;
            font-weight: 500;
            color: #9BA1A6;
            margin-bottom: 20px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #9BA1A6;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .form-input {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-color);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            transition: all 0.2s ease;
            font-size: 18px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .form-textarea {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-color);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            transition: all 0.2s ease;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .step-content {
            display: block;
        }

        .step-content.hidden {
            display: none;
        }

        .step-indicator-container {
            padding: 8px 0 24px 0;
            margin-bottom: 8px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: none;
        }

        .step-indicator-line {
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        .step-indicator-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
        }

        .step-indicator-item {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .step-indicator-item.active {
            background-color: #3B74FF;
            color: white;
            border-color: #3B74FF;
            box-shadow: 0 4px 12px rgba(59, 116, 255, 0.3);
        }

        .step-indicator-item.completed {
            background: rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(16, 185, 129, 0.4);
        }

        .step-indicator-item.default {
            background-color: rgba(255, 255, 255, 0.1);
            color: #9BA1A6;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .step-indicator-name {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 10px;
            color: #9BA1A6;
            font-weight: 500;
        }

        .step-indicator-item.active .step-indicator-name {
            color: #3B74FF;
            font-weight: 600;
        }

        .step-indicator-item.completed .step-indicator-name {
            color: #10B981;
        }

        .terms-radio-container {
            margin-bottom: 24px;
        }

        .terms-radio-item {
            margin-bottom: 16px;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .terms-radio-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .terms-radio-item.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .terms-radio-label {
            display: flex;
            align-items: center;
            font-size: 18px;
            color: var(--text-color);
            font-weight: 500;
        }

        .terms-radio-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .terms-radio-item.selected .terms-radio-circle {
            border-color: #3B74FF;
            background-color: #3B74FF;
        }

        .terms-radio-item.selected .terms-radio-circle::after {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: white;
        }

        .terms-details {
            margin-top: 8px;
            padding-left: 36px;
            font-size: 16px;
            color: #9BA1A6;
        }

        .terms-container {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .recipient-type-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .recipient-type-btn {
            flex: 1;
            padding: 20px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recipient-type-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .recipient-type-btn.active {
            background-color: rgba(59, 116, 255, 0.15);
            border-color: #3B74FF;
            color: #3B74FF;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 20px;
        }

        .toggle-label {
            font-size: 18px;
            color: var(--text-color);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3B74FF;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .business-type-container {
            margin-top: 16px;
        }

        .business-name-container {
            margin-top: 16px;
        }

        .business-type-select {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-color);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            font-size: 18px;
            cursor: pointer;
        }

        .business-type-select:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
        }

        .saved-recipients-container {
            margin-top: 20px;
        }

        .saved-recipient-item {
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .saved-recipient-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .saved-recipient-item.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .saved-recipient-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .saved-recipient-info {
            font-size: 16px;
            color: #9BA1A6;
        }

        .delete-recipient-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #EF4444;
            border-radius: 6px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-recipient-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .recipient-content {
            cursor: pointer;
            padding-right: 40px;
        }

        .you-recipient-info {
            background-color: rgba(59, 116, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 116, 255, 0.2);
        }

        .you-recipient-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .you-recipient-item:last-child {
            border-bottom: none;
        }

        .you-recipient-label {
            font-size: 16px;
            color: #9BA1A6;
        }

        .you-recipient-value {
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
        }

        /* Date and Time Selection */
        .datetime-container {
            margin-top: 20px;
        }

        .datetime-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .datetime-input {
            flex: 1;
        }

        .time-slots-container {
            margin-top: 20px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .time-slot-btn {
            padding: 16px 8px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .time-slot-btn.selected {
            background-color: rgba(59, 116, 255, 0.15);
            border-color: #3B74FF;
            color: #3B74FF;
        }

        .time-slot-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-card {
            background: linear-gradient(135deg, rgba(59, 116, 255, 0.1) 0%, rgba(59, 116, 255, 0.05) 100%);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(59, 116, 255, 0.2);
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            color: #3B74FF;
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 16px;
            color: #9BA1A6;
            line-height: 1.5;
        }

        /* Product Selection */
        .service-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .add-more-btn {
            background-color: rgba(59, 116, 255, 0.1);
            border: 1px solid #3B74FF;
            color: #3B74FF;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-more-btn:hover {
            background-color: rgba(59, 116, 255, 0.2);
            transform: translateY(-1px);
        }

        .selected-products-container {
            margin-top: 24px;
        }

        .selected-product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .selected-product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .selected-product-details {
            flex: 1;
        }

        .selected-product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .selected-product-price {
            font-size: 16px;
            color: #9BA1A6;
        }

        .selected-product-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn-small {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-color);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .quantity-display-small {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .delivery-instructions {
            margin-top: 20px;
        }

        .instructions-title {
            font-size: 18px;
            font-weight: 600;
            color: #9BA1A6;
            margin-bottom: 12px;
        }

        .instructions-example {
            font-size: 14px;
            color: #9BA1A6;
            font-style: italic;
            margin-bottom: 12px;
        }

        .delivery-info-note {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            color: #F59E0B;
            font-size: 16px;
            line-height: 1.5;
        }

        .no-products-selected {
            text-align: center;
            padding: 40px 20px;
            color: #9BA1A6;
            font-size: 18px;
        }

        /* Price Display */
        .price-display {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .price-row.total {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 16px;
            margin-top: 8px;
        }

        .price-label {
            font-size: 18px;
            color: #9BA1A6;
        }

        .price-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        .price-value.total {
            font-size: 24px;
            font-weight: 700;
            color: #3B74FF;
        }

        /* Review Section */
        .review-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .review-section {
            margin-bottom: 20px;
        }

        .review-section:last-child {
            margin-bottom: 0;
        }

        .review-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #9BA1A6;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-size: 18px;
            color: #9BA1A6;
        }

        .review-value {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
        }

        .review-product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .review-product-details {
            flex: 1;
        }

        .review-product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        .review-product-price {
            font-size: 16px;
            color: #3B74FF;
            font-weight: 600;
        }

        /* Payment Methods */
        .payment-method-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .payment-method-card:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 116, 255, 0.5);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .payment-method-card.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .payment-method-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .payment-method-icon.mobile {
            background-color: rgba(34, 197, 94, 0.15);
            color: #10B981;
        }

        .payment-method-icon.delivery {
            background-color: rgba(251, 146, 60, 0.15);
            color: #FB923C;
        }

        .payment-check {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: rgba(59, 116, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 116, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .payment-method-card.selected .payment-check {
            opacity: 1;
        }

        .mobile-payment-note {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            color: #10B981;
            font-size: 16px;
        }

        /* Processing and Success States */
        .processing-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3B74FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 24px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3B74FF 0%, #2563EB 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Rating Stars */
        .rating-stars-container {
            display: flex;
            gap: 8px;
            margin: 24px 0;
        }

        .rating-star-large {
            font-size: 36px;
            color: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-star-large.selected {
            color: #FCD34D;
            transform: scale(1.1);
        }

        .rating-star-large:hover {
            color: #FCD34D;
            transform: scale(1.2);
        }

        /* Static Rating Stars */
        .star-rating-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .star-rating-btn:hover svg {
            transform: scale(1.1);
        }

        .star-rating-btn svg {
            transition: transform 0.2s ease;
        }

        .star-rating-btn svg path {
            transition: fill 0.2s ease;
        }

        /* Responsive stars container */
        #staticRatingStars {
            max-width: 100%;
            overflow-x: auto;
            justify-content: center;
        }

        @media (max-width: 480px) {
            #staticRatingStars {
                gap: 1px;
            }
            
            .star-rating-btn {
                width: 28px !important;
                height: 28px !important;
            }
        }

        /* Navigation Buttons */
        .step-navigation {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-btn {
            flex: 1;
            padding: 20px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn.prev {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .nav-btn.prev:hover {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav-btn.next {
            background: rgba(59, 116, 255, 0.2);
            color: white;
            border: 1px solid rgba(59, 116, 255, 0.4);
        }

        .nav-btn.next:hover {
            background: rgba(59, 116, 255, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 116, 255, 0.3);
        }

        .nav-btn.pay {
            background: rgba(16, 185, 129, 0.2);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .nav-btn.pay:hover {
            background: rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .nav-btn.done {
            background: rgba(59, 116, 255, 0.2);
            color: white;
            border: 1px solid rgba(59, 116, 255, 0.4);
        }

        .nav-btn.done:hover {
            background: rgba(59, 116, 255, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 116, 255, 0.3);
        }

        /* Error and Success Messages */
        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 12px;
            color: #EF4444;
            font-size: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 12px;
            color: #10B981;
            font-size: 16px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        /* New Product Selection Step Styles */
        .products-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .product-select-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .product-select-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .product-select-card.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .product-select-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 8px;
        }

        .product-select-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
            min-height: 20px;
        }

        .product-select-price {
            font-size: 16px;
            font-weight: 700;
            color: #3B74FF;
        }

        .product-select-quantity {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            position: relative;
            z-index: 10;
        }

        .quantity-btn-product {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quantity-btn-product:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .quantity-btn-product:active {
            transform: scale(0.95);
        }

        .quantity-display-product {
            font-size: 16px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        /* Pay on Delivery Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(29, 29, 31, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 32px 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .modal-icon.warning {
            background: rgba(251, 146, 60, 0.2);
            border: 2px solid rgba(251, 146, 60, 0.4);
            color: #FB923C;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #FB923C;
            text-align: center;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-message {
            color: var(--text-main);
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .modal-message p {
            margin-bottom: 12px;
        }

        .modal-subtitle {
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 16px;
            margin-bottom: 12px;
        }

        .modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .modal-list li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        .modal-list li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #FB923C;
            font-weight: bold;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .modal-btn.confirm {
            background: rgba(251, 146, 60, 0.2);
            color: #FB923C;
            border: 1px solid rgba(251, 146, 60, 0.4);
        }

        .modal-btn.confirm:hover {
            background: rgba(251, 146, 60, 0.3);
            transform: translateY(-2px);
        }

        /* Mobile responsive adjustments */
        @media (max-width: 480px) {
            .modal-overlay {
                padding: 16px;
            }

            .modal-content {
                padding: 24px 20px;
                margin: 0;
            }

            .modal-title {
                font-size: 18px;
            }

            .modal-message {
                font-size: 15px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body class="dark-theme h-screen flex flex-col overflow-hidden">

    <!-- Header with Back Button and Profile Image (Exact from schedule.tsx) -->
    <div class="relative w-full">
        <!-- Banner Background -->
        <div class="absolute inset-0 w-full h-[180px] overflow-hidden">
            <img id="shopBannerImage" class="w-full h-full object-cover" style="display: none;" />
            <div id="bannerPlaceholder" class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                <div class="text-center">
                    <svg class="w-16 h-16 mx-auto mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-gray-500 text-sm">No Banner Image</span>
                </div>
            </div>
        </div>
        
        <!-- Back Button -->
        <div class="absolute top-5 left-4 z-20">
            <button onclick="window.history.back()" class="w-10 h-10 flex items-center justify-center">
                <img src="images/main/ArrowLeftIcon.png" class="w-6 h-6 object-contain">
            </button>
        </div>

        <!-- Menu Button -->
        <div class="absolute top-5 right-4 z-20">
            <button onclick="openTermsOfService()" class="w-10 h-10 flex items-center justify-center rounded-full bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.2)] transition-colors">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>

        <!-- Header Space (height: 80) -->
        <div class="h-[80px] w-full"></div>

        <!-- Profile Image Container (top: 40, left: 40, p: 8, rounded: 14, height: 90, width: 95) -->
        <div class="absolute top-[60px] left-10 z-10 p-2 rounded-[14px]"
            style="background-color: var(--bottom-sheet-color); height: 90px; width: 95px;">
            <div class="w-full h-full rounded-[14px] overflow-hidden bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                <img id="shopProfileImage" class="w-full h-full object-cover rounded-[14px]" style="display: none;" />
                <div id="profilePlaceholder" class="w-full h-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Scrollable Content -->
    <div class="flex-1 overflow-y-auto hide-scrollbar pb-[70px] mt-2 relative z-10">

        <!-- Top Spacer - Increased to move company data beneath banner -->
        <div class="h-[100px]"></div>

        <div class="px-0 relative flex flex-col">

            <!-- CompanyDescription Component (Dynamic from DB) -->
            <div class="px-10 p-2 relative">
                <!-- Added spacing before company data -->
                <div class="mb-6">
                    <!-- Loading spinner for company name -->
                    <div id="companyNameLoader" class="flex items-center gap-2 mb-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        <span class="text-white text-lg">Loading company info...</span>
                    </div>
                    
                    <h1 id="companyName" class="text-white text-2xl font-bold hidden">
                        <span id="companyNameText"></span>
                        <span id="verifiedBadge" class="material-symbols-outlined">verified</span>
                    </h1>
                    
                    <!-- Loading spinner for location -->
                    <div id="locationLoader" class="flex items-center gap-2 mt-1">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-[#808080]"></div>
                        <span class="text-[#808080] text-lg">Loading location...</span>
                    </div>
                    
                    <p id="companyLocation" class="text-[#808080] text-lg mt-1 hidden">
                        <!-- Location will be loaded from database -->
                    </p>
                </div>
                
                <!-- Loading spinner for description -->
                <div id="descriptionLoader" class="flex items-center gap-2 mb-4">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span class="text-white text-sm">Loading description...</span>
                </div>
                
                <div id="descriptionContainer" class="overflow-hidden transition-all duration-300 hidden"
                    style="height: 45px;">
                    <div class="relative h-full">
                        <!-- Linear Gradient Overlay (exact from RN) -->
                        <div class="absolute inset-0 pointer-events-none z-10"
                            style="background: linear-gradient(to bottom, transparent, var(--bg-color));"
                            id="descGradient"></div>
                        <p id="descriptionText" class="text-white text-base font-normal leading-6 tracking-tighter text-justify">
                            <!-- Description will be loaded from database -->
                        </p>
                    </div>
                </div>
                <!-- Read More Button (rounded: 5, shadow, height: 30, width: 60) -->
                <div class="relative pl-0 mt-4 z-20">
                    <button onclick="toggleReadMore()"
                        class="h-[30px] w-[60px] flex items-center justify-center rounded-[5px] rn-shadow"
                        style="background-color: var(--bottom-sheet-color);">
                        <span id="readMoreText" class="text-white font-medium text-sm">more +</span>
                    </button>
                </div>
            </div>

            <!-- WorkingDays Component (Exact) -->
            <div class="mt-4 px-10">
                <!-- Loading spinner for working hours -->
                <div id="workingHoursLoader" class="flex items-center gap-2 mb-3">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span class="text-white text-base font-medium">Loading working hours...</span>
                </div>
                
                <div id="workingHoursContent" class="hidden">
                    <div class="flex flex-row items-center gap-2">
                        <span class="text-white text-base font-medium">Working Days</span>
                        <!-- Dropdown (exact zIndex and styling) -->
                        <select id="workingDaysSelect" onchange="updateWorkingHours()"
                            class="bg-[#202225] text-white border-none rounded-xl px-2 py-1 w-[140px] focus:outline-none">
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                        <option value="saturday">Saturday</option>
                        <option value="sunday">Sunday</option>
                    </select>
                </div>
                <!-- Time Display Row (exact bg #292B2F, rounded, padding) -->
                <div class="mt-2 w-full flex flex-row items-center justify-center p-1 rounded gap-6"
                    style="background-color: #292B2F;">
                    <div class="flex flex-row justify-between w-[45%] items-center">
                        <span class="text-white text-base font-medium">Opening:</span>
                        <span id="openingTime" class="text-white text-base font-medium">08:00</span>
                    </div>
                    <div class="flex flex-row justify-between w-[45%] items-center">
                        <span class="text-white text-base font-medium">Closing:</span>
                        <span id="closingTime" class="text-white text-base font-medium">17:00</span>
                    </div>
                </div>
            </div>

            <!-- SocialMedia Component (Exact from React Native) -->
            <div class="mt-1">
                <div class="w-full flex flex-row justify-between items-center py-2 px-8" style="gap: 24px; background-color: var(--bottom-sheet-color); height: 42px;">
                    <span class="text-white font-[500] text-lg whitespace-nowrap">Social media</span>
                    <div class="flex flex-row justify-center items-center overflow-x-auto hide-scrollbar" style="gap: 8px; max-width: 200px;">
                        <!-- Facebook -->
                        <div onclick="showSocialModal('Facebook')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </div>
                        <!-- Instagram -->
                        <div onclick="showSocialModal('Instagram')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                        </div>
                        <!-- Twitter -->
                        <div onclick="showSocialModal('Twitter')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                            </svg>
                        </div>
                        <!-- LinkedIn -->
                        <div onclick="showSocialModal('LinkedIn')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                        </div>
                        <!-- Discord -->
                        <div onclick="showSocialModal('Discord')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                            </svg>
                        </div>
                        <!-- WhatsApp -->
                        <div onclick="showSocialModal('WhatsApp')" class="flex flex-row justify-center items-center p-1 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: #333333; height: 28px; width: 28px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M17.471 3.549C15.579 1.614 13.109 0.584 10.459 0.584 4.751 0.584.084 5.251.084 10.959c0 1.928.503 3.81 1.459 5.469L0 24l6.752-1.422c1.594.871 3.393 1.332 5.26 1.332 5.708 0 10.375-4.667 10.375-10.375 0-2.772-1.087-5.374-3.063-7.32zm-7.012 18.032c-1.64 0-3.248-.436-4.666-1.263l-.335-.199-3.49.735.748-3.377-.222-.354c-1.031-1.639-1.577-3.522-1.577-5.485 0-4.746 3.862-8.608 8.608-8.608 2.296 0 4.454.894 6.08 2.52 1.627 1.626 2.52 3.792 2.52 6.088 0 4.746-3.862 8.608-8.608 8.608zm4.709-6.459c-.258-.129-1.522-.753-1.758-.838-.236-.085-.408-.129-.58.129-.172.258-.667.838-.816 1.01-.15.172-.3.194-.558.064-.259-.129-1.092-.402-2.081-1.286-.77-.686-1.291-1.532-1.441-1.79-.15-.258-.016-.397.112-.525.116-.114.258-.3.387-.449.129-.15.172-.258.258-.43.086-.172.043-.323-.021-.452-.064-.129-.58-1.396-.796-1.911-.209-.492-.422-.426-.58-.434-.15-.007-.322-.007-.494-.007-.172 0-.451.065-.688.322-.237.258-.904.883-.904 2.15 0 1.268.926 2.496 1.055 2.668.129.172 1.826 2.79 4.426 3.911.618.268 1.1.427 1.476.547.62.197 1.184.169 1.629.103.497-.074 1.522-.622 1.737-1.222.216-.6.216-1.114.151-1.222-.065-.108-.237-.172-.494-.301z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-Navigation Tabs (exact height: 35, rounded: 100, px: 24) -->
            <div class="mt-4 pl-6">
                <div class="flex flex-row gap-4 overflow-x-auto hide-scrollbar pb-2">
                    <button onclick="setSubView('schedule')" id="btn-schedule"
                        class="h-[35px] px-6 rounded-[100px] flex items-center justify-center border border-transparent transition-all">
                        <span class="text-white text-xl font-medium capitalize whitespace-nowrap">Schedule Order</span>
                    </button>
                    <button onclick="setSubView('products')" id="btn-products"
                        class="h-[35px] px-6 rounded-[100px] flex items-center justify-center border border-transparent bg-transparent transition-all">
                        <span class="text-white text-xl font-medium capitalize">Products</span>
                    </button>
                    <button onclick="setSubView('rating')" id="btn-rating"
                        class="h-[35px] px-6 rounded-[100px] flex items-center justify-center border border-transparent bg-transparent transition-all">
                        <span class="text-white text-xl font-medium capitalize">Rating</span>
                    </button>
                </div>
            </div>

            <!-- Views Content -->
            <div class="mt-4 pb-[80px]">

                <!-- SCHEDULE ORDER VIEW (ScheduleOrder.tsx - Exact) -->
                <div id="view-schedule" class="block">
                    <!-- Container height: 300 (from RN) - Now with Map -->
                    <div class="relative w-full" style="height: 300px; z-index: 1;">
                        <!-- Map Container -->
                        <div id="scheduleMap" class="w-full h-full rounded-lg overflow-hidden relative" style="z-index: 1;">
                            <!-- Map will be initialized here -->
                        </div>

                        <!-- View Company Website Button (width: 225, top: 10, left: 20, rounded: 5, elevation: 5) -->
                        <button id="websiteButton"
                            class="flex flex-row items-center gap-2 p-3 rounded-[5px] absolute top-[10px] left-[20px] rn-shadow z-[1000]"
                            style="background-color: var(--bottom-sheet-color); width: 225px;"
                            onclick="openCompanyWebsite()">
                            <svg class="w-6 h-6" fill="white" stroke="white" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="white" />
                                <path d="M2 12h20" stroke="white" />
                                <path
                                    d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="white" />
                            </svg>
                            <span class="text-white text-base font-[500] px-4 leading-5 capitalize whitespace-nowrap">View Company Website</span>
                        </button>

                        <!-- Contact Popup (width: 250, rounded: 10, bottom: 70, right: 20) -->
                        <div id="contactPopup" class="absolute bottom-[70px] right-[20px] hidden rounded-[10px] z-[1000]"
                            style="width: 250px; background-color: var(--bottom-sheet-color);">
                            <button id="contactPopupPhoneButton" onclick="callCompany()" class="flex flex-row items-center gap-4 pl-4 w-full" style="height: 60px;">
                                <div class="w-8 h-8 rounded-full border border-white flex items-center justify-center">
                                    <span class="text-white text-xl font-bold">+</span>
                                </div>
                                <span id="contactPopupPhone" class="text-white text-lg font-[600] capitalize px-4 leading-5 whitespace-nowrap">+234 810 000 0000</span>
                            </button>
                        </div>

                        <!-- Call Button (height: 60, width: 60, rounded: 10, bottom: 5, right: 20, elevation: 5) -->
                        <button onclick="toggleContactPopup()"
                            class="absolute bottom-[5px] right-[20px] rounded-[10px] flex items-center justify-center z-[1000]"
                            style="background-color: var(--bottom-sheet-color); width: 60px; height: 60px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);">
                            <svg class="w-8 h-8" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path
                                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
                            </svg>
                        </button>

                        <!-- Map Controls -->
                        <div class="absolute top-[10px] right-[20px] z-[1000] flex flex-col gap-2">
                            <button onclick="toggleMapType()" class="w-10 h-10 bg-[rgba(30,30,30,0.9)] backdrop-blur-lg border border-[rgba(59,116,255,0.3)] rounded-lg flex items-center justify-center text-white hover:bg-[rgba(59,116,255,0.2)] transition-all" title="Toggle Map View">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M12 1v6m0 6v6m4.22-13.22l4.24 4.24M1.54 1.54l4.24 4.24M20.46 20.46l-4.24-4.24M1.54 20.46l4.24-4.24"/>
                                    <circle cx="12" cy="12" r="8" stroke-dasharray="2 2"/>
                                </svg>
                            </button>
                            <button onclick="zoomInMap()" class="w-10 h-10 bg-[rgba(30,30,30,0.9)] backdrop-blur-lg border border-[rgba(59,116,255,0.3)] rounded-lg flex items-center justify-center text-white hover:bg-[rgba(59,116,255,0.2)] transition-all">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/>
                                </svg>
                            </button>
                            <button onclick="zoomOutMap()" class="w-10 h-10 bg-[rgba(30,30,30,0.9)] backdrop-blur-lg border border-[rgba(59,116,255,0.3)] rounded-lg flex items-center justify-center text-white hover:bg-[rgba(59,116,255,0.2)] transition-all">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35M8 11h6"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Schedule Pickup Button (height: 46, rounded: 30, paddingVertical: 15) -->
                    <div class="px-4 relative py-[15px] flex justify-center z-[110]">
                        <button id="schedulePickupBtn"
                            class="rounded-[30px] flex items-center justify-center border schedule-pickup-btn relative z-[110]"
                            style="background-color: var(--btn-color); border-color: var(--btn-border); height: 46px; width: 242px; touch-action: manipulation;">
                            <span class="text-white text-xl font-[500] capitalize leading-5">Schedule Pickup</span>
                        </button>
                    </div>
                </div>

                <!-- PRODUCTS VIEW (Products.tsx - Exact Grid) -->
                <div id="view-products" class="hidden px-4 pb-[20px]">
                    <!-- Loading spinner for products -->
                    <div id="productsLoader" class="flex flex-col items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mb-3"></div>
                        <span class="text-white text-base">Loading products...</span>
                    </div>
                    
                    <!-- flex-wrap, gap-4, px-4 from RN -->
                    <div class="flex flex-row flex-wrap gap-4 hidden" id="productsGrid">
                        <!-- Products rendered by JS with exact dimensions -->
                    </div>
                </div>

                <!-- RATING VIEW (Rating.tsx - Exact with RatingBar, AllRating, Comment) -->
                <div id="view-rating" class="hidden p-4 pb-[100px]">
                    <!-- Loading spinner for ratings -->
                    <div id="ratingsLoader" class="flex flex-col items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mb-3"></div>
                        <span class="text-white text-base">Loading ratings...</span>
                    </div>

                    <!-- RatingBar Component (Exact) -->
                    <div id="ratingContent" class="hidden">
                        <div class="p-4 rounded-xl mb-4" style="min-height: 200px;">
                        <div class="flex flex-row justify-between items-center">
                            <span class="text-white font-bold text-xl">3.0 rating</span>
                            <span class="text-white font-semibold text-lg">200 reviews</span>
                        </div>
                        <!-- Rating bars (exact height: 13, rounded: 100, bg: #40444B) -->
                        <div class="mt-4 flex flex-col gap-2">
                            <!-- 5 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">5</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 80%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">80%</span>
                                </div>
                            </div>
                            <!-- 4 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">4</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 60%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">60%</span>
                                </div>
                            </div>
                            <!-- 3 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">3</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 40%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">40%</span>
                                </div>
                            </div>
                            <!-- 2 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">2</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 20%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">20%</span>
                                </div>
                            </div>
                            <!-- 1 Star -->
                            <div class="flex flex-row items-center gap-2">
                                <span class="text-white font-semibold text-xl">1</span>
                                <div class="flex flex-row items-center gap-2 flex-grow">
                                    <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden"
                                        style="height: 13px;">
                                        <div class="bg-white h-full" style="width: 10%"></div>
                                    </div>
                                    <span class="text-white font-medium text-lg">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AllRating Component (Exact) -->
                    <div class="p-4">
                        <h3 class="text-white text-lg font-medium mb-4">All Reviews</h3>
                        <div class="flex flex-col gap-4">
                            <!-- Single Review Item (exact dimensions from AllRating.tsx) -->
                            <div class="flex flex-col gap-4">
                                <div class="flex flex-row gap-4">
                                    <!-- Avatar (height: 63, width: 63, rounded-full, bg: #292B2F99, border: #DADADA) -->
                                    <div class="rounded-full border"
                                        style="height: 63px; width: 63px; background-color: #292B2F99; border-color: #DADADA;">
                                    </div>
                                    <div class="flex flex-col justify-between py-1">
                                        <span class="text-white font-medium text-lg pl-8">Anonymous name</span>
                                        <div class="flex flex-row gap-2">
                                            <div class="flex flex-row gap-1">
                                                <span class="text-white text-base">â˜…â˜…â˜…â˜…â˜…</span>
                                            </div>
                                            <span class="text-white font-medium text-lg">Time / Day</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Comment Bubble (rounded: 12, height: 90, bg: #292B2FCC) -->
                                <div class="w-full rounded-[12px] p-2"
                                    style="height: 90px; background-color: #292B2FCC;">
                                    <p class="text-white px-5 py-2 text-lg font-normal">
                                        Lorem ipsum dolor sit amet consectetur adipisicing elit.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Review Input Section (fixed above main nav, only shows in rating tab) -->
                    <div id="floatingReviewInput" class="fixed bottom-[64px] left-0 right-0 p-4 bg-gray-900/95 backdrop-blur-xl border-t border-gray-700/50 z-[90]" style="pointer-events: auto;">
                        <!-- Static Rating Stars (shown when toggled) -->
                        <div id="staticRatingStars" class="hidden mb-4 p-3 bg-black/50 rounded-[100px] flex justify-center gap-2">
                            <button onclick="setStarRating(1)" class="w-8 h-8 star-rating-btn">
                                <svg fill="#666" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                </svg>
                            </button>
                            <button onclick="setStarRating(2)" class="w-8 h-8 star-rating-btn">
                                <svg fill="#666" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                </svg>
                            </button>
                            <button onclick="setStarRating(3)" class="w-8 h-8 star-rating-btn">
                                <svg fill="#666" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                </svg>
                            </button>
                            <button onclick="setStarRating(4)" class="w-8 h-8 star-rating-btn">
                                <svg fill="#666" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                </svg>
                            </button>
                            <button onclick="setStarRating(5)" class="w-8 h-8 star-rating-btn">
                                <svg fill="#666" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                </svg>
                            </button>
                        </div>

                        <!-- Tags (shown when rating is selected) -->
                        <div id="ratingTags" class="hidden mb-4">
                            <div class="flex flex-row gap-3 overflow-x-auto hide-scrollbar">
                                <button onclick="toggleTag(this)"
                                    class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent"
                                    style="height: 35px; padding: 0 24px;">
                                    Sachets
                                </button>
                                <button onclick="toggleTag(this)"
                                    class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent"
                                    style="height: 35px; padding: 0 24px;">
                                    Bottle
                                </button>
                                <button onclick="toggleTag(this)"
                                    class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent"
                                    style="height: 35px; padding: 0 24px;">
                                    Dispenser
                                </button>
                            </div>
                        </div>

                        <!-- Static Input Row with larger height and star icon -->
                        <div class="flex flex-row items-center gap-4">
                            <div class="border rounded-[46px] relative"
                                style="height: 56px; background-color: #292B2FCC; border-color: var(--input-border); width: calc(100% - 60px); display: flex; align-items: center; padding: 0 20px;">
                                <input type="text" id="ratingCommentInput" placeholder="Write a review.."
                                    style="background: transparent; border: none; outline: none; color: white; font-size: 18px; flex: 1; padding-right: 40px; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                <!-- Star Icon Trigger -->
                                <button onclick="toggleStaticRatingStars()" 
                                    style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer;"
                                    onmouseover="this.querySelector('svg').style.opacity='1'"
                                    onmouseout="this.querySelector('svg').style.opacity='0.5'">
                                    <svg class="w-7 h-7" style="opacity: 0.5; transition: opacity 0.2s;" fill="gold" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                    </svg>
                                </button>
                            </div>
                            <!-- Send Button (larger) -->
                            <button onclick="submitReview()" class="border rounded-full flex items-center justify-center"
                                style="background-color: var(--btn-color); border-color: var(--btn-border); height: 56px; width: 56px;">
                                <svg class="w-6 h-6" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>

            </div>
        </div>

    </div>

    <!-- Product Details Modal (from schedule.tsx bottom sheet) -->
    <div id="productModal"
        class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300"
        style="background-color: rgba(0,0,0,0.5);">
        <div id="productModalContent"
            class="pointer-events-auto bg-[#1D1D1D] w-full max-w-[400px] h-[400px] rounded-[30px] p-5 flex flex-col items-center relative transform translate-y-full transition-transform duration-300">
            <button onclick="closeProductModal()"
                class="absolute top-4 left-4 z-10 w-10 h-10 flex items-center justify-center">
                <img src="images/main/ArrowLeftIcon.png" class="w-6 h-6">
            </button>
            <div class="w-full h-full flex flex-col items-center justify-center gap-4">
                <div id="modalImageContainer" class="h-[200px] w-full flex items-center justify-center bg-[#101010] rounded-[12px]">
                    <img id="modalProductImage" src="" class="h-[200px] object-contain" alt="Product image" 
                        onerror="this.onerror=null; const basename = this.src.split('/files/')[1]?.split('/view')[0] || ''; const altUrl = 'https://nyc.cloud.appwrite.io/v1/storage/buckets/695fec72003b8ba4fb22/files/' + basename + '/view?project=695f826500067c381616'; if(basename && this.src.includes('/68b1c57b001542be7fbe/')) { this.src = altUrl; console.log('ðŸ”„ Trying alternate bucket for modal image'); } else { console.error('âŒ Modal image failed'); this.style.display='none'; document.getElementById('modalImageContainer').innerHTML='<span class=&quot;text-white/50&quot;>Image unavailable</span>'; }">
                </div>
                <h2 id="modalProductName" class="text-white text-2xl font-bold">Product Name</h2>
                <p id="modalProductDescription" class="text-white text-lg text-center px-4">Product Description</p>
                <p id="modalProductPrice" class="text-white text-xl">GHS 0.00</p>
            </div>
        </div>
    </div>

    <!-- Social Media Modal -->
    <div id="socialModal" class="fixed inset-0 z-50 flex items-center justify-center p-9 hidden"
        style="background-color: rgba(0,0,0,0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        <div class="rounded-[30px] w-full max-w-[350px] h-[200px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]"
            style="background-color: #1D1D1D; border-color: rgba(255,255,255,0.1);">

            <div class="flex-1 w-full items-center flex-col justify-center relative">
                <!-- Icon Section -->
                <div class="items-center flex-1 w-full relative flex items-center justify-center mb-4">
                    <div class="w-[60px] h-[60px] rounded-full flex items-center justify-center"
                         style="background-color: #3B74FF;">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                    </div>
                </div>

                <!-- Text Section -->
                <div class="w-full flex-1 flex-col items-center justify-center text-center">
                    <h2 class="text-white text-center text-xl font-semibold mb-2">
                        Social Media Unavailable
                    </h2>
                    <p class="text-white text-center text-base font-normal">
                        <span id="socialPlatformName">Facebook</span> page is not available at the moment.
                    </p>
                    <p class="text-white text-center text-sm font-normal mt-2 opacity-75">
                        Please try again later or contact us directly.
                    </p>
                </div>

                <!-- Button Section -->
                <div class="w-full flex-1 flex-col items-center justify-end mt-6">
                    <button onclick="closeSocialModal()"
                        class="h-[37px] w-[177px] rounded-[100px] flex items-center justify-center border mx-auto"
                        style="background-color: var(--btn-color); border-color: var(--btn-border);">
                        <span class="text-white text-base font-semibold capitalize"
                            style="font-weight: 500;">Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="termsModal" class="fixed inset-0 z-[10002] flex items-center justify-center p-4 hidden"
        style="background-color: rgba(0,0,0,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        <div class="rounded-[20px] w-full max-w-[400px] h-[80vh] bg-[#1D1D1D] border border-[rgba(255,255,255,0.1)] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-[rgba(255,255,255,0.1)] flex-shrink-0">
                <h3 class="text-white text-xl font-semibold">Terms of Service</h3>
                <button onclick="closeTermsModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.2)] transition-colors">
                    <span class="text-white text-lg">Ã—</span>
                </button>
            </div>
            
            <!-- Content with Notion link -->
            <div class="flex-1 overflow-hidden p-4">
                <div class="w-full h-full rounded-lg border-0 bg-white p-6 text-center">
                    <h4 class="text-gray-800 text-lg font-medium mb-4">Terms of Service</h4>
                    <p class="text-gray-600 mb-6">Please read our Terms of Service on Notion</p>
                    <a href="https://pyrite-kicker-251.notion.site/Phluowise-Ecommerce-Regulations-2fd097f4f33c8064b37dd3071e6be2ee?source=copy_link" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        View Terms of Service
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Flow Bottom Sheet (NEW VERSION - Integrated from second file) -->
    <div id="scheduleFlowSheet"
        class="bottom-sheet-container fixed inset-0 z-[10001] flex items-end justify-center pointer-events-none">

        <!-- Content -->
        <div id="scheduleFlowContent" class="bottom-sheet-content w-full max-w-[400px] flex flex-col relative"
            style="height: 85vh;">

            <!-- Drag Handle -->
            <div class="sheet-drag-handle"></div>

            <!-- Step Indicators (Hidden as requested) -->
            <div class="step-indicator-container" style="display: none;">
                <div class="step-indicator-line"></div>
                <div class="step-indicator-wrapper px-6">
                    <div id="stepTermsIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Terms</span>
                    </div>
                    <div id="stepRecipientIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Recipient</span>
                    </div>
                    <div id="stepQuantityIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Quantity</span>
                    </div>
                    <div id="stepReviewIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Review</span>
                    </div>
                    <div id="stepPaymentIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Payment</span>
                    </div>
                </div>
            </div>

            <!-- Close Button -->
            <button onclick="closeScheduleFlow()"
                class="absolute top-4 right-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.2)] transition-colors">
                <span class="text-white text-2xl">Ã—</span>
            </button>

            <!-- Error Message Container -->
            <div id="errorMessage" class="error-message mx-6"></div>

            <!-- Success Message Container -->
            <div id="successMessage" class="success-message mx-6"></div>

            <!-- Step Content Container -->
            <div class="flex-1 overflow-y-auto hide-scrollbar px-6 pt-4">

                <!-- Step 1: Terms of Service (Radio Button Style) -->
                <div id="termsStep" class="step-content">
                    <h3 class="section-header">Terms of Service</h3>
                    <p class="section-subheader">Please select your order type:</p>

                    <div class="terms-radio-container">
                        <div onclick="selectTermsOption('schedule')" class="terms-radio-item selected"
                            id="termsSchedule">
                            <div class="terms-radio-label">
                                <div class="terms-radio-circle"></div>
                                Schedule Order
                            </div>
                            <div class="terms-details">
                                Place an order for future delivery. Orders must be scheduled at least 2 hours in
                                advance.
                            </div>
                        </div>

                        <div onclick="selectTermsOption('immediate')" class="terms-radio-item" id="termsImmediate">
                            <div class="terms-radio-label">
                                <div class="terms-radio-circle"></div>
                                Immediate Order
                            </div>
                            <div class="terms-details">
                                Order for immediate delivery. Subject to availability and current delivery conditions.
                            </div>
                        </div>
                    </div>

                    <div class="terms-container">
                        <p class="info-text">
                            By continuing you agree to our <a href="#" onclick="openTermsOfService()"
                                class="text-blue-400 hover:text-blue-300 underline">terms of service</a>
                        </p>
                    </div>
                </div>

                <!-- Step 2: Product Selection -->
                <div id="productSelectionStep" class="step-content hidden">
                    <h3 class="section-header">Select Products</h3>
                    <p class="section-subheader">Choose the products you want to order</p>

                    <div class="products-grid-container" id="productsSelectionGrid">
                        <!-- Products will be dynamically added here -->
                    </div>

                    <div class="info-card mt-4">
                        <div class="info-title">Important Note</div>
                        <div class="info-text">
                            You can adjust quantities after selecting products. Minimum order is 1 item per product.
                        </div>
                    </div>
                </div>

                <!-- Step 3: Order Recipient -->
                <div id="orderRecipientStep" class="step-content hidden">
                    <h3 class="section-header">Order Recipient</h3>
                    <p class="section-subheader">Who is this order for?</p>

                    <div class="recipient-type-container">
                        <button onclick="selectRecipientType('you')" class="recipient-type-btn active"
                            id="recipientYou">You</button>
                        <button onclick="selectRecipientType('individual')" class="recipient-type-btn"
                            id="recipientIndividual">Individual</button>
                        <button onclick="selectRecipientType('business')" class="recipient-type-btn"
                            id="recipientBusiness">Business</button>
                    </div>

                    <!-- Saved Recipients Toggle -->
                    <div class="toggle-container">
                        <span class="toggle-label">Save this for future orders</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="saveRecipientToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Saved Recipients (if any) -->
                    <div id="savedRecipientsContainer" class="saved-recipients-container hidden">
                        <p class="section-subheader">Select saved recipient:</p>
                        <div id="savedRecipientsList">
                            <!-- Saved recipients will be dynamically added here -->
                        </div>
                    </div>

                    <div class="form-container space-y-6">
                        <!-- You recipient info display -->
                        <div id="youRecipientInfo" class="you-recipient-info">
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Name:</span>
                                <span id="youNameDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Phone:</span>
                                <span id="youPhoneDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Email:</span>
                                <span id="youEmailDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Delivery Address:</span>
                                <span id="youAddressDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                        </div>

                        <!-- Business Type Selector (hidden by default) -->
                        <div id="businessTypeContainer" class="business-type-container hidden">
                            <label class="form-label">Business Type</label>
                            <select id="businessType" class="business-type-select">
                                <option value="">Select Business Type</option>
                                <option value="school">School/Educational Institution</option>
                                <option value="hospital">Hospital/Clinic</option>
                                <option value="hotel">Hotel/Restaurant</option>
                                <option value="office">Office/Corporate</option>
                                <option value="church">Church/Religious Institution</option>
                                <option value="ngo">NGO/Non-Profit</option>
                                <option value="government">Government Agency</option>
                                <option value="factory">Factory/Manufacturing</option>
                                <option value="construction">Construction Site</option>
                                <option value="other">Other Business</option>
                            </select>
                        </div>

                        <!-- Name field (hidden for "You" type) -->
                        <div id="recipientNameContainer" class="hidden">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="recipientName" class="form-input" placeholder="Enter recipient name">
                        </div>

                        <!-- Business Name Field (hidden by default, shown only for business type) -->
                        <div id="businessNameContainer" class="business-name-container hidden">
                            <label class="form-label">Business Name</label>
                            <input type="text" id="businessName" class="form-input" placeholder="Enter business name">
                        </div>

                        <!-- Phone field (hidden for "You" type) -->
                        <div id="recipientPhoneContainer" class="hidden">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="recipientPhone" class="form-input" placeholder="Enter phone number">
                        </div>

                        <!-- Email field (hidden for "You" type) -->
                        <div id="recipientEmailContainer" class="hidden">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="recipientEmail" class="form-input"
                                placeholder="Enter email address">
                        </div>

                        <!-- Delivery Address (always shown) -->
                        <div>
                            <label class="form-label">Delivery Address *</label>
                            <textarea id="recipientAddress" rows="3" class="form-textarea"
                                placeholder="Full address or detailed location (e.g: 5th Floor, Block B, Ring Road)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Date and Time Selection -->
                <div id="datetimeStep" class="step-content hidden">
                    <h3 class="section-header">Select Date & Time</h3>
                    <p class="section-subheader">Choose when you want your order delivered</p>

                    <div class="form-container space-y-6">
                        <div class="datetime-row">
                            <div class="datetime-input">
                                <label class="form-label">Delivery Date</label>
                                <input type="date" id="deliveryDate" class="form-input" min="">
                            </div>
                            <div class="datetime-input">
                                <label class="form-label">Delivery Time</label>
                                <select id="deliveryTime" class="form-input">
                                    <option value="">Select Time</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                </select>
                            </div>
                        </div>

                        <div class="time-slots-container">
                            <label class="form-label">Popular Time Slots</label>
                            <div class="time-slots-grid" id="timeSlotsGrid">
                                <!-- Time slots will be dynamically generated -->
                            </div>
                        </div>

                        <div class="info-card">
                            <div class="info-title">Important Note</div>
                            <div class="info-text">
                                Orders must be scheduled at least 2 hours in advance. Same-day delivery is subject to
                                availability.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Product Quantity Selection (Multiple Products) -->
                <div id="quantityStep" class="step-content hidden">
                    <div class="service-products-header">
                        <h3 class="section-header">Adjust Quantities</h3>
                        <button onclick="goToProductSelection()" class="add-more-btn">
                            + Add More Products
                        </button>
                    </div>
                    <p class="section-subheader">Adjust quantities for your selected products</p>

                    <!-- Selected Products Container -->
                    <div class="selected-products-container" id="selectedProductsContainer">
                        <!-- Selected products from service cards will appear here -->
                        <div class="no-products-selected">No products selected. Please go back and select products.</div>
                    </div>

                    <!-- Delivery Instructions -->
                    <div class="delivery-instructions">
                        <div class="instructions-title">Add additional Information</div>
                        <div class="instructions-example">Example: "Please Call Me On 024XXXXXXXX When You Arrive At The
                            Main Gate. The Security Guard Will Direct You."</div>
                        <textarea id="deliveryInstructions" rows="3" class="form-textarea"
                            placeholder="Enter delivery instructions..."></textarea>
                    </div>

                    <!-- Delivery Fee Information -->
                    <div class="delivery-info-note">
                        <strong>Please Note:</strong> Delivery Fees Are Charged By The Water Company, Not Phluowise.
                        Payment Must Be Made Upon Delivery To Confirm Receipt.
                    </div>

                    <!-- Price Summary -->
                    <div class="price-display mt-6">
                        <div class="price-row">
                            <span class="price-label">Subtotal</span>
                            <span id="quantitySubtotal" class="price-value">GHS 0.00</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">Service Fee (GHS 0.2 per item)</span>
                            <span id="serviceFeeDisplay" class="price-value">GHS 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">Total Amount</span>
                            <span id="quantityTotal" class="price-value total">GHS 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Order Review -->
                <div id="orderReviewStep" class="step-content hidden">
                    <h3 class="section-header">Review Your Order</h3>

                    <!-- Order Summary -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Order Summary</h4>
                            <div id="reviewProductsList">
                                <!-- Products will be dynamically added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Information -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Delivery Information</h4>
                            <div class="review-item">
                                <span class="review-label">Date:</span>
                                <span id="reviewDeliveryDate" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Time:</span>
                                <span id="reviewDeliveryTime" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Address:</span>
                                <span id="reviewDeliveryAddress" class="review-value"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Instructions -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Delivery Instructions</h4>
                            <div class="review-value" id="reviewDeliveryInstructions">None provided</div>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Payment Summary</h4>
                            <div class="review-item">
                                <span class="review-label">Subtotal</span>
                                <span id="reviewSubtotal" class="review-value">GHS 0.00</span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Service Fee (GHS 0.2 per item)</span>
                                <span id="reviewServiceFee" class="review-value">GHS 0.00</span>
                            </div>
                            <div class="review-item"
                                style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
                                <span class="review-label">Total Amount</span>
                                <span id="reviewTotal" class="review-value"
                                    style="color: #3B74FF; font-weight: 600;">GHS 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Fee Note -->
                    <div class="delivery-info-note">
                        <strong>Please Note:</strong> Delivery Fees Are Charged By The Water Company, Not Phluowise.
                        Payment Must Be Made Upon Delivery To Confirm Receipt.
                    </div>
                </div>

                <!-- Step 7: Payment -->
                <div id="selectPaymentStep" class="step-content hidden">
                    <h3 class="section-header">Payment Method</h3>
                    <p class="section-subheader">Select your preferred payment method</p>

                    <!-- Mobile Money -->
                    <div class="payment-method-card disabled" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">
                        <div class="payment-method-icon mobile">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div class="payment-method-name">Mobile Money</div>
                        <div class="payment-method-desc">MTN, Vodafone, AirtelTigo</div>
                        <div class="payment-check">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Pay on Delivery -->
                    <div onclick="selectPaymentMethod('delivery')" class="payment-method-card" style="margin-top: 16px;">
                        <div class="payment-method-icon delivery">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="payment-method-name">Pay on Delivery</div>
                        <div class="payment-method-desc">Pay when you receive your order</div>
                        <div class="payment-check">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>

                    <div class="mobile-payment-note">
                        You will receive a prompt on your mobile phone to complete the payment, or pay when you receive your order.
                    </div>
                </div>

                <!-- Step 8: Input Payment Details (Mobile Money Only) -->
                <div id="paymentDetailsStep" class="step-content hidden">
                    <h3 class="section-header">Mobile Money Details</h3>

                    <div class="form-container space-y-4">
                        <div>
                            <label class="form-label">Mobile Network</label>
                            <select id="mobileNetwork" class="form-input">
                                <option value="">Select Network</option>
                                <option value="mtn">MTN Mobile Money</option>
                                <option value="vodafone">Vodafone Cash</option>
                                <option value="airteltigo">AirtelTigo Money</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="mobileNumber" class="form-input" placeholder="0201234567">
                        </div>
                    </div>
                </div>

                <!-- Step 9: Payment Confirmation Processing -->
                <div id="paymentProcessingStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="processing-spinner"></div>
                        <h3 class="section-header mb-2">Processing Payment</h3>
                        <p class="section-subheader">Please wait while we process your payment securely...</p>
                        <div class="progress-bar-container">
                            <div id="paymentProgressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 10: Payment Success -->
                <div id="paymentSuccessStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="success-icon">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-2">Payment Successful!</h3>
                        <p class="section-subheader mb-6">Your payment has been processed successfully</p>
                        <div class="review-card w-full mb-6">
                            <div class="review-item">
                                <span class="review-label">Transaction ID:</span>
                                <span id="transactionIdDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Amount Paid:</span>
                                <span id="amountPaidDisplay" class="review-value" style="color: #10B981;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 11: Schedule Pickup Sent & Rate Phluowise -->
                <div id="scheduleSentStep" class="step-content hidden">
                    <div class="flex flex-col items-center h-full text-center">
                        <div class="success-icon"
                            style="background: rgba(59, 116, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 2px solid rgba(59, 116, 255, 0.4); margin-bottom: 24px;">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-2">Schedule Pickup Sent!</h3>
                        <p class="section-subheader mb-6">Your order has been successfully scheduled and confirmed</p>

                        <div class="review-card w-full mb-6">
                            <h4 class="review-section-title mb-4">Order Summary</h4>
                            <div class="review-item">
                                <span class="review-label">Order ID:</span>
                                <span id="orderIdDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Date:</span>
                                <span id="orderDateDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Time:</span>
                                <span id="orderTimeDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Total Items:</span>
                                <span id="orderItemsDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Status:</span>
                                <span class="review-value" style="color: #10B981;">Confirmed</span>
                            </div>
                        </div>

                        <!-- Download PDF Button -->
                        <div class="w-full mb-6">
                            <button onclick="downloadOrderPDF()" class="w-full py-4 rounded-lg backdrop-blur-xl bg-[#007ACC]/20 border border-[#007ACC]/40 text-white font-medium hover:bg-[#007ACC]/30 transition-all duration-300 shadow-lg flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Download Order PDF
                            </button>
                        </div>

                        <!-- Rating Section -->
                        <div class="w-full">
                            <h4 class="review-section-title mb-4">Rate Phluowise</h4>
                            <p class="section-subheader mb-6">How was your experience with our service?</p>

                            <div class="rating-stars-container">
                                <div onclick="setRating(1)" class="rating-star-large">â˜†</div>
                                <div onclick="setRating(2)" class="rating-star-large">â˜†</div>
                                <div onclick="setRating(3)" class="rating-star-large">â˜†</div>
                                <div onclick="setRating(4)" class="rating-star-large">â˜†</div>
                                <div onclick="setRating(5)" class="rating-star-large">â˜†</div>
                            </div>

                            <textarea id="ratingComment" rows="3" class="form-textarea mt-4"
                                placeholder="Share your experience (optional)..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 12: Rating Success -->
                <div id="ratingSuccessStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="success-icon" style="width: 80px; height: 80px;">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-4">Thank You!</h3>
                        <p class="text-lg text-gray-300 mb-2">Your rating has been submitted</p>
                        <p class="section-subheader mb-6">We appreciate your feedback</p>

                        <div class="review-card w-full mb-6">
                            <div class="review-item">
                                <span class="review-label">Order ID:</span>
                                <span id="finalOrderId" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Date:</span>
                                <span id="finalDeliveryDate" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Rating:</span>
                                <span id="finalRatingStars" class="review-value"
                                    style="color: #FCD34D; font-size: 18px;"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Total Paid:</span>
                                <span id="finalTotalPaid" class="review-value" style="color: #3B74FF;"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Navigation Buttons (Improved) -->
            <div class="step-navigation px-6 pb-6">
                <button id="prevBtn" onclick="previousStep()" class="nav-btn prev hidden">
                    Back
                </button>
                <button id="nextBtn" onclick="nextStep()" class="nav-btn next">
                    Continue
                </button>
                <button id="payBtn" onclick="processPayment()" class="nav-btn pay hidden">
                    <span id="payBtnText">Pay Now</span>
                    <span id="payBtnLoading" class="hidden">Processing...</span>
                </button>
                <button id="doneBtn" onclick="finishFlow()" class="nav-btn done hidden">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Schedule History renamed) -->
    <div
        class="tab-bar fixed bottom-0 left-0 right-0 h-[64px] flex flex-row justify-around items-center px-4 border-t-0 bg-[#101010] z-[100]">
        <a href="home.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path
                    d="M9.02 2.84004L3.63 7.04004C2.73 7.74004 2 9.23004 2 10.36V17.77C2 20.09 3.89 21.99 6.21 21.99H17.79C20.11 21.99 22 20.09 22 17.78V10.5C22 9.29004 21.19 7.74004 20.2 7.05004L14.02 2.72004C12.62 1.74004 10.37 1.79004 9.02 2.84004Z"
                    stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 17.99V14.99" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Home</span>
        </a>
        <a href="services.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path
                    fill="#FFFFFF"
                    d="m31.696 15.098-1.75-4.376a1.742 1.742 0 0 0-1.625-1.1H23.75V8.376a.75.75 0 0 0-.75-.75H4a1.75 1.75 0 0 0-1.75 1.75v14A1.75 1.75 0 0 0 4 25.125h2.325a3.75 3.75 0 0 0 7.35 0h6.65a3.75 3.75 0 0 0 7.35 0H30a1.75 1.75 0 0 0 1.75-1.75v-8a.752.752 0 0 0-.054-.277Zm-7.946-3.973h4.573a.25.25 0 0 1 .232.158l1.337 3.342H23.75v-3.5Zm-20-1.75a.25.25 0 0 1 .25-.25h18.25v8.5H3.75v-8.25ZM10 26.625a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm10.325-3h-6.65a3.75 3.75 0 0 0-7.35 0H4a.25.25 0 0 1-.25-.25v-4.25h18.5v1.935a3.763 3.763 0 0 0-1.925 2.565Zm3.675 3a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm6.25-3.25a.25.25 0 0 1-.25.25h-2.325a3.756 3.756 0 0 0-3.675-3c-.084 0-.168 0-.25.009v-4.509h6.5v7.25Z"
                />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Services</span>
        </a>
        <a href="schedule-history.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path d="M8 2V5" />
                <path d="M16 2V5" />
                <path
                    d="M3.5 9.09H20.5" />
                <path d="M3.5 9.09H20.5" />
                <path
                    d="M18.2 21.4C19.9673 21.4 21.4 19.9673 21.4 18.2C21.4 16.4327 19.9673 15 18.2 15C16.4327 15 15 16.4327 15 18.2C15 19.9673 16.4327 21.4 18.2 21.4Z" />
                <path d="M22 22L21 21" />
                <path
                    d="M21 8.5V13.63C20.27 13.14 19.38 12.85 18.43 12.85C15.86 12.85 13.78 14.95 13.78 17.54C13.78 18.45 14.04 19.29 14.49 20H8C4.5 20 3 18 3 15V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Schedule History</span>
        </a>
    </div>

    <!-- Appwrite SDK and Config -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script src="js/appwriteConfig.js"></script>
    <script src="js/companyData.js"></script>
    <script src="js/cacheManager.js"></script>
    <script src="js/orderManager.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/pageTracker.js"></script>
    <script src="js/offlineDetector.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Map initialization flag
        let mapInitialized = false;
        let mapInitializationTimer = null;
        
        // Function to safely initialize the map when company data is available
        function initializeMapWhenReady() {
            // Only attempt initialization once
            if (mapInitialized) return;
            
            // Check if company data is ready
            if (window.currentCompany && window.currentCompany.coordinates && 
                window.currentCompany.coordinates.lat && window.currentCompany.coordinates.lng) {
                
                console.log('ðŸ—ºï¸ Company data ready, initializing map with coordinates:', window.currentCompany.coordinates);
                
                // Clear timer if it exists
                if (mapInitializationTimer) {
                    clearInterval(mapInitializationTimer);
                    mapInitializationTimer = null;
                }
                
                // Initialize the map
                initMap();
                mapInitialized = true;
                console.log('âœ… Map initialized successfully');
            }
        }
        
        // Global variables for the schedule flow
        let currentStep = 1;
        const totalSteps = 12; // Increased to 12 steps
        let selectedPaymentMethod = null;
        let orderData = {
            recipient: {},
            products: [],
            subtotal: 0,
            serviceFee: 0,
            total: 0
        };
        let userRating = 0;
        let selectedCompany = '';
        let recipientType = 'you';
        const SERVICE_FEE_PER_ITEM = 0.2;
        let savedRecipients = [];
        let selectedSavedRecipient = null;
        let selectedDate = '';
        let selectedTime = '';
        let selectedProducts = [];

        // Products data for the company (fetched from Appwrite)
        let companyProducts = [];

        async function fetchProductsForCurrentBranch() {
            try {
                console.log('ðŸ›’ Starting product fetch for current branch...');
                
                // Ensure Appwrite is available
                if (!window.databases || !window.appwriteConfig) {
                    console.error('âŒ Appwrite not available for products - SDK not loaded');
                    return;
                }

                // Get branch_id from URL
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');

                // If branch data already loaded, prefer using its IDs
                let filterQueries = [];
                const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                const resolvedBranchId = branchData?.branch_id || branchId;
                const resolvedCompanyId = branchData?.company_id;

                console.log('ðŸ›’ Product fetch parameters:', {
                    urlBranchId: branchId,
                    resolvedBranchId,
                    resolvedCompanyId,
                    hasBranchData: !!branchData
                });

                if (resolvedBranchId) {
                    filterQueries.push(window.Query.equal('branch_id', resolvedBranchId));
                }
                if (resolvedCompanyId) {
                    filterQueries.push(window.Query.equal('company_id', resolvedCompanyId));
                }

                // Build the query - Appwrite automatically ANDs multiple queries
                let finalQuery;
                if (filterQueries.length > 0) {
                    finalQuery = filterQueries;
                } else {
                    // Fallback: no branch/company filter, just fetch all
                    finalQuery = [window.Query.orderDesc('$createdAt')];
                }

                const response = await window.databases.listDocuments(
                    window.appwriteConfig.DATABASE_ID,
                    window.appwriteConfig.PRODUCTS_TABLE,
                    finalQuery
                );

                const productsFromDb = response.documents || [];
                console.log(`ðŸ›’ Found ${productsFromDb.length} products in database`);
                console.log('ðŸ›’ Raw products from DB:', productsFromDb);

                // Map DB fields to UI model, including image resolution
                companyProducts = productsFromDb.map((doc, index) => {
                    const type = (doc.product_type || '').toLowerCase();

                    // Use product_image from database and construct Appwrite storage URL if needed
                    let imageUrl = doc.product_image || '';
                    
                    // Debug logging - show all available fields
                    console.log(`ðŸ” Product image processing: "${doc.product_name}"`);
                    console.log(`   - product_image field: "${imageUrl}"`);
                    console.log(`   - All doc fields:`, doc);
                    
                    // If product_image exists but doesn't start with http, construct Appwrite URL
                    if (imageUrl && !imageUrl.startsWith('http')) {
                        // Try the configured storage bucket first
                        const primaryUrl = `https://nyc.cloud.appwrite.io/v1/storage/buckets/${window.appwriteConfig.STORAGE_BUCKET_ID}/files/${imageUrl}/view?project=${window.appwriteConfig.PROJECT_ID}&mode=admin`;
                        
                        // Fallback to alternate bucket (in case images are stored there)
                        const alternateUrl = `https://nyc.cloud.appwrite.io/v1/storage/buckets/695fec72003b8ba4fb22/files/${imageUrl}/view?project=${window.appwriteConfig.PROJECT_ID}`;
                        
                        imageUrl = primaryUrl;
                        console.log(`ðŸ”§ Constructed primary Appwrite URL: ${primaryUrl}`);
                        console.log(`ðŸ”§ Fallback URL: ${alternateUrl}`);
                    } else if (imageUrl.startsWith('http')) {
                        console.log(`âœ… Using direct HTTP URL: ${imageUrl}`);
                    }
                    
                    console.log(`ðŸ“Š Image URL status: ${imageUrl ? 'âœ… Has URL' : 'âŒ No URL'}`);
                    
                    // If no product_image, use type-based fallback
                    if (!imageUrl) {
                        console.log(`âš ï¸ No product image found, using fallback for type: ${type}`);
                        if (type.includes('dispenser')) imageUrl = 'images/products/dispenser.jpg';
                        else if (type.includes('bottle')) imageUrl = 'images/products/bottle.jpg';
                        else if (type.includes('sachet') || type.includes('sachets')) imageUrl = 'images/products/sachets.jpg';
                        else imageUrl = 'images/main/ProductImage1.png';
                    }

                    // Quantity default to 1, ensure numeric price
                    const priceNum = parseFloat(doc.price) || 0;

                    return {
                        id: doc.product_id || doc.$id || index + 1,
                        name: doc.product_name || 'Product',
                        price: priceNum,
                        image: imageUrl,
                        quantity: 1,
                        type: type, // Add the type field from product_type
                        description: doc.size ? `${doc.size}` : (doc.product_type || 'Product')
                    };
                });

                console.log(`ðŸ›’ Successfully mapped ${companyProducts.length} products for UI`);
                console.log('ðŸ›’ Final companyProducts array:', companyProducts);

                // Refresh selection grid UI if on product selection step
                if (typeof updateProductSelectionStep === 'function') {
                    console.log('ðŸ›’ Updating product selection step UI...');
                    updateProductSelectionStep();
                }

                // Also refresh Products subview grid
                if (typeof renderProducts === 'function') {
                    console.log('ðŸ›’ Rendering products in subview...');
                    renderProducts();
                }
            } catch (error) {
                console.error('âŒ Error fetching products:', error);
            }
        }

        // Trigger fetching after branch data is loaded and DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // After branch info updates, fetch related products
            fetchProductsForCurrentBranch();
        });

        // Variables from original schedule.html
        let readMore = false;
        let subView = 'schedule';
        let map;
        let userLocation = null;
        let companyMarker = null;
        let userMarker = null;
        let currentTileLayer = null;
        let isSatelliteView = false;

        // Current company data (will be populated from database)
        let currentCompany = {
            id: null,
            name: null,
            location: null,
            coordinates: { lat: 5.6037, lng: -0.1870 }, // Default Accra coordinates
            phone: null,
            website: null,
            workingHours: {}
        };

        // Products data (will be populated from database)
        let products = [];

        // Rating system state
        let currentRating = 0;
        let selectedTags = new Set();
        let reviews = []; // Will be populated from database

        // Helper function to get verified icon CSS class based on verification tier
        function getVerifiedIconClass(tier) {
            console.log(`ðŸ” [DEBUG] Getting icon class for tier: ${tier}`);
            let cssClass;
            switch (tier) {
                case 2:
                    cssClass = 'verified-checkmark-tier2'; // Blue icon
                    console.log(`ðŸ” [DEBUG] Tier 2 -> Blue icon: ${cssClass}`);
                    break;
                case 3:
                    cssClass = 'verified-checkmark-tier3'; // Gold icon
                    console.log(`ðŸ” [DEBUG] Tier 3 -> Gold icon: ${cssClass}`);
                    break;
                default:
                    cssClass = 'verified-checkmark-tier2'; // Default to blue (tier2)
                    console.log(`ðŸ” [DEBUG] Default tier (${tier}) -> Blue icon: ${cssClass}`);
                    break;
            }
            return cssClass;
        }

        // Functions from original schedule.html
        function toggleReadMore() {
            readMore = !readMore;
            const container = document.getElementById('descriptionContainer');
            const gradient = document.getElementById('descGradient');
            const text = document.getElementById('readMoreText');

            if (readMore) {
                container.style.height = 'auto';
                gradient.style.display = 'none';
                text.textContent = 'less -';
            } else {
                container.style.height = '45px';
                gradient.style.display = 'block';
                text.textContent = 'more +';
            }
        }

        function setSubView(view) {
            subView = view;
            const btns = ['schedule', 'products', 'rating'];
            btns.forEach(btn => {
                const button = document.getElementById('btn-' + btn);
                if (btn === view) {
                    button.style.backgroundColor = 'var(--btn-color)';
                    button.style.borderColor = 'var(--btn-border)';
                } else {
                    button.style.backgroundColor = 'transparent';
                    button.style.borderColor = 'transparent';
                }
            });

            document.getElementById('view-schedule').style.display = view === 'schedule' ? 'block' : 'none';
            document.getElementById('view-products').style.display = view === 'products' ? 'block' : 'none';
            document.getElementById('view-rating').style.display = view === 'rating' ? 'block' : 'none';

            if (view === 'products') renderProducts();
        }

        function renderProducts() {
            const container = document.getElementById('productsGrid');
            const productsLoader = document.getElementById('productsLoader');
            
            // Hide loader and show content
            if (productsLoader) productsLoader.classList.add('hidden');
            if (container) container.classList.remove('hidden');
            
            container.innerHTML = '';

            const list = (Array.isArray(companyProducts) && companyProducts.length > 0) ? companyProducts : products;

            list.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = "relative overflow-hidden rounded-[10px]";
                card.style.width = "calc(50% - 8px)";
                card.style.height = "220px";
                card.style.backgroundColor = "var(--card-bg-dark)";

                const priceText = Number(p.price || 0).toFixed(2);
                const descText = p.description || p.type || '';
                
                // Escape variables for onclick handler using JSON.stringify
                const escapedName = JSON.stringify(p.name || '').slice(1, -1);
                const escapedDesc = JSON.stringify(descText || '').slice(1, -1);
                const escapedImage = JSON.stringify(p.image || '').slice(1, -1);

                card.innerHTML = `
                    <!-- Top Blur (intensity: 70, height: 40, zIndex: 2) -->
                    <div class="absolute top-0 left-0 right-0 px-2 flex flex-row justify-between items-center z-10 glass-blur-70" style="height: 40px;">
                         <span class="text-white font-[700] text-lg">GHS ${priceText}</span>
                         <div class="w-[15px] h-[15px] bg-white/50 rounded-sm"></div>
                    </div>
                    
                    <img src="${p.image}" 
                         class="w-full h-full object-cover" 
                         alt="${p.name}"
                         onerror="this.onerror=null; const basename = this.src.split('/files/')[1]?.split('/view')[0] || ''; const altUrl = 'https://nyc.cloud.appwrite.io/v1/storage/buckets/695fec72003b8ba4fb22/files/' + basename + '/view?project=695f826500067c381616'; if(basename && this.src.includes('/68b1c57b001542be7fbe/')) { this.src = altUrl; console.log('ðŸ”„ Trying alternate bucket for: ' + basename); } else { console.error('âŒ Image failed in both buckets: ${p.image}'); }">
                    
                    <!-- Bottom Blur (intensity: 50, height: 50, zIndex: 2) -->
                    <div class="absolute bottom-0 left-0 right-0 px-2 py-1 flex flex-row justify-between items-center gap-2 z-10 glass-blur-50" style="height: 50px;">
                         <div style="flex: 1; min-width: 0;">
                              <span class="text-white font-[600] block leading-tight truncate" style="max-width: 100%;">${p.name}</span>
                              <span class="text-white font-[400] text-sm block leading-tight truncate" style="max-width: 100%;">${descText}</span>
                         </div>
                         <!-- Button (height: 25, rounded: 5, bg: #40444B, shadow) -->
                         <button class="bg-[#40444B] rounded-[5px] px-2 py-1 flex items-center justify-center transform active:scale-95 transition-transform flex-shrink-0"
                                 onclick="openProductModal('${escapedName}', ${Number(p.price || 0)}, '${escapedDesc}', '${escapedImage}')"
                                 style="height: 28px; white-space: nowrap; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);">
                              <span class="text-white text-xs font-[500]">Details</span>
                         </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateWorkingHours() {
            const select = document.getElementById('workingDaysSelect');
            const openingTimeSpan = document.getElementById('openingTime');
            const closingTimeSpan = document.getElementById('closingTime');
            
            if (!select || !select.value) {
                openingTimeSpan.textContent = 'Closed';
                closingTimeSpan.textContent = 'Closed';
                openingTimeSpan.style.color = '#F57D7D';
                closingTimeSpan.style.color = '#F57D7D';
                return;
            }
            
            const selectedDay = select.value;
            const dayHours = window.currentCompany?.workingHours?.[selectedDay];
            
            // Check if day exists and has both opening and closing times
            if (!dayHours || !dayHours.open || !dayHours.close || dayHours.open === '' || dayHours.close === '') {
                openingTimeSpan.textContent = 'Closed';
                closingTimeSpan.textContent = 'Closed';
                openingTimeSpan.style.color = '#FF0000'; // Red color for Closed
                closingTimeSpan.style.color = '#FF0000'; // Red color for Closed
                console.log(`${selectedDay}: Closed (no opening/closing times set)`);
                return;
            }
            
            openingTimeSpan.textContent = dayHours.open;
            closingTimeSpan.textContent = dayHours.close;
            openingTimeSpan.style.color = '#FFFFFF'; // Reset to normal color
            closingTimeSpan.style.color = '#FFFFFF'; // Reset to normal color
            console.log(`${selectedDay}: ${dayHours.open} - ${dayHours.close}`);
            
            // Highlight today
            const today = new Date().toLocaleDateString('en-US', { weekday: 'short' }).toLowerCase();
            const dayMapping = {
                'mon': 'monday', 'tue': 'tuesday', 'wed': 'wednesday',
                'thu': 'thursday', 'fri': 'friday', 'sat': 'saturday', 'sun': 'sunday'
            };
            
            const currentDay = dayMapping[today] || 'monday';
            if (selectedDay === currentDay) {
                select.style.backgroundColor = '#3B74FF';
                select.style.color = '#FFFFFF';
            } else {
                select.style.backgroundColor = '#202225';
                select.style.color = '#FFFFFF';
            }
        }

        function setCurrentDay() {
            const select = document.getElementById('workingDaysSelect');
            
            if (!select) {
                return;
            }
            
            const today = new Date().toLocaleDateString('en-US', { weekday: 'short' }).toLowerCase();
            
            const dayMapping = {
                'mon': 'monday',
                'tue': 'tuesday', 
                'wed': 'wednesday',
                'thu': 'thursday',
                'fri': 'friday',
                'sat': 'saturday',
                'sun': 'sunday'
            };
            
            const currentDay = dayMapping[today] || 'monday';
            
            const option = select.querySelector(`option[value="${currentDay}"]`);
            if (option) {
                select.value = currentDay;
                option.textContent = option.textContent.replace(/^(\w+)/, '$1 (Today)');
            } else {
                select.value = select.options[0]?.value || 'monday';
            }
            
            updateWorkingHours();
        }

        function openProductModal(name, price, description, imageUrl) {
            const modal = document.getElementById('productModal');
            const content = document.getElementById('productModalContent');
            const modalContainer = document.getElementById('modalImageContainer');
            
            document.getElementById('modalProductName').textContent = name;
            document.getElementById('modalProductPrice').textContent = "GHS " + price;
            document.getElementById('modalProductDescription').textContent = description;
            
            // Update modal image if URL is provided
            if (imageUrl && modalContainer) {
                modalContainer.innerHTML = `<img id="modalProductImage" src="${imageUrl}" class="h-[200px] object-contain" alt="Product image" onerror="this.onerror=null; const basename = this.src.split('/files/')[1]?.split('/view')[0] || ''; const altUrl = 'https://nyc.cloud.appwrite.io/v1/storage/buckets/695fec72003b8ba4fb22/files/' + basename + '/view?project=695f826500067c381616'; if(basename && this.src.includes('/68b1c57b001542be7fbe/')) { this.src = altUrl; console.log('ðŸ”„ Trying alternate bucket for modal image'); } else { console.error('âŒ Modal image failed'); this.style.display='none'; document.getElementById('modalImageContainer').innerHTML='<span class=&quot;text-white/50&quot;>Image unavailable</span>'; }">`;
                console.log('ðŸ–¼ï¸ Modal image updated:', imageUrl);
            } else {
                console.log('âš ï¸ No image URL provided for modal');
                if (modalContainer) {
                    modalContainer.innerHTML = '<span class="text-white/50">No image available</span>';
                }
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        function closeProductModal() {
            const modal = document.getElementById('productModal');
            const content = document.getElementById('productModalContent');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 300);
        }

        // Schedule Flow Bottom Sheet Functions
        function openScheduleBottomSheet() {
            return new Promise(async (resolve) => {
                console.log('Opening schedule bottom sheet...');
                
                // Reset to first step
                currentStep = 1;
                
                const sheet = document.getElementById('scheduleFlowSheet');
                const content = document.getElementById('scheduleFlowContent');
                
                console.log('Sheet element:', sheet);
                console.log('Content element:', content);
                
                if (!sheet) {
                    console.error('Schedule flow sheet not found!');
                    resolve();
                    return;
                }
                
                if (!content) {
                    console.error('Schedule flow content not found!');
                    resolve();
                    return;
                }
                
                console.log('Adding active classes...');
                sheet.classList.add('active');
                content.classList.add('active');
                sheet.classList.remove('pointer-events-none');
                
                console.log('Classes added. Sheet classes:', sheet.className);
                console.log('Content classes:', content.className);
                
                // Load saved recipients
                loadSavedRecipients();
                
                // Initialize date input with minimum date (today + 2 hours)
                initializeDateInput();
                
                // Load user profile data
                loadUserProfileData();
                
                // Reset selected products
                selectedProducts = [];
                orderData.products = [];
                
                // Ensure products are loaded for this branch
                if (companyProducts.length === 0) {
                    console.log('ðŸ›’ No products loaded, fetching now...');
                    await fetchProductsForCurrentBranch();
                } else {
                    console.log(`ðŸ›’ Products already loaded (${companyProducts.length} products)`);
                }
                
                console.log('About to call goToStep...');
                goToStep('terms');
                console.log('goToStep completed');
                
                resolve();
            });
        }

        function closeScheduleFlow() {
            const sheet = document.getElementById('scheduleFlowSheet');
            const content = document.getElementById('scheduleFlowContent');
            content.classList.remove('active');
            setTimeout(() => {
                sheet.classList.remove('active');
                sheet.classList.add('pointer-events-none');
            }, 300);
            
            // Reset step
            currentStep = 1;
            updateStepIndicators();
            
            // Reset data
            orderData = {
                recipient: {}
            };
            selectedPaymentMethod = null;
            userRating = 0;
            selectedProducts = [];
            hideError();
        }

        function goToStep(step) {
            console.log('goToStep called with:', step);
            
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Show current step
            const stepMap = {
                'terms': 'termsStep',
                'productSelection': 'productSelectionStep',
                'recipient': 'orderRecipientStep',
                'datetime': 'datetimeStep',
                'quantity': 'quantityStep',
                'review': 'orderReviewStep',
                'selectPayment': 'selectPaymentStep',
                'paymentDetails': 'paymentDetailsStep',
                'paymentProcessing': 'paymentProcessingStep',
                'paymentSuccess': 'paymentSuccessStep',
                'scheduleSent': 'scheduleSentStep',
                'ratingSuccess': 'ratingSuccessStep'
            };

            console.log('Step map:', stepMap);
            console.log('Looking for element ID:', stepMap[step]);

            const stepElement = document.getElementById(stepMap[step]);
            console.log('Found step element:', stepElement);
            
            // Refresh user profile data when opening Order Recipient step
            if (step === 'recipient') {
                console.log('ðŸ”„ Opening Order Recipient step, refreshing user profile data...');
                refreshUserProfileData();
            }
            
            if (stepElement) {
                stepElement.classList.remove('hidden');
                console.log('Removed hidden class from step element');

                // Special handling for specific steps
                if (step === 'productSelection') {
                    updateProductSelectionStep();
                } else if (step === 'recipient') {
                    updateRecipientStep();
                } else if (step === 'datetime') {
                    updateDateTimeStep();
                } else if (step === 'quantity') {
                    updateQuantityStep();
                } else if (step === 'review') {
                    updateOrderReview();
                } else if (step === 'paymentProcessing') {
                    startPaymentProcessing();
                } else if (step === 'paymentSuccess') {
                    showPaymentSuccess();
                } else if (step === 'scheduleSent') {
                    showScheduleSent();
                } else if (step === 'ratingSuccess') {
                    showRatingSuccess();
                }
            } else {
                console.error('Step element not found for:', step, 'ID:', stepMap[step]);
            }

            updateStepIndicators();
            updateNavigationButtons();
            hideError();
            console.log('goToStep completed');
        }

        function updateStepIndicators() {
            // Step indicators are hidden as requested
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const payBtn = document.getElementById('payBtn');
            const doneBtn = document.getElementById('doneBtn');

            // Show/hide previous button
            if (currentStep === 1) {
                prevBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
            }

            // Show/hide buttons based on current step
            nextBtn.classList.add('hidden');
            payBtn.classList.add('hidden');
            doneBtn.classList.add('hidden');

            if (currentStep === totalSteps) {
                doneBtn.classList.remove('hidden');
            } else if (currentStep === 8) { // Payment details step
                payBtn.classList.remove('hidden');
            } else if (currentStep < totalSteps) {
                nextBtn.classList.remove('hidden');

                // Update button text based on step
                if (currentStep === 6) { // Review step
                    nextBtn.textContent = 'Confirm Order';
                } else if (currentStep === 7) { // Select payment step
                    if (selectedPaymentMethod === 'delivery') {
                        nextBtn.textContent = 'Confirm Order';
                    } else {
                        nextBtn.textContent = 'Proceed to Payment';
                    }
                } else if (currentStep === 2) { // Product selection step
                    nextBtn.textContent = selectedProducts.length > 0 ? 'Continue' : 'Skip for now';
                } else {
                    nextBtn.textContent = 'Continue';
                }
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                // Validate current step
                if (!validateCurrentStep()) {
                    return;
                }

                currentStep++;
                
                // Special handling for Pay on Delivery - skip payment details and processing
                if (currentStep === 8 && selectedPaymentMethod === 'delivery') {
                    // Skip payment details (step 8) and payment processing (step 9) 
                    // Go directly to payment success (step 10) for delivery orders
                    currentStep = 10;
                }
                
                const steps = ['terms', 'productSelection', 'recipient', 'datetime', 'quantity', 'review', 'selectPayment', 'paymentDetails', 'paymentProcessing', 'paymentSuccess', 'scheduleSent', 'ratingSuccess'];
                if (currentStep <= steps.length && currentStep <= totalSteps) {
                    goToStep(steps[currentStep - 1]);
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                const steps = ['terms', 'productSelection', 'recipient', 'datetime', 'quantity', 'review', 'selectPayment', 'paymentDetails', 'paymentProcessing', 'paymentSuccess', 'scheduleSent', 'ratingSuccess'];
                goToStep(steps[currentStep - 1]);
            }
        }

        function validateCurrentStep() {
            hideError();

            switch (currentStep) {
                case 1: // Terms - no validation needed
                    break;
                case 2: // Product Selection
                    // Allow user to continue even if no products selected
                    break;
                case 3: // Recipient
                    const address = document.getElementById('recipientAddress').value;

                    if (recipientType === 'business') {
                        const businessType = document.getElementById('businessType').value;
                        const businessName = document.getElementById('businessName').value;
                        if (!businessType) {
                            showError('Please select a business type');
                            return false;
                        }
                        if (!businessName) {
                            showError('Please enter a business name');
                            return false;
                        }

                        orderData.recipient.businessName = businessName;
                        orderData.recipient.businessType = businessType;
                    }

                    if (recipientType !== 'you') {
                        const name = document.getElementById('recipientName').value;
                        const phone = document.getElementById('recipientPhone').value;
                        const email = document.getElementById('recipientEmail').value;

                        if (!name || !phone || !email) {
                            showError('Please fill in all recipient information');
                            return false;
                        }

                        if (!/^0\d{9}$/.test(phone)) {
                            showError('Please enter a valid Ghanaian phone number (e.g., 0201234567)');
                            return false;
                        }

                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                            showError('Please enter a valid email address');
                            return false;
                        }

                        orderData.recipient.name = name;
                        orderData.recipient.phone = phone;
                        orderData.recipient.email = email;
                    } else {
                        // For 'you' recipient type, get data from display elements
                        const youName = document.getElementById('youNameDisplay').textContent?.trim() || '';
                        const youPhone = document.getElementById('youPhoneDisplay').textContent?.trim() || '';
                        const youEmail = document.getElementById('youEmailDisplay').textContent?.trim() || '';
                        
                        console.log('ðŸ‘¤ "You" recipient data from UI:', {youName, youPhone, youEmail});
                        
                        if (!youName || youName === 'Loading...') {
                            showError('Please wait for your profile to load');
                            return false;
                        }
                        
                        if (!youPhone || youPhone === 'Loading...') {
                            showError('Your phone number is missing. Please update your profile.');
                            return false;
                        }
                        
                        orderData.recipient.name = youName;
                        orderData.recipient.phone = youPhone;
                        orderData.recipient.email = youEmail;
                    }

                    if (!address) {
                        showError('Please enter a delivery address');
                        return false;
                    }

                    orderData.recipient.address = address;
                    orderData.recipient.type = recipientType;

                    const saveToggle = document.getElementById('saveRecipientToggle').checked;
                    if (saveToggle && recipientType !== 'you') {
                        saveRecipient();
                    }
                    break;
                case 4: // Date and Time
                    selectedDate = document.getElementById('deliveryDate').value;
                    selectedTime = document.getElementById('deliveryTime').value;

                    if (!selectedDate || !selectedTime) {
                        showError('Please select both date and time for delivery');
                        return false;
                    }

                    const selectedDateTime = new Date(`${selectedDate} ${selectedTime}`);
                    const now = new Date();

                    if (selectedDateTime <= now) {
                        showError('Please select a future date and time for delivery');
                        return false;
                    }

                    // Validate against working days
                    const branchData = window.currentCompany;
                    const workingDays = branchData?.working_days || branchData?.workingHours || [];
                    
                    if (workingDays.length > 0) {
                        const dayOfWeek = selectedDateTime.toLocaleDateString('en-US', { weekday: 'long' });
                        const workingDay = workingDays.find(day => day.day === dayOfWeek);
                        
                        if (!workingDay) {
                            showError(`${dayOfWeek} is not a working day. Please select a different day.`);
                            return false;
                        }
                        
                        console.log(`âœ… ${dayOfWeek} is a working day: ${workingDay.time}`);
                    }

                    orderData.deliveryDate = selectedDate;
                    orderData.deliveryTime = selectedTime;
                    break;
                case 5: // Quantity
                    if (selectedProducts.length === 0) {
                        showError('Please select at least one product');
                        return false;
                    }

                    const invalidProduct = selectedProducts.find(p => p.quantity < 1);
                    if (invalidProduct) {
                        showError('Product quantity must be at least 1');
                        return false;
                    }

                    orderData.products = selectedProducts;
                    orderData.deliveryInstructions = document.getElementById('deliveryInstructions').value;
                    break;
                case 7: // Select Payment
                    if (!selectedPaymentMethod) {
                        showError('Please select a payment method');
                        return false;
                    }
                    break;
                case 8: // Payment Details
                    if (!validatePaymentDetails()) {
                        return false;
                    }
                    break;
            }
            return true;
        }

        function validatePaymentDetails() {
            const mobileNetwork = document.getElementById('mobileNetwork').value;
            const mobileNumber = document.getElementById('mobileNumber').value;

            if (!mobileNetwork) {
                showError('Please select a mobile network');
                return false;
            }

            if (!mobileNumber) {
                showError('Please enter your mobile number');
                return false;
            }

            if (!/^0\d{9}$/.test(mobileNumber)) {
                showError('Please enter a valid Ghanaian phone number (e.g., 0201234567)');
                return false;
            }

            orderData.payment = {
                method: 'mobile',
                network: mobileNetwork,
                phoneNumber: mobileNumber
            };

            return true;
        }

        function initializeDateInput() {
            const dateInput = document.getElementById('deliveryDate');
            const now = new Date();
            const minDate = new Date(now.getTime() + 2 * 60 * 60 * 1000); // 2 hours from now

            const minDateString = minDate.toISOString().split('T')[0];
            dateInput.min = minDateString;

            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowString = tomorrow.toISOString().split('T')[0];
            dateInput.value = tomorrowString;
            selectedDate = tomorrowString;
        }

        function generateTimeSlots() {
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');
            timeSlotsGrid.innerHTML = '';

            const timeSlots = [
                { time: '08:00', label: '8:00 AM', available: true },
                { time: '09:00', label: '9:00 AM', available: true },
                { time: '10:00', label: '10:00 AM', available: true },
                { time: '11:00', label: '11:00 AM', available: true },
                { time: '12:00', label: '12:00 PM', available: true },
                { time: '13:00', label: '1:00 PM', available: true },
                { time: '14:00', label: '2:00 PM', available: true },
                { time: '15:00', label: '3:00 PM', available: true },
                { time: '16:00', label: '4:00 PM', available: true },
                { time: '17:00', label: '5:00 PM', available: true },
                { time: '18:00', label: '6:00 PM', available: true }
            ];

            timeSlots.forEach(slot => {
                const timeSlotBtn = document.createElement('button');
                timeSlotBtn.type = 'button';
                timeSlotBtn.className = `time-slot-btn ${slot.available ? '' : 'disabled'}`;
                timeSlotBtn.textContent = slot.label;
                timeSlotBtn.disabled = !slot.available;

                if (slot.available) {
                    timeSlotBtn.onclick = () => selectTimeSlot(slot.time, slot.label, timeSlotBtn);
                }

                timeSlotsGrid.appendChild(timeSlotBtn);
            });
        }

        function selectTimeSlot(time, label, button) {
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            button.classList.add('selected');
            document.getElementById('deliveryTime').value = time;
            selectedTime = time;
        }

        function selectTermsOption(type) {
            document.querySelectorAll('.terms-radio-item').forEach(item => {
                item.classList.remove('selected');
            });

            document.getElementById(`terms${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('selected');
            orderData.orderType = type;
        }

        function updateProductSelectionStep() {
            console.log('ðŸ›’ Updating product selection step...');
            const productsGrid = document.getElementById('productsSelectionGrid');
            
            if (!productsGrid) {
                console.error('âŒ productsSelectionGrid element not found!');
                return;
            }
            
            console.log(`ðŸ›’ Clearing grid and rendering ${companyProducts.length} products`);
            productsGrid.innerHTML = '';

            if (companyProducts.length === 0) {
                console.log('ðŸ›’ No products available to display');
                const noProductsMessage = document.createElement('div');
                noProductsMessage.className = 'no-products-selected';
                noProductsMessage.textContent = 'No products available for this branch.';
                productsGrid.appendChild(noProductsMessage);
                return;
            }

            companyProducts.forEach((product, index) => {
                console.log(`ðŸ›’ Rendering product ${index + 1}: ${product.name}`);
                const isSelected = selectedProducts.find(p => p.id === product.id);
                const productCard = document.createElement('div');
                productCard.className = `product-select-card ${isSelected ? 'selected' : ''}`;
                productCard.onclick = () => toggleProductSelection(product);

                const quantity = isSelected ? (isSelected.quantity !== undefined ? isSelected.quantity : 1) : 0;
                const productId = product.id || product.$id || index; // Fallback to index if no ID
                const imageUrl = product.image || product.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0zMCA0MEg3MFY2MEgzMFY0MFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPGNpcmNsZSBjeD0iNTAiIGN5PSIzMCIgcj0iOCIgZmlsbD0iI0NDQ0NDQzIi8+CjxwYXRoIGQ9Ik00NSA1MEg1NUw1MCA2MEw0NSA1MFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+'; // SVG placeholder
                const quantityControls = `
                        <div class="product-select-quantity" style="display: ${isSelected ? 'flex' : 'none'};">
                            <button class="quantity-btn-product" data-product-id="${productId}" data-action="decrease">-</button>
                            <span class="quantity-display-product">${quantity}</span>
                            <button class="quantity-btn-product" data-product-id="${productId}" data-action="increase">+</button>
                        </div>
                    `;
                productCard.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}" class="product-select-image" 
                         onerror="${createImageErrorHandler(product.name)}"
                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #1D1D1D;">
                    <div class="product-select-name">${product.name}</div>
                    <div class="product-select-price">GHS ${product.price.toFixed(2)}</div>
                    ${quantityControls}
                `;

                // Add event listeners for quantity buttons
                const quantityButtons = productCard.querySelectorAll('.quantity-btn-product');
                quantityButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = button.getAttribute('data-product-id');
                        const action = button.getAttribute('data-action');
                        const amount = action === 'increase' ? 1 : -1;
                        changeProductQuantityInSelection(productId, amount);
                    });
                });

                productsGrid.appendChild(productCard);
            });
            
            console.log(`ðŸ›’ Successfully rendered ${companyProducts.length} products in selection grid`);
        }

        function toggleProductSelection(product) {
            const existingIndex = selectedProducts.findIndex(p => p.id === product.id);
            
            if (existingIndex > -1) {
                // Remove product from selection completely
                selectedProducts.splice(existingIndex, 1);
            } else {
                // Add product with default quantity of 1
                selectedProducts.push({
                    ...product,
                    quantity: 1
                });
            }
            
            updateProductSelectionStep();
        }

        function changeProductQuantityInSelection(productId, amount) {
            console.log('Changing quantity for product:', productId, 'amount:', amount, 'type:', typeof productId);
            const productIndex = selectedProducts.findIndex(p => p.id === productId || p.$id === productId);
            
            if (productIndex > -1) {
                const product = selectedProducts[productIndex];
                const newQuantity = product.quantity + amount;
                console.log('Current quantity:', product.quantity, 'New quantity:', newQuantity);
                
                if (newQuantity <= 0) {
                    // Remove product from selection when quantity reaches 0
                    selectedProducts.splice(productIndex, 1);
                    console.log('Product removed from selection');
                } else if (newQuantity > 100) {
                    showError(`Maximum quantity per product is 100 items`);
                    return;
                } else {
                    // Update quantity
                    selectedProducts[productIndex].quantity = newQuantity;
                    console.log('Quantity updated to:', newQuantity);
                }
                
                // Re-render the product selection step to update UI
                updateProductSelectionStep();
            } else {
                console.log('Product not found in selected products:', productId);
                console.log('Available products:', selectedProducts.map(p => ({ id: p.id, $id: p.$id })));
            }
        }

        function goToProductSelection() {
            currentStep = 2;
            goToStep('productSelection');
        }

        function selectRecipientType(type) {
            recipientType = type;

            document.querySelectorAll('.recipient-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`recipient${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');

            const nameContainer = document.getElementById('recipientNameContainer');
            const phoneContainer = document.getElementById('recipientPhoneContainer');
            const emailContainer = document.getElementById('recipientEmailContainer');
            const businessTypeContainer = document.getElementById('businessTypeContainer');
            const businessNameContainer = document.getElementById('businessNameContainer');
            const youInfo = document.getElementById('youRecipientInfo');
            const savedContainer = document.getElementById('savedRecipientsContainer');

            if (type === 'you') {
                nameContainer.classList.add('hidden');
                phoneContainer.classList.add('hidden');
                emailContainer.classList.add('hidden');
                businessTypeContainer.classList.add('hidden');
                businessNameContainer.classList.add('hidden');
                youInfo.classList.remove('hidden');
                savedContainer.classList.add('hidden');
            } else {
                nameContainer.classList.remove('hidden');
                phoneContainer.classList.remove('hidden');
                emailContainer.classList.remove('hidden');
                youInfo.classList.add('hidden');

                if (type === 'business') {
                    businessTypeContainer.classList.remove('hidden');
                    businessNameContainer.classList.remove('hidden');
                } else {
                    businessTypeContainer.classList.add('hidden');
                    businessNameContainer.classList.add('hidden');
                }

                if (savedRecipients.length > 0) {
                    savedContainer.classList.remove('hidden');
                }
            }
        }

        function loadUserProfileData() {
            // Get current user data from Appwrite or customer_tb
            let userProfile = {};
            
            // Try to get data from cache manager first
            if (window.cacheManager) {
                userProfile = window.cacheManager.getCache('user_profile') || {};
            } else {
                // Fallback to regular localStorage
                userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
            }
            
            // Try to get current user from Appwrite auth
            if (window.account && window.account.get) {
                window.account.get().then(async user => {
                    console.log('ðŸ‘¤ Current user from Appwrite:', user);
                    
                    // Try to fetch customer data from database
                    let customerData = null;
                    try {
                        if (window.databases && window.appwriteConfig) {
                            const response = await window.databases.listDocuments(
                                window.appwriteConfig.DATABASE_ID,
                                window.appwriteConfig.CUSTOMER_TABLE,
                                [window.Query.equal('uid', user.$id)]
                            );
                            
                            if (response.documents.length > 0) {
                                customerData = response.documents[0];
                                console.log('ðŸ‘¤ Found customer data from DB:', customerData);
                            }
                        }
                    } catch (err) {
                        console.log('âš ï¸ Could not fetch customer data from DB:', err);
                    }
                    
                    // Update profile with Appwrite data and customer data if available
                    if (user && user.email) {
                        profileData = {
                            full_name: customerData?.full_name || user.name || user.fullName || user.full_name || 'User',
                            email: user.email,
                            phone1: customerData?.phone1 || customerData?.phone_number || customerData?.phone || customerData?.mobile || customerData?.contact || userProfile.phone_number || userProfile.phone || '',
                            address: customerData?.address || userProfile.address || '',
                            name: customerData?.full_name || user.name || user.fullName || user.full_name || 'User'
                        };
                        
                        console.log('ðŸ‘¤ Profile data being set:', profileData);
                        console.log('ðŸ“ž Phone number found:', profileData.phone1 || 'No phone number');
                        
                        // Cache updated profile
                        if (window.cacheManager) {
                            window.cacheManager.setCache('user_profile', profileData);
                        } else {
                            localStorage.setItem('userProfile', JSON.stringify(profileData));
                        }
                        
                        updateUserProfileDisplay(profileData);
                    }
                }).catch(err => {
                    console.log('âš ï¸ Could not get Appwrite user:', err);
                    // Use cached profile data
                    if (userProfile && userProfile.full_name) {
                        updateUserProfileDisplay(userProfile);
                    }
                });
            } else {
                // Use cached profile data
                if (userProfile && userProfile.full_name) {
                    updateUserProfileDisplay(userProfile);
                }
            }
        }

        function updateUserProfileDisplay(profile) {
            console.log('ðŸ‘¤ Updating user profile display with:', profile);
            
            const phoneElement = document.getElementById('youPhoneDisplay');
            const nameElement = document.getElementById('youNameDisplay');
            const emailElement = document.getElementById('youEmailDisplay');
            const addressElement = document.getElementById('youAddressDisplay');
            
            if (nameElement) {
                nameElement.textContent = profile.name || profile.full_name || 'Your Name';
            }
            
            if (phoneElement) {
                const phoneNumber = profile.phone1 || profile.phone_number || profile.phone || profile.mobile || profile.contact || 'Your Phone';
                phoneElement.textContent = phoneNumber;
                console.log('ðŸ“ž Phone number set to:', phoneNumber);
            }
            
            if (emailElement) {
                emailElement.textContent = profile.email || 'Your Email';
            }
            
            if (addressElement) {
                addressElement.textContent = profile.address || 'Your Address';
            }

            const addressField = document.getElementById('recipientAddress');
            if (addressField && profile.address) {
                addressField.value = profile.address;
            }
        }

        // Function to force refresh user profile data
        async function refreshUserProfileData() {
            console.log('ðŸ”„ Force refreshing user profile data...');
            await loadUserProfileData();
        }

        async function fetchCustomerData(uid) {
            try {
                if (!window.databases || !window.appwriteConfig) {
                    console.error('âŒ Appwrite not available');
                    return null;
                }

                const response = await window.databases.listDocuments(
                    window.appwriteConfig.DATABASE_ID,
                    window.appwriteConfig.CUSTOMER_TABLE,
                    [window.Query.equal('uid', uid)]
                );

                if (response.documents.length > 0) {
                    console.log('ðŸ‘¤ Found customer data:', response.documents[0]);
                    return response.documents[0];
                }
                return null;
            } catch (error) {
                console.error('âŒ Error fetching customer data:', error);
                return null;
            }
        }

        function saveUserAddress() {
            const address = document.getElementById('recipientAddress').value;
            if (address && recipientType === 'you') {
                // Get existing user profile
                let userProfile = {};
                
                if (window.cacheManager) {
                    userProfile = window.cacheManager.getCache('user_profile') || {};
                } else {
                    userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
                }
                
                userProfile.address = address;
                
                // Save using cache manager if available
                if (window.cacheManager) {
                    window.cacheManager.setCache('user_profile', userProfile);
                    console.log('ðŸ’¾ User profile cached with updated address');
                } else {
                    // Fallback to regular localStorage
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
                
                document.getElementById('youAddressDisplay').textContent = address;
            }
        }

        function loadSavedRecipients() {
            // Try to load saved recipients from localStorage first
            const savedRecipientsData = localStorage.getItem('savedRecipients');
            if (savedRecipientsData) {
                savedRecipients = JSON.parse(savedRecipientsData);
            } else {
                // Initialize with empty array - no more hardcoded sample data
                savedRecipients = [];
                localStorage.setItem('savedRecipients', JSON.stringify(savedRecipients));
            }

            // Only load actual saved recipients, not all customers
            updateSavedRecipientsList();
        }

        function updateSavedRecipientsList() {
            const savedList = document.getElementById('savedRecipientsList');
            savedList.innerHTML = '';

            if (savedRecipients.length === 0) {
                savedList.innerHTML = '<p class="text-gray-400 text-center py-4">No saved recipients yet</p>';
                return;
            }

            savedRecipients.forEach(recipient => {
                const recipientItem = document.createElement('div');
                recipientItem.className = 'saved-recipient-item';
                recipientItem.style.position = 'relative';

                recipientItem.innerHTML = `
                    <button onclick="event.stopPropagation(); deleteSavedRecipient(${recipient.id})" class="delete-recipient-btn" title="Delete recipient">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2 2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            <path d="M10 11v6"/>
                            <path d="M14 11v6"/>
                        </svg>
                    </button>
                    <div onclick="selectSavedRecipient(${recipient.id})" class="recipient-content">
                        <div class="saved-recipient-name">${recipient.name}</div>
                        <div class="saved-recipient-info">${recipient.phone} â€¢ ${recipient.address}</div>
                    </div>
                `;

                savedList.appendChild(recipientItem);
            });
        }

        function selectSavedRecipient(recipientId) {
            const recipient = savedRecipients.find(r => r.id === recipientId);
            if (!recipient) return;

            selectedSavedRecipient = recipient;
            event.currentTarget.closest('.saved-recipient-item').classList.add('selected');

            document.getElementById('recipientName').value = recipient.name;
            document.getElementById('recipientPhone').value = recipient.phone;
            document.getElementById('recipientEmail').value = recipient.email;
            document.getElementById('recipientAddress').value = recipient.address;

            if (recipient.type === 'business') {
                document.getElementById('businessType').value = recipient.businessType;
                document.getElementById('businessName').value = recipient.businessName;
            }

            selectRecipientType(recipient.type);
        }

        function deleteSavedRecipient(recipientId) {
            if (confirm('Are you sure you want to delete this saved recipient?')) {
                savedRecipients = savedRecipients.filter(r => r.id !== recipientId);
                localStorage.setItem('savedRecipients', JSON.stringify(savedRecipients));
                updateSavedRecipientsList();
                showSuccess('Recipient deleted successfully');

                if (selectedSavedRecipient && selectedSavedRecipient.id === recipientId) {
                    selectedSavedRecipient = null;
                }
            }
            event.stopPropagation();
        }

        function saveRecipient() {
            const name = document.getElementById('recipientName').value;
            const phone = document.getElementById('recipientPhone').value;
            const email = document.getElementById('recipientEmail').value;
            const address = document.getElementById('recipientAddress').value;

            const newRecipient = {
                id: Date.now(),
                name,
                phone,
                email,
                address,
                type: recipientType
            };

            if (recipientType === 'business') {
                newRecipient.businessName = document.getElementById('businessName').value;
                newRecipient.businessType = document.getElementById('businessType').value;
            }

            const existingIndex = savedRecipients.findIndex(r =>
                r.name === name && r.phone === phone && r.email === email
            );

            if (existingIndex === -1) {
                savedRecipients.push(newRecipient);
                localStorage.setItem('savedRecipients', JSON.stringify(savedRecipients));
                updateSavedRecipientsList();
                showSuccess('Recipient saved successfully');
            }
        }

        function updateDateTimeStep() {
            generateTimeSlots();

            if (orderData.deliveryDate) {
                document.getElementById('deliveryDate').value = orderData.deliveryDate;
            }

            if (orderData.deliveryTime) {
                document.getElementById('deliveryTime').value = orderData.deliveryTime;

                const timeSlots = document.querySelectorAll('.time-slot-btn');
                timeSlots.forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent.includes(orderData.deliveryTime.replace(':00', ''))) {
                        btn.classList.add('selected');
                    }
                });
            }
        }

        function updateRecipientStep() {
            if (orderData.recipient) {
                if (recipientType !== 'you') {
                    document.getElementById('recipientName').value = orderData.recipient.name || '';
                    document.getElementById('businessName').value = orderData.recipient.businessName || '';
                    document.getElementById('recipientPhone').value = orderData.recipient.phone || '';
                    document.getElementById('recipientEmail').value = orderData.recipient.email || '';
                    document.getElementById('recipientAddress').value = orderData.recipient.address || '';

                    if (orderData.recipient.type === 'business' && orderData.recipient.businessType) {
                        document.getElementById('businessType').value = orderData.recipient.businessType;
                    }
                } else {
                    document.getElementById('recipientAddress').value = orderData.recipient.address || '';
                }
            }
        }

        // âš¡ Helper function to get optimized image URL from database
        function getOptimizedProductImageUrl(product) {
            // Priority: 1. product.image, 2. product.imageUrl, 3. product.product_image, 4. placeholder
            let imageUrl = product.image || product.imageUrl || product.product_image || null;
            
            if (!imageUrl) {
                // Return placeholder SVG
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0zMCA0MEg3MFY2MCBIMzBWNDBaIiBmaWxsPSIjQ0NDQ0NDIi8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzAiIHI9IjgiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTQ1IDUwSDU1TDUwIDYwTDQ1IDUwWiIgZmlsbD0iI0NDQ0NDQzIi8+Cjwvc3ZnPgo';
            }
            
            return imageUrl;
        }

        // âš¡ Helper function to create error handler for product images
        function createImageErrorHandler(productName) {
            return `this.onerror=null; 
                const basename = this.src.split('/files/')[1]?.split('/view')[0] || ''; 
                const altUrl = 'https://nyc.cloud.appwrite.io/v1/storage/buckets/695fec72003b8ba4fb22/files/' + basename + '/view?project=695f826500067c381616'; 
                if(basename && this.src.includes('/68b1c57b001542be7fbe/')) { 
                    this.src = altUrl; 
                    console.log('ðŸ”„ Trying alternate bucket for: ' + basename); 
                } else if(basename) { 
                    this.src = altUrl; 
                } else { 
                    this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0zMCA0MEg3MFY2MCBIMzBWNDBaIiBmaWxsPSIjQ0NDQ0NDIi8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzAiIHI9IjgiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTQ1IDUwSDU1TDUwIDYwTDQ1IDUwWiIgZmlsbD0iI0NDQ0NDQzIi8+Cjwvc3ZnPgo'; 
                    console.error('âŒ No file ID found for image'); 
                }`;
        }

        function updateQuantityStep() {
            const selectedContainer = document.getElementById('selectedProductsContainer');
            selectedContainer.innerHTML = '';

            // Filter out products with quantity 0
            const productsWithQuantity = selectedProducts.filter(product => product.quantity > 0);

            if (productsWithQuantity.length > 0) {
                productsWithQuantity.forEach((product, index) => {
                    const selectedItem = document.createElement('div');
                    selectedItem.className = 'selected-product-item';
                    // Find the actual index in the full selectedProducts array
                    const actualIndex = selectedProducts.findIndex(p => p.id === product.id);
                    
                    // Get optimized image URL
                    const imageUrl = getOptimizedProductImageUrl(product);
                    
                    selectedItem.innerHTML = `
                        <img src="${imageUrl}" alt="${product.name}" 
                             class="selected-product-image"
                             onerror="${createImageErrorHandler(product.name)}"
                             style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; background: #1D1D1D;">
                        <div class="selected-product-details">
                            <div class="selected-product-name">${product.name}</div>
                            <div class="selected-product-price">GHS ${product.price.toFixed(2)} each</div>
                        </div>
                        <div class="selected-product-quantity">
                            <button onclick="changeProductQuantity(${actualIndex}, -1)" class="quantity-btn-small">-</button>
                            <span class="quantity-display-small">${product.quantity}</span>
                            <button onclick="changeProductQuantity(${actualIndex}, 1)" class="quantity-btn-small">+</button>
                        </div>
                    `;
                    selectedContainer.appendChild(selectedItem);
                });
            } else {
                const noProducts = document.createElement('div');
                noProducts.className = 'no-products-selected';
                noProducts.textContent = 'No products selected. Please go back and select products.';
                selectedContainer.appendChild(noProducts);
            }

            updateQuantityCalculations();
        }

        function changeProductQuantity(productIndex, amount) {
            if (selectedProducts[productIndex]) {
                const product = selectedProducts[productIndex];
                const newQuantity = product.quantity + amount;

                if (newQuantity <= 0) {
                    // Remove product from selection when quantity reaches 0
                    selectedProducts.splice(productIndex, 1);
                } else if (newQuantity > 100) {
                    showError(`Maximum quantity per product is 100 items`);
                    return;
                } else {
                    // Update quantity
                    selectedProducts[productIndex].quantity = newQuantity;
                }

                updateQuantityStep();
            }
        }

        function updateQuantityCalculations() {
            calculateTotals();
            
            document.getElementById('quantitySubtotal').textContent = `GHS ${orderData.subtotal.toFixed(2)}`;
            document.getElementById('serviceFeeDisplay').textContent = `GHS ${orderData.serviceFee.toFixed(2)}`;
            document.getElementById('quantityTotal').textContent = `GHS ${orderData.total.toFixed(2)}`;
        }

        function calculateTotals() {
            // Filter out products with quantity 0 for calculations
            const productsWithQuantity = selectedProducts.filter(product => product.quantity > 0);
            
            console.log('ðŸ” calculateTotals - productsWithQuantity:', productsWithQuantity);
            console.log('ðŸ” calculateTotals - SERVICE_FEE_PER_ITEM:', SERVICE_FEE_PER_ITEM);
            
            orderData.subtotal = productsWithQuantity.reduce((sum, product) => 
                sum + (product.price * product.quantity), 0);
            const totalItems = productsWithQuantity.reduce((sum, product) => sum + product.quantity, 0);
            orderData.serviceFee = totalItems * SERVICE_FEE_PER_ITEM;
            orderData.total = orderData.subtotal + orderData.serviceFee;
            
            console.log('ðŸ” calculateTotals - subtotal:', orderData.subtotal);
            console.log('ðŸ” calculateTotals - totalItems:', totalItems);
            console.log('ðŸ” calculateTotals - serviceFee:', orderData.serviceFee);
            console.log('ðŸ” calculateTotals - total:', orderData.total);
        }

        function updateOrderReview() {
            // Filter out products with quantity 0
            const productsWithQuantity = selectedProducts.filter(product => product.quantity > 0);
            
            if (productsWithQuantity.length === 0) return;

            calculateTotals();

            const productsList = document.getElementById('reviewProductsList');
            productsList.innerHTML = '';

            productsWithQuantity.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'review-product-item';
                
                // Get optimized image URL from database
                const imageUrl = getOptimizedProductImageUrl(product);
                
                productItem.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}" 
                         class="review-product-image"
                         onerror="${createImageErrorHandler(product.name)}"
                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #1D1D1D;">
                    <div class="review-product-details">
                        <div class="review-product-name">${product.quantity}x ${product.name}</div>
                        <div class="review-product-price">GHS ${(product.price * product.quantity).toFixed(2)}</div>
                    </div>
                `;
                productsList.appendChild(productItem);
            });

            document.getElementById('reviewDeliveryDate').textContent = formatDate(selectedDate);
            document.getElementById('reviewDeliveryTime').textContent = formatTime(selectedTime);
            document.getElementById('reviewDeliveryAddress').textContent = orderData.recipient.address || '';

            const instructions = document.getElementById('deliveryInstructions').value || 'None provided';
            document.getElementById('reviewDeliveryInstructions').textContent = instructions;

            document.getElementById('reviewSubtotal').textContent = `GHS ${orderData.subtotal.toFixed(2)}`;
            document.getElementById('reviewServiceFee').textContent = `GHS ${orderData.serviceFee.toFixed(2)}`;
            document.getElementById('reviewTotal').textContent = `GHS ${orderData.total.toFixed(2)}`;

            orderData.products = selectedProducts;
            orderData.deliveryInstructions = instructions;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;

            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });

            event.currentTarget.classList.add('selected');

            // If Pay on Delivery is selected, show confirmation dialog
            if (method === 'delivery') {
                showPayOnDeliveryConfirmation();
            }
        }

        function showPayOnDeliveryConfirmation() {
            const modal = document.getElementById('payOnDeliveryModal');
            modal.classList.remove('hidden');
            
            // Add active class after a small delay for animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function confirmPayOnDelivery() {
            const modal = document.getElementById('payOnDeliveryModal');
            modal.classList.remove('active');
            
            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
                // Show service fee payment modal
                showServiceFeePaymentModal();
            }, 300);
        }

        function cancelPayOnDelivery() {
            const modal = document.getElementById('payOnDeliveryModal');
            modal.classList.remove('active');
            
            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            // User cancelled - reset selection
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Service Fee Payment Functions
        function showServiceFeePaymentModal() {
            const serviceFee = orderData.serviceFee;
            const remainingBalance = orderData.subtotal; // Remaining balance is subtotal (excluding service fee)

            // Update modal displays
            document.getElementById('serviceFeeAmountDisplay').textContent = `GHS ${serviceFee.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `GHS ${remainingBalance.toFixed(2)}`;

            const modal = document.getElementById('serviceFeePaymentModal');
            modal.classList.remove('hidden');
            
            // Add active class after a small delay for animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function cancelServiceFeePayment() {
            const modal = document.getElementById('serviceFeePaymentModal');
            modal.classList.remove('active');
            
            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            // User cancelled - reset selection
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function payServiceFeeWithPaystack() {
            const serviceFee = orderData.serviceFee;
            
            if (serviceFee <= 0) {
                showError('Service fee amount is invalid');
                return;
            }

            // Hide service fee modal and show processing modal
            const serviceFeeModal = document.getElementById('serviceFeePaymentModal');
            serviceFeeModal.classList.remove('active');
            setTimeout(() => {
                serviceFeeModal.classList.add('hidden');
            }, 300);

            // Show processing modal
            const processingModal = document.getElementById('paymentProcessingModal');
            processingModal.classList.remove('hidden');
            setTimeout(() => {
                processingModal.classList.add('active');
            }, 10);

            // Initialize Paystack payment
            const handler = PaystackPop.setup({
                key: 'pk_live_00d41944ffac0707f49b240150e55474e2a5c06e', // Live public key
                email: orderData.recipient.email || orderData.customer.email || 'customer@example.com',
                amount: serviceFee * 100, // Convert to kobo/cents
                currency: 'GHS',
                ref: 'SF_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                callback: function(response) {
                    handleServiceFeePaymentSuccess(response);
                },
                onClose: function() {
                    handleServiceFeePaymentClose();
                }
            });

            handler.openIframe();
        }

        function handleServiceFeePaymentSuccess(response) {
            console.log('Service fee payment successful:', response);
            
            // Hide processing modal
            const processingModal = document.getElementById('paymentProcessingModal');
            processingModal.classList.remove('active');
            setTimeout(() => {
                processingModal.classList.add('hidden');
            }, 300);

            // Store payment details
            orderData.serviceFeePayment = {
                paid: true,
                amount: orderData.serviceFee,
                transactionRef: response.reference,
                paidAt: new Date().toISOString()
            };

            // Add payment info to orderData
            orderData.payment = {
                network: 'Paystack',
                transactionRef: response.reference,
                status: 'completed'
            };

            console.log('ðŸ’³ Payment successful, now saving order to database...');

            // Show success message
            showSuccess('Service fee paid successfully! Saving your order...');

            // Save order to database AFTER payment confirmation
            setTimeout(() => {
                processPayment();
            }, 1500);
        }

        function handleServiceFeePaymentClose() {
            console.log('Service fee payment window closed');
            
            // Hide processing modal
            const processingModal = document.getElementById('paymentProcessingModal');
            processingModal.classList.remove('active');
            setTimeout(() => {
                processingModal.classList.add('hidden');
            }, 300);

            // Show error message
            showError('Service fee payment was cancelled. Please try again to continue with your order.');

            // Show service fee modal again for retry
            setTimeout(() => {
                showServiceFeePaymentModal();
            }, 2000);
        }

        async function processPayment() {
            console.log('ðŸš€ ===== PAYMENT PROCESSING STARTED =====');
            console.log('ðŸš€ Current Step:', currentStep);
            console.log('ðŸš€ Selected Products:', selectedProducts);
            console.log('ðŸš€ Order Data:', orderData);
            
            if (!validateCurrentStep()) {
                console.warn('âŒ Current step validation failed, exiting processPayment');
                return;
            }

            // Show loading state
            const payBtn = document.getElementById('payBtn');
            const payBtnText = document.getElementById('payBtnText');
            const payBtnLoading = document.getElementById('payBtnLoading');
            
            if (payBtn) {
                payBtn.disabled = true;
                payBtnText?.classList.add('hidden');
                payBtnLoading?.classList.remove('hidden');
                console.log('âœ… Payment button loading state activated');
            }

            try {
                console.log('ðŸ”§ Initializing OrderManager...');
                // Initialize OrderManager
                const orderManager = new OrderManager();
                
                // Get current user/customer data
                let customerData = null;
                try {
                    customerData = await window.account.get();
                    console.log('âœ… Customer data retrieved from Appwrite:', customerData.$id);
                } catch (err) {
                    console.error('âŒ Error getting customer data:', err);
                    // Try to use cached user data if available
                    const cachedUser = localStorage.getItem('currentUser');
                    if (cachedUser) {
                        try {
                            customerData = JSON.parse(cachedUser);
                            console.log('âœ… Using cached customer data:', customerData.$id);
                        } catch (parseErr) {
                            console.error('âŒ Error parsing cached data:', parseErr);
                            showError('Unable to get customer information. Please refresh the page and try again.');
                            return;
                        }
                    } else {
                        showError('Unable to get customer information. Please check your connection and try again.');
                        return;
                    }
                }

                // Get branch data
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');
                const branchData = window.currentCompany;
                
                if (!branchData || !branchData.branch_id) {
                    showError('Branch information not available. Please try again.');
                    return;
                }

                console.log('âœ… Branch data retrieved:', branchData.branch_id);

                // Validate selected products before creating order
                if (!selectedProducts || selectedProducts.length === 0) {
                    showError('No products selected. Please add products to your order.');
                    payBtn.disabled = false;
                    payBtnText?.classList.remove('hidden');
                    payBtnLoading?.classList.add('hidden');
                    return;
                }

                console.log('âœ… Products validated:', selectedProducts.length, 'items');

                // Generate transaction ID before creating order
                const transactionId = 'TXN' + Date.now().toString().slice(-8);
                console.log('ðŸ” Generated transaction ID:', transactionId);

                // Prepare order data
                const orderPayload = {
                    buyerId: customerData.$id,
                    customer_id: customerData.$id,
                    branchId: branchData.branch_id,
                    deliveryDate: orderData.deliveryDate,
                    deliveryTime: orderData.deliveryTime,
                    deliveryAddress: orderData.recipient.address,
                    orderComment: orderData.deliveryInstructions || '',
                    paymentMethod: orderData.payment?.network || 'Pay on Delivery',
                    transactionId: transactionId, // Add transaction ID
                    deliveryName: selectedProducts.map(p => p.name).join(', '),
                    deliveryOrgType: orderData.recipient.type || 'individual',
                    total: Number(orderData.total || 0), // Add total amount
                    purchase_type: orderData.recipient.type === 'you' ? 'self' : 
                                   orderData.recipient.type === 'business' ? 'business' : 'someone_else',
                    // Recipient details (if different from buyer)
                    recipient_full_name: orderData.recipient.type !== 'you' ? orderData.recipient.name : '',
                    recipient_phone_number: orderData.recipient.type !== 'you' ? orderData.recipient.phone : '',
                    recipient_email: orderData.recipient.type !== 'you' ? orderData.recipient.email : '',
                    // Business details (if business type)
                    business_name: orderData.recipient.type === 'business' ? orderData.recipient.businessName : ''
                };

                console.log('ðŸ“ Order payload prepared:', orderPayload);
                console.log('ðŸ’³ Payment method:', orderPayload.paymentMethod);

                // Validate date/time with working days
                const workingDays = branchData.working_days || branchData.workingHours || [];
                const validation = orderManager.validateDateTimeWithWorkingDays(
                    orderData.deliveryDate,
                    orderData.deliveryTime,
                    workingDays
                );

                if (!validation.valid) {
                    console.error('âŒ Date/time validation failed:', validation.message);
                    showError(validation.message);
                    payBtn.disabled = false;
                    payBtnText?.classList.remove('hidden');
                    payBtnLoading?.classList.add('hidden');
                    return;
                }

                console.log('âœ… Date/time validation passed');
                console.log('ðŸ“¦ Creating order and order items in database...');

                // Create order and order items (this saves to database)
                const order = await orderManager.createCompleteOrder(
                    orderPayload,
                    selectedProducts,
                    workingDays
                );

                console.log('âœ…âœ…âœ… ORDER CREATED IN DATABASE âœ…âœ…âœ…');
                console.log('âœ… Order successfully saved to database with ID:', order.$id);
                console.log('âœ… Order document:', order);
                console.log('âœ… Order status:', order.orderStatus);
                console.log('âœ… Order total:', order.total);

                // Save purchase recipient info to database
                if (orderData.recipient) {
                    console.log('ðŸ” Creating purchase recipient info for order:', order.$id);
                    console.log('ðŸ” Recipient data:', orderData.recipient);
                    
                    // Get customer full name and phone for 'you' recipient type
                    let recipientName = orderData.recipient.name || '';
                    let recipientPhone = orderData.recipient.phone || '';
                    let recipientEmail = orderData.recipient.email || '';
                    
                    // If we couldn't get from orderData.recipient (shouldn't happen), try to fetch from customer
                    if (!recipientName && orderData.recipient.type === 'you') {
                        try {
                            const customerProfile = await fetchCustomerData(customerData.$id);
                            recipientName = customerProfile?.full_name || customerData.name || '';
                            recipientPhone = customerProfile?.phone_number || '';
                            recipientEmail = customerProfile?.email || customerData.email || '';
                            console.log('ðŸ“ž Retrieved customer profile for recipient:', {recipientName, recipientPhone, recipientEmail});
                        } catch (err) {
                            console.warn('âš ï¸ Could not fetch customer profile:', err);
                        }
                    }
                    
                    const recipientPayload = {
                        purchase_recipient_type: orderData.recipient.type || 'you',
                        recipient_name: recipientName,
                        recipient_phone: recipientPhone,
                        recipient_email: recipientEmail,
                        recipient_address: orderData.recipient.address || '',
                        recipient_type: orderData.recipient.type || '',
                        business_name: orderData.recipient.type === 'business' ? orderData.recipient.businessName : '',
                        business_type: orderData.recipient.type === 'business' ? orderData.recipient.businessType : '',
                        self_pickup: orderData.recipient.selfPickup || false,
                        self_delivery_address: orderData.recipient.selfDeliveryAddress || ''
                    };
                    
                    console.log('ðŸ” Recipient payload:', recipientPayload);
                    console.log('ðŸ“‹ Payload fields - Name:', recipientPayload.recipient_name, 'Phone:', recipientPayload.recipient_phone);

                    try {
                        const recipientResult = await orderManager.createPurchaseRecipientInfo(order.$id, recipientPayload);
                        console.log('âœ… Purchase recipient info saved to database:', recipientResult.$id);
                        console.log('âœ… Recipient document created with:', recipientPayload);
                    } catch (recipientError) {
                        console.error('âŒ Error saving purchase recipient info:', recipientError);
                        console.error('âŒ Tried to save payload:', recipientPayload);
                        // Don't fail the order if recipient info fails, but log the error
                    }
                } else {
                    console.log('âš ï¸ No recipient data found in orderData');
                }

                // Store order data for success page
                orderData.orderId = order.$id;
                orderData.transactionId = transactionId; // Store the transaction ID
                orderData.timestamp = new Date().toISOString();
                orderData.orderStatus = 'pending';

                console.log('ðŸ’¾ Order data stored in memory:', orderData);
                console.log('ðŸ“Š Order Summary:');
                console.log('   - Order ID: ' + orderData.orderId);
                console.log('   - Transaction ID: ' + orderData.transactionId);
                console.log('   - Total: GHS ' + orderData.total);
                console.log('   - Status: SAVED TO DATABASE âœ…');

                // Cache order locally
                if (window.cacheManager) {
                    try {
                        window.cacheManager.setCache('lastOrder', orderData, order.$id);
                        console.log('ðŸ’¾ Order cached locally for offline access');
                    } catch (cacheErr) {
                        console.warn('âš ï¸ Could not cache order locally:', cacheErr);
                    }
                }

                // Trigger storage event for schedule-history.html to update
                window.dispatchEvent(new Event('storage'));
                console.log('ðŸ”„ Storage event dispatched to notify other pages');

                console.log('ðŸš€ ===== PAYMENT PROCESSING COMPLETED SUCCESSFULLY =====');

                // Move to next step
                nextStep();
                
            } catch (error) {
                console.error('âŒ Error processing payment/order:', error);
                console.error('âŒ Error stack:', error.stack);
                showError('Failed to create order: ' + error.message);
                
                // Reset loading state on error
                if (payBtn) {
                    payBtn.disabled = false;
                    payBtnText?.classList.remove('hidden');
                    payBtnLoading?.classList.add('hidden');
                }
            }
        }

        function startPaymentProcessing() {
            let progress = 0;
            const progressBar = document.getElementById('paymentProgressBar');

            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    
                    // Verify order was saved to database
                    if (orderData.orderId && orderData.transactionId) {
                        verifyOrderSavedToDatabase();
                    }
                    
                    setTimeout(() => {
                        nextStep();
                    }, 1000);
                }
            }, 300);
        }

        // Verify order was successfully saved to database
        async function verifyOrderSavedToDatabase() {
            try {
                console.log('ðŸ” Verifying order was saved to database...');
                console.log('ðŸ” Order ID:', orderData.orderId);
                
                const orderManager = new OrderManager();
                const savedOrder = await orderManager.getOrder(orderData.orderId);
                
                if (savedOrder && savedOrder.$id === orderData.orderId) {
                    console.log('âœ… Order verified in database:', savedOrder);
                    console.log('âœ… Order status:', savedOrder.orderStatus);
                    console.log('âœ… Order total:', savedOrder.total);
                    return true;
                } else {
                    console.warn('âš ï¸ Order not found in database verification');
                    return false;
                }
            } catch (error) {
                console.error('âŒ Error verifying order in database:', error);
                console.error('âŒ Order ID was:', orderData.orderId);
                // Don't fail - the order was already created, just verification failed
                return false;
            }
        }

        function showPaymentSuccess() {
            if (selectedPaymentMethod === 'delivery') {
                // For Pay on Delivery, show order confirmation with payment breakdown
                const orderId = 'ORD' + Date.now().toString().slice(-8);
                document.getElementById('transactionIdDisplay').textContent = orderId;
                
                const serviceFee = orderData.serviceFee;
                const remainingBalance = orderData.subtotal;
                
                // Update amount display to show payment breakdown
                let paymentBreakdown = '';
                if (orderData.serviceFeePayment && orderData.serviceFeePayment.paid) {
                    paymentBreakdown = `Service Fee: GHS ${serviceFee.toFixed(2)} (Paid Online)\nRemaining Balance: GHS ${remainingBalance.toFixed(2)} (Pay on Delivery)`;
                } else {
                    paymentBreakdown = `GHS ${orderData.total.toFixed(2)} (Pay on Delivery)`;
                }
                
                document.getElementById('amountPaidDisplay').textContent = paymentBreakdown;
                
                // Update the payment success message for delivery
                const successMessage = document.querySelector('#paymentSuccessStep .section-header');
                if (successMessage) {
                    successMessage.textContent = 'Order Confirmed!';
                }
                
                const subMessage = document.querySelector('#paymentSuccessStep .section-subheader');
                if (subMessage) {
                    if (orderData.serviceFeePayment && orderData.serviceFeePayment.paid) {
                        subMessage.textContent = 'Service fee paid successfully. Remaining balance payable upon delivery.';
                    } else {
                        subMessage.textContent = 'Your order has been confirmed. Pay upon delivery.';
                    }
                }
                
                orderData.transactionId = orderId;
                orderData.paymentMethod = 'delivery';
                orderData.timestamp = new Date().toISOString();
            } else {
                // Regular mobile money payment success
                // Use the transaction ID that was already generated during order creation
                const transactionId = orderData.transactionId || ('TXN' + Date.now().toString().slice(-8));
                document.getElementById('transactionIdDisplay').textContent = transactionId;
                document.getElementById('amountPaidDisplay').textContent = `GHS ${orderData.total.toFixed(2)}`;

                // Store transaction ID for order record (in case it wasn't set)
                if (!orderData.transactionId) {
                    orderData.transactionId = transactionId;
                }
                orderData.paymentMethod = 'mobile';
                orderData.timestamp = new Date().toISOString();
            }
        }

        function showScheduleSent() {
            // Use real order ID or generate fallback
            const orderId = orderData.orderId || ('ORD' + Date.now().toString().slice(-8));
            document.getElementById('orderIdDisplay').textContent = orderId;
            document.getElementById('orderDateDisplay').textContent = formatDate(selectedDate);
            document.getElementById('orderTimeDisplay').textContent = formatTime(selectedTime);

            const totalItems = selectedProducts.reduce((sum, product) => sum + product.quantity, 0);
            document.getElementById('orderItemsDisplay').textContent = `${totalItems} items`;

            // Store order data
            if (!orderData.orderId) {
                orderData.orderId = orderId;
            }
            orderData.orderDate = formatDate(selectedDate);
            orderData.orderTime = formatTime(selectedTime);
        }

        function setRating(rating) {
            userRating = rating;

            document.querySelectorAll('.rating-star-large').forEach((star, index) => {
                star.textContent = 'â˜†';
                star.classList.remove('selected');

                if (index < rating) {
                    star.textContent = 'â˜…';
                    star.classList.add('selected');
                }
            });
        }

        async function submitRating() {
            const comment = document.getElementById('ratingComment').value;

            if (userRating === 0) {
                showError('Please select a rating');
                return;
            }

            orderData.rating = userRating;
            orderData.comment = comment;

            // Prefer server-side API to ensure DB save without client auth
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');
                const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                const resolvedBranchId = branchData?.branch_id || branchId;
                const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

                const payload = {
                    company_id: resolvedCompanyId,
                    branch_id: resolvedBranchId || '',
                    stars: userRating,
                    comment: comment || '',
                    product_tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                    location: orderData.recipient?.address || (window.currentCompany?.location || ''),
                    order_id: orderData.orderId || null,
                    customer_id: null
                };

                const resp = await fetch('/api/ratings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) throw new Error('Server API failed');

                const data = await resp.json();
                console.log('âœ… Rating saved via server API', data);

                // Also reflect immediately in local histogram & list
                const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
                const existing = localStorage.getItem(storageKey);
                const reviewsLocal = existing ? JSON.parse(existing) : [];
                const newReview = {
                    id: Date.now(),
                    name: 'You',
                    rating: userRating,
                    comment: comment || '',
                    tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                    date: new Date().toISOString()
                };
                reviewsLocal.push(newReview);
                localStorage.setItem(storageKey, JSON.stringify(reviewsLocal));

                updateRatingDisplay();
                renderReviews();

                currentStep = 12;
                goToStep('ratingSuccess');
                return;
            } catch (apiErr) {
                console.warn('API rating save failed, attempting Appwrite client save...', apiErr);
            }

            // Save rating to Appwrite DB (client-side) as secondary path
            try {
                if (window.databases && window.appwriteConfig && window.account) {
                    const user = await window.account.get();
                    const ratingId = (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 20);

                    // Resolve company and branch IDs
                    const urlParams = new URLSearchParams(window.location.search);
                    const branchId = urlParams.get('branch_id');
                    const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                    const resolvedBranchId = branchData?.branch_id || branchId;
                    const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

                    const payload = {
                        rating_id: ratingId,
                        company_id: resolvedCompanyId,
                        branch_id: resolvedBranchId || '',
                        order_id: orderData.orderId || null,
                        customer_id: user.$id,
                        stars: userRating,
                        comment: comment || '',
                        created_at: new Date().toISOString(),
                        location: orderData.recipient?.address || (window.currentCompany?.location || ''),
                        product_tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : []
                    };

                    await window.databases.createDocument(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.RATINGS_TABLE,
                        window.ID.unique(),
                        payload
                    );
                    console.log('âœ… Rating saved to Appwrite', payload);

                    // Refresh ratings and histogram after successful save
                    const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
                    const existing = localStorage.getItem(storageKey);
                    const reviewsLocal = existing ? JSON.parse(existing) : [];
                    const newReview = {
                        id: Date.now(),
                        name: 'You',
                        rating: userRating,
                        comment: comment || '',
                        tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                        date: new Date().toISOString()
                    };
                    reviewsLocal.push(newReview);
                    localStorage.setItem(storageKey, JSON.stringify(reviewsLocal));

                    updateRatingDisplay();
                    renderReviews();

                    // Proceed to success only after saving
                    currentStep = 12;
                    goToStep('ratingSuccess');
                    return;
                } else {
                    console.error('âŒ Appwrite not available for ratings');
                }
            } catch (err) {
                console.error('âŒ Failed to save rating via Appwrite client:', err);
            }

            // Fallback: save locally and update UI
            const urlParams = new URLSearchParams(window.location.search);
            const branchId = urlParams.get('branch_id');
            const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
            const resolvedBranchId = branchData?.branch_id || branchId;
            const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');
            const localReview = {
                id: (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 20),
                name: 'Anonymous',
                rating: userRating,
                comment: comment || '',
                tags: (typeof selectedTags !== 'undefined') ? Array.from(selectedTags) : [],
                date: new Date()
            };
            reviews.push(localReview);
            const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
            localStorage.setItem(storageKey, JSON.stringify(reviews));
            updateRatingDisplay();
            renderReviews();
            currentStep = 12;
            goToStep('ratingSuccess');
        }

        function showRatingSuccess() {
            document.getElementById('finalOrderId').textContent = orderData.orderId;
            document.getElementById('finalDeliveryDate').textContent = `${formatDate(selectedDate)} at ${formatTime(selectedTime)}`;
            document.getElementById('finalTotalPaid').textContent = `GHS ${orderData.total.toFixed(2)}`;

            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < userRating) {
                    stars += 'â˜…';
                } else {
                    stars += 'â˜†';
                }
            }
            document.getElementById('finalRatingStars').textContent = stars;
        }

        function finishFlow() {
            completeOrderFlow();
        }

        function completeOrderFlow() {
            saveOrderToHistory();
            
            showSuccess(`Thank you for your order! Order ID: ${orderData.orderId}. Your order has been confirmed and will be processed.`);

            setTimeout(() => {
                closeScheduleFlow();
            }, 3000);
        }

        function saveOrderToHistory() {
            try {
                console.log('ðŸš€ Saving order to history...');
                console.log('ðŸ“¦ Order data:', orderData);
                console.log('ðŸ“¦ Order ID:', orderData.orderId);
                console.log('ðŸ“¦ Transaction ID:', orderData.transactionId);

                // Verify order was saved to database
                if (!orderData.orderId) {
                    console.error('âŒ Order ID is missing - order may not have been saved to database');
                    showError('Order was not properly saved. Please contact support with your transaction ID: ' + orderData.transactionId);
                    return;
                }

                // Cache order data locally for offline access
                if (window.cacheManager) {
                    try {
                        window.cacheManager.setCache('orders', orderData, orderData.orderId);
                        console.log('ðŸ’¾ Order cached locally with ID:', orderData.orderId);
                    } catch (cacheErr) {
                        console.warn('âš ï¸ Could not cache order:', cacheErr);
                    }
                }

                // Also cache to localStorage as backup
                try {
                    const ordersArray = JSON.parse(localStorage.getItem('orderHistory') || '[]');
                    ordersArray.unshift({
                        ...orderData,
                        savedAt: new Date().toISOString()
                    });
                    localStorage.setItem('orderHistory', JSON.stringify(ordersArray.slice(0, 50))); // Keep last 50 orders
                    console.log('ðŸ’¾ Order saved to localStorage backup');
                } catch (storageErr) {
                    console.warn('âš ï¸ Could not save to localStorage:', storageErr);
                }

                // Trigger storage event for schedule-history.html
                window.dispatchEvent(new Event('storage'));
                console.log('ðŸ”„ Storage event dispatched to schedule-history.html');

                console.log('âœ… Order successfully saved to history with ID:', orderData.orderId);

            } catch (error) {
                console.error('âŒ Error in saveOrderToHistory:', error);
                console.error('âŒ Error details:', error.message);
                
                // Handle offline scenario - add to sync queue
                if (window.cacheManager && window.cacheManager.isOffline && window.cacheManager.isOffline()) {
                    console.log('ðŸ“´ Offline mode - adding order to sync queue');
                    try {
                        const syncId = window.cacheManager.addToSyncQueue('save_order', orderData, 'high');
                        
                        if (syncId) {
                            console.log('ðŸ“‹ Order queued for sync with ID:', syncId);
                            showSuccess('Order saved offline. It will sync when you\'re back online.');
                            return;
                        }
                    } catch (syncErr) {
                        console.error('âŒ Error adding to sync queue:', syncErr);
                    }
                }
                
                showError('Error saving order history. Your order ID is: ' + (orderData.orderId || orderData.transactionId));
            }
        }

        function downloadOrderPDF() {
            try {
                const orderId = document.getElementById('orderIdDisplay')?.textContent || 'N/A';
                const orderDate = document.getElementById('orderDateDisplay')?.textContent || 'N/A';
                const orderTime = document.getElementById('orderTimeDisplay')?.textContent || 'N/A';
                const orderItems = document.getElementById('orderItemsDisplay')?.textContent || 'N/A';
                
                const recipientName = orderData.recipient?.name || 'N/A';
                const recipientPhone = orderData.recipient?.phone || 'N/A';
                const recipientAddress = orderData.recipient?.address || 'N/A';
                const deliveryInstructions = orderData.recipient?.instructions || 'None';
                
                let subtotal = 0;
                let totalItems = 0;
                let productsList = [];
                
                if (selectedProducts && selectedProducts.length > 0) {
                    selectedProducts.forEach(product => {
                        const productPrice = parseFloat(product.price) || 0;
                        const productQuantity = parseInt(product.quantity) || 0;
                        const productTotal = productPrice * productQuantity;
                        
                        subtotal += productTotal;
                        totalItems += productQuantity;
                        productsList.push({
                            name: product.name || 'Unknown Product',
                            quantity: productQuantity,
                            price: productPrice,
                            total: productTotal
                        });
                    });
                }
                
                const serviceFee = totalItems * SERVICE_FEE_PER_ITEM;
                const totalAmount = subtotal + serviceFee;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                let yPosition = 15;
                
                function checkPageBreak(requiredHeight) {
                    if (yPosition + requiredHeight > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 15;
                        return true;
                    }
                    return false;
                }
                
                doc.setFillColor(59, 116, 255);
                doc.rect(0, 0, pageWidth, 50, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('Phluowise', margin, 25);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Order Confirmation', margin, 35);
                
                doc.setFontSize(10);
                doc.text(`#${orderId}`, pageWidth - margin, 25, { align: 'right' });
                
                doc.setTextColor(0, 0, 0);
                yPosition = 60;
                
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, yPosition);
                yPosition += 15;
                
                checkPageBreak(40);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Delivery Information', margin, yPosition);
                yPosition += 8;
                
                doc.setDrawColor(59, 116, 255);
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, margin + 60, yPosition);
                yPosition += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Date:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(orderDate, margin + 25, yPosition);
                
                doc.setFont('helvetica', 'normal');
                doc.text('Time:', margin + 80, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(orderTime, margin + 100, yPosition);
                yPosition += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text('Items:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(orderItems, margin + 25, yPosition);
                
                doc.setFont('helvetica', 'normal');
                doc.text('Status:', margin + 80, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(16, 185, 129);
                doc.text('Confirmed', margin + 100, yPosition);
                doc.setTextColor(0, 0, 0);
                yPosition += 20;
                
                checkPageBreak(60);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Customer Information', margin, yPosition);
                yPosition += 8;
                
                doc.setDrawColor(59, 116, 255);
                doc.line(margin, yPosition, margin + 80, yPosition);
                yPosition += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Name:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(recipientName.substring(0, 40), margin + 25, yPosition);
                yPosition += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text('Phone:', margin, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(recipientPhone, margin + 25, yPosition);
                yPosition += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text('Address:', margin, yPosition);
                
                const addressLines = doc.splitTextToSize(recipientAddress, contentWidth - 25);
                doc.setFont('helvetica', 'bold');
                addressLines.forEach((line, index) => {
                    if (index === 0) {
                        doc.text(line, margin + 25, yPosition);
                    } else {
                        doc.text(line, margin, yPosition + (index * 7));
                    }
                });
                yPosition += (addressLines.length * 7) + 5;
                
                if (deliveryInstructions && deliveryInstructions !== 'None') {
                    doc.setFont('helvetica', 'normal');
                    doc.text('Instructions:', margin, yPosition);
                    
                    const instructionLines = doc.splitTextToSize(deliveryInstructions, contentWidth - 25);
                    doc.setFont('helvetica', 'bold');
                    instructionLines.forEach((line, index) => {
                        if (index === 0) {
                            doc.text(line, margin + 25, yPosition);
                        } else {
                            doc.text(line, margin, yPosition + (index * 7));
                        }
                    });
                    yPosition += (instructionLines.length * 7) + 5;
                }
                
                checkPageBreak(80);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Order Details', margin, yPosition);
                yPosition += 8;
                
                doc.setDrawColor(59, 116, 255);
                doc.line(margin, yPosition, margin + 60, yPosition);
                yPosition += 12;
                
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 7, contentWidth, 12, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('Product', margin + 3, yPosition);
                doc.text('Qty', margin + 80, yPosition);
                doc.text('Price', margin + 100, yPosition);
                doc.text('Total', margin + 140, yPosition);
                yPosition += 15;
                
                doc.setFont('helvetica', 'normal');
                productsList.forEach((product, index) => {
                    checkPageBreak(12);
                    
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 248, 248);
                        doc.rect(margin, yPosition - 7, contentWidth, 10, 'F');
                    }
                    
                    const productName = product.name.substring(0, 25);
                    const quantity = product.quantity.toString();
                    const unitPrice = `GHS ${product.price.toFixed(2)}`;
                    const totalPrice = `GHS ${product.total.toFixed(2)}`;
                    
                    doc.text(productName, margin + 3, yPosition);
                    doc.text(quantity, margin + 80, yPosition);
                    doc.text(unitPrice, margin + 100, yPosition);
                    doc.text(totalPrice, margin + 140, yPosition);
                    yPosition += 10;
                });
                
                yPosition += 10;
                
                checkPageBreak(50);
                
                doc.setFillColor(240, 248, 255);
                doc.rect(margin, yPosition - 5, contentWidth, 45, 'F');
                doc.setDrawColor(59, 116, 255);
                doc.rect(margin, yPosition - 5, contentWidth, 45);
                
                doc.setTextColor(59, 116, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Price Summary', margin + 3, yPosition + 5);
                yPosition += 15;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Subtotal:', margin + 3, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(`GHS ${subtotal.toFixed(2)}`, margin + 120, yPosition);
                yPosition += 8;
                
                doc.setFont('helvetica', 'normal');
                doc.text(`Service Fee (${totalItems} items):`, margin + 3, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(`GHS ${serviceFee.toFixed(2)}`, margin + 120, yPosition);
                yPosition += 10;
                
                doc.setDrawColor(59, 116, 255);
                doc.line(margin + 3, yPosition, margin + contentWidth - 3, yPosition);
                yPosition += 8;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('Total Amount:', margin + 3, yPosition);
                doc.setTextColor(59, 116, 255);
                doc.text(`GHS ${totalAmount.toFixed(2)}`, margin + 120, yPosition);
                
                yPosition = pageHeight - 25;
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Thank you for choosing Phluowise!', margin, yPosition);
                doc.text('This is an automatically generated order confirmation.', margin, yPosition + 6);
                doc.text('For inquiries, contact our customer support.', margin, yPosition + 12);
                
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, yPosition + 12, { align: 'right' });
                }
                
                // Mobile-optimized PDF save with fallback
                if (isAPKEnvironment()) {
                    // APK environment - use specialized methods
                    tryAPKPDFDownload(doc, `order_${orderId}_${Date.now()}.pdf`).then(() => {
                        showMobileNotification('PDF processing for APK environment...', 'success');
                    }).catch(() => {
                        // Fallback to mobile methods
                        tryMobilePDFDownload(doc, `order_${orderId}_${Date.now()}.pdf`).then(() => {
                            showMobileNotification('PDF download initiated! Check downloads or open in new tab.', 'success');
                        }).catch(() => {
                            doc.save(`order_${orderId}_${Date.now()}.pdf`);
                            showMobileNotification('PDF download initiated! Check downloads folder.', 'success');
                        });
                    });
                } else if (isMobileDevice()) {
                    // Regular mobile browser
                    tryMobilePDFDownload(doc, `order_${orderId}_${Date.now()}.pdf`).then(() => {
                        showMobileNotification('PDF download initiated! Check downloads or open in new tab.', 'success');
                    }).catch(() => {
                        // Fallback to standard download
                        doc.save(`order_${orderId}_${Date.now()}.pdf`);
                        showMobileNotification('PDF download initiated! Check downloads folder.', 'success');
                    });
                } else {
                    // Standard desktop download
                    doc.save(`order_${orderId}_${Date.now()}.pdf`);
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMobileNotification('Failed to generate PDF. Please try again.', 'error');
            }
        }

        // Mobile device detection with APK detection
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768 && 'ontouchstart' in window);
        }
        
        // APK detection (Android app environment)
        function isAPKEnvironment() {
            // More aggressive APK detection
            const isAndroidApp = navigator.userAgent.includes('Android') && 
                               !navigator.userAgent.includes('Mobile Safari') &&
                               !navigator.userAgent.includes('Chrome');
            
            const hasCordova = window.cordova || window.PhoneGap || window.phonegap;
            const isWebView = navigator.userAgent.includes('wv');
            
            // Website 2 APK Pro specific detection
            const isWebsite2APK = navigator.userAgent.includes('wv') || 
                                 window.location.protocol === 'file:' ||
                                 (window.webkit && window.webkit.messageHandlers);
            
            return isAndroidApp || hasCordova || isWebView || isWebsite2APK;
        }
        
        // WebView APK detection (Website 2 APK Pro)
        function isWebViewAPK() {
            return navigator.userAgent.includes('wv') || 
                   window.location.protocol === 'file:' ||
                   (window.webkit && window.webkit.messageHandlers);
        }
        
        // APK-specific PDF download methods
        async function tryAPKPDFDownload(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Try WebView APK specific method (Website 2 APK Pro)
                    if (isWebViewAPK()) {
                        tryWebViewAPKSave(doc, filename).then(resolve).catch(() => {
                            // Fallback to other methods
                            tryDirectAndroidSave(doc, filename).then(resolve).catch(() => {
                                // Method 2: Try Cordova File Plugin if available
                                if (window.cordova && window.cordova.file) {
                                    tryCordovaFileSave(doc, filename).then(resolve).catch(() => {
                                        // Method 3: WebView download with share intent
                                        tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                                    });
                                } else {
                                    // Method 3: WebView download with share intent
                                    tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                                }
                            });
                        });
                    } else {
                        // Method 2: Try direct Android file system access
                        tryDirectAndroidSave(doc, filename).then(resolve).catch(() => {
                            // Method 3: Try Cordova File Plugin if available
                            if (window.cordova && window.cordova.file) {
                                tryCordovaFileSave(doc, filename).then(resolve).catch(() => {
                                    // Method 4: WebView download with share intent
                                    tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                                });
                            } else {
                                // Method 4: WebView download with share intent
                                tryWebViewDownload(doc, filename).then(resolve).catch(reject);
                            }
                        });
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // WebView APK specific save method (Website 2 APK Pro)
        async function tryWebViewAPKSave(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Try to open with Android native PDF viewer
                    const pdfBlob = doc.output('blob');
                    const dataUrl = doc.output('datauristring');
                    
                    // Create a download link that triggers Android system PDF viewer
                    const downloadLink = document.createElement('a');
                    downloadLink.href = dataUrl;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    
                    // Force Android to open with system PDF app
                    downloadLink.setAttribute('download', filename);
                    downloadLink.setAttribute('target', '_system'); // Try system viewer
                    downloadLink.setAttribute('rel', 'noopener noreferrer');
                    
                    document.body.appendChild(downloadLink);
                    
                    // Method 1: Try to trigger Android system PDF viewer
                    try {
                        downloadLink.click();
                        showMobileNotification('Opening PDF with Android PDF viewer...', 'success');
                        
                        // Check if PDF opened in new window (system viewer)
                        setTimeout(() => {
                            const newWindow = window.open(dataUrl, '_system', 'width=800,height=600');
                            if (newWindow) {
                                showMobileNotification('PDF opened with system viewer. Use Android share/save options.', 'success');
                            } else {
                                // Fallback to direct download
                                tryDirectAndroidPDFOpen(doc, filename).then(resolve).catch(reject);
                            }
                            resolve();
                        }, 1000);
                        
                    } catch (e1) {
                        try {
                            // Method 2: Try system viewer with different approach
                            downloadLink.setAttribute('target', '_blank');
                            downloadLink.click();
                            showMobileNotification('Opening PDF with Android system app...', 'success');
                            resolve();
                        } catch (e2) {
                            try {
                                // Method 3: Try to open with Android intent
                                const event = document.createEvent('MouseEvents');
                                event.initEvent('click', true, true);
                                downloadLink.dispatchEvent(event);
                                showMobileNotification('Opening PDF with Android PDF viewer...', 'success');
                                resolve();
                            } catch (e3) {
                                console.log('System viewer methods failed, trying direct open:', e3);
                                // Method 4: Direct Android PDF open
                                tryDirectAndroidPDFOpen(doc, filename).then(resolve).catch(reject);
                            }
                        }
                    }
                    
                } catch (error) {
                    console.log('WebView APK save failed:', error);
                    reject(error);
                }
            });
        }
        
        // Direct Android PDF open method
        async function tryDirectAndroidPDFOpen(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    const dataUrl = doc.output('datauristring');
                    
                    // Try to open with Android system PDF viewer
                    const pdfWindow = window.open(dataUrl, '_system', 'noopener,noreferrer');
                    
                    if (pdfWindow) {
                        showMobileNotification('PDF opened with Android system viewer!', 'success');
                        resolve();
                    } else {
                        // Fallback: Create download link for manual opening
                        const downloadLink = document.createElement('a');
                        downloadLink.href = dataUrl;
                        downloadLink.download = filename;
                        downloadLink.style.display = 'none';
                        downloadLink.target = '_blank';
                        
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        showMobileNotification('PDF ready. Open with Android PDF viewer from downloads.', 'info');
                        resolve();
                    }
                    
                } catch (error) {
                    console.log('Direct Android PDF open failed:', error);
                    reject(error);
                }
            });
        }
        
        // Enhanced Cordova file save method
        async function tryCordovaFileSave(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    const pdfBlob = doc.output('blob');
                    
                    // Try multiple Android storage locations
                    const storageLocations = [
                        window.cordova.file.externalRootDirectory,  // External storage (SD card)
                        window.cordova.file.dataDirectory,        // Internal app storage
                        window.cordova.file.cacheDirectory,       // App cache
                        window.cordova.file.syncedDataDirectory   // Synced storage
                    ];
                    
                    let locationIndex = 0;
                    
                    function tryNextLocation() {
                        if (locationIndex >= storageLocations.length) {
                            reject(new Error('All storage locations failed'));
                            return;
                        }
                        
                        const storage = storageLocations[locationIndex];
                        const locationName = locationIndex === 0 ? 'External Storage' : 
                                         locationIndex === 1 ? 'App Storage' :
                                         locationIndex === 2 ? 'App Cache' : 'Synced Storage';
                        
                        try {
                            storage.getDirectory('Download', {
                                create: true,
                                exclusive: false
                            }, function(dirEntry) {
                                dirEntry.getFile(filename, {
                                    create: true,
                                    exclusive: false
                                }, function(fileEntry) {
                                    fileEntry.createWriter(function(fileWriter) {
                                        fileWriter.write(pdfBlob);
                                        fileWriter.onwriteend = function() {
                                            showMobileNotification(`PDF saved to ${locationName} â†’ Downloads folder!`, 'success');
                                            resolve();
                                        };
                                        fileWriter.onerror = function() {
                                            console.log(`Failed to write to ${locationName}, trying next location...`);
                                            locationIndex++;
                                            tryNextLocation();
                                        };
                                    }, function() {
                                        console.log(`Failed to create file in ${locationName}, trying next location...`);
                                        locationIndex++;
                                        tryNextLocation();
                                    });
                                }, function() {
                                    console.log(`Failed to access Downloads in ${locationName}, trying next location...`);
                                    locationIndex++;
                                    tryNextLocation();
                                });
                            }, function() {
                                console.log(`Failed to access ${locationName}, trying next location...`);
                                locationIndex++;
                                tryNextLocation();
                            });
                        } catch (error) {
                            console.log(`Error accessing ${locationName}:`, error);
                            locationIndex++;
                            tryNextLocation();
                        }
                    }
                    
                    tryNextLocation();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // WebView download with share intent
        async function tryWebViewDownload(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Data URL with share intent
                    const dataUrl = doc.output('datauristring');
                    
                    // Create share link
                    const shareLink = document.createElement('a');
                    shareLink.href = dataUrl;
                    shareLink.download = filename;
                    shareLink.style.display = 'none';
                    shareLink.target = '_blank';
                    
                    // Try to trigger Android share/download
                    document.body.appendChild(shareLink);
                    shareLink.click();
                    document.body.removeChild(shareLink);
                    
                    // Method 2: Open in new tab for manual save
                    setTimeout(() => {
                        const newTab = window.open(dataUrl, '_blank');
                        if (newTab) {
                            showMobileNotification('PDF opened. Use browser menu to save/share.', 'info');
                        } else {
                            showMobileNotification('PDF ready. Check app downloads or use share menu.', 'info');
                        }
                        resolve();
                    }, 1000);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        async function tryMobilePDFDownload(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Try standard download first
                    doc.save(filename);
                    
                    // Method 2: Create blob and download link (fallback)
                    setTimeout(() => {
                        try {
                            const pdfBlob = doc.output('blob');
                            const url = URL.createObjectURL(pdfBlob);
                            const downloadLink = document.createElement('a');
                            downloadLink.href = url;
                            downloadLink.download = filename;
                            downloadLink.style.display = 'none';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                            URL.revokeObjectURL(url);
                            
                            // Method 3: Open in new tab as additional fallback
                            setTimeout(() => {
                                try {
                                    const newTab = window.open(url, '_blank');
                                    if (newTab) {
                                        newTab.focus();
                                        showMobileNotification('PDF opened in new tab. Save from browser menu.', 'info');
                                    }
                                } catch (tabError) {
                                    console.log('Could not open in new tab:', tabError);
                                }
                            }, 500);
                            
                            resolve();
                        } catch (fallbackError) {
                            console.log('Blob method failed, trying data URL:', fallbackError);
                            
                            // Method 4: Data URL fallback
                            try {
                                const dataUrl = doc.output('datauristring');
                                const dataLink = document.createElement('a');
                                dataLink.href = dataUrl;
                                dataLink.download = filename;
                                dataLink.style.display = 'none';
                                dataLink.target = '_blank'; // Force new window
                                document.body.appendChild(dataLink);
                                dataLink.click();
                                document.body.removeChild(dataLink);
                                
                                showMobileNotification('PDF download initiated. Check your downloads or browser tabs.', 'info');
                                resolve();
                            } catch (dataUrlError) {
                                console.log('Data URL method failed:', dataUrlError);
                                reject(dataUrlError);
                            }
                        }
                    }, 1000);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // Update working hours based on selected day
        function updateWorkingHours() {
            const select = document.getElementById('workingDaysSelect');
            const selectedDay = select.value;
            
            // Get working days from current company data
            const workingHours = window.currentCompany?.workingHours || {};
            
            // Find the working hours for the selected day
            const dayData = workingHours[selectedDay.toLowerCase()];
            
            if (dayData && dayData.open && dayData.close) {
                // Use pre-parsed time data
                const openingTime = dayData.open;
                const closingTime = dayData.close;
                
                // Convert to 12-hour format for display
                const formatTime = (time24) => {
                    const [hours, minutes] = time24.split(':').map(Number);
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const hours12 = hours % 12 || 12; // Convert 0 to 12 for 12 AM/PM
                    return `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                };

                const openingTime12 = formatTime(openingTime);
                const closingTime12 = formatTime(closingTime);
                
                // Update the display
                document.getElementById('openingTime').textContent = openingTime12;
                document.getElementById('closingTime').textContent = closingTime12;
            } else {
                // No working hours found for this day
                document.getElementById('openingTime').textContent = 'Closed';
                document.getElementById('closingTime').textContent = 'Closed';
            }
        }

        // Initialize working hours when page loads
        function initializeWorkingHours() {
            const workingHoursLoader = document.getElementById('workingHoursLoader');
            const workingHoursContent = document.getElementById('workingHoursContent');
            
            // Hide loader and show content
            if (workingHoursLoader) workingHoursLoader.classList.add('hidden');
            if (workingHoursContent) workingHoursContent.classList.remove('hidden');
            
            // Set today's day as default and update hours
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
            const select = document.getElementById('workingDaysSelect');
            if (select) {
                select.value = today;
                updateWorkingHours();
            }
        }
        function showMobileFeedback(message, type = 'info') {
            showMobileNotification(message, type);
        }

        // Mobile notification system
        function showMobileNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotification = document.querySelector('.mobile-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `mobile-notification fixed top-4 left-4 right-4 z-50 p-4 rounded-lg backdrop-blur-xl border transition-all duration-300 transform translate-y-[-100px]`;
            
            // Style based on type
            if (type === 'error') {
                notification.className += ' bg-red-500/20 border-red-500/40 text-red-300';
            } else if (type === 'success') {
                notification.className += ' bg-green-500/20 border-green-500/40 text-green-300';
            } else {
                notification.className += ' bg-blue-500/20 border-blue-500/40 text-blue-300';
            }
            
            // Add Android-specific guidance
            const androidGuidance = isAPKEnvironment() ? 
                '<div class="mt-2 text-xs opacity-75"> Check Android notification panel for download progress</div>' : 
                isMobileDevice() ? 
                '<div class="mt-2 text-xs opacity-75"> Check browser downloads and notifications</div>' : 
                '';
            
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                        ${type === 'error' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' : 
                          type === 'success' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' :
                          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                        ${androidGuidance}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 p-1 hover:bg-white/10 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-y-[-100px]');
                notification.classList.add('translate-y-0');
            }, 100);
            
            // Auto-remove after 8 seconds (longer for Android guidance)
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-y-[-100px]');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 8000);
        }
        
        // Android notification panel checker
        function checkAndroidNotificationPanel() {
            if (isAPKEnvironment()) {
                showMobileNotification('ðŸ”” Check your Android notification panel (pull down from top) for download progress!', 'info');
                
                // Try to trigger Android notification if possible
                if (window.cordova && window.cordova.plugins && window.cordova.plugins.notification) {
                    try {
                        window.cordova.plugins.notification.local.schedule({
                            id: 1,
                            title: "PDF Download",
                            message: "Your PDF is being downloaded...",
                            sound: "file://sounds/notification.mp3"
                        });
                    } catch (e) {
                        console.log('Could not trigger Android notification:', e);
                    }
                }
            }
        }

        // Message display functions
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');

            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('active');

            setTimeout(() => {
                successDiv.classList.remove('active');
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        // Original functions from schedule.html
        function showSocialModal(platform) {
            const modal = document.getElementById('socialModal');
            const platformNameSpan = document.getElementById('socialPlatformName');
            
            platformNameSpan.textContent = platform;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        function closeSocialModal() {
            const modal = document.getElementById('socialModal');
            
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function toggleContactPopup() {
            const popup = document.getElementById('contactPopup');
            popup.classList.toggle('hidden');
        }

        function toggleTag(btn) {
            const tagText = btn.textContent.trim();
            
            if (selectedTags.has(tagText)) {
                selectedTags.delete(tagText);
                btn.style.backgroundColor = '#40444B';
                btn.style.borderColor = 'transparent';
            } else {
                selectedTags.add(tagText);
                btn.style.backgroundColor = 'var(--btn-color)';
                btn.style.borderColor = 'var(--btn-border)';
            }
        }

        // Logout function to switch accounts
        async function logoutUser() {
            try {
                await window.account.deleteSession('current');
                showMobileFeedback('Logged out successfully. Please login with your real account.', 'success');
                // Optionally redirect to login page or refresh
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Logout error:', error);
                showMobileFeedback('Error logging out. Please try again.', 'error');
            }
        }

        async function submitReview() {
            const commentInput = document.getElementById('ratingCommentInput');
            const comment = commentInput.value.trim();

            if (currentRating === 0) {
                showMobileFeedback('Please select a star rating', 'error');
                return;
            }

            if (comment === '') {
                showMobileFeedback('Please write a review', 'error');
                return;
            }

            try {
                // Get current authenticated user
                let customerId = null;
                let userName = 'Anonymous';
                
                try {
                    const user = await window.account.get();
                    customerId = user.$id;
                    // Try different possible name fields
                    userName = user.name || user.fullName || user.full_name || user.email || 'User';
                    console.log('ðŸ‘¤ User data:', { id: user.$id, name: userName, email: user.email });
                    
                    // Check if this is a guest user
                    if (user.email && user.email.includes('guest_')) {
                        showMobileFeedback('Please logout from guest account and login with your real account', 'error');
                        return;
                    }
                    
                    // Store current user ID for display logic
                    window.currentUserId = customerId;
                } catch (authError) {
                    showMobileFeedback('Please login to submit a review', 'error');
                    return;
                }

                // Get company and branch IDs
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');
                const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                const resolvedBranchId = branchData?.branch_id || branchId;
                const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

                // Generate unique rating_id
                const ratingId = (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 20);

                // Create payload for ratings database
                const payload = {
                    rating_id: ratingId,
                    company_id: resolvedCompanyId,
                    branch_id: resolvedBranchId,
                    order_id: null,
                    customer_id: customerId,
                    stars: currentRating,
                    comment: comment,
                    created_at: new Date().toISOString(),
                    location: window.currentCompany?.location || '',
                    product_tags: Array.from(selectedTags).join(', ').substring(0, 50)
                };

                // Save to Appwrite database
                let dbSaveSuccess = false;
                let createdDocument = null;
                if (window.databases && window.appwriteConfig) {
                    try {
                        createdDocument = await window.databases.createDocument(
                            window.appwriteConfig.DATABASE_ID,
                            window.appwriteConfig.RATINGS_TABLE,
                            window.ID.unique(),
                            payload
                        );
                        console.log('âœ… Rating saved to database');
                        console.log('ðŸ“„ Created document:', createdDocument);
                        dbSaveSuccess = true;
                    } catch (dbError) {
                        console.log('âš ï¸ Database save failed:', dbError.message);
                        showMobileFeedback('Failed to save to database. Please try again.', 'error');
                        return;
                    }
                }

                // Create local review object for display
                const newReview = {
                    id: ratingId,
                    dbId: createdDocument?.$id || createdDocument?.rating_id, // Store database document ID
                    ratingId: createdDocument?.rating_id || ratingId, // Store rating ID
                    name: 'You', // Always show "You" for current user's own review
                    rating: currentRating,
                    comment: comment,
                    tags: Array.from(selectedTags),
                    date: new Date(),
                    userId: customerId, // Store user ID for reference
                    actualName: userName // Store actual name for other users
                };

                // Add to reviews array (at the beginning)
                reviews.unshift(newReview);
                
                // Save to local storage
                saveReviews();

                // Update displays
                updateRatingDisplay();
                renderReviews();

                // Reset form
                currentRating = 0;
                selectedTags.clear();
                commentInput.value = '';
                updateStarDisplay();
                
                // Hide stars and tags
                document.getElementById('staticRatingStars').classList.add('hidden');
                document.getElementById('ratingTags').classList.add('hidden');
                
                // Reset star colors
                document.querySelectorAll('#staticRatingStars .star-rating-btn svg path').forEach(star => {
                    star.setAttribute('fill', '#666');
                });

                // Show success feedback
                showMobileFeedback('Review submitted successfully!', 'success');

            } catch (error) {
                console.error('âŒ Error submitting review:', error);
                showMobileFeedback('Failed to submit review. Please try again.', 'error');
            }
        }

        async function loadReviews() {
            console.log('ðŸš€ Starting loadReviews function...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const branchId = urlParams.get('branch_id');
            const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
            const resolvedBranchId = branchData?.branch_id || branchId;
            const resolvedCompanyId = branchData?.company_id || window.currentCompany?.company_id || branchId; // Use branchId as fallback

            console.log('ðŸ“ LoadReviews params:', { branchId, resolvedBranchId, resolvedCompanyId });

            // Show ratings loader
            const ratingsLoader = document.getElementById('ratingsLoader');
            const ratingContent = document.getElementById('ratingContent');
            if (ratingsLoader) ratingsLoader.classList.remove('hidden');
            if (ratingContent) ratingContent.classList.add('hidden');

            try {
                console.log('ðŸ” Checking database availability...');
                console.log('ðŸ” window.databases:', !!window.databases);
                console.log('ðŸ” window.appwriteConfig:', !!window.appwriteConfig);
                console.log('ðŸ” window.Query:', !!window.Query);
                
                if (window.databases && window.appwriteConfig && window.Query) {
                    console.log('âœ… Database available, fetching from database...');
                    console.log('ðŸ” Fetching ratings for company:', resolvedCompanyId, 'branch:', resolvedBranchId);
                    
                    // Build queries - only add company_id if it exists
                    const queries = [];
                    if (resolvedCompanyId && resolvedCompanyId !== '') {
                        queries.push(window.Query.equal('company_id', resolvedCompanyId));
                    }
                    if (resolvedBranchId) {
                        queries.push(window.Query.equal('branch_id', resolvedBranchId));
                    }
                    
                    console.log('ðŸ“‹ Database queries:', queries);
                    
                    const result = await window.databases.listDocuments(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.RATINGS_TABLE,
                        queries.length > 0 ? queries : undefined // If no queries, get all documents
                    );
                    
                    console.log('ðŸ“Š Database result received');
                    console.log('ðŸ“ Documents found:', result.documents?.length || 0);
                    console.log('ðŸ“„ Sample document:', result.documents?.[0]);
                    
                    if (!result.documents || result.documents.length === 0) {
                        console.log('âš ï¸ No documents found in database, falling back to localStorage');
                        throw new Error('No database documents');
                    }
                    
                    // Get current user info for display logic (optional, for "You" display)
                    let currentUserId = null;
                    try {
                        const user = await window.account.get();
                        currentUserId = user.$id;
                        window.currentUserId = currentUserId;
                        console.log('ðŸ‘¤ Current user found:', currentUserId);
                    } catch (e) {
                        // User not logged in - that's fine, still load all ratings
                        console.log('ðŸ‘¤ User not logged in, loading ratings as anonymous viewer');
                    }
                    
                    // Extract customer IDs
                    const customerIds = [...new Set(result.documents.map(doc => doc.customer_id).filter(id => id))];
                    console.log('ðŸ‘¥ Customer IDs to fetch:', customerIds);
                    
                    const customersMap = new Map();
                    
                    if (customerIds.length > 0) {
                        console.log('ðŸ”„ Fetching customer names using Users API...');
                        try {
                            // Fetch user names using Appwrite Users API
                            const customerPromises = customerIds.map(async (customerId) => {
                                try {
                                    console.log(`ðŸ” Fetching customer: ${customerId}`);
                                    const customerResult = await window.databases.listDocuments(
                                        window.appwriteConfig.DATABASE_ID,
                                        'customer_tb', // Correct collection name
                                        [window.Query.equal('$id', customerId)]
                                    );
                                    console.log(`ðŸ“„ Customer result for ${customerId}:`, customerResult);
                                    if (customerResult.documents && customerResult.documents.length > 0) {
                                        const customerDoc = customerResult.documents[0];
                                        console.log(`ðŸ” Full customer document for ${customerId}:`, customerDoc);
                                        console.log(`ðŸ” Available fields:`, Object.keys(customerDoc));
                                        
                                        // Try different possible name fields
                                        const customerName = customerDoc.full_name || customerDoc.name || customerDoc.customer_name || customerDoc.username || `Customer ${customerId.slice(0, 8)}`;
                                        console.log(`âœ… Found customer: ${customerId} -> ${customerName}`);
                                        return { id: customerId, name: customerName };
                                    } else {
                                        console.log(`âš ï¸ No customer found for ID: ${customerId}`);
                                        // Use fallback name
                                        return { id: customerId, name: `User ${customerId.slice(0, 8)}` };
                                    }
                                } catch (e) {
                                    console.log('âŒ Could not fetch customer:', customerId, e);
                                    return { id: customerId, name: `User ${customerId.slice(0, 8)}` };
                                }
                            });
                            
                            const customers = await Promise.all(customerPromises);
                            customers.forEach(customer => {
                                customersMap.set(customer.id, customer.name);
                            });
                            
                            console.log('ðŸ‘¥ Final customers map:', customersMap);
                        } catch (e) {
                            console.log('âŒ Could not fetch customers, using anonymous names:', e);
                        }
                    } else {
                        console.log('âš ï¸ No customer IDs found in ratings');
                    }
                    
                    reviews = (result.documents || []).map(doc => {
                        const customerName = customersMap.get(doc.customer_id) || 'Anonymous';
                        console.log(`ðŸ“„ Mapping rating: ${doc.customer_id} -> ${customerName}`);
                        return {
                            id: doc.$id || doc.rating_id,
                            dbId: doc.$id, // Store actual database document ID
                            ratingId: doc.rating_id, // Store rating_id if it exists
                            name: customerName, // Use fetched customer name
                            rating: doc.stars,
                            comment: doc.comment || '',
                            tags: Array.isArray(doc.product_tags) ? doc.product_tags : [],
                            date: doc.created_at ? new Date(doc.created_at) : (doc.$createdAt ? new Date(doc.$createdAt) : new Date()),
                            userId: doc.customer_id,
                            actualName: customerName
                        };
                    });
                    
                    console.log('âœ… Final reviews array from database:', reviews);
                    
                    // Update displays after loading
                    updateRatingDisplay();
                    renderReviews();
                    
                    if (ratingsLoader) ratingsLoader.classList.add('hidden');
                    if (ratingContent) ratingContent.classList.remove('hidden');
                    return;
                }
            } catch (e) {
                console.error('âŒ Database fetch failed, falling back to localStorage:', e);
            }

            console.log('ðŸ“¦ Loading from localStorage...');
            const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
            console.log('ðŸ“¦ Storage key:', storageKey);
            
            const savedReviews = localStorage.getItem(storageKey);
            console.log('ðŸ“¦ Saved reviews found:', !!savedReviews);
            
            if (savedReviews) {
                const parsed = JSON.parse(savedReviews);
                console.log('ðŸ“¦ Parsed reviews from localStorage:', parsed);
                reviews = parsed.map(review => ({
                    ...review,
                    date: review.date ? new Date(review.date) : new Date()
                }));
                console.log('ðŸ“¦ Final reviews array from localStorage:', reviews);
            } else {
                console.log('ðŸ“¦ No saved reviews found, using empty array');
                reviews = [];
            }
            
            // Update displays after loading
            updateRatingDisplay();
            renderReviews();
            
            if (ratingsLoader) ratingsLoader.classList.add('hidden');
            if (ratingContent) ratingContent.classList.remove('hidden');
        }

        function saveReviews() {
            const urlParams = new URLSearchParams(window.location.search);
            const branchId = urlParams.get('branch_id');
            const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
            const resolvedBranchId = branchData?.branch_id || branchId;
            const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');
            const storageKey = `reviews_${resolvedCompanyId || 'unknown'}_${resolvedBranchId || 'all'}`;
            localStorage.setItem(storageKey, JSON.stringify(reviews));
        }

        function calculateRatingStats() {
            if (reviews.length === 0) {
                return { average: 0, total: 0, distribution: [0, 0, 0, 0, 0] };
            }

            const total = reviews.reduce((sum, review) => sum + review.rating, 0);
            const average = (total / reviews.length).toFixed(1);
            
            const distribution = [0, 0, 0, 0, 0];
            reviews.forEach(review => {
                distribution[review.rating - 1]++;
            });

            const percentages = distribution.map(count => 
                reviews.length > 0 ? Math.round((count / reviews.length) * 100) : 0
            );

            return { average, total: reviews.length, distribution: percentages };
        }

        function updateRatingDisplay() {
            const stats = calculateRatingStats();
            
            // Hide ratings loader and show content
            const ratingsLoader = document.getElementById('ratingsLoader');
            const ratingContent = document.getElementById('ratingContent');
            if (ratingsLoader) ratingsLoader.classList.add('hidden');
            if (ratingContent) ratingContent.classList.remove('hidden');
            
            const ratingView = document.getElementById('view-rating');
            if (!ratingView) return;
            ratingView.querySelector('.text-white.font-bold.text-xl').textContent = `${stats.average} rating`;
            ratingView.querySelector('.text-white.font-semibold.text-lg').textContent = `${stats.total} reviews`;

            const ratingBarsContainer = ratingView.querySelector('.mt-4.flex.flex-col.gap-2');
            const barRows = ratingBarsContainer ? ratingBarsContainer.querySelectorAll(':scope > .flex.flex-row.items-center.gap-2') : [];

            const starLabels = [5, 4, 3, 2, 1];
            starLabels.forEach((star, index) => {
                // Correct mapping: 1-star -> index 0, ..., 5-star -> index 4
                const percentage = stats.distribution[star - 1];
                const row = barRows[index];
                if (row) {
                    const bar = row.querySelector('.bg-white.h-full');
                    const percentageText = row.querySelector('.text-white.font-medium.text-lg');
                    if (bar) bar.style.width = `${percentage}%`;
                    if (percentageText) percentageText.textContent = `${percentage}%`;
                }
            });
        }

        // Initialize ratings view
        loadReviews().then(() => {
            updateRatingDisplay();
            renderReviews();
        });

        // Mobile-friendly modal functions
        function showEditModal(review) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'editRatingModal';
            modalOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-800/40 backdrop-blur-xl rounded-2xl p-6 max-w-md w-full border border-gray-600/50 shadow-2xl';
            modalContent.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-white mb-2">Edit Your Review</h3>
                    <p class="text-gray-400 text-sm">Update your review comment below</p>
                </div>
                <div class="mb-6">
                    <textarea 
                        id="editReviewText" 
                        class="w-full p-3 bg-gray-800/50 backdrop-blur-sm border border-gray-600/50 rounded-lg text-white placeholder-gray-400 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
                        rows="4"
                        placeholder="Enter your review..."
                    >${review.comment}</textarea>
                    <div class="mt-2 text-right">
                        <span id="charCount" class="text-gray-400 text-sm">${review.comment.length}/500</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button 
                        onclick="cancelEditModal()" 
                        class="flex-1 px-4 py-3 bg-gray-700/50 backdrop-blur-sm hover:bg-gray-700/70 text-white rounded-lg font-medium transition-all border border-gray-600/30"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="saveEditModal('${review.id}')" 
                        class="flex-1 px-4 py-3 bg-blue-600/80 backdrop-blur-sm hover:bg-blue-700/80 text-white rounded-lg font-medium transition-all border border-blue-500/30"
                    >
                        Save Changes
                    </button>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            
            // Add character counter functionality
            const textarea = document.getElementById('editReviewText');
            const charCount = document.getElementById('charCount');
            textarea.addEventListener('input', () => {
                const length = textarea.value.length;
                charCount.textContent = `${length}/500`;
                if (length > 500) {
                    charCount.className = 'text-red-400 text-sm';
                } else {
                    charCount.className = 'text-gray-400 text-sm';
                }
            });
            
            // Close on overlay click
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    cancelEditModal();
                }
            });
            
            // Focus textarea
            setTimeout(() => textarea.focus(), 100);
        }
        
        function cancelEditModal() {
            const modal = document.getElementById('editRatingModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveEditModal(reviewId) {
            const textarea = document.getElementById('editReviewText');
            const newComment = textarea.value.trim();
            
            if (newComment === '') {
                showMobileFeedback('Review cannot be empty', 'error');
                return;
            }
            
            if (newComment.length > 500) {
                showMobileFeedback('Review must be 500 characters or less', 'error');
                return;
            }
            
            // Show loading state
            const saveButton = document.querySelector('button[onclick="saveEditModal(\'' + reviewId + '\')"]');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            try {
                const review = reviews.find(r => r.id === reviewId);
                if (!review) throw new Error('Review not found');
                
                // Update in database - use the stored database document ID
                if (window.databases && window.appwriteConfig) {
                    const dbDocumentId = review.dbId || review.ratingId;
                    if (!dbDocumentId) {
                        throw new Error('No database document ID available for this review');
                    }
                    
                    console.log(`ðŸ”„ Updating database document: ${dbDocumentId}`);
                    
                    await window.databases.updateDocument(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.RATINGS_TABLE,
                        dbDocumentId,
                        {
                            comment: newComment
                        }
                    );
                    console.log('âœ… Review updated in database');
                }
                
                // Update local review
                review.comment = newComment;
                saveReviews();
                renderReviews();
                
                // Close modal and show success
                cancelEditModal();
                showMobileFeedback('Review updated successfully!', 'success');
                
            } catch (error) {
                console.error('âŒ Error updating review:', error);
                showMobileFeedback('Failed to update review. Please try again.', 'error');
                
                // Reset button
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            }
        }
        
        function showDeleteModal(review) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'deleteRatingModal';
            modalOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-800/40 backdrop-blur-xl rounded-2xl p-6 max-w-md w-full border border-gray-600/50 shadow-2xl';
            modalContent.innerHTML = `
                <div class="mb-6 text-center">
                    <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">Delete Review?</h3>
                    <p class="text-gray-400 text-sm">This action cannot be undone. Your review will be permanently removed.</p>
                </div>
                <div class="flex gap-3">
                    <button 
                        onclick="cancelDeleteModal()" 
                        class="flex-1 px-4 py-3 bg-gray-700/50 backdrop-blur-sm hover:bg-gray-700/70 text-white rounded-lg font-medium transition-all border border-gray-600/30"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="confirmDeleteModal('${review.id}')" 
                        class="flex-1 px-4 py-3 bg-red-600/80 backdrop-blur-sm hover:bg-red-700/80 text-white rounded-lg font-medium transition-all border border-red-500/30"
                    >
                        Delete Review
                    </button>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            
            // Close on overlay click
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    cancelDeleteModal();
                }
            });
        }
        
        function cancelDeleteModal() {
            const modal = document.getElementById('deleteRatingModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function confirmDeleteModal(reviewId) {
            // Show loading state
            const deleteButton = document.querySelector('button[onclick="confirmDeleteModal(\'' + reviewId + '\')"]');
            const originalText = deleteButton.textContent;
            deleteButton.textContent = 'Deleting...';
            deleteButton.disabled = true;
            
            try {
                const review = reviews.find(r => r.id === reviewId);
                if (!review) throw new Error('Review not found');
                
                // Delete from database - use the stored database document ID
                if (window.databases && window.appwriteConfig) {
                    const dbDocumentId = review.dbId || review.ratingId;
                    if (!dbDocumentId) {
                        throw new Error('No database document ID available for this review');
                    }
                    
                    console.log(`ðŸ—‘ï¸ Deleting database document: ${dbDocumentId}`);
                    
                    await window.databases.deleteDocument(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.RATINGS_TABLE,
                        dbDocumentId
                    );
                    console.log('âœ… Review deleted from database');
                }
                
                // Remove from local reviews
                reviews = reviews.filter(r => r.id !== reviewId);
                saveReviews();
                updateRatingDisplay();
                renderReviews();
                
                // Close modal and show success
                cancelDeleteModal();
                showMobileFeedback('Review deleted successfully!', 'success');
                
            } catch (error) {
                console.error('âŒ Error deleting review:', error);
                showMobileFeedback('Failed to delete review. Please try again.', 'error');
                
                // Reset button
                deleteButton.textContent = originalText;
                deleteButton.disabled = false;
            }
        }

        // Update review function
        async function updateReview(reviewId) {
            const review = reviews.find(r => r.id === reviewId);
            if (!review) return;
            
            // Check if user owns this review
            if (review.userId && window.currentUserId && review.userId !== window.currentUserId) {
                showMobileFeedback('You can only edit your own reviews', 'error');
                return;
            }
            
            // Show mobile-friendly edit modal
            showEditModal(review);
        }
        
        // Delete review function
        async function deleteReview(reviewId) {
            const review = reviews.find(r => r.id === reviewId);
            if (!review) return;
            
            // Check if user owns this review
            if (review.userId && window.currentUserId && review.userId !== window.currentUserId) {
                showMobileFeedback('You can only delete your own reviews', 'error');
                return;
            }
            
            // Show mobile-friendly delete modal
            showDeleteModal(review);
        }

        function renderReviews() {
            const container = document.querySelector('#view-rating .flex.flex-col.gap-4');
            if (!container) return;

            container.innerHTML = '';
            
            reviews.slice().reverse().forEach(review => {
                const reviewElement = document.createElement('div');
                reviewElement.className = 'flex flex-col gap-6 mb-6';
                
                // Determine display name: "You" for current user, actual name for others
                const displayName = (review.userId && window.currentUserId && review.userId === window.currentUserId) 
                    ? 'You' 
                    : (review.actualName || review.name);
                
                const stars = 'â˜…'.repeat(review.rating) + 'â˜†'.repeat(5 - review.rating);
                const dateStr = review.date && typeof review.date.toLocaleDateString === 'function' 
                    ? review.date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    })
                    : 'Unknown date';
                
                const timeStr = review.date && typeof review.date.toLocaleTimeString === 'function'
                    ? review.date.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    })
                    : 'Unknown time';
                
                reviewElement.innerHTML = `
                    <div class="flex flex-row gap-4">
                        <div class="rounded-full border flex-shrink-0"
                            style="height: 63px; width: 63px; background-color: #292B2F99; border-color: #DADADA;">
                            <div class="w-full h-full rounded-full flex items-center justify-center text-white text-xl font-bold">
                                ${displayName.charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div class="flex flex-col justify-between py-1 flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0 pr-3">
                                    <span class="text-white font-medium text-lg block">${displayName}</span>
                                    <div class="flex flex-row gap-2 mt-1 flex-wrap items-center">
                                        <div class="flex flex-row gap-1">
                                            <span class="text-white text-base">${stars}</span>
                                        </div>
                                        <span class="text-white text-sm whitespace-nowrap">${dateStr} ${timeStr}</span>
                                    </div>
                                </div>
                                ${review.userId && window.currentUserId && review.userId === window.currentUserId ? `
                                    <div class="flex gap-2 flex-shrink-0">
                                        <button onclick="updateReview('${review.id}')" 
                                                class="px-3 py-1 rounded-lg text-sm font-medium bg-blue-500/20 border border-blue-500/40 text-blue-300 hover:bg-blue-500/30 transition-colors whitespace-nowrap">
                                            Edit
                                        </button>
                                        <button onclick="deleteReview('${review.id}')" 
                                                class="px-3 py-1 rounded-lg text-sm font-medium bg-red-500/20 border border-red-500/40 text-red-300 hover:bg-red-500/30 transition-colors whitespace-nowrap">
                                            Delete
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="w-full rounded-[12px] p-2"
                        style="height: 90px; background-color: #292B2FCC;">
                        <p class="text-white px-5 py-2 text-lg font-normal">
                            ${review.comment}
                        </p>
                    </div>
                    ${review.tags && review.tags.length > 0 ? `
                        <div class="flex flex-row gap-2">
                            ${review.tags.map(tag => `
                                <span class="px-3 py-1 rounded-full text-sm font-medium" 
                                      style="background-color: #40444B; color: white;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(reviewElement);
            });
        }

        function setStarRating(rating) {
            currentRating = rating;
            updateStarDisplay();
            
            // Show tags when rating is selected
            const tagsContainer = document.getElementById('ratingTags');
            if (rating > 0) {
                tagsContainer.classList.remove('hidden');
            }
        }

        function updateStarDisplay() {
            const stars = document.querySelectorAll('#staticRatingStars .star-rating-btn svg path');
            stars.forEach((star, index) => {
                if (index < currentRating) {
                    star.setAttribute('fill', 'gold');
                } else {
                    star.setAttribute('fill', '#666');
                }
            });
        }

        function toggleStaticRatingStars() {
            const starsContainer = document.getElementById('staticRatingStars');
            const tagsContainer = document.getElementById('ratingTags');
            
            // Toggle stars visibility
            starsContainer.classList.toggle('hidden');
            
            // Show tags if stars are visible AND a rating is selected
            if (!starsContainer.classList.contains('hidden') && currentRating > 0) {
                tagsContainer.classList.remove('hidden');
            } else {
                tagsContainer.classList.add('hidden');
            }
        }

        // Map Functions
        function initMap() {
            const coords = window.currentCompany?.coordinates || currentCompany.coordinates;
            console.log('ðŸ—ºï¸ Initializing map with coordinates:', coords);
            
            map = L.map('scheduleMap', {
                zoomControl: false,
                attributionControl: false
            }).setView([coords.lat, coords.lng], 14);
            
            // Expose map globally for consistent access
            window.map = map;

            currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: ' OpenStreetMap contributors, CARTO',
                maxZoom: 19
            }).addTo(map);

            const companyIcon = L.divIcon({
                className: 'custom-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            companyMarker = L.marker([coords.lat, coords.lng], {
                icon: companyIcon
            }).addTo(map);
            
            // Expose marker globally
            window.companyMarker = companyMarker;

            companyMarker.bindPopup(`
                <div class="p-2">
                    <h3 class="font-semibold text-white mb-1">${window.currentCompany?.name || currentCompany.name}<span class="material-symbols-outlined ${getVerifiedIconClass(window.currentCompany?.verification_tier || 2)}" style="font-size: 16px; margin-left: 2px;">verified</span></h3>
                    <p class="text-gray-300 text-sm mb-2">${window.currentCompany?.location || currentCompany.location}</p>
                    <button onclick="callCompany()" class="text-[#3B74FF] text-sm hover:underline">Call Now</button>
                </div>
            `);

            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            const userIcon = L.divIcon({
                                className: 'user-location-marker',
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            });

                            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                                icon: userIcon
                            }).addTo(map);

                            userMarker.bindPopup(`
                                <div class="p-2">
                                    <h3 class="font-semibold text-white mb-1">Your Location</h3>
                                    <p class="text-gray-300 text-sm">Current position</p>
                                </div>
                            `);
                        },
                        (error) => {
                            // console.log('Location access denied');
                        }
                    );
                }
            }

            getUserLocation();
        }

        function zoomInMap() {
            if (map) map.zoomIn();
        }

        function zoomOutMap() {
            if (map) map.zoomOut();
        }

        function callCompany() {
            const phone = window.currentCompany?.phone || currentCompany.phone;
            if (phone) {
                console.log('ðŸ“ž Calling phone:', phone);
                window.location.href = `tel:${phone}`;
            } else {
                console.log('âš ï¸ No phone number available');
            }
        }
        
        function openCompanyWebsite() {
            const website = window.currentCompany?.website;
            if (website) {
                console.log('ðŸŒ Opening website:', website);
                // Ensure URL has protocol
                let url = website;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank');
            } else {
                console.log('âš ï¸ No website available');
            }
        }
        
        function updateMapLocation(lat, lng, name) {
            if (!map || !companyMarker) return;
            
            console.log('ðŸ—ºï¸ Updating map location:', { lat, lng, name });
            
            // Smoothly move the map center to the new location, keep current zoom
            const zoomLevel = map.getZoom() || 14;
            map.flyTo([lat, lng], zoomLevel, { duration: 0.5 });
            
            // Update marker position
            companyMarker.setLatLng([lat, lng]);
            
            // Update popup content
            companyMarker.setPopupContent(`
                <div class="p-2">
                    <h3 class="font-semibold text-white mb-1">${name || 'Company'}<span class="material-symbols-outlined ${getVerifiedIconClass(window.currentCompany?.verification_tier || 2)}" style="font-size: 16px; margin-left: 2px;">verified</span></h3>
                    <p class="text-gray-300 text-sm mb-2">${window.currentCompany?.location || 'Location'}</p>
                    <button onclick="callCompany()" class="text-[#3B74FF] text-sm hover:underline">Call Now</button>
                </div>
            `);
            
            // Invalidate size to ensure correct rendering after any DOM/layout changes
            map.invalidateSize();
        }
        
        // Geocoding function to convert location text to coordinates
        async function geocodeLocation(locationText) {
            try {
                console.log('ðŸ—ºï¸ Geocoding location:', locationText);
                
                // Normalize and bias the query toward Ghana for better accuracy
                const raw = (locationText || '').trim();
                const normalized = raw.replace(/\s+/g, ' ').replace(/-/g, ' ');
                const hasGhana = /ghana/i.test(normalized);
                const hasAccra = /accra/i.test(normalized);
                const queryPrimary = hasGhana ? normalized : (hasAccra ? `${normalized}, Ghana` : `${normalized}, Accra, Ghana`);
                
                // First attempt: restrict to Ghana and limit results
                // Use the Express server on port 3000 which has the /api/geocode endpoint
                let url = `http://127.0.0.1:3000/api/geocode?q=${encodeURIComponent(queryPrimary)}`;
                let response = await fetch(url);
                let data = await response.json();
                
                // Fallback attempt: if no result, try with just Ghana
                if (!data || data.length === 0) {
                    const queryFallback = `${normalized}, Ghana`;
                    url = `http://127.0.0.1:3000/api/geocode?q=${encodeURIComponent(queryFallback)}`;
                    response = await fetch(url);
                    data = await response.json();
                }
                
                if (data && data.length > 0) {
                    const result = data[0];
                    const coords = {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    };
                    console.log('âœ… Geocoding successful:', coords);
                    return coords;
                } else {
                    console.log('âš ï¸ Geocoding failed, using default coordinates');
                    return { lat: 5.6037, lng: -0.1870 }; // Default Accra coordinates
                }
            } catch (error) {
                console.error('âŒ Geocoding error:', error);
                return { lat: 5.6037, lng: -0.1870 }; // Default Accra coordinates
            }
        }

        function toggleMapType() {
            if (!map || !currentTileLayer) return;
            
            map.removeLayer(currentTileLayer);
            
            isSatelliteView = !isSatelliteView;
            
            if (isSatelliteView) {
                currentTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Â© Esri',
                    maxZoom: 19
                });
            } else {
                currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: 'Â© OpenStreetMap contributors, Â© CARTO',
                    maxZoom: 19
                });
            }
            
            currentTileLayer.addTo(map);
        }

        function openTermsOfService() {
            document.getElementById('termsModal').classList.remove('hidden');
        }

        function closeTermsModal() {
            document.getElementById('termsModal').classList.add('hidden');
        }
        
        // Debug function to check social media status
        window.checkSocialMediaStatus = function() {
            console.log('=== ðŸ“± SOCIAL MEDIA STATUS DEBUG ===');
            console.log('1. Current company social media data:');
            console.log('   window.currentCompanySocialMedia:', window.currentCompanySocialMedia);
            console.log('2. Full branch data object:');
            console.log('   window.currentCompany:', window.currentCompany);
            if (window.currentCompany && window.currentCompany.social_media) {
                console.log('   Raw social_media from branch:', window.currentCompany.social_media);
            }
            console.log('3. Social media DOM elements:');
            const container = document.querySelector('.flex.flex-row.justify-center.items-center.overflow-x-auto.hide-scrollbar');
            if (container) {
                const icons = container.querySelectorAll('div[onclick*="showSocialModal"]');
                icons.forEach((icon, i) => {
                    console.log(`   Icon ${i + 1}:`, {
                        onclick: icon.getAttribute('onclick'),
                        'data-social-url': icon.getAttribute('data-social-url'),
                        'data-social-platform': icon.getAttribute('data-social-platform')
                    });
                });
            } else {
                console.log('   Social media container not found!');
            }
            console.log('====================================');
        };
        
        // Make social media checker available in console
        console.log('ðŸ’¡ Tip: Run "window.checkSocialMediaStatus()" in console to debug social media issues');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.remove('dark-theme', 'gray-theme', 'light-theme');
            document.body.classList.add(savedTheme + '-theme');

            setSubView('schedule');
            
            loadReviews();
            updateRatingDisplay();
            renderReviews();
            
            setCurrentDay();
            
            // Map will be initialized by initializeMapWhenReady() after company data loads
            // Removed inline initMap() call to avoid initializing before company data is available

            selectRecipientType('you');
            
            selectTermsOption('schedule');
            
            const addressField = document.getElementById('recipientAddress');
            if (addressField) {
                addressField.addEventListener('input', saveUserAddress);
            }
            
            loadUserProfileData();
            
            // Add mobile touch support for Schedule Pickup button
            const schedulePickupBtn = document.getElementById('schedulePickupBtn');
            if (schedulePickupBtn) {
                // Handle both click and touch events
                schedulePickupBtn.addEventListener('click', openScheduleBottomSheet);
                schedulePickupBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // Prevent default touch behavior
                    openScheduleBottomSheet();
                }, { passive: false });
                
                console.log('Schedule Pickup button event listeners added');
            }
        });
    </script>
    <script>
        // Branch data fetching for schedule.html
        async function fetchBranchDataForSchedule() {
            try {
                // Get branch_id from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                let branchId = urlParams.get('branch_id');
                
                if (!branchId) {
                    console.warn('No branch_id found in URL parameters');
                    return;
                }
                
                console.log(' Fetching branch data for branch_id:', branchId);
                
                // Force refresh to get fresh data from database (bypass cache)
                console.log(' Forcing data refresh from database...');
                const companyData = await window.companyDataManager.refreshCompanyData();
                
                console.log(' Searching for branch_id:', branchId);
                console.log(' Data type of branchId:', typeof branchId);
                console.log(' Length of branchId:', branchId.length);
                
                let branchData = null;
                
                // Try multiple search approaches
                for (let i = 0; i < companyData.length; i++) {
                    const branch = companyData[i];
                    console.log(` Checking branch ${i + 1}:`);
                    console.log(`  - branch_id: "${branch.branch_id}" (type: ${typeof branch.branch_id}, length: ${branch.branch_id.length})`);
                    console.log(`  - branch_name: "${branch.branch_name}"`);
                    
                    // Try exact match
                    if (branch.branch_id === branchId) {
                        branchData = branch;
                        console.log(' Found exact match!');
                        break;
                    }
                    
                    // Try string conversion match (in case of type issues)
                    if (String(branch.branch_id) === String(branchId)) {
                        branchData = branch;
                        console.log(' Found string conversion match!');
                        break;
                    }
                }
                
                // If not found, try to auto-correct common wrong IDs
                if (!branchData) {
                    console.log(' Branch not found, attempting auto-correction...');
                    
                    // Map of common wrong IDs to correct ones
                    const idCorrections = {
                        '68b8cb454e339050f5b0': '68b8cb42defcefb9507b', // One piece
                        '694c82027fceaf9bd962': '694c82005940d48eecae', // YAQSON HQ
                    };
                    
                    if (idCorrections[branchId]) {
                        const correctId = idCorrections[branchId];
                        console.log(` Auto-correcting ID: ${branchId} â†’ ${correctId}`);
                        
                        // Update URL without page reload
                        const newUrl = `${window.location.pathname}?branch_id=${correctId}`;
                        window.history.replaceState({}, '', newUrl);
                        
                        // Search again with correct ID
                        for (let i = 0; i < companyData.length; i++) {
                            const branch = companyData[i];
                            if (branch.branch_id === correctId) {
                                branchData = branch;
                                console.log(' Found branch after auto-correction!');
                                break;
                            }
                        }
                    }
                }
                
                if (!branchData) {
                    console.error(' Branch not found with branch_id:', branchId);
                    console.log(' Available branch IDs:');
                    companyData.forEach((branch, index) => {
                        console.log(`  ${index + 1}. branch_id: "${branch.branch_id}" - branch_name: "${branch.branch_name}"`);
                    });
                    return;
                }
                
                console.log(' Found branch data:', branchData);
                
                // Update HTML elements with branch data
                await updateBranchDataInHTML(branchData);
                
            } catch (error) {
                console.error(' Error fetching branch data:', error);
            }
        }
        
        async function updateBranchDataInHTML(branchData) {
            // 1. Update header image for banner
            const bannerImage = document.getElementById('shopBannerImage');
            const bannerPlaceholder = document.getElementById('bannerPlaceholder');
            
            if (branchData.header_image && bannerImage) {
                bannerImage.src = branchData.header_image;
                bannerImage.style.display = 'block';
                if (bannerPlaceholder) {
                    bannerPlaceholder.style.display = 'none';
                }
                console.log(' Updated banner image:', branchData.header_image);
            } else {
                // Hide banner image and show placeholder if no header_image
                if (bannerImage) {
                    bannerImage.style.display = 'none';
                }
                if (bannerPlaceholder) {
                    bannerPlaceholder.style.display = 'flex';
                }
            }
            
            // 2. Update profile image
            const profileImage = document.getElementById('shopProfileImage');
            const profilePlaceholder = document.getElementById('profilePlaceholder');
            
            if (branchData.profile_image && profileImage) {
                profileImage.src = branchData.profile_image;
                profileImage.style.display = 'block';
                if (profilePlaceholder) {
                    profilePlaceholder.style.display = 'none';
                }
                console.log(' Updated profile image:', branchData.profile_image);
            } else {
                // Hide profile image and show placeholder if no profile_image
                if (profileImage) {
                    profileImage.style.display = 'none';
                }
                if (profilePlaceholder) {
                    profilePlaceholder.style.display = 'flex';
                }
            }
            
            // 3. Update company name and location
            const companyNameElement = document.getElementById('companyName');
            const companyNameLoader = document.getElementById('companyNameLoader');
            const locationElement = document.getElementById('companyLocation');
            const locationLoader = document.getElementById('locationLoader');
            
            // Hide loaders and show content
            if (companyNameLoader) companyNameLoader.classList.add('hidden');
            if (locationLoader) locationLoader.classList.add('hidden');
            if (companyNameElement) companyNameElement.classList.remove('hidden');
            if (locationElement) locationElement.classList.remove('hidden');
            
            if (companyNameElement && branchData.branch_name) {
                const companyNameText = document.getElementById('companyNameText');
                if (companyNameText) {
                    companyNameText.textContent = branchData.branch_name;
                    console.log(' Updated company name:', branchData.branch_name);
                }
            }
            
            // Update verification badge with tier-based styling
            const verifiedBadge = document.getElementById('verifiedBadge');
            if (verifiedBadge) {
                // Get verification tier from branch data
                const verificationTier = branchData.verification_tier || 2; // Default to tier2
                const iconClass = getVerifiedIconClass(verificationTier);
                
                // Remove all existing verified classes
                verifiedBadge.classList.remove('verified-checkmark', 'verified-checkmark-tier2', 'verified-checkmark-tier3');
                // Add the appropriate tier class
                verifiedBadge.classList.add(iconClass);
                
                console.log(`âœ… Updated verified badge for ${branchData.branch_name}: tier ${verificationTier} -> ${iconClass}`);
            } else {
                console.log('âŒ verifiedBadge element not found!');
            }
            
            if (locationElement && branchData.location) {
                locationElement.textContent = branchData.location;
                console.log(' Updated location:', branchData.location);
            }
            
            // 4. Update description with email
            const descriptionText = document.getElementById('descriptionText');
            const descriptionLoader = document.getElementById('descriptionLoader');
            const descriptionContainer = document.getElementById('descriptionContainer');
            
            // Hide loader and show content
            if (descriptionLoader) descriptionLoader.classList.add('hidden');
            if (descriptionContainer) descriptionContainer.classList.remove('hidden');
            
            if (descriptionText) {
                // Combine description and email with || separator
                let descriptionContent = branchData.description || 'No description available';
                if (branchData.email) {
                    descriptionContent += ` || ${branchData.email}`;
                }
                descriptionText.textContent = descriptionContent;
                console.log(' Updated description with email');
            }
            
            // 6. Update website and phone data
            const websiteButton = document.getElementById('websiteButton');
            if (websiteButton) {
                if (branchData.website) {
                    websiteButton.style.display = 'flex';
                    console.log(' Website available:', branchData.website);
                } else {
                    websiteButton.style.display = 'none';
                    console.log(' No website available, hiding button');
                }
            }
            
            // Update contact popup phone number
            const contactPopupPhone = document.getElementById('contactPopupPhone');
            if (contactPopupPhone && branchData.phone_number) {
                contactPopupPhone.textContent = branchData.phone_number;
                console.log(' Updated contact popup phone:', branchData.phone_number);
            } else {
                console.log(' No phone number available for contact popup');
            }
            
            // Update global currentCompany object with database values
            window.currentCompany = {
                ...window.currentCompany,
                company_id: branchData.company_id,
                branch_id: branchData.branch_id,
                phone: branchData.phone_number,
                website: branchData.website,
                name: branchData.branch_name,
                location: branchData.location,
                email: branchData.email,
                is_verified: branchData.is_verified || false, // Add verification status
                // Use coordinates from branchData (already computed by companyDataManager)
                coordinates: branchData.coordinates || {
                    lat: 5.6037,
                    lng: -0.1870
                }
            };
            console.log(' Updated company contact info - Phone:', branchData.phone_number, 'Website:', branchData.website);
            console.log('ðŸ” Full branchData object for debugging:', branchData);
            console.log('ðŸ” Coordinates from branchData:', branchData.coordinates);
            console.log(' Updated company coordinates:', window.currentCompany.coordinates);
            
            // Initialize working hours display
            initializeWorkingHours();
            
            // Update map with new coordinates if map is initialized
            if (map) {
                // Use the coordinates already set in window.currentCompany
                const coords = window.currentCompany.coordinates;
                console.log('ðŸ—ºï¸ Updating map with coordinates:', coords);
                
                updateMapLocation(coords.lat, coords.lng, branchData.branch_name);
            }
            
            // 6. Update social media links
            await updateSocialMediaLinks(branchData);
            
            // 7. Update working days and hours
            updateWorkingDaysFromDB(branchData);
            
            // 8. Fetch products for this branch
            await fetchProductsForCurrentBranch();
            
            // 9. Initialize the map with company location
            console.log('ðŸ—ºï¸ Company data loaded, attempting to initialize map');
            initializeMapWhenReady();
        }
        
        // Update social media links - use social_media data from branchData
        async function updateSocialMediaLinks(branchData) {
            console.log('ðŸ” Checking social media fields in branchData:', branchData);
            console.log('ðŸ“± Social media data from branchData.social_media:', branchData.social_media);
            
            try {
                // Use social media data that's already been fetched with company data
                const socialMediaData = branchData.social_media || [];
                console.log('ðŸ“± Social media data array:', socialMediaData);
                
                if (socialMediaData.length > 0) {
                    // If social media data exists as an array, use the first item or merge all
                    const socialData = socialMediaData.length === 1 ? socialMediaData[0] : 
                        socialMediaData.reduce((merged, item) => ({...merged, ...item}), {});
                    
                    console.log('ðŸ“± Raw socialData object:', socialData);
                    console.log('ðŸ“± Available fields in socialData:', Object.keys(socialData));
                    
                    // Log each field individually
                    console.log('ðŸ“± Facebook field:', socialData.facebook, socialData.facebook_url);
                    console.log('ðŸ“± Instagram field:', socialData.instagram, socialData.instagram_url);
                    console.log('ðŸ“± Twitter field:', socialData.twitter, socialData.twitter_url);
                    console.log('ðŸ“± LinkedIn field:', socialData.linkedIn, socialData.linkedin_url);
                    console.log('ðŸ“± Discord field:', socialData.discord, socialData.discord_url);
                    console.log('ðŸ“± WhatsApp field:', socialData.whatsapp, socialData.whatsapp_url);
                    
                    const socialPlatforms = {
                        'Facebook': socialData.facebook || socialData.facebook_url || '',
                        'Instagram': socialData.instagram || socialData.instagram_url || '',
                        'Twitter': socialData.twitter || socialData.twitter_url || '',
                        'LinkedIn': socialData.linkedIn || socialData.linkedin_url || '',
                        'Discord': socialData.discord || socialData.discord_url || '',
                        'WhatsApp': socialData.whatsapp || socialData.whatsapp_url || ''
                    };
                    
                    console.log('ðŸ“± Social media URLs found:', socialPlatforms);
                    
                    // Store social media data in window for global access
                    window.currentCompanySocialMedia = socialPlatforms;
                    console.log('âœ… Social media data stored in window.currentCompanySocialMedia:', window.currentCompanySocialMedia);
                    
                    // Update each social media icon click handler using data attributes for reliability
                    Object.keys(socialPlatforms).forEach(platform => {
                        const socialUrl = socialPlatforms[platform];
                        
                        // Find all social media icon containers
                        const socialMediaContainer = document.querySelector('.flex.flex-row.justify-center.items-center.overflow-x-auto.hide-scrollbar');
                        if (socialMediaContainer) {
                            // Get all icon divs within the social media container
                            const allIcons = socialMediaContainer.querySelectorAll('div[onclick*="showSocialModal"]');
                            
                            // Find the icon that matches this platform by checking the onclick attribute
                            allIcons.forEach(icon => {
                                if (icon.getAttribute('onclick').includes(platform)) {
                                    // Store the URL as a data attribute for reference
                                    icon.setAttribute('data-social-url', socialUrl);
                                    icon.setAttribute('data-social-platform', platform);
                                    
                                    if (socialUrl && socialUrl.trim()) {
                                        // If URL exists, open it directly
                                        icon.setAttribute('onclick', `window.open('${socialUrl}', '_blank')`);
                                        icon.style.cursor = 'pointer';
                                        console.log(`âœ… ${platform}: Direct link set to ${socialUrl}`);
                                    } else {
                                        // If no URL, show the unavailable modal
                                        icon.setAttribute('onclick', `showSocialModal('${platform}')`);
                                        console.log(`âš ï¸ ${platform}: No link available, showing modal`);
                                    }
                                }
                            });
                        }
                    });
                } else {
                    console.log('ðŸ“± No social media data found for this branch');
                    // Show empty modal for all platforms
                    ['Facebook', 'Instagram', 'Twitter', 'LinkedIn', 'Discord', 'WhatsApp'].forEach(platform => {
                        const socialMediaContainer = document.querySelector('.flex.flex-row.justify-center.items-center.overflow-x-auto.hide-scrollbar');
                        if (socialMediaContainer) {
                            const allIcons = socialMediaContainer.querySelectorAll('div[onclick*="showSocialModal"]');
                            allIcons.forEach(icon => {
                                if (icon.getAttribute('onclick').includes(platform)) {
                                    icon.setAttribute('onclick', `showSocialModal('${platform}')`);
                                    icon.setAttribute('data-social-url', '');
                                    icon.setAttribute('data-social-platform', platform);
                                }
                            });
                        }
                    });
                    // Store empty social media data
                    window.currentCompanySocialMedia = {
                        'Facebook': '',
                        'Instagram': '',
                        'Twitter': '',
                        'LinkedIn': '',
                        'Discord': '',
                        'WhatsApp': ''
                    };
                }
            } catch (error) {
                console.error(' Error processing social media data:', error);
            }
        }
        
        // Update working days from database
        function updateWorkingDaysFromDB(branchData) {
            console.log('ðŸ• Working days data from branchData:', branchData.working_days);
            console.log('ðŸ• Raw working days data:', JSON.stringify(branchData.working_days, null, 2));
            
            // Hide working hours loader and show content
            const workingHoursLoader = document.getElementById('workingHoursLoader');
            const workingHoursContent = document.getElementById('workingHoursContent');
            if (workingHoursLoader) workingHoursLoader.classList.add('hidden');
            if (workingHoursContent) workingHoursContent.classList.remove('hidden');
            
            // Get working days data from branchData - it should be an array from the database
            let workingDays = {};
            
            if (branchData.working_days && Array.isArray(branchData.working_days)) {
                // Convert array format to object format for easier access
                workingDays = {};
                branchData.working_days.forEach((day, index) => {
                    console.log(`ðŸ• Processing day ${index}:`, day);
                    
                    if (day.day && day.time) {
                        console.log(`ðŸ• Day ${day.day} has time: ${day.time}`);
                        
                        // Parse time format like "8:00 AM - 6:00 PM"
                        const timeMatch = day.time.match(/(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/i);
                        if (timeMatch) {
                            const dayKey = day.day.toLowerCase();
                            workingDays[dayKey] = {
                                open: timeMatch[1],
                                close: timeMatch[2],
                                isOpen: true,
                                originalTime: day.time // Keep original for debugging
                            };
                            console.log(`ðŸ• Successfully parsed ${day.day}: ${timeMatch[1]} - ${timeMatch[2]}`);
                        } else {
                            // Try other formats like "8:00 - 18:00"
                            const simpleTimeMatch = day.time.match(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/);
                            if (simpleTimeMatch) {
                                const dayKey = day.day.toLowerCase();
                                workingDays[dayKey] = {
                                    open: simpleTimeMatch[1],
                                    close: simpleTimeMatch[2],
                                    isOpen: true,
                                    originalTime: day.time
                                };
                                console.log(`ðŸ• Successfully parsed ${day.day} (simple format): ${simpleTimeMatch[1]} - ${simpleTimeMatch[2]}`);
                            } else {
                                console.log(`ðŸ• Failed to parse time for ${day.day}: "${day.time}"`);
                            }
                        }
                    } else {
                        console.log(`ðŸ• Day ${index} missing day or time field:`, day);
                    }
                });
            } else if (branchData.workingHours) {
                workingDays = branchData.workingHours;
                console.log('ðŸ• Using workingHours from branchData');
            } else if (typeof branchData.working_days === 'object') {
                workingDays = branchData.working_days;
                console.log('ðŸ• Using working_days as object');
            }
            
            console.log('ðŸ• Processed working days:', workingDays);
            console.log('ðŸ• Final working days JSON:', JSON.stringify(workingDays, null, 2));
            
            // Update the currentCompany object with new working hours
            if (window.currentCompany) {
                window.currentCompany.workingHours = workingDays;
                console.log('ðŸ• Updated window.currentCompany.workingHours');
            }
            
            // Update the working days select and display (only call once)
            updateWorkingHours();
            
            // Only set current day once to prevent duplication
            if (!window.currentDaySet) {
                setCurrentDay();
                window.currentDaySet = true;
            }
            
            console.log(' Updated working days from database:', workingDays);
        }
        
        // Initialize branch data fetching when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any cached company data to force fresh fetch
            if (window.companyDataManager) {
                window.companyDataManager.lastFetchTime = null;
                window.companyDataManager.companies = [];
                window.companyDataManager.branches = [];
                window.companyDataManager.workingDays = [];
            }
            
            // Clear any localStorage cache
            localStorage.removeItem('companyDataCache');
            localStorage.removeItem('branchesCache');
            
            // Wait a bit for company data manager to be ready
            setTimeout(() => {
                fetchBranchDataForSchedule();
                
                // Also start a fallback timer to initialize map if data loads
                if (!mapInitializationTimer) {
                    mapInitializationTimer = setInterval(() => {
                        if (window.currentCompany && window.currentCompany.coordinates) {
                            initializeMapWhenReady();
                        }
                    }, 300); // Check every 300ms
                    
                    // Stop checking after 30 seconds
                    setTimeout(() => {
                        if (mapInitializationTimer) {
                            clearInterval(mapInitializationTimer);
                            mapInitializationTimer = null;
                        }
                    }, 30000);
                }
            }, 1500); // Increased delay to ensure everything is loaded
        });
    </script>
    <script src="js/notifications.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>

        <!-- Pay on Delivery Confirmation Modal -->
        <div id="payOnDeliveryModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-icon warning">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                </div>
                
                <h3 class="modal-title">IMPORTANT NOTICE</h3>
                
                <div class="modal-message">
                    <p>Companies will receive your order request immediately.</p>
                    <p class="modal-subtitle">By selecting "Pay on Delivery", you confirm that:</p>
                    
                    <ul class="modal-list">
                        <li>You will pay the full amount upon delivery</li>
                        <li>Your order will be processed immediately</li>
                        <li>You are committed to receiving and paying for this order</li>
                    </ul>
                </div>
                
                <div class="modal-actions">
                    <button onclick="cancelPayOnDelivery()" class="modal-btn cancel">
                        Cancel
                    </button>
                    <button onclick="confirmPayOnDelivery()" class="modal-btn confirm">
                        I Understand
                    </button>
                </div>
            </div>
        </div>

    <!-- Service Fee Payment Modal -->
    <div id="serviceFeePaymentModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-icon" style="background: rgba(59, 116, 255, 0.2); border: 2px solid rgba(59, 116, 255, 0.4); color: #3B74FF;">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
            </div>
            
            <h3 class="modal-title" style="color: #3B74FF;">Pay Service Fee</h3>
            
            <div class="modal-message">
                <p>Please pay the service fee to continue with your order.</p>
                <div style="background: rgba(59, 116, 255, 0.1); border: 1px solid rgba(59, 116, 255, 0.2); border-radius: 12px; padding: 16px; margin: 16px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: var(--text-secondary); font-size: 14px;">Service Fee Amount:</span>
                        <span id="serviceFeeAmountDisplay" style="color: #3B74FF; font-weight: 600; font-size: 18px;">GHS 0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary); font-size: 14px;">Remaining Balance (Pay on Delivery):</span>
                        <span id="remainingBalanceDisplay" style="color: var(--text-main); font-weight: 600; font-size: 16px;">GHS 0.00</span>
                    </div>
                </div>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">
                    <strong>Note:</strong> Only the service fee is required now. The remaining amount will be paid upon delivery.
                </p>
            </div>
            
            <div class="modal-actions">
                <button onclick="cancelServiceFeePayment()" class="modal-btn cancel">
                    Cancel
                </button>
                <button onclick="payServiceFeeWithPaystack()" class="modal-btn confirm" style="background: rgba(59, 116, 255, 0.2); color: #3B74FF; border: 1px solid rgba(59, 116, 255, 0.4);">
                    Pay Service Fee
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal -->
    <div id="paymentProcessingModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-icon" style="background: rgba(251, 146, 60, 0.2); border: 2px solid rgba(251, 146, 60, 0.4); color: #FB923C;">
                <div class="animate-spin" style="border: 3px solid rgba(251, 146, 60, 0.3); border-top: 3px solid #FB923C; border-radius: 50%; width: 32px; height: 32px; margin: 16px auto;"></div>
            </div>
            
            <h3 class="modal-title" style="color: #FB923C;">Processing Payment</h3>
            
            <div class="modal-message">
                <p>Please wait while we process your service fee payment...</p>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">Do not close this window.</p>
            </div>
        </div>
    </div>

    </body>

    </html>
