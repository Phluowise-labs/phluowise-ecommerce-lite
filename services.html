<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TRV3R43NQZ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-TRV3R43NQZ');
    </script>
    <title>Phluowise - Services</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007ACC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Phluowise">

    <!-- Error Handler - Load First to Catch External Service Errors -->
    <script src="js/errorHandler.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=verified" />
    <link rel="stylesheet" href="css/notifications.css" />
    <link rel="stylesheet" href="css/mobile-responsive.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007ACC',
                        tabActive: '#3B74FF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --input-field-second: #40444B66;
            --input-field-second-border: #808080;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --btn-second-color: #F57D7D4D;
            --btn-second-border: #F57D7D;
            --modal-bg: #101010;
            --modal-border: #DADADA;
            --text-main: #FFFFFF;
            --text-secondary: #9BA1A6;
        }

        body.dark-theme {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --input-field-second: #40444B66;
            --input-field-second-border: #808080;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --btn-second-color: #F57D7D4D;
            --btn-second-border: #F57D7D;
            --modal-bg: #101010;
            --modal-border: #DADADA;
            --text-main: #FFFFFF;
            --text-secondary: #9BA1A6;
        }

        body.gray-theme {
            --bg-color: #202225;
            --bg-second: #40444B;
            --bg-third: #292B2F;
            --header-bg: #292B2F;
            --tab-bg: #292B2F;
            --input-field-second: #40444B;
            --input-field-second-border: #40444B;
            --btn-color: #007ACC;
            --btn-border: #007ACC;
            --btn-second-color: #F57D7D;
            --btn-second-border: #F57D7D;
            --modal-bg: #40444B;
            --modal-border: #40444B;
            --text-main: #E0E0E0;
            --text-secondary: #A0A0A0;
        }

        body.light-theme {
            --bg-color: #202225;
            --bg-second: #40444B;
            --bg-third: #292B2F;
            --header-bg: #292B2F;
            --tab-bg: #292B2F;
            --input-field-second: #40444B;
            --input-field-second-border: #40444B;
            --btn-color: #007ACC;
            --btn-border: #007ACC;
            --btn-second-color: #F57D7D;
            --btn-second-border: #F57D7D;
            --modal-bg: #40444B;
            --modal-border: #40444B;
            --text-main: #212529;
            --text-secondary: #6C757D;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
        }

        .header-bar {
            background-color: var(--header-bg);
        }

        .tab-bar {
            background-color: var(--tab-bg);
        }

        .card-bg {
            background-color: var(--bg-second);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Swiper Navigation Buttons */
        .swiper-btn {
            width: 60px;
            height: 60px;
            background-color: var(--bg-second);
            border: 1px solid var(--input-field-second-border);
        }

        /* Material Symbols Styles */
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .verified-checkmark {
            color: #FFD700;
            font-size: 20px;
            margin-left: 4px;
            vertical-align: middle;
        }

        .verified-checkmark-tier2 {
            color: #3B74FF;
            font-size: 20px;
            margin-left: 4px;
            vertical-align: middle;
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .verified-checkmark-tier3 {
            color: #FFD700;
            font-size: 20px;
            margin-left: 4px;
            vertical-align: middle;
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .search-container:focus-within {
            border-color: #3B74FF !important;
            box-shadow: 0 0 0 1px #3B74FF !important;
        }

        .product-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .product-item.selected {
            border-color: #3B74FF !important;
            box-shadow: 0 0 0 2px rgba(59, 116, 255, 0.3) !important;
        }

        .product-item.selected::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(59, 116, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 116, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-item.selected::before {
            content: '';
            position: absolute;
            top: 9px;
            right: 9px;
            width: 6px;
            height: 10px;
            border-left: 2px solid white;
            border-bottom: 2px solid white;
            transform: rotate(-45deg);
        }

        /* Schedule Bottom Sheet Styles */
        .step-content {
            display: block;
        }

        .step-content.hidden {
            display: none;
        }

        /* Rating Stars Styling */
        .rating-star {
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4B5563;
        }

        .rating-star:hover {
            transform: scale(1.1);
            color: #FCD34D;
        }

        .rating-star.text-yellow-400 {
            color: #FCD34D;
        }

        /* Payment Method Buttons */
        .payment-method-btn {
            transition: all 0.3s ease;
        }

        .payment-method-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .payment-method-radio {
            transition: all 0.3s ease;
        }

        /* Progress Bar Animation */
        @keyframes progress {
            0% {
                width: 0%;
            }

            100% {
                width: 100%;
            }
        }

        /* Hide scrollbar for bottomsheet */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Bottom sheet animation classes */
        .bottom-sheet-container {
            background: rgba(29, 29, 31, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .bottom-sheet-container.active {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet-content {
            background: rgba(29, 29, 31, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px 28px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.3);
        }

        .bottom-sheet-content.active {
            transform: translateY(0);
        }

        .sheet-drag-handle {
            width: 40px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 0 auto 16px auto;
        }

        .section-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .section-subheader {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .form-input {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-main);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            transition: all 0.2s ease;
            font-size: 18px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .form-textarea {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-main);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            transition: all 0.2s ease;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .quantity-control {
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .quantity-display {
            font-size: 48px;
            font-weight: 700;
            color: var(--text-main);
            margin: 20px 0;
            min-width: 80px;
            text-align: center;
        }

        .quantity-btn {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-main);
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .quantity-btn:active {
            transform: translateY(0);
        }

        .price-display {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .price-row.total {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 16px;
            margin-top: 8px;
        }

        .price-label {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .price-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
        }

        .price-value.total {
            font-size: 24px;
            font-weight: 700;
            color: #3B74FF;
        }

        .review-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .review-section {
            margin-bottom: 20px;
        }

        .review-section:last-child {
            margin-bottom: 0;
        }

        .review-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .review-value {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-main);
        }

        .payment-method-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .payment-method-card:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 116, 255, 0.5);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .payment-method-card.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .payment-method-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .payment-method-icon.mobile {
            background-color: rgba(34, 197, 94, 0.15);
            color: #10B981;
        }

        .payment-method-icon.delivery {
            background-color: rgba(251, 146, 60, 0.15);
            color: #FB923C;
        }

        .payment-check {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: rgba(59, 116, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 116, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .payment-method-card.selected .payment-check {
            opacity: 1;
        }

        .processing-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3B74FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .rating-stars-container {
            display: flex;
            gap: 8px;
            margin: 24px 0;
        }

        .rating-star-large {
            font-size: 36px;
            color: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-star-large.selected {
            color: #FCD34D;
            transform: scale(1.1);
        }

        .rating-star-large:hover {
            color: #FCD34D;
            transform: scale(1.2);
        }

        .step-navigation {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-btn {
            flex: 1;
            padding: 20px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn.prev {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .nav-btn.prev:hover {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav-btn.next {
            background: rgba(59, 116, 255, 0.2);
            color: white;
            border: 1px solid rgba(59, 116, 255, 0.4);
        }

        .nav-btn.next:hover {
            background: rgba(59, 116, 255, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 116, 255, 0.3);
        }

        .nav-btn.pay {
            background: rgba(16, 185, 129, 0.2);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .nav-btn.pay:hover {
            background: rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .nav-btn.done {
            background: rgba(59, 116, 255, 0.2);
            color: white;
            border: 1px solid rgba(59, 116, 255, 0.4);
        }

        .nav-btn.done:hover {
            background: rgba(59, 116, 255, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 116, 255, 0.3);
        }

        .terms-container {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .terms-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 12px;
        }

        .terms-list li {
            padding: 12px 0;
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.5;
            position: relative;
            padding-left: 24px;
        }

        .terms-list li:before {
            content: "•";
            color: #3B74FF;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 20px;
        }

        .toggle-label {
            font-size: 18px;
            color: var(--text-main);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #3B74FF;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(30px);
        }

        .info-card {
            background: linear-gradient(135deg, rgba(59, 116, 255, 0.1) 0%, rgba(59, 116, 255, 0.05) 100%);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(59, 116, 255, 0.2);
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            color: #3B74FF;
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 24px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3B74FF 0%, #2563EB 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* New styles for requested features */
        .recipient-type-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .recipient-type-btn {
            flex: 1;
            padding: 20px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recipient-type-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .recipient-type-btn.active {
            background-color: rgba(59, 116, 255, 0.15);
            border-color: #3B74FF;
            color: #3B74FF;
        }

        .business-type-container {
            margin-top: 16px;
        }

        .business-name-container {
            margin-top: 16px;
        }

        .business-type-select {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-main);
            padding: 16px 20px;
            border-radius: 12px;
            width: 100%;
            font-size: 18px;
            cursor: pointer;
        }

        .business-type-select:focus {
            outline: none;
            border-color: #3B74FF;
            box-shadow: 0 0 0 3px rgba(59, 116, 255, 0.15);
        }

        .delivery-info-note {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            color: #F59E0B;
            font-size: 16px;
            line-height: 1.5;
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 12px;
            color: #EF4444;
            font-size: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 12px;
            color: #10B981;
            font-size: 16px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .product-card:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .product-card.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .product-image {
            width: 100%;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 12px;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: #3B74FF;
        }

        .selected-products-container {
            margin-top: 24px;
        }

        .selected-product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .selected-product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .selected-product-image-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background-color: #40444B;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .selected-product-details {
            flex: 1;
        }

        .selected-product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .selected-product-price {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .selected-product-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn-small {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-main);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .quantity-display-small {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .delivery-instructions {
            margin-top: 20px;
        }

        .instructions-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .instructions-example {
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 12px;
        }

        .review-product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .review-product-details {
            flex: 1;
        }

        .review-product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
        }

        .review-product-price {
            font-size: 16px;
            color: #3B74FF;
            font-weight: 600;
        }

        .mobile-payment-note {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            color: #10B981;
            font-size: 16px;
        }

        .step-indicator-container {
            padding: 8px 0 24px 0;
            margin-bottom: 8px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: none;
        }

        .step-indicator-line {
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        .step-indicator-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
        }

        .step-indicator-item {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .step-indicator-item.active {
            background-color: #3B74FF;
            color: white;
            border-color: #3B74FF;
            box-shadow: 0 4px 12px rgba(59, 116, 255, 0.3);
        }

        .step-indicator-item.completed {
            background: rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(16, 185, 129, 0.4);
        }

        .step-indicator-item.default {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .step-indicator-name {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .step-indicator-item.active .step-indicator-name {
            color: #3B74FF;
            font-weight: 600;
        }

        .step-indicator-item.completed .step-indicator-name {
            color: #10B981;
        }

        .service-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .add-more-btn {
            background-color: rgba(59, 116, 255, 0.1);
            border: 1px solid #3B74FF;
            color: #3B74FF;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-more-btn:hover {
            background-color: rgba(59, 116, 255, 0.2);
            transform: translateY(-1px);
        }

        .no-products-selected {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 18px;
        }

        .product-item-quantity {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(59, 116, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 116, 255, 0.4);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .swipe-product-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            background-color: #292B2F;
            border-radius: 10px;
        }

        .swipe-product-item.selected {
            border-color: #3B74FF !important;
            box-shadow: 0 0 0 2px rgba(59, 116, 255, 0.3) !important;
        }

        .terms-radio-container {
            margin-bottom: 24px;
        }

        .terms-radio-item {
            margin-bottom: 16px;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .terms-radio-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .terms-radio-item.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .terms-radio-label {
            display: flex;
            align-items: center;
            font-size: 18px;
            color: var(--text-main);
            font-weight: 500;
        }

        .terms-radio-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .terms-radio-item.selected .terms-radio-circle {
            border-color: #3B74FF;
            background-color: #3B74FF;
        }

        .terms-radio-item.selected .terms-radio-circle::after {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: white;
        }

        .terms-details {
            margin-top: 8px;
            padding-left: 36px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .saved-recipients-container {
            margin-top: 20px;
        }

        .saved-recipient-item {
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .saved-recipient-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .saved-recipient-item.selected {
            border-color: #3B74FF;
            background-color: rgba(59, 116, 255, 0.1);
        }

        .saved-recipient-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .saved-recipient-info {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .delete-recipient-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #EF4444;
            border-radius: 6px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-recipient-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .recipient-content {
            cursor: pointer;
            padding-right: 40px;
            /* Space for delete button */
        }

        .you-recipient-info {
            background-color: rgba(59, 116, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 116, 255, 0.2);
        }

        .you-recipient-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .you-recipient-item:last-child {
            border-bottom: none;
        }

        .you-recipient-label {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .you-recipient-value {
            font-size: 16px;
            color: var(--text-main);
            font-weight: 500;
        }

        /* Date and Time Selection Styles */
        .datetime-container {
            margin-top: 20px;
        }

        .datetime-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .datetime-input {
            flex: 1;
        }

        .time-slots-container {
            margin-top: 20px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .time-slot-btn {
            padding: 16px 8px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .time-slot-btn.selected {
            background-color: rgba(59, 116, 255, 0.15);
            border-color: #3B74FF;
            color: #3B74FF;
        }

        .time-slot-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive bottom sheet */
        @media (max-width: 640px) {
            .bottom-sheet-content {
                width: 100%;
                max-width: 100%;
                border-radius: 24px 24px 0 0;
            }

            .section-header {
                font-size: 22px;
            }

            .section-subheader {
                font-size: 16px;
            }

            .form-input,
            .form-textarea,
            .business-type-select {
                font-size: 16px;
                padding: 14px 16px;
            }

            .recipient-type-btn {
                padding: 16px 8px;
                font-size: 14px;
            }

            .nav-btn {
                padding: 16px 20px;
                font-size: 16px;
            }

            .time-slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .datetime-row {
                flex-direction: column;
                gap: 12px;
            }
        }

        @media (min-width: 641px) and (max-width: 768px) {
            .bottom-sheet-content {
                width: 90%;
                max-width: 500px;
            }
        }

        @media (min-width: 769px) {
            .bottom-sheet-content {
                width: 400px;
                max-width: 400px;
            }
        }

        /* Sliding Menu Styles */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sliding-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 400px;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .sliding-menu.active {
            right: 0;
        }

        /* Pay on Delivery Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(29, 29, 31, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 32px 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .modal-icon.warning {
            background: rgba(251, 146, 60, 0.2);
            border: 2px solid rgba(251, 146, 60, 0.4);
            color: #FB923C;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #FB923C;
            text-align: center;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-message {
            color: var(--text-main);
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .modal-message p {
            margin-bottom: 12px;
        }

        .modal-subtitle {
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 16px;
            margin-bottom: 12px;
        }

        .modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .modal-list li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        .modal-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #FB923C;
            font-weight: bold;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .modal-btn.confirm {
            background: rgba(251, 146, 60, 0.2);
            color: #FB923C;
            border: 1px solid rgba(251, 146, 60, 0.4);
        }

        .modal-btn.confirm:hover {
            background: rgba(251, 146, 60, 0.3);
            transform: translateY(-2px);
        }

        /* Mobile responsive adjustments */
        @media (max-width: 480px) {
            .modal-overlay {
                padding: 16px;
            }

            .modal-content {
                padding: 24px 20px;
                margin: 0;
            }

            .modal-title {
                font-size: 18px;
            }

            .modal-message {
                font-size: 15px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }
    </style>
</head>

<body class="dark-theme h-screen flex flex-col overflow-hidden">

    <!-- Top Header Bar (height: 110px) -->
    <div class="header-bar w-full h-[110px] flex flex-row items-center justify-between px-5">
        <!-- Greeting Text -->
        <div class="flex-1">
            <h1 id="greetingText" class="text-white text-lg font-medium truncate max-w-[250px]">
                Greetings...
            </h1>
        </div>

        <!-- Menu Button (Hamburger) -->
        <button onclick="toggleMenu()"
            class="relative rounded-full flex items-center justify-center h-[45px] w-[45px] border-[0.5px] border-[#808080] bg-[#40444B4D] hover:bg-[#40444B] transition-colors">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <line x1="4" y1="6" x2="20" y2="6" />
                <line x1="4" y1="12" x2="20" y2="12" />
                <line x1="4" y1="18" x2="20" y2="18" />
            </svg>
        </button>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto hide-scrollbar pb-[70px]" style="background-color: var(--bg-color);">
        <!-- Menu Overlay -->
        <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
        <!-- Sliding Menu -->
        <div class="sliding-menu" id="slidingMenu">
            <!-- Avatar Section -->
            <div class="flex flex-col items-center justify-center gap-4 py-6">
                <!-- Profile Image Container -->
                <div class="relative flex items-center justify-center rounded-full border-[0.5px] border-[#292B2F]"
                    style="height: 110px; width: 110px; background-color: #292B2F;">
                    <img src="images/main/ProfileImage.png" class="w-[62px] h-[62px] object-contain" alt="Profile">

                    <!-- Edit Button -->
                    <button onclick="openProfileImagePicker()"
                        class="absolute rounded-full flex items-center justify-center"
                        style="top: 2px; right: 0; height: 38px; width: 38px; background-color: #40444B;">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>

                    <!-- Hidden file input -->
                    <input type="file" id="profileImageInput" accept="image/*" style="display: none;"
                        onchange="handleProfileImageChange(event)">
                </div>

                <!-- User Name -->
                <h2 id="menuUserName" class="text-white text-xl font-semibold">Phluowiser</h2>
                <p id="menuUserEmail" class="text-[#808080] text-base">loading...</p>
            </div>

            <!-- Menu Content -->
            <div class="p-4">
                <div class="rounded-[15px] overflow-hidden border-[0.5px]" style="border-color: #DADADA;">

                    <!-- History -->
                    <a href="schedule-history.html" onclick="navigateToPage('schedule-history.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span class="text-white text-lg font-semibold">History</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- About -->
                    <a href="about.html" onclick="navigateToPage('about.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">About</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- Report -->
                    <a href="report.html" onclick="navigateToPage('report.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Report</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- Theme -->
                    <button onclick="openThemeModal()"
                        class="w-full h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Theme</span>
                        </div>
                        <div class="py-2 px-4 rounded-[5px]" style="background-color: #FFFFFF1A;">
                            <span id="currentThemeDisplay" class="capitalize text-white text-sm font-medium">Dark</span>
                        </div>
                    </button>

                    <!-- Profile -->
                    <a href="profile.html" onclick="navigateToPage('profile.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Profile</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- Delete Account -->
                    <button onclick="showDeleteConfirm()"
                        class="w-full h-[60px] flex flex-row justify-between items-center px-6"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Delete Account</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>

                    <!-- Visit Website -->
                    <a href="https://phluowise.com" target="_blank"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-t border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Visit us on our website</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                </div>

                <!-- Logout Button -->
                <button onclick="logout()"
                    class="mt-4 h-[62px] w-full rounded-[15px] flex flex-row justify-between items-center px-6 shadow-md"
                    style="background-color: #1D1D1D;">
                    <div class="flex flex-row items-center gap-[30px]">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span class="text-white text-lg font-semibold">Logout</span>
                    </div>
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- Version -->
            <div class="flex flex-col items-center gap-2 mt-4 pb-8">
                <span class="text-lg font-semibold text-[#808080]">Phluowise</span>
                <span class="text-xs font-medium text-white">version 1.0.0</span>
            </div>
        </div>

        <!-- Search & Filter Row (SearchService + FillterService) -->
        <div class="flex flex-row px-8 justify-center py-2 gap-2 items-center">
            <!-- Search Service (92% width, h=42px, border-radius=100px) -->
            <div class="search-container h-[42px] mt-3 border rounded-[100px] flex flex-row items-center px-8 gap-4"
                style="width: 92%; background-color: var(--input-field-second); border-color: var(--input-field-second-border);">
                <input type="text" id="searchInput" placeholder="Search"
                    class="bg-transparent border-none outline-none text-white text-xl font-medium placeholder-white"
                    style="height: 42px; width: 90%;" oninput="handleSearch()">
                <div>
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>

            <!-- Filter Toggle Button (48x44px, bg #292B2F, border-radius 10px) -->
            <button id="toggleViewBtn" onclick="toggleView()"
                class="mt-2 flex items-center justify-center rounded-[10px]"
                style="height: 48px; width: 44px; background-color: #292B2F;">
                <svg id="toggleIcon" class="w-7 h-6" fill="none" stroke="#FFFFFF" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>

        <!-- Services List (ServiceList.tsx) -->
        <div id="listView" class="flex flex-col gap-8 px-[25px] mt-[15px] mb-20">
            <!-- Service cards will be dynamically loaded here from database -->
        </div>

        <!-- Swipe View (hidden by default) -->
        <div id="swipeView" class="px-[25px] hidden relative" style="height: 560px;">
            <!-- Swipe Container -->
            <div id="swipeContainer" class="relative w-full h-full">
                <!-- Single Card Display -->
                <div id="swipeCard" class="card-bg w-full h-full rounded-[20px] overflow-hidden shadow-lg relative">
                    <!-- Content will be injected by JS -->
                </div>
            </div>

            <!-- Navigation Buttons -->
            <button onclick="prevCard()"
                class="swiper-btn absolute left-[-10px] top-1/2 transform -translate-y-1/2 rounded-full flex items-center justify-center border z-10">
                <svg class="w-5 h-5" fill="none" stroke="white" viewBox="0 0 24 24" style="transform: rotate(180deg);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            <button onclick="nextCard()"
                class="swiper-btn absolute right-[-10px] top-1/2 transform -translate-y-1/2 rounded-full flex items-center justify-center border z-10">
                <svg class="w-5 h-5" fill="none" stroke="white" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

    </div>

    <!-- Bottom Tab Navigation Bar (3 Tabs - height: 64px) -->
    <div
        class="tab-bar fixed bottom-0 left-0 right-0 h-[64px] flex flex-row justify-around items-center px-4 border-t-0">

        <!-- Home Tab -->
        <a href="home.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path
                    d="M9.02 2.84004L3.63 7.04004C2.73 7.74004 2 9.23004 2 10.36V17.77C2 20.09 3.89 21.99 6.21 21.99H17.79C20.11 21.99 22 20.09 22 17.78V10.5C22 9.29004 21.19 7.74004 20.2 7.05004L14.02 2.72004C12.62 1.74004 10.37 1.79004 9.02 2.84004Z"
                    stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 17.99V14.99" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Home</span>
        </a>

        <!-- Services Tab (Active) -->
        <a href="services.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="#3B74FF" stroke-width="1.5">
                <path fill="#3B74FF"
                    d="m31.696 15.098-1.75-4.376a1.742 1.742 0 0 0-1.625-1.1H23.75V8.376a.75.75 0 0 0-.75-.75H4a1.75 1.75 0 0 0-1.75 1.75v14A1.75 1.75 0 0 0 4 25.125h2.325a3.75 3.75 0 0 0 7.35 0h6.65a3.75 3.75 0 0 0 7.35 0H30a1.75 1.75 0 0 0 1.75-1.75v-8a.752.752 0 0 0-.054-.277Zm-7.946-3.973h4.573a.25.25 0 0 1 .232.158l1.337 3.342H23.75v-3.5Zm-20-1.75a.25.25 0 0 1 .25-.25h18.25v8.5H3.75v-8.25ZM10 26.625a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm10.325-3h-6.65a3.75 3.75 0 0 0-7.35 0H4a.25.25 0 0 1-.25-.25v-4.25h18.5v1.935a3.763 3.763 0 0 0-1.925 2.565Zm3.675 3a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm6.25-3.25a.25.25 0 0 1-.25.25h-2.325a3.756 3.756 0 0 0-3.675-3c-.084 0-.168 0-.25.009v-4.509h6.5v7.25Z" />
            </svg>
            <span class="text-sm text-[#3B74FF] font-normal mt-1">Services</span>
        </a>

        <!-- Schedule History Tab -->
        <a href="schedule-history.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path d="M8 2V5" />
                <path d="M16 2V5" />
                <path d="M3.5 9.09H20.5" />
                <path
                    d="M18.2 21.4C19.9673 21.4 21.4 19.9673 21.4 18.2C21.4 16.4327 19.9673 15 18.2 15C16.4327 15 15 16.4327 15 18.2C15 19.9673 16.4327 21.4 18.2 21.4Z" />
                <path d="M22 22L21 21" />
                <path
                    d="M21 8.5V13.63C20.27 13.14 19.38 12.85 18.43 12.85C15.86 12.85 13.78 14.95 13.78 17.54C13.78 18.45 14.04 19.29 14.49 20H8C4.5 20 3 18 3 15V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Schedule History</span>
        </a>

    </div>

    <!-- Schedule Flow Bottom Sheet (Improved UI) -->
    <div id="scheduleFlowSheet"
        class="bottom-sheet-container fixed inset-0 z-[10002] flex items-end justify-center pointer-events-none">

        <!-- Content (Improved Design) -->
        <div id="scheduleFlowContent" class="bottom-sheet-content w-full max-w-[400px] flex flex-col relative"
            style="height: 85vh;">

            <!-- Drag Handle -->
            <div class="sheet-drag-handle"></div>

            <!-- Step Indicators (Hidden as requested) -->
            <div class="step-indicator-container" style="display: none;">
                <div class="step-indicator-line"></div>
                <div class="step-indicator-wrapper px-6">
                    <div id="stepTermsIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Terms</span>
                    </div>
                    <div id="stepRecipientIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Recipient</span>
                    </div>
                    <div id="stepQuantityIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Quantity</span>
                    </div>
                    <div id="stepReviewIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Review</span>
                    </div>
                    <div id="stepPaymentIndicator" class="step-indicator-item default">
                        <span class="step-indicator-name">Payment</span>
                    </div>
                </div>
            </div>

            <!-- Close Button -->
            <button onclick="closeScheduleFlow()"
                class="absolute top-4 right-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.2)] transition-colors">
                <span class="text-white text-2xl">×</span>
            </button>

            <!-- Error Message Container -->
            <div id="errorMessage" class="error-message mx-6"></div>

            <!-- Success Message Container -->
            <div id="successMessage" class="success-message mx-6"></div>

            <!-- Step Content Container -->
            <div class="flex-1 overflow-y-auto hide-scrollbar px-6 pt-4">

                <!-- Step 1: Terms of Service (Radio Button Style) -->
                <div id="termsStep" class="step-content">
                    <h3 class="section-header">Terms of Service</h3>
                    <p class="section-subheader">Please select your order type:</p>

                    <div class="terms-radio-container">
                        <div onclick="selectTermsOption('schedule')" class="terms-radio-item selected"
                            id="termsSchedule">
                            <div class="terms-radio-label">
                                <div class="terms-radio-circle"></div>
                                Schedule Order
                            </div>
                            <div class="terms-details">
                                Place an order for future delivery. Orders must be scheduled at least 2 hours in
                                advance.
                            </div>
                        </div>

                        <div onclick="selectTermsOption('immediate')" class="terms-radio-item" id="termsImmediate">
                            <div class="terms-radio-label">
                                <div class="terms-radio-circle"></div>
                                Immediate Order
                            </div>
                            <div class="terms-details">
                                Order for immediate delivery. Subject to availability and current delivery conditions.
                            </div>
                        </div>
                    </div>

                    <div class="terms-container">
                        <p class="info-text">
                            By continuing you agree to our <a href="about.html" onclick="navigateToPage('about.html')"
                                class="text-blue-400 hover:text-blue-300 underline">terms of service</a>
                        </p>
                    </div>
                </div>

                <!-- Step 2: Order Recipient -->
                <div id="orderRecipientStep" class="step-content hidden">
                    <h3 class="section-header">Order Recipient</h3>
                    <p class="section-subheader">Who is this order for?</p>

                    <div class="recipient-type-container">
                        <button onclick="selectRecipientType('you')" class="recipient-type-btn active"
                            id="recipientYou">You</button>
                        <button onclick="selectRecipientType('individual')" class="recipient-type-btn"
                            id="recipientIndividual">Individual</button>
                        <button onclick="selectRecipientType('business')" class="recipient-type-btn"
                            id="recipientBusiness">Business</button>
                    </div>

                    <!-- Saved Recipients Toggle -->
                    <div class="toggle-container">
                        <span class="toggle-label">Save this for future orders</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="saveRecipientToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Saved Recipients (if any) -->
                    <div id="savedRecipientsContainer" class="saved-recipients-container hidden">
                        <p class="section-subheader">Select saved recipient:</p>
                        <div id="savedRecipientsList">
                            <!-- Saved recipients will be dynamically added here -->
                        </div>
                    </div>

                    <div class="form-container space-y-6">
                        <!-- You recipient info display -->
                        <div id="youRecipientInfo" class="you-recipient-info">
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Name:</span>
                                <span id="youNameDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Phone:</span>
                                <span id="youPhoneDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Email:</span>
                                <span id="youEmailDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                            <div class="you-recipient-item">
                                <span class="you-recipient-label">Delivery Address:</span>
                                <span id="youAddressDisplay" class="you-recipient-value">Loading...</span>
                            </div>
                        </div>

                        <!-- Business Type Selector (hidden by default) -->
                        <div id="businessTypeContainer" class="business-type-container hidden">
                            <label class="form-label">Business Type</label>
                            <select id="businessType" class="business-type-select">
                                <option value="">Select Business Type</option>
                                <option value="school">School/Educational Institution</option>
                                <option value="hospital">Hospital/Clinic</option>
                                <option value="hotel">Hotel/Restaurant</option>
                                <option value="office">Office/Corporate</option>
                                <option value="church">Church/Religious Institution</option>
                                <option value="ngo">NGO/Non-Profit</option>
                                <option value="government">Government Agency</option>
                                <option value="factory">Factory/Manufacturing</option>
                                <option value="construction">Construction Site</option>
                                <option value="other">Other Business</option>
                            </select>
                        </div>

                        <!-- Name field (hidden for "You" type) -->
                        <div id="recipientNameContainer" class="hidden">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="recipientName" class="form-input" placeholder="Enter recipient name">
                        </div>

                        <!-- Business Name Field (hidden by default, shown only for business type) -->
                        <div id="businessNameContainer" class="business-name-container hidden">
                            <label class="form-label">Business Name</label>
                            <input type="text" id="businessName" class="form-input" placeholder="Enter business name">
                        </div>

                        <!-- Phone field (hidden for "You" type) -->
                        <div id="recipientPhoneContainer" class="hidden">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="recipientPhone" class="form-input" placeholder="Enter phone number">
                        </div>

                        <!-- Email field (hidden for "You" type) -->
                        <div id="recipientEmailContainer" class="hidden">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="recipientEmail" class="form-input"
                                placeholder="Enter email address">
                        </div>

                        <!-- Delivery Address (always shown) -->
                        <div>
                            <label class="form-label">Delivery Address *</label>
                            <textarea id="recipientAddress" rows="3" class="form-textarea"
                                placeholder="Full address or detailed location (e.g: 5th Floor, Block B, Ring Road)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Date and Time Selection -->
                <div id="datetimeStep" class="step-content hidden">
                    <h3 class="section-header">Select Date & Time</h3>
                    <p class="section-subheader">Choose when you want your order delivered</p>

                    <!-- Company Working Hours Display -->
                    <div id="workingHoursDisplay" class="info-card mb-4" style="display: none;">
                        <div class="info-title">Working Hours</div>
                        <div id="workingHoursText" class="info-text"></div>
                    </div>

                    <div class="form-container space-y-6">
                        <div class="datetime-row">
                            <div class="datetime-input">
                                <label class="form-label">Delivery Date</label>
                                <input type="date" id="deliveryDate" class="form-input" min="">
                            </div>
                            <div class="datetime-input">
                                <label class="form-label">Delivery Time</label>
                                <select id="deliveryTime" class="form-input">
                                    <option value="">Select Time</option>
                                </select>
                            </div>
                        </div>

                        <div class="time-slots-container">
                            <label class="form-label">Popular Time Slots</label>
                            <div class="time-slots-grid" id="timeSlotsGrid">
                                <!-- Time slots will be dynamically generated -->
                            </div>
                        </div>

                        <div class="info-card">
                            <div class="info-title">Important Note</div>
                            <div class="info-text">
                                Orders must be scheduled at least 2 hours in advance. Same-day delivery is subject to
                                availability.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Product Quantity Selection (Multiple Products) -->
                <div id="quantityStep" class="step-content hidden">
                    <div class="service-products-header">
                        <h3 class="section-header">Select Products</h3>
                        <button onclick="addMoreProducts()" class="add-more-btn">
                            + Add More
                        </button>
                    </div>
                    <p class="section-subheader">Adjust quantities for your selected products</p>

                    <!-- Selected Products Container -->
                    <div class="selected-products-container" id="selectedProductsContainer">
                        <!-- Selected products from service cards will appear here -->
                    </div>

                    <!-- Delivery Instructions -->
                    <div class="delivery-instructions">
                        <div class="instructions-title">Add additional Information</div>
                        <div class="instructions-example">Example: "Please Call Me On 024XXXXXXXX When You Arrive At The
                            Main Gate. The Security Guard Will Direct You."</div>
                        <textarea id="deliveryInstructions" rows="3" class="form-textarea"
                            placeholder="Enter delivery instructions..."></textarea>
                    </div>

                    <!-- Delivery Fee Information -->
                    <div class="delivery-info-note">
                        <strong>Please Note:</strong> Delivery Fees Are Charged By The Water Company, Not Phluowise.
                        Payment Must Be Made Upon Delivery To Confirm Receipt.
                    </div>

                    <!-- Price Summary -->
                    <div class="price-display mt-6">
                        <div class="price-row">
                            <span class="price-label">Subtotal</span>
                            <span id="quantitySubtotal" class="price-value">GHS 0.00</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">Service Fee (GHS 0.2 per item)</span>
                            <span id="serviceFeeDisplay" class="price-value">GHS 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">Total Amount</span>
                            <span id="quantityTotal" class="price-value total">GHS 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Order Review -->
                <div id="orderReviewStep" class="step-content hidden">
                    <h3 class="section-header">Review Your Order</h3>

                    <!-- Order Summary -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Order Summary</h4>
                            <div id="reviewProductsList">
                                <!-- Products will be dynamically added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Information -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Delivery Information</h4>
                            <div class="review-item">
                                <span class="review-label">Date:</span>
                                <span id="reviewDeliveryDate" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Time:</span>
                                <span id="reviewDeliveryTime" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Address:</span>
                                <span id="reviewDeliveryAddress" class="review-value"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Instructions -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Delivery Instructions</h4>
                            <div class="review-value" id="reviewDeliveryInstructions">None provided</div>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="review-card">
                        <div class="review-section">
                            <h4 class="review-section-title">Payment Summary</h4>
                            <div class="review-item">
                                <span class="review-label">Subtotal</span>
                                <span id="reviewSubtotal" class="review-value">GHS 0.00</span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Service Fee (GHS 0.2 per item)</span>
                                <span id="reviewServiceFee" class="review-value">GHS 0.00</span>
                            </div>
                            <div class="review-item"
                                style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
                                <span class="review-label">Total Amount</span>
                                <span id="reviewTotal" class="review-value"
                                    style="color: #3B74FF; font-weight: 600;">GHS 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Fee Note -->
                    <div class="delivery-info-note">
                        <strong>Please Note:</strong> Delivery Fees Are Charged By The Water Company, Not Phluowise.
                        Payment Must Be Made Upon Delivery To Confirm Receipt.
                    </div>
                </div>

                <!-- Step 6: Payment -->
                <div id="selectPaymentStep" class="step-content hidden">
                    <h3 class="section-header">Payment Method</h3>
                    <p class="section-subheader">Select your preferred payment method</p>

                    <!-- Mobile Money -->
                    <div class="payment-method-card disabled"
                        style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">
                        <div class="payment-method-icon mobile">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div class="payment-method-name">Mobile Money</div>
                        <div class="payment-method-desc">MTN, Vodafone, AirtelTigo</div>
                        <div class="payment-check">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Pay on Delivery -->
                    <div onclick="selectPaymentMethod('delivery')" class="payment-method-card"
                        style="margin-top: 16px;">
                        <div class="payment-method-icon delivery">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="payment-method-name">Pay on Delivery</div>
                        <div class="payment-method-desc">Pay when you receive your order</div>
                        <div class="payment-check">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>

                    <div class="mobile-payment-note">
                        You will receive a prompt on your mobile phone to complete the payment, or pay when you receive
                        your order.
                    </div>
                </div>

                <!-- Step 7: Input Payment Details (Mobile Money Only) -->
                <div id="paymentDetailsStep" class="step-content hidden">
                    <h3 class="section-header">Mobile Money Details</h3>

                    <div class="form-container space-y-4">
                        <div>
                            <label class="form-label">Mobile Network</label>
                            <select id="mobileNetwork" class="form-input">
                                <option value="">Select Network</option>
                                <option value="mtn">MTN Mobile Money</option>
                                <option value="vodafone">Vodafone Cash</option>
                                <option value="airteltigo">AirtelTigo Money</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="mobileNumber" class="form-input" placeholder="0201234567">
                        </div>
                    </div>
                </div>

                <!-- Step 8: Payment Confirmation Processing -->
                <div id="paymentProcessingStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="processing-spinner"></div>
                        <h3 class="section-header mb-2">Processing Payment</h3>
                        <p class="section-subheader">Please wait while we process your payment securely...</p>
                        <div class="progress-bar-container">
                            <div id="paymentProgressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 9: Payment Success -->
                <div id="paymentSuccessStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="success-icon">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-2">Payment Successful!</h3>
                        <p class="section-subheader mb-6">Your payment has been processed successfully</p>
                        <div class="review-card w-full">
                            <div class="review-item">
                                <span class="review-label">Transaction ID:</span>
                                <span id="transactionIdDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Amount Paid:</span>
                                <span id="amountPaidDisplay" class="review-value" style="color: #10B981;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 10: Schedule Pickup Sent & Rate Phluowise -->
                <div id="scheduleSentStep" class="step-content hidden">
                    <div class="flex flex-col items-center h-full text-center">
                        <div class="success-icon"
                            style="background: rgba(59, 116, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 2px solid rgba(59, 116, 255, 0.4); margin-bottom: 24px;">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-2">Schedule Pickup Sent!</h3>
                        <p class="section-subheader mb-6">Your order has been successfully scheduled and confirmed</p>

                        <div class="review-card w-full mb-6">
                            <h4 class="review-section-title mb-4">Order Summary</h4>
                            <div class="review-item">
                                <span class="review-label">Order ID:</span>
                                <span id="orderIdDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Date:</span>
                                <span id="orderDateDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Time:</span>
                                <span id="orderTimeDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Total Items:</span>
                                <span id="orderItemsDisplay" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Status:</span>
                                <span class="review-value" style="color: #10B981;">Confirmed</span>
                            </div>
                        </div>

                        <!-- Download PDF Button -->
                        <div class="w-full mb-6">
                            <button onclick="downloadOrderPDF()"
                                class="w-full py-4 rounded-lg backdrop-blur-xl bg-[#007ACC]/20 border border-[#007ACC]/40 text-white font-medium hover:bg-[#007ACC]/30 transition-all duration-300 shadow-lg flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Download Order PDF
                            </button>
                        </div>

                        <!-- Rating Section -->
                        <div class="w-full">
                            <h4 class="review-section-title mb-4">Rate Phluowise</h4>
                            <p class="section-subheader mb-6">How was your experience with our service?</p>

                            <div class="rating-stars-container">
                                <div onclick="setRating(1)" class="rating-star-large">☆</div>
                                <div onclick="setRating(2)" class="rating-star-large">☆</div>
                                <div onclick="setRating(3)" class="rating-star-large">☆</div>
                                <div onclick="setRating(4)" class="rating-star-large">☆</div>
                                <div onclick="setRating(5)" class="rating-star-large">☆</div>
                            </div>

                            <textarea id="ratingComment" rows="3" class="form-textarea mt-4"
                                placeholder="Share your experience (optional)..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 11: Rating Success -->
                <div id="ratingSuccessStep" class="step-content hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="success-icon" style="width: 80px; height: 80px;">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="section-header mb-4">Thank You!</h3>
                        <p class="text-lg text-gray-300 mb-2">Your rating has been submitted</p>
                        <p class="section-subheader mb-6">We appreciate your feedback</p>

                        <div class="review-card w-full mb-6">
                            <div class="review-item">
                                <span class="review-label">Order ID:</span>
                                <span id="finalOrderId" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Delivery Date:</span>
                                <span id="finalDeliveryDate" class="review-value"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Rating:</span>
                                <span id="finalRatingStars" class="review-value"
                                    style="color: #FCD34D; font-size: 18px;"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Total Paid:</span>
                                <span id="finalTotalPaid" class="review-value" style="color: #3B74FF;"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Navigation Buttons (Improved) -->
            <div class="step-navigation px-6 pb-6">
                <button id="prevBtn" onclick="previousStep()" class="nav-btn prev hidden">
                    Back
                </button>
                <button id="nextBtn" onclick="nextStep()" class="nav-btn next">
                    Continue
                </button>
                <button id="payBtn" onclick="processPayment()" class="nav-btn pay hidden">
                    Pay Now
                </button>
                <button id="doneBtn" onclick="finishFlow()" class="nav-btn done hidden">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Pay on Delivery Confirmation Modal -->
    <div id="payOnDeliveryModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-icon warning">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>

            <h3 class="modal-title">IMPORTANT NOTICE</h3>

            <div class="modal-message">
                <p>Companies will receive your order request immediately.</p>
                <p class="modal-subtitle">By selecting "Pay on Delivery", you confirm that:</p>

                <ul class="modal-list">
                    <li>You will pay the full amount upon delivery</li>
                    <li>Your order will be processed immediately</li>
                    <li>You are committed to receiving and paying for this order</li>
                </ul>
            </div>

            <div class="modal-actions">
                <button onclick="cancelPayOnDelivery()" class="modal-btn cancel">
                    Cancel
                </button>
                <button onclick="confirmPayOnDelivery()" class="modal-btn confirm">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- Service Fee Payment Modal -->
    <div id="serviceFeePaymentModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-icon"
                style="background: rgba(59, 116, 255, 0.2); border: 2px solid rgba(59, 116, 255, 0.4); color: #3B74FF;">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
            </div>

            <h3 class="modal-title" style="color: #3B74FF;">Pay Service Fee</h3>

            <div class="modal-message">
                <p>Please pay the service fee to continue with your order.</p>
                <div
                    style="background: rgba(59, 116, 255, 0.1); border: 1px solid rgba(59, 116, 255, 0.2); border-radius: 12px; padding: 16px; margin: 16px 0;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: var(--text-secondary); font-size: 14px;">Service Fee Amount:</span>
                        <span id="serviceFeeAmountDisplay"
                            style="color: #3B74FF; font-weight: 600; font-size: 18px;">GHS 0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary); font-size: 14px;">Remaining Balance (Pay on
                            Delivery):</span>
                        <span id="remainingBalanceDisplay"
                            style="color: var(--text-main); font-weight: 600; font-size: 16px;">GHS 0.00</span>
                    </div>
                </div>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">
                    <strong>Note:</strong> Only the service fee is required now. The remaining amount will be paid upon
                    delivery.
                </p>
            </div>

            <div class="modal-actions">
                <button onclick="cancelServiceFeePayment()" class="modal-btn cancel">
                    Cancel
                </button>
                <button onclick="payServiceFeeWithPaystack()" class="modal-btn confirm"
                    style="background: rgba(59, 116, 255, 0.2); color: #3B74FF; border: 1px solid rgba(59, 116, 255, 0.4);">
                    Pay Service Fee
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal -->
    <div id="paymentProcessingModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-icon"
                style="background: rgba(251, 146, 60, 0.2); border: 2px solid rgba(251, 146, 60, 0.4); color: #FB923C;">
                <div class="animate-spin"
                    style="border: 3px solid rgba(251, 146, 60, 0.3); border-top: 3px solid #FB923C; border-radius: 50%; width: 32px; height: 32px; margin: 16px auto;">
                </div>
            </div>

            <h3 class="modal-title" style="color: #FB923C;">Processing Payment</h3>

            <div class="modal-message">
                <p>Please wait while we process your service fee payment...</p>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">Do not close this window.
                </p>
            </div>
        </div>
    </div>

    <script src="js/theme.js"></script>
    <script>
        let viewSwipe = false;
        let currentCardIndex = 0;
        let searchQuery = '';
        let userLocation = null;
        let selectedProducts = []; // Array for multiple product selection
        let currentStep = 1;
        const totalSteps = 11;
        let selectedPaymentMethod = null;
        let orderData = {
            recipient: {}, // Initialize recipient object to fix the error
            // Customer details (who placed the order) - will be populated from database
            customer: {
                id: '',
                uid: '',
                email: '',
                name: '',
                phone: '',
                type: ''
            },
            // Purchase recipient type
            purchase_recipient_type: 'you' // Default to 'you'
        };
        let userRating = 0;
        let selectedCompany = '';
        let recipientType = 'you';
        const SERVICE_FEE_PER_ITEM = 0.2; // GHS 0.2 per bag/pack/bottle
        let savedRecipients = [];
        let selectedSavedRecipient = null;
        let selectedDate = '';
        let selectedTime = '';
        let services = []; // Will be loaded from database
        let servicesDataLoaded = false;

        // Track service product selections separately
        let serviceProducts = {};

        // Load service data from database
        let loadRetryCount = 0;
        const MAX_RETRIES = 10;

        // Get verified icon CSS class based on verification tier
        function getVerifiedIconClass(tier) {
            console.log(`🔍 [DEBUG] Getting icon class for tier: ${tier}`);
            let cssClass;
            switch (tier) {
                case 2:
                    cssClass = 'verified-checkmark-tier2'; // Blue icon
                    console.log(`🔍 [DEBUG] Tier 2 -> Blue icon: ${cssClass}`);
                    break;
                case 3:
                    cssClass = 'verified-checkmark-tier3'; // Gold icon
                    console.log(`🔍 [DEBUG] Tier 3 -> Gold icon: ${cssClass}`);
                    break;
                default:
                    cssClass = 'verified-checkmark-tier2'; // Default to blue (tier2)
                    console.log(`🔍 [DEBUG] Default tier (${tier}) -> Blue icon: ${cssClass}`);
                    break;
            }
            return cssClass;
        }

        // Calculate distance and time using advanced distance calculator
        async function calculateDistanceAndTime(fromCoords, toCoords) {
            try {
                // Validate input coordinates
                if (!fromCoords || !toCoords ||
                    !fromCoords.lat || !fromCoords.lng ||
                    !toCoords.lat || !toCoords.lng ||
                    isNaN(fromCoords.lat) || isNaN(fromCoords.lng) ||
                    isNaN(toCoords.lat) || isNaN(toCoords.lng)) {
                    console.warn('❌ Invalid coordinates for distance calculation', { fromCoords, toCoords });
                    return {
                        distance: null,
                        time: 'Invalid location',
                        accuracy: 'low'
                    };
                }

                if (window.distanceCalculator) {
                    const result = await window.distanceCalculator.calculateDistanceAndTime(fromCoords, toCoords, { mode: 'driving' });
                    const distance = result.distance ? result.distance.km : null;
                    console.log(`✅ Distance API: ${distance?.toFixed(1)}km, Time: ${result.duration?.text}`);
                    return {
                        distance: distance,
                        time: result.duration ? result.duration.text : 'Unknown distance',
                        accuracy: result.accuracy || 'high'
                    };
                } else {
                    // Enhanced fallback calculation with road factors
                    const distanceKm = calculateEnhancedDistance(fromCoords, toCoords);
                    const timeEstimate = distanceKm ? generateEstimatedTime(distanceKm) : 'Unknown distance';
                    console.log(`🔄 Fallback calculation: ${distanceKm?.toFixed(1)}km, Time: ${timeEstimate}`);
                    return {
                        distance: distanceKm,
                        time: timeEstimate,
                        accuracy: 'estimated'
                    };
                }
            } catch (error) {
                console.error('❌ Distance calculation failed:', error);
                // Enhanced fallback calculation
                const distanceKm = calculateEnhancedDistance(fromCoords, toCoords);
                const timeEstimate = distanceKm ? generateEstimatedTime(distanceKm) : 'Unknown distance';
                return {
                    distance: distanceKm,
                    time: timeEstimate,
                    accuracy: 'estimated'
                };
            }
        }

        // Enhanced distance calculation with road network factors
        function calculateEnhancedDistance(fromCoords, toCoords) {
            // Validate input coordinates
            if (!fromCoords || !toCoords ||
                !fromCoords.lat || !fromCoords.lng ||
                !toCoords.lat || !toCoords.lng ||
                isNaN(fromCoords.lat) || isNaN(fromCoords.lng) ||
                isNaN(toCoords.lat) || isNaN(toCoords.lng)) {
                console.warn('❌ Invalid coordinates in calculateEnhancedDistance', { fromCoords, toCoords });
                return null;
            }

            // Calculate straight-line distance using Haversine
            const straightDistance = haversineDistance(fromCoords, toCoords);
            console.log(`📏 Straight line distance: ${straightDistance?.toFixed(1)}km`);

            // Validate the calculated distance
            if (!straightDistance || isNaN(straightDistance) || straightDistance <= 0) {
                console.warn('⚠️ Invalid distance calculated in haversine:', straightDistance);
                return null;
            }

            // Apply road network factor (1.3 for urban areas)
            const roadFactor = 1.3;
            const enhancedDistance = straightDistance * roadFactor;
            console.log(`🛣️ Enhanced distance (with ${roadFactor}x road factor): ${enhancedDistance?.toFixed(1)}km`);

            // Final validation
            if (isNaN(enhancedDistance) || enhancedDistance <= 0) {
                console.warn('⚠️ Invalid enhanced distance calculated:', enhancedDistance);
                return null;
            }

            return enhancedDistance;
        }

        // Haversine distance calculation (only for fallback)
        function haversineDistance(fromCoords, toCoords) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = toRadians(toCoords.lat - fromCoords.lat);
            const dLng = toRadians(toCoords.lng - fromCoords.lng);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRadians(fromCoords.lat)) * Math.cos(toRadians(toCoords.lat)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Convert degrees to radians
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // Generate estimated time based on distance
        function generateEstimatedTime(distanceKm) {
            // Validate input
            if (!distanceKm || isNaN(distanceKm) || distanceKm <= 0) {
                console.warn('⚠️ Invalid distance for time calculation:', distanceKm);
                return 'Unknown time';
            }

            // Ensure distanceKm is a number
            const distance = parseFloat(distanceKm);
            if (isNaN(distance) || distance <= 0) {
                console.warn('⚠️ Distance is NaN or invalid after parsing:', distance);
                return 'Unknown time';
            }

            const avgSpeed = 30; // km/h average city driving speed
            const timeMinutes = Math.round((distance / avgSpeed) * 60);

            // Validate calculated time
            if (isNaN(timeMinutes) || timeMinutes <= 0) {
                console.warn('⚠️ Calculated time is invalid:', timeMinutes);
                return 'Unknown time';
            }

            // Log the calculation for debugging
            console.log(`📋 Distance: ${distance.toFixed(1)}km → Time: ${timeMinutes}min`);

            if (timeMinutes < 5) return 'Less than 5 min';
            if (timeMinutes < 15) return `${timeMinutes} min`;
            if (timeMinutes < 60) return `${timeMinutes} min`;

            const hours = Math.floor(timeMinutes / 60);
            const minutes = timeMinutes % 60;
            return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
        }

        async function loadServiceData() {
            console.log('🔄 Loading services with web2app cache-first strategy...');

            try {
                // Check if user is authenticated
                if (!window.account && loadRetryCount < MAX_RETRIES) {
                    loadRetryCount++;
                    setTimeout(() => loadServiceData(), 1000);
                    return;
                }

                // Wait for companyDataManager to be available
                if (!window.companyDataManager && loadRetryCount < MAX_RETRIES) {
                    loadRetryCount++;
                    setTimeout(() => loadServiceData(), 500);
                    return;
                }

                // Stop retrying if max retries reached
                if (loadRetryCount >= MAX_RETRIES) {
                    console.error('❌ Max retries reached for service data loading');
                    return;
                }

                // STEP 1: Always try cache first for instant UI
                if (window.cacheManager) {
                    const cachedServices = window.cacheManager.getCache('companies'); // Use same key as home.html
                    if (cachedServices && cachedServices.length > 0) {
                        console.log('📦 Loading services from cache for instant UI:', cachedServices.length);
                        services = cachedServices;
                        servicesDataLoaded = true;

                        // Initialize serviceProducts object for each company
                        services.forEach(service => {
                            if (!serviceProducts[service.name]) {
                                serviceProducts[service.name] = [];
                            }
                        });

                        renderServices();

                        // STEP 2: Background refresh - check if cache needs update
                        setTimeout(() => refreshServicesInBackground(), 1000);
                        return;
                    }
                }

                // STEP 3: No cache available - load from database with fallback
                await loadServicesFromDatabaseWithFallback();

            } catch (error) {
                console.error('❌ Error in loadServiceData:', error);
                await loadServicesFromDatabaseWithFallback();
            }
        }

        // Background refresh for services
        async function refreshServicesInBackground() {
            if (!navigator.onLine) {
                console.log('📴 Offline - skipping services background refresh');
                return;
            }

            try {
                console.log('🔄 Background refresh - checking for new service data...');
                const freshData = await window.companyDataManager.fetchCompanyData();

                // Always check for verification tier changes, even if timestamps haven't changed
                const verificationTiersChanged = hasVerificationTiersChanged(freshData, services);

                // Check if data has changed OR verification tiers changed
                if (hasServicesChanged(freshData, services) || verificationTiersChanged) {
                    console.log('🆕 New service data or verification tiers detected - updating cache and UI');
                    services = freshData;
                    servicesDataLoaded = true;

                    // Update cache
                    if (window.cacheManager) {
                        window.cacheManager.setCache('companies', freshData);
                        console.log('💾 Services cache updated with fresh data');
                    }

                    // Re-initialize serviceProducts
                    serviceProducts = {};
                    services.forEach(service => {
                        if (!serviceProducts[service.name]) {
                            serviceProducts[service.name] = [];
                        }
                    });

                    // Update UI
                    renderServices();
                } else {
                    console.log('📊 No new service data - cache is current');
                }
            } catch (error) {
                console.error('❌ Background refresh for services failed:', error);
                // Don't show error to user - UI already working with cache
            }
        }

        // Check if verification tiers have changed between old and new data
        function hasVerificationTiersChanged(newData, oldData) {
            if (!oldData || oldData.length === 0) return true;
            if (!newData || newData.length === 0) return false;

            for (let i = 0; i < newData.length; i++) {
                const newService = newData[i];
                const oldService = oldData.find(s => s.company_id === newService.company_id);

                if (!oldService) return true; // New service found

                // Check if verification tier changed
                const newTier = newService.verification_tier || 2;
                const oldTier = oldService.verification_tier || 2;

                if (newTier !== oldTier) {
                    console.log(`🔄 Verification tier changed for ${newService.name}: ${oldTier} → ${newTier}`);
                    return true;
                }
            }

            return false;
        }

        // Check if services data has changed
        function hasServicesChanged(newData, oldData) {
            if (!oldData || oldData.length === 0) return true;
            if (!newData || newData.length === 0) return false;
            if (newData.length !== oldData.length) return true;

            // Check for updated timestamps or new services
            for (let i = 0; i < newData.length; i++) {
                const newService = newData[i];
                const oldService = oldData.find(s => s.company_id === newService.company_id);

                if (!oldService) return true; // New service found

                // Check for updates
                if (newService.$updatedAt && oldService.$updatedAt) {
                    if (newService.$updatedAt !== oldService.$updatedAt) return true;
                }
            }

            return false;
        }

        // Load services from database with multiple fallback layers
        async function loadServicesFromDatabaseWithFallback() {
            try {
                // Try database first
                console.log('📡 Loading services from database...');
                services = await window.companyDataManager.fetchCompanyData();
                servicesDataLoaded = true;

                // Cache the loaded services
                if (window.cacheManager) {
                    window.cacheManager.setCache('companies', services);
                    console.log('💾 Services cached for offline access');
                }

                // Initialize serviceProducts object for each company
                services.forEach(service => {
                    if (!serviceProducts[service.name]) {
                        serviceProducts[service.name] = [];
                    }
                });

                renderServices();
                console.log(`✅ Loaded ${services.length} services from database`);

            } catch (error) {
                console.error('❌ Database load for services failed:', error);

                // Fallback 1: Try cache manager again
                if (window.cacheManager) {
                    const cachedServices = window.cacheManager.getCache('companies');
                    if (cachedServices && cachedServices.length > 0) {
                        console.log('📦 Using cache manager as fallback for services:', cachedServices.length);
                        services = cachedServices;
                        servicesDataLoaded = true;

                        // Initialize serviceProducts object for each company
                        services.forEach(service => {
                            if (!serviceProducts[service.name]) {
                                serviceProducts[service.name] = [];
                            }
                        });

                        renderServices();
                        return;
                    }
                }

                // Fallback 2: Use companyDataManager fallback data
                console.log('🔄 Using companyDataManager fallback data for services...');
                services = window.companyDataManager.getFallbackData();
                servicesDataLoaded = true;

                // Cache fallback data
                if (window.cacheManager) {
                    window.cacheManager.setCache('companies', services);
                }

                // Initialize serviceProducts object for each company
                services.forEach(service => {
                    if (!serviceProducts[service.name]) {
                        serviceProducts[service.name] = [];
                    }
                });

                renderServices();
                console.log('⚠️ Using fallback data for services - app works offline');
            }
        }

        // Render service cards dynamically
        async function renderServices() {
            console.log('🔍 [DEBUG] renderServices() called');
            console.log('🔍 [DEBUG] Total services array length:', services.length);
            console.log('🔍 [DEBUG] Services array:', services);

            const listView = document.getElementById('listView');
            listView.innerHTML = '';

            // Calculate distances for all services if user location is available
            let servicesWithDistance = services;
            if (userLocation) {
                console.log('📍 User location available:', userLocation);
                console.log('📍 Calculating distances for', services.length, 'services...');
                servicesWithDistance = await Promise.all(
                    services.map(async (service) => {
                        if (service.coordinates && service.coordinates.lat && service.coordinates.lng) {
                            try {
                                const distanceResult = await calculateDistanceAndTime(userLocation, service.coordinates);
                                console.log(`✅ ${service.name}: Distance=${distanceResult.distance?.toFixed(1)}km, Time=${distanceResult.time}, Accuracy=${distanceResult.accuracy}`);
                                return {
                                    ...service,
                                    distance: distanceResult.distance,
                                    time: distanceResult.time,
                                    accuracy: distanceResult.accuracy
                                };
                            } catch (error) {
                                console.error(`❌ Error calculating distance for ${service.name}:`, error);
                                return { ...service, distance: null, time: 'Unable to calculate' };
                            }
                        } else {
                            console.warn(`⚠️ ${service.name} has no valid coordinates`);
                            return { ...service, distance: null, time: 'Location unknown' };
                        }
                    })
                );
            } else {
                console.log('📍 User location not available yet, using default/stored times');
            }

            if (servicesWithDistance.length === 0) {
                console.log('🔍 [DEBUG] No services found - showing empty state');
                // Show professional empty state when no companies are available
                listView.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-white text-center p-8" style="min-height: 400px;">
                        <div class="mb-6">
                            <div class="w-24 h-24 bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-12 h-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-semibold mb-2">No Services Available</h3>
                            <p class="text-gray-400 text-lg mb-6">We couldn't find any water services in your area.</p>
                            <div class="space-y-3">
                                <p class="text-gray-500 text-sm">This could be because:</p>
                                <ul class="text-gray-500 text-sm space-y-1 max-w-md mx-auto">
                                    <li>• No companies have registered in your location yet</li>
                                    <li>• Services are currently unavailable in your area</li>
                                    <li>• There might be a connection issue</li>
                                </ul>
                            </div>
                            <button onclick="location.reload()" class="mt-6 px-6 py-3 bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-lg hover:bg-gray-700/50 transition-all duration-300 flex items-center gap-2 mx-auto">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span class="text-gray-300">Refresh Services</span>
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            // Apply verification tier filtering - hide tier1 companies, show tier2 and tier3
            const filteredServices = servicesWithDistance.filter(service => {
                const tier = service.verification_tier || 2; // Default to tier2 if not set
                console.log(`🔍 [DEBUG] Service: ${service.name}, Tier: ${tier}, verification_tier field: ${service.verification_tier}`);
                const shouldShow = tier !== 1; // Hide tier1 companies
                console.log(`🔍 [DEBUG] Should show ${service.name}: ${shouldShow} (tier ${tier})`);
                return shouldShow;
            });

            console.log(`🔍 [DEBUG] Filtered services: ${filteredServices.length} out of ${servicesWithDistance.length}`);

            filteredServices.forEach((service, index) => {
                console.log(`🔍 [DEBUG] Creating card for service: ${service.name}`);
                const serviceCard = createServiceCard(service, index);
                listView.appendChild(serviceCard);
            });
        }

        // Create a service card element
        function createServiceCard(service, index) {
            const card = document.createElement('div');
            card.className = 'card-bg w-full rounded-[20px] overflow-hidden shadow-lg relative flex flex-col';
            card.style.minHeight = '100%';

            // Use header_image for banner, profile_image for logo
            const bannerImage = service.header_image;
            const profileImage = service.profile_image;

            // Create products HTML
            const productsHTML = (service.products || []).map(product => `
                <div class="flex flex-col items-center gap-2 flex-shrink-0" style="scroll-snap-align: start;">
                    <div class="product-item bg-[#292B2F] rounded-[12px] flex items-center justify-center transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl" style="height: clamp(80px, 20vw, 100px); width: clamp(80px, 20vw, 100px); ${product.image ? `background-image: url('${product.image}'); background-size: cover; background-position: center;` : ''}"
                        onclick="toggleServiceProduct(this, '${service.name.replace(/'/g, "\\'")}', '${(product.name || product.product_name || 'Unknown Product').replace(/'/g, "\\'")}', ${parseFloat(product.price) || 0}, '${(product.image || '').replace(/'/g, "\\'")}', '${(product.type || 'product').replace(/'/g, "\\'")}')">
                        ${product.image ? '' : `
                            <div class="text-center px-1">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 mx-auto mb-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                                <span class="text-gray-500 text-xs">No Image</span>
                            </div>
                        `}
                    </div>
                    <span class="text-white text-xs sm:text-sm font-semibold">GHS ${(parseFloat(product.price) || 0).toFixed(2)}</span>
                </div>
            `).join('');

            card.innerHTML = `
                <!-- Primary Image (height: 120-140px responsive) -->
                <div class="w-full flex-shrink-0" style="height: clamp(120px, 25vw, 140px);">
                    ${bannerImage ?
                    `<img src="${bannerImage}" class="w-full h-full object-cover" alt="Service Banner">` :
                    `<div class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                            <div class="text-center px-4">
                                <svg class="w-10 h-10 mx-auto mb-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-gray-500 text-xs sm:text-sm">No Banner Image</span>
                            </div>
                        </div>`
                }
                </div>

                <!-- Company Logo Overlay (responsive sizing) -->
                <div class="absolute border p-2 overflow-hidden flex items-center justify-center"
                    style="width: clamp(80px, 18vw, 100px); height: clamp(72px, 16vw, 89px); top: clamp(90px, 22vw, 100px); left: 50%; transform: translateX(-50%); border-radius: 15px; background-color: var(--bg-second); border-color: #40444B;">
                    ${profileImage ?
                    `<img src="${profileImage}" class="w-full h-full object-cover" alt="Company Logo">` :
                    `<div class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>`
                }
                </div>

                <!-- Company Info Section (responsive spacing) -->
                <div class="flex flex-col flex-grow px-4 sm:px-5 mt-20 sm:mt-24 pb-4 sm:pb-6 border-b border-gray-700/30">
                    <!-- Company Name Row -->
                    <div class="flex items-center gap-1 flex-wrap mb-3 sm:mb-4">
                        <h3 class="text-white text-base sm:text-lg font-medium line-clamp-2">
                            <a href="schedule.html?branch_id=${service.branch_id}" class="hover:text-blue-400 transition-colors">${service.name}</a>
                            <span class="material-symbols-outlined ${getVerifiedIconClass(service.verification_tier)} text-base sm:text-lg">verified</span>
                        </h3>
                    </div>
                    
                    <!-- Location, Time & Rating - All on one line -->
                    <div class="flex items-center gap-2 sm:gap-3 flex-wrap text-xs sm:text-sm">
                        <span class="text-gray-300 font-medium truncate">${service.location || 'Location unknown'}</span>
                        <span class="text-gray-500 flex-shrink-0">•</span>
                        <span class="text-[#2C9043] font-medium flex-shrink-0">${(service.time && service.time !== 'NaN' && service.time !== 'NaNh' && service.time !== 'Unknown time' && service.time !== 'Unable to calculate' && service.time !== 'Location unknown') ? service.time : 'Distance unknown'}</span>
                        ${service.company_rating && service.company_rating > 0 ? `
                            <span class="text-gray-500 flex-shrink-0">•</span>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="#FCD34D" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                </svg>
                                <span class="text-yellow-400 font-semibold">${service.company_rating.toFixed(1)}</span>
                                <span class="text-gray-400">(${service.rating_count || 0})</span>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Products Section (flexible) -->
                <div class="flex-grow flex flex-col px-4 sm:px-5 pt-4 sm:pt-6">
                    ${(service.products && service.products.length > 0) ? `
                        <p class="text-white text-sm sm:text-base font-medium mb-3 sm:mb-4">Select products</p>

                        <!-- Product Scroll Container -->
                        <div class="w-full overflow-x-auto hide-scrollbar flex-grow">
                            <div class="flex flex-row gap-3 sm:gap-4 pb-2" style="scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;">
                                ${productsHTML}
                            </div>
                        </div>
                    ` : `
                        <!-- Empty State for No Products -->
                        <div class="w-full flex flex-col items-center justify-center py-6 sm:py-8 flex-grow">
                            <svg class="w-12 h-12 sm:w-16 sm:h-16 text-gray-500 opacity-50 mb-3" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0z"></path>
                            </svg>
                            <h4 class="text-gray-400 text-base sm:text-lg font-semibold mb-1 sm:mb-2">No Products</h4>
                            <p class="text-gray-500 text-xs sm:text-sm text-center">This company hasn't added any products yet.</p>
                        </div>
                    `}
                </div>

                <!-- Selected Products Counter -->
                <div id="selectedCount${index + 1}" class="hidden px-4 sm:px-5">
                    <span class="text-blue-400 text-xs sm:text-sm font-medium">
                        <span id="selectedProductsCount${index + 1}"><span class="badge">0</span></span> selected
                    </span>
                </div>

                <!-- Schedule Order Button (sticky bottom) -->
                <div class="px-4 sm:px-5 py-3 sm:py-4 mt-auto flex-shrink-0 border-t border-gray-700/30">
                    <button onclick="openScheduleFlow('${service.name}')"
                        class="w-full py-3 sm:py-4 rounded-lg backdrop-blur-xl transition-all duration-300 shadow-lg text-sm sm:text-base font-semibold ${(service.products && service.products.length > 0) ? '' : 'opacity-50 cursor-not-allowed'}"
                        style="background-color: var(--btn-color); border-color: var(--btn-border);"
                        ${(service.products && service.products.length > 0) ? '' : 'disabled'}>
                        <span class="text-white capitalize">${(service.products && service.products.length > 0) ? 'Schedule Order' : 'No Products'}</span>
                    </button>
                </div>
            `;

            return card;
        }

        // Handle search input
        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            searchQuery = searchInput.value.toLowerCase();

            if (viewSwipe) {
                renderSwipeCard(currentCardIndex);
            } else {
                filterServicesList();
            }
        }

        // Filter services in list view
        function filterServicesList() {
            const serviceCards = document.querySelectorAll('#listView > .card-bg');

            serviceCards.forEach((card, index) => {
                const serviceName = card.querySelector('h3 a').textContent;
                const serviceLocation = card.querySelector('.flex-row.gap-2 span:first-child').textContent;

                if (searchQuery === '' ||
                    serviceName.toLowerCase().includes(searchQuery) ||
                    serviceLocation.toLowerCase().includes(searchQuery)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Toggle product selection in service card
        function toggleServiceProduct(element, companyName, productName, price, image, type) {

            // Find the original product to get minQuantity
            const originalProduct = services.find(service => service.name === companyName)
                ?.products.find(p => p.name === productName && p.type === type);

            const minQuantity = originalProduct?.minQuantity || 1;

            // Check if product is already selected
            const existingIndex = serviceProducts[companyName].findIndex(p => p.name === productName);

            if (existingIndex > -1) {
                // Remove product
                serviceProducts[companyName].splice(existingIndex, 1);
                element.classList.remove('selected');

                // Remove quantity indicator if exists
                const quantityIndicator = element.querySelector('.product-item-quantity');
                if (quantityIndicator) {
                    quantityIndicator.remove();
                }
            } else {
                // Add product with minimum quantity
                serviceProducts[companyName].push({
                    id: Date.now(),
                    company: companyName,
                    name: productName,
                    price: parseFloat(price) || 0,
                    image: image,
                    quantity: minQuantity,
                    type: type
                });
                element.classList.add('selected');

                // Add quantity indicator with minimum quantity
                const quantityIndicator = document.createElement('div');
                quantityIndicator.className = 'product-item-quantity';
                quantityIndicator.textContent = minQuantity;
                element.appendChild(quantityIndicator);
            }

            // Update selected count display
            updateServiceProductCount(companyName);
        }

        // Toggle product selection in swipe view
        function toggleSwipeProduct(element, companyName, productName, price, image, type) {

            // Find original product to get minQuantity
            const originalProduct = services.find(service => service.name === companyName)
                ?.products.find(p => p.name === productName && p.type === type);

            const minQuantity = originalProduct?.minQuantity || 1;

            // Check if product is already selected
            const existingIndex = serviceProducts[companyName].findIndex(p => p.name === productName);

            if (existingIndex > -1) {
                // Remove product
                serviceProducts[companyName].splice(existingIndex, 1);
                element.classList.remove('selected');

                // Remove quantity indicator if exists
                const quantityIndicator = element.querySelector('.product-item-quantity');
                if (quantityIndicator) {
                    quantityIndicator.remove();
                }
            } else {
                // Add product with minimum quantity
                serviceProducts[companyName].push({
                    id: Date.now(),
                    company: companyName,
                    name: productName,
                    price: parseFloat(price) || 0,
                    image: image,
                    quantity: minQuantity,
                    type: type
                });
                element.classList.add('selected');

                // Add quantity indicator with minimum quantity
                const quantityIndicator = document.createElement('div');
                quantityIndicator.className = 'product-item-quantity';
                quantityIndicator.textContent = minQuantity;
                element.appendChild(quantityIndicator);
            }

            // Update selected count display
            updateServiceProductCount(companyName);
        }

        // Update service product count display
        function updateServiceProductCount(companyName) {
            const count = serviceProducts[companyName].length;
            let countElementId, displayElementId;

            switch (companyName) {
                case 'Voltic Water Company':
                    countElementId = 'selectedProductsCount1';
                    displayElementId = 'selectedCount1';
                    break;
                case 'Bel-Aqua Ghana':
                    countElementId = 'selectedProductsCount2';
                    displayElementId = 'selectedCount2';
                    break;
                case 'Special Ice Water':
                    countElementId = 'selectedProductsCount3';
                    displayElementId = 'selectedCount3';
                    break;
            }

            if (countElementId && displayElementId) {
                document.getElementById(countElementId).innerHTML = `<span class="badge">${count}</span>`;
                if (count > 0) {
                    document.getElementById(displayElementId).classList.remove('hidden');
                } else {
                    document.getElementById(displayElementId).classList.add('hidden');
                }

                // Also update swipe view if it's active
                if (viewSwipe) {
                    const currentService = services[currentCardIndex];
                    if (currentService.name === companyName) {
                        renderSwipeCard(currentCardIndex);
                    }
                }
            }
        }

        // Get user location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                    },
                    (error) => {
                        // Location access denied
                    }
                );
            }
        }

        // Toggle between list and swipe view
        function toggleView() {
            viewSwipe = !viewSwipe;
            const toggleIcon = document.getElementById('toggleIcon');
            const listView = document.getElementById('listView');
            const swipeView = document.getElementById('swipeView');

            if (viewSwipe) {
                // Switch to swipe view
                toggleIcon.setAttribute('stroke', '#3B74FF');
                listView.classList.add('hidden');
                swipeView.classList.remove('hidden');
                renderSwipeCard(currentCardIndex);
            } else {
                // Switch to list view
                toggleIcon.setAttribute('stroke', '#FFFFFF');
                listView.classList.remove('hidden');
                swipeView.classList.add('hidden');
            }
        }

        // Render swipe card with full functionality
        function renderSwipeCard(index) {
            const service = services[index];
            const container = document.getElementById('swipeCard');

            // Get selected products for this service
            const selectedForService = serviceProducts[service.name] || [];
            const selectedCount = selectedForService.length;

            container.innerHTML = `
                <div class="w-full" style="height: 135px;">
                    ${service.header_image ?
                    `<img src="${service.header_image}" class="w-full h-full object-cover" alt="Service Banner">` :
                    `<div class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                            <div class="text-center">
                                <svg class="w-12 h-12 mx-auto mb-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-gray-500 text-sm">No Banner Image</span>
                            </div>
                        </div>`
                }
                </div>
                <div class="absolute border p-2 overflow-hidden flex items-center justify-center"
                     style="width: 100px; height: 89px; top: 90px; left: 35%; border-radius: 15px; background-color: var(--bg-second); border-color: #40444B;">
                    ${service.profile_image ?
                    `<img src="${service.profile_image}" class="w-full h-full object-cover rounded-lg" alt="Company Logo">` :
                    `<div class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>`
                }
                </div>
                <div class="flex flex-col mt-12 px-5">
                    <h3 class="text-white text-lg font-medium">${service.name}<span class="material-symbols-outlined ${getVerifiedIconClass(service.verification_tier)}">verified</span></h3>
                    <div class="flex flex-row gap-2">
                        <span class="text-white text-lg font-medium">${service.location || 'Location unknown'}</span>
                        <span class="text-[#2C9043] text-lg font-medium">${(service.time && service.time !== 'NaN' && service.time !== 'NaNh') ? service.time : 'Distance unknown'}</span>
                    </div>
                </div>
                <p class="px-5 text-white text-lg mt-4 font-medium">Select products to Schedule order</p>
                <div class="w-full flex justify-center items-center">
                    <div class="w-full flex flex-row gap-[8px] overflow-x-auto px-5 mt-3 hide-scrollbar scroll-smooth" style="scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;">
                        ${service.products.map((p, idx) => {
                    // Check if this product is selected
                    const isSelected = selectedForService.some(sp => sp.name === (p.name || p.product_name));
                    const quantity = isSelected ? selectedForService.find(sp => sp.name === (p.name || p.product_name)).quantity : 0;

                    return `
                                <div class="flex flex-col items-center gap-3 flex-shrink-0" style="scroll-snap-align: start;">
                                    <div class="swipe-product-item rounded-[12px] flex items-center justify-center ${isSelected ? 'selected' : ''} transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl" 
                                         style="height: 100px; width: 100px; ${p.image ? `background-image: url('${p.image}'); background-size: cover; background-position: center;` : ''}"
                                         onclick="toggleSwipeProduct(this, '${service.name.replace(/'/g, "\\'")}', '${(p.name || p.product_name || 'Unknown Product').replace(/'/g, "\\'")}', ${parseFloat(p.price) || 0}, '${(p.image || '').replace(/'/g, "\\'")}', '${(p.type || 'product').replace(/'/g, "\\'")}')">
                                        ${isSelected ? `<div class="product-item-quantity">${quantity}</div>` : ''}
                                        ${p.image ? '' : `
                                            <div class="text-center">
                                                <svg class="w-8 h-8 mx-auto mb-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                </svg>
                                                <span class="text-gray-500 text-xs">No Image</span>
                                            </div>
                                        `}
                                    </div>
                                    <span class="text-white text-base font-bold">GHS ${(parseFloat(p.price) || 0).toFixed(2)}</span>
                                    <div class="flex flex-row items-center justify-center">
                                        <svg class="w-4 h-4 mt-1" fill="white" viewBox="0 0 24 24">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                        <span class="text-white text-base font-medium">${p.rating > 0 ? p.rating.toFixed(1) : '0.0'}</span>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                </div>
                
                <!-- Selected Products Count -->
                <div class="px-5 mt-3 text-sm text-[#3B74FF] font-medium ${selectedCount > 0 ? '' : 'hidden'}" id="swipeSelectedCount">
                    <span>${selectedCount}</span> products selected
                </div>
                
                <div class="px-10 mt-6">
                    <button onclick="scheduleOrder('${service.name}')" 
                            class="h-[46px] w-full rounded-[20px] flex items-center justify-center border shadow-md active:scale-95 transition-transform"
                            style="background-color: var(--btn-color); border-color: var(--btn-border);">
                        <span class="text-white text-xl font-semibold capitalize">Schedule Order</span>
                    </button>
                </div>
            `;
        }

        // Navigate to previous card
        function prevCard() {
            // Get filtered services (excluding tier1)
            const filteredServices = services.filter(service => {
                const tier = service.verification_tier || 2;
                return tier !== 1; // Hide tier1 companies
            });

            if (filteredServices.length === 0) return;

            do {
                currentCardIndex = (currentCardIndex - 1 + services.length) % services.length;
            } while (services[currentCardIndex].verification_tier === 1); // Skip tier1 companies

            renderSwipeCard(currentCardIndex);
        }

        // Navigate to next card
        function nextCard() {
            // Get filtered services (excluding tier1)
            const filteredServices = services.filter(service => {
                const tier = service.verification_tier || 2;
                return tier !== 1; // Hide tier1 companies
            });

            if (filteredServices.length === 0) return;

            do {
                currentCardIndex = (currentCardIndex + 1) % services.length;
            } while (services[currentCardIndex].verification_tier === 1); // Skip tier1 companies

            renderSwipeCard(currentCardIndex);
        }

        // Schedule order - Open bottom sheet
        async function scheduleOrder(companyName) {
            selectedCompany = companyName;

            // Get selected products for this company
            selectedProducts = [...serviceProducts[companyName]];

            if (selectedProducts.length === 0) {
                showError('Please select at least one product first');
                return;
            }

            await startScheduleFlow();
        }

        // Open schedule flow - same as scheduleOrder
        async function openScheduleFlow(companyName) {
            selectedCompany = companyName;

            // Get selected products for this company
            let products = serviceProducts[companyName] || [];

            if (products.length === 0) {
                // No products selected - show error and don't open schedule flow
                showError('Please select at least one product first before scheduling an order.');
                return;
            }

            // Update selectedProducts with the products for this company
            selectedProducts = [...products];
            await startScheduleFlow();
        }

        // Show error message in bottom sheet
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');

            // Auto hide after 5 seconds
            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 5000);
        }

        // Show success message in bottom sheet
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('active');

            // Auto hide after 5 seconds
            setTimeout(() => {
                successDiv.classList.remove('active');
            }, 5000);
        }

        // Hide error message
        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        // Schedule Flow Bottom Sheet
        async function startScheduleFlow() {
            console.log('🚀 Starting schedule flow...');

            // TEMPORARY: Bypass authentication for debugging
            // const isAuthenticated = await validateUserAuthentication();
            // if (!isAuthenticated) {
            //     showError('You must be logged in to schedule an order. Please log in and try again.');
            //     return;
            // }

            console.log('✅ Authentication bypassed for debugging');

            // Reset to first step
            currentStep = 1;
            updateStepIndicators();

            const sheet = document.getElementById('scheduleFlowSheet');
            const content = document.getElementById('scheduleFlowContent');

            console.log('📋 Elements found:', { sheet: !!sheet, content: !!content });

            // Add active classes to show bottom sheet
            sheet.classList.add('active');
            content.classList.add('active');
            sheet.classList.remove('pointer-events-none');

            console.log('🎯 Classes added:', {
                sheetClasses: sheet.className,
                contentClasses: content.className
            });

            // Load saved recipients
            loadSavedRecipients();

            // Initialize date input with minimum date (today + 2 hours)
            initializeDateInput();

            goToStep('terms');

            console.log('✅ Schedule flow started successfully');
        }

        function closeScheduleFlow() {
            const sheet = document.getElementById('scheduleFlowSheet');
            const content = document.getElementById('scheduleFlowContent');
            content.classList.remove('active');
            setTimeout(() => {
                sheet.classList.remove('active');
                sheet.classList.add('pointer-events-none');
            }, 300);
            // Reset step
            currentStep = 1;
            updateStepIndicators();
            // Reset data
            orderData = {
                recipient: {}, // Reset recipient object
                // Customer details (who placed the order) - will be populated from database
                customer: {
                    id: '',
                    uid: '',
                    email: '',
                    name: '',
                    phone: '',
                    type: ''
                },
                // Purchase recipient type
                purchase_recipient_type: 'you' // Default to 'you'
            };
            selectedPaymentMethod = null;
            userRating = 0;
            hideError();
        }

        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Show current step
            const stepMap = {
                'terms': 'termsStep',
                'recipient': 'orderRecipientStep',
                'datetime': 'datetimeStep',
                'quantity': 'quantityStep',
                'review': 'orderReviewStep',
                'selectPayment': 'selectPaymentStep',
                'paymentDetails': 'paymentDetailsStep',
                'paymentProcessing': 'paymentProcessingStep',
                'paymentSuccess': 'paymentSuccessStep',
                'scheduleSent': 'scheduleSentStep',
                'ratingSuccess': 'ratingSuccessStep'
            };

            const stepElement = document.getElementById(stepMap[step]);
            if (stepElement) {
                stepElement.classList.remove('hidden');

                // Special handling for specific steps
                if (step === 'recipient') {
                    updateRecipientStep();
                } else if (step === 'datetime') {
                    updateDateTimeStep();
                } else if (step === 'quantity') {
                    updateQuantityStep();
                } else if (step === 'review') {
                    updateOrderReview();
                } else if (step === 'paymentProcessing') {
                    startPaymentProcessing();
                } else if (step === 'paymentSuccess') {
                    showPaymentSuccess();
                } else if (step === 'scheduleSent') {
                    showScheduleSent();
                } else if (step === 'ratingSuccess') {
                    showRatingSuccess();
                }
            }

            updateStepIndicators();
            updateNavigationButtons();
            hideError();
        }

        function updateStepIndicators() {
            // Step indicators are hidden as requested
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const payBtn = document.getElementById('payBtn');
            const doneBtn = document.getElementById('doneBtn');

            // Show/hide previous button
            if (currentStep === 1) {
                prevBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
            }

            // Show/hide buttons based on current step
            nextBtn.classList.add('hidden');
            payBtn.classList.add('hidden');
            doneBtn.classList.add('hidden');

            if (currentStep === totalSteps) {
                doneBtn.classList.remove('hidden');
            } else if (currentStep === 7) { // Payment details step (adjusted for new step)
                payBtn.classList.remove('hidden');
            } else if (currentStep < totalSteps) {
                nextBtn.classList.remove('hidden');

                // Update button text based on step and payment method
                if (currentStep === 5) { // Review step (adjusted for new step)
                    nextBtn.textContent = 'Confirm Order';
                } else if (currentStep === 6) { // Select payment step (adjusted for new step)
                    if (selectedPaymentMethod === 'delivery') {
                        nextBtn.textContent = 'Confirm Order';
                    } else {
                        nextBtn.textContent = 'Proceed to Payment';
                    }
                } else {
                    nextBtn.textContent = 'Continue';
                }
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                // Validate current step
                if (!validateCurrentStep()) {
                    return;
                }

                currentStep++;

                // Special handling for Pay on Delivery - skip payment details and processing
                if (currentStep === 7 && selectedPaymentMethod === 'delivery') {
                    // Skip payment details (step 7) and payment processing (step 8) 
                    // Go directly to payment success (step 9) for delivery orders
                    currentStep = 9;
                }

                const steps = ['terms', 'recipient', 'datetime', 'quantity', 'review', 'selectPayment', 'paymentDetails', 'paymentProcessing', 'paymentSuccess', 'scheduleSent', 'ratingSuccess'];
                if (currentStep <= steps.length && currentStep <= totalSteps) {
                    goToStep(steps[currentStep - 1]);
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                const steps = ['terms', 'recipient', 'datetime', 'quantity', 'review', 'selectPayment', 'paymentDetails', 'paymentProcessing', 'paymentSuccess', 'scheduleSent', 'ratingSuccess'];
                goToStep(steps[currentStep - 1]);
            }
        }

        function validateCurrentStep() {
            hideError();

            switch (currentStep) {
                case 1: // Terms
                    // No checkbox validation needed as requested
                    break;
                case 2: // Recipient
                    const address = document.getElementById('recipientAddress').value;

                    if (recipientType === 'business') {
                        const businessType = document.getElementById('businessType').value;
                        const businessName = document.getElementById('businessName').value;
                        if (!businessType) {
                            showError('Please select a business type');
                            return false;
                        }
                        if (!businessName) {
                            showError('Please enter a business name');
                            return false;
                        }

                        // Save business name and type
                        orderData.recipient.businessName = businessName;
                        orderData.recipient.businessType = businessType;
                    }

                    if (recipientType !== 'you') {
                        const name = document.getElementById('recipientName').value?.trim();
                        const phone = document.getElementById('recipientPhone').value?.trim();
                        const email = document.getElementById('recipientEmail').value?.trim();

                        if (!name || !phone || !email) {
                            showError('Please fill in all recipient information');
                            return false;
                        }

                        // Validate phone number
                        if (!/^0\d{9}$/.test(phone)) {
                            showError('Please enter a valid Ghanaian phone number (e.g., 0201234567)');
                            return false;
                        }

                        // Validate email
                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                            showError('Please enter a valid email address');
                            return false;
                        }

                        orderData.recipient.name = name;
                        orderData.recipient.phone = phone;
                        orderData.recipient.email = email;
                    } else {
                        // For "You" type, get data from profile
                        const youName = document.getElementById('youNameDisplay').textContent?.trim();
                        const youPhone = document.getElementById('youPhoneDisplay').textContent?.trim();
                        const youEmail = document.getElementById('youEmailDisplay').textContent?.trim();
                        
                        // Ensure no empty values
                        if (!youName || !youPhone || !youEmail) {
                            showError('Your profile information is incomplete. Please update your profile first.');
                            return false;
                        }
                        
                        orderData.recipient.name = youName;
                        orderData.recipient.phone = youPhone;
                        orderData.recipient.email = youEmail;
                    }

                    if (!address) {
                        showError('Please enter a delivery address');
                        return false;
                    }

                    // Save recipient data
                    orderData.recipient.address = address;
                    orderData.recipient.type = recipientType;

                    // Check if save toggle is on
                    const saveToggle = document.getElementById('saveRecipientToggle').checked;
                    if (saveToggle && recipientType !== 'you') {
                        saveRecipient();
                    }
                    break;
                case 3: // Date and Time
                    // Get selected date and time
                    selectedDate = document.getElementById('deliveryDate').value;
                    selectedTime = document.getElementById('deliveryTime').value;

                    // Validate date and time
                    if (!selectedDate) {
                        showError('Please select a delivery date');
                        return false;
                    }

                    if (!selectedTime) {
                        showError('Please select a delivery time');
                        return false;
                    }

                    // Validate against working hours
                    if (!validateDateTimeAgainstWorkingHours()) {
                        return false;
                    }

                    // Save date and time to order data
                    orderData.deliveryDate = selectedDate;
                    orderData.deliveryTime = selectedTime;
                    break;
                case 4: // Quantity
                    if (selectedProducts.length === 0) {
                        showError('Please select at least one product');
                        return false;
                    }

                    // Check if any product has quantity 0
                    const invalidProduct = selectedProducts.find(p => p.quantity < 1);
                    if (invalidProduct) {
                        showError('Product quantity must be at least 1');
                        return false;
                    }

                    // Save products data with a deep copy to prevent loss due to array mutations
                    orderData.products = JSON.parse(JSON.stringify(selectedProducts));
                    console.log('✅ Products saved to orderData in step 4:', orderData.products);
                    orderData.deliveryInstructions = document.getElementById('deliveryInstructions').value;
                    break;
                case 6: // Select Payment
                    if (!selectedPaymentMethod) {
                        showError('Please select a payment method');
                        return false;
                    }
                    break;
                case 7: // Payment Details
                    if (!validatePaymentDetails()) {
                        return false;
                    }
                    break;
            }
            return true;
        }

        function validatePaymentDetails() {
            const mobileNetwork = document.getElementById('mobileNetwork').value;
            const mobileNumber = document.getElementById('mobileNumber').value;

            if (!mobileNetwork) {
                showError('Please select a mobile network');
                return false;
            }

            if (!mobileNumber) {
                showError('Please enter your mobile number');
                return false;
            }

            // Validate mobile number
            if (!/^0\d{9}$/.test(mobileNumber)) {
                showError('Please enter a valid Ghanaian phone number (e.g., 0201234567)');
                return false;
            }

            orderData.payment = {
                method: 'mobile',
                network: mobileNetwork,
                phoneNumber: mobileNumber
            };

            return true;
        }

        // Initialize date input with minimum date
        function initializeDateInput() {
            const dateInput = document.getElementById('deliveryDate');
            const now = new Date();
            const minDate = new Date(now.getTime() + 2 * 60 * 60 * 1000); // 2 hours from now

            // Format date as YYYY-MM-DD
            const minDateString = minDate.toISOString().split('T')[0];
            dateInput.min = minDateString;

            // Get selected company's working days
            const company = services.find(service => service.name === selectedCompany);
            if (company && company.working_days && company.working_days.length > 0) {
                // Find the next available working day
                let nextAvailableDate = new Date(minDate);
                let foundAvailableDate = false;

                // Check up to 30 days ahead
                for (let i = 0; i < 30; i++) {
                    const dayOfWeek = nextAvailableDate.toLocaleDateString('en-US', { weekday: 'long' });
                    const isWorkingDay = company.working_days.some(wd =>
                        wd.day.toLowerCase() === dayOfWeek.toLowerCase()
                    );

                    if (isWorkingDay) {
                        foundAvailableDate = true;
                        break;
                    }

                    // Move to next day
                    nextAvailableDate.setDate(nextAvailableDate.getDate() + 1);
                }

                if (foundAvailableDate) {
                    const nextAvailableString = nextAvailableDate.toISOString().split('T')[0];
                    dateInput.value = nextAvailableString;
                    selectedDate = nextAvailableString;
                } else {
                    // If no working days found, use tomorrow as fallback
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowString = tomorrow.toISOString().split('T')[0];
                    dateInput.value = tomorrowString;
                    selectedDate = tomorrowString;
                }
            } else {
                // Set default to tomorrow if no working days data
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowString = tomorrow.toISOString().split('T')[0];
                dateInput.value = tomorrowString;
                selectedDate = tomorrowString;
            }

            // Add event listener to update time slots when date changes
            dateInput.addEventListener('change', function () {
                selectedDate = this.value;
                generateTimeSlots();
            });
        }

        // Generate time slots based on company working hours
        function generateTimeSlots() {
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');
            timeSlotsGrid.innerHTML = '';

            // Get selected company's working hours for the selected date
            const company = services.find(service => service.name === selectedCompany);
            if (!company || !company.working_days || !selectedDate) {
                // Fallback to default time slots if no working hours data
                generateDefaultTimeSlots();
                return;
            }

            // Get day of week for selected date
            const selectedDateObj = new Date(selectedDate);
            const dayOfWeek = selectedDateObj.toLocaleDateString('en-US', { weekday: 'long' });

            // Find working hours for this day
            const todayWorkingHours = company.working_days.find(wd =>
                wd.day.toLowerCase() === dayOfWeek.toLowerCase()
            );

            if (!todayWorkingHours || !todayWorkingHours.time) {
                // No working hours for this day
                timeSlotsGrid.innerHTML = '<p class="text-gray-400 text-center">No working hours for this day</p>';
                return;
            }

            // Parse working hours (e.g., "8:00 AM - 6:00 PM")
            const timeRange = todayWorkingHours.time;
            const timeMatch = timeRange.match(/(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/i);

            if (!timeMatch) {
                // If parsing fails, use default time slots
                generateDefaultTimeSlots();
                return;
            }

            const openingTime = timeMatch[1];
            const closingTime = timeMatch[2];

            // Convert to 24-hour format for easier manipulation
            const openingHour = convertTo24Hour(openingTime);
            const closingHour = convertTo24Hour(closingTime);

            // Generate time slots based on working hours
            const timeSlots = [];
            for (let hour = openingHour; hour < closingHour; hour++) {
                const time24 = `${hour.toString().padStart(2, '0')}:00`;
                const label = convertTo12Hour(time24);

                // Check if it's at least 2 hours from now for same-day delivery
                const now = new Date();
                const slotDateTime = new Date(selectedDate);
                slotDateTime.setHours(hour, 0, 0, 0);
                const minDateTime = new Date(now.getTime() + 2 * 60 * 60 * 1000);

                const available = slotDateTime >= minDateTime;

                timeSlots.push({
                    time: time24,
                    label: label,
                    available: available
                });
            }

            // Update the time select dropdown
            const timeSelect = document.getElementById('deliveryTime');
            timeSelect.innerHTML = '<option value="">Select Time</option>';

            timeSlots.forEach(slot => {
                const option = document.createElement('option');
                option.value = slot.time;
                option.textContent = slot.label;
                if (!slot.available) {
                    option.disabled = true;
                    option.textContent += ' (Unavailable)';
                }
                timeSelect.appendChild(option);
            });

            // Add event listener to update selected time when dropdown changes
            timeSelect.onchange = function () {
                selectedTime = this.value;
                // Update button selection to match dropdown
                document.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent === convertTo12Hour(selectedTime)) {
                        btn.classList.add('selected');
                    }
                });
            };

            // Generate time slot buttons
            timeSlots.forEach(slot => {
                const timeSlotBtn = document.createElement('button');
                timeSlotBtn.type = 'button';
                timeSlotBtn.className = `time-slot-btn ${slot.available ? '' : 'disabled'}`;
                timeSlotBtn.textContent = slot.label;
                timeSlotBtn.disabled = !slot.available;

                if (slot.available) {
                    timeSlotBtn.onclick = () => selectTimeSlot(slot.time, slot.label, timeSlotBtn);
                }

                timeSlotsGrid.appendChild(timeSlotBtn);
            });
        }

        // Generate default time slots (fallback)
        function generateDefaultTimeSlots() {
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');
            timeSlotsGrid.innerHTML = '';

            const timeSlots = [
                { time: '08:00', label: '8:00 AM', available: true },
                { time: '09:00', label: '9:00 AM', available: true },
                { time: '10:00', label: '10:00 AM', available: true },
                { time: '11:00', label: '11:00 AM', available: true },
                { time: '12:00', label: '12:00 PM', available: true },
                { time: '13:00', label: '1:00 PM', available: true },
                { time: '14:00', label: '2:00 PM', available: true },
                { time: '15:00', label: '3:00 PM', available: true },
                { time: '16:00', label: '4:00 PM', available: true },
                { time: '17:00', label: '5:00 PM', available: true },
                { time: '18:00', label: '6:00 PM', available: true }
            ];

            // Update the time select dropdown
            const timeSelect = document.getElementById('deliveryTime');
            timeSelect.innerHTML = '<option value="">Select Time</option>';

            timeSlots.forEach(slot => {
                const option = document.createElement('option');
                option.value = slot.time;
                option.textContent = slot.label;
                if (!slot.available) {
                    option.disabled = true;
                    option.textContent += ' (Unavailable)';
                }
                timeSelect.appendChild(option);
            });

            // Add event listener to update selected time when dropdown changes
            timeSelect.onchange = function () {
                selectedTime = this.value;
                // Update button selection to match dropdown
                document.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent === convertTo12Hour(selectedTime)) {
                        btn.classList.add('selected');
                    }
                });
            };

            // Generate time slot buttons
            timeSlots.forEach(slot => {
                const timeSlotBtn = document.createElement('button');
                timeSlotBtn.type = 'button';
                timeSlotBtn.className = `time-slot-btn ${slot.available ? '' : 'disabled'}`;
                timeSlotBtn.textContent = slot.label;
                timeSlotBtn.disabled = !slot.available;

                if (slot.available) {
                    timeSlotBtn.onclick = () => selectTimeSlot(slot.time, slot.label, timeSlotBtn);
                }

                timeSlotsGrid.appendChild(timeSlotBtn);
            });
        }

        // Convert 12-hour time to 24-hour format
        function convertTo24Hour(time12) {
            const match = time12.match(/(\d{1,2}):(\d{2})\s*([AP]M)/i);
            if (!match) return 8; // Default to 8 AM

            let [, hours, minutes, period] = match;
            hours = parseInt(hours);

            if (period.toUpperCase() === 'PM' && hours !== 12) {
                hours += 12;
            } else if (period.toUpperCase() === 'AM' && hours === 12) {
                hours = 0;
            }

            return hours;
        }

        // Convert 24-hour time to 12-hour format
        function convertTo12Hour(time24) {
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            return `${displayHour}:${minutes} ${period}`;
        }

        // Validate selected date and time against company working hours
        function validateDateTimeAgainstWorkingHours() {
            const company = services.find(service => service.name === selectedCompany);
            if (!company || !company.working_days || !selectedDate || !selectedTime) {
                return true; // Skip validation if no working hours data
            }

            // Get day of week for selected date
            const selectedDateObj = new Date(selectedDate);
            const dayOfWeek = selectedDateObj.toLocaleDateString('en-US', { weekday: 'long' });

            // Find working hours for this day
            const todayWorkingHours = company.working_days.find(wd =>
                wd.day.toLowerCase() === dayOfWeek.toLowerCase()
            );

            if (!todayWorkingHours || !todayWorkingHours.time) {
                showError('Selected company is not available on this day');
                return false;
            }

            // Parse working hours
            const timeRange = todayWorkingHours.time;
            const timeMatch = timeRange.match(/(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/i);

            if (!timeMatch) {
                return true; // Skip validation if parsing fails
            }

            const openingTime = timeMatch[1];
            const closingTime = timeMatch[2];
            const openingHour = convertTo24Hour(openingTime);
            const closingHour = convertTo24Hour(closingTime);
            const selectedHour = parseInt(selectedTime.split(':')[0]);

            // Check if selected time is within working hours
            if (selectedHour < openingHour || selectedHour >= closingHour) {
                showError(`Selected time is outside working hours (${openingTime} - ${closingTime})`);
                return false;
            }

            // Check if it's at least 2 hours from now for same-day delivery
            const now = new Date();
            const selectedDateTime = new Date(selectedDate);
            selectedDateTime.setHours(selectedHour, 0, 0, 0);
            const minDateTime = new Date(now.getTime() + 2 * 60 * 60 * 1000);

            if (selectedDateTime < minDateTime) {
                showError('Orders must be scheduled at least 2 hours in advance');
                return false;
            }

            return true;
        }

        // Select time slot
        function selectTimeSlot(time, label, button) {
            // Remove selected class from all buttons
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selected class to clicked button
            button.classList.add('selected');

            // Update time select
            document.getElementById('deliveryTime').value = time;
            selectedTime = time;
        }

        // Terms option selection (radio button style)
        function selectTermsOption(type) {
            // Update UI
            document.querySelectorAll('.terms-radio-item').forEach(item => {
                item.classList.remove('selected');
            });

            document.getElementById(`terms${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('selected');

            orderData.orderType = type;
        }

        // Recipient type selection
        function selectRecipientType(type) {
            recipientType = type;
            orderData.purchase_recipient_type = type; // Set purchase recipient type

            // Update UI
            document.querySelectorAll('.recipient-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide relevant fields
            const youInfo = document.getElementById('youRecipientInfo');
            const nameContainer = document.getElementById('recipientNameContainer');
            const phoneContainer = document.getElementById('recipientPhoneContainer');
            const emailContainer = document.getElementById('recipientEmailContainer');
            const businessTypeContainer = document.getElementById('businessTypeContainer');
            const businessNameContainer = document.getElementById('businessNameContainer');

            if (type === 'individual') {
                // Hide "You" info
                youInfo.style.display = 'none';
                // Show individual fields
                nameContainer.classList.remove('hidden');
                phoneContainer.classList.remove('hidden');
                emailContainer.classList.remove('hidden');
                // Hide business fields
                businessTypeContainer.classList.add('hidden');
                businessNameContainer.classList.add('hidden');
            } else if (type === 'business') {
                // Hide "You" info
                youInfo.style.display = 'none';
                // Show individual fields
                nameContainer.classList.remove('hidden');
                phoneContainer.classList.remove('hidden');
                emailContainer.classList.remove('hidden');
                // Show business fields
                businessTypeContainer.classList.remove('hidden');
                businessNameContainer.classList.remove('hidden');
            } else { // 'you'
                // Show "You" info
                youInfo.style.display = 'block';
                // Hide individual fields
                nameContainer.classList.add('hidden');
                phoneContainer.classList.add('hidden');
                emailContainer.classList.add('hidden');
                // Hide business fields
                businessTypeContainer.classList.add('hidden');
                businessNameContainer.classList.add('hidden');
                loadUserProfileData();
            }
        }

        // Load user profile data from localStorage with cache manager
        function loadUserProfileData() {
            // Try to get data from cache manager first
            let userProfile = {};

            if (window.cacheManager) {
                userProfile = window.cacheManager.getCache('user_profile') || {};
            } else {
                // Fallback to regular localStorage
                userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
            }

            // Use multiple field name fallbacks to ensure we get the data
            const name = userProfile.name || userProfile.full_name || '';
            const phone = userProfile.phone1 || userProfile.phone_number || '';
            const email = userProfile.email || '';

            document.getElementById('youNameDisplay').textContent = name;
            document.getElementById('youPhoneDisplay').textContent = phone;
            document.getElementById('youEmailDisplay').textContent = email;

            if (userProfile.address) {
                document.getElementById('youAddressDisplay').textContent = userProfile.address;
            }

            // Also pre-fill the delivery address field with the saved address
            const addressField = document.getElementById('recipientAddress');
            if (addressField && userProfile.address) {
                addressField.value = userProfile.address;
            }

            console.log('🔍 Loaded user profile data:', { name, phone, email });
        }

        // Load user data for menu display
        function loadMenuUserData() {
            // Try to get data from multiple sources in priority order
            let userData = {};

            // 1. Try customerSession first (most reliable for logged-in users)
            const customerSession = localStorage.getItem('customerSession');
            if (customerSession) {
                try {
                    const sessionData = JSON.parse(customerSession);
                    userData = {
                        name: sessionData.name,
                        email: sessionData.email
                    };
                } catch (e) {
                    console.log('Error parsing customerSession:', e);
                }
            }

            // 2. Try userProfile cache
            if (!userData.name) {
                if (window.cacheManager) {
                    userData = window.cacheManager.getCache('user_profile') || {};
                } else {
                    // Fallback to regular localStorage
                    userData = JSON.parse(localStorage.getItem('userProfile')) || {};
                }
            }

            // 3. Try customerData as fallback
            if (!userData.name) {
                const customerData = localStorage.getItem('customerData');
                if (customerData) {
                    try {
                        const customer = JSON.parse(customerData);
                        userData = {
                            name: customer.full_name,
                            email: customer.email
                        };
                    } catch (e) {
                        console.log('Error parsing customerData:', e);
                    }
                }
            }

            // Update menu display with fallbacks
            const menuUserName = document.getElementById('menuUserName');
            const menuUserEmail = document.getElementById('menuUserEmail');

            if (menuUserName) {
                menuUserName.textContent = userData.name || userData.full_name || '';
            }

            if (menuUserEmail) {
                menuUserEmail.textContent = userData.email || '';
            }

            console.log('Menu user data loaded:', { name: userData.name || userData.full_name, email: userData.email });
        }

        // Save user address to localStorage when updated
        function saveUserAddress() {
            const address = document.getElementById('recipientAddress').value;
            if (address && recipientType === 'you') {
                // Get existing user profile
                let userProfile = {};

                if (window.cacheManager) {
                    userProfile = window.cacheManager.getCache('user_profile') || {};
                } else {
                    userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
                }

                // Update address
                userProfile.address = address;

                // Save using cache manager if available
                if (window.cacheManager) {
                    window.cacheManager.setCache('user_profile', userProfile);
                    console.log('💾 User profile cached with updated address');
                } else {
                    // Fallback to regular localStorage
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }

                // Update display
                document.getElementById('youAddressDisplay').textContent = address;
            }
        }

        // Add event listener to save user address when updated
        document.addEventListener('DOMContentLoaded', function () {
            const addressField = document.getElementById('recipientAddress');
            if (addressField) {
                addressField.addEventListener('input', saveUserAddress);
            }
        });

        // Load customer data from database
        async function loadCustomerData() {
            try {
                // Get current user from Appwrite
                if (window.account) {
                    const user = await window.account.get();
                    console.log('🔍 Current user:', user.$id);

                    // Get customer profile from database
                    const customerProfile = await getCustomerProfile(user.$id);
                    console.log(' Customer profile found:', !!customerProfile);

                    if (customerProfile) {
                        // Fix common name variations from database
                        if (customerProfile.full_name === 'Asar') {
                            customerProfile.full_name = 'Asare';
                            console.log(' Fixed DB name: Asar → Asare');
                        }

                        // Update orderData with customer details
                        orderData.customer = {
                            id: customerProfile.$id, // This is the critical field
                            uid: customerProfile.uid,
                            email: customerProfile.email,
                            name: customerProfile.full_name,
                            full_name: customerProfile.full_name,
                            phone: customerProfile.phone_number,
                            phone_number: customerProfile.phone_number,
                            type: customerProfile.user_type
                        };

                        // Store customer data in localStorage for schedule history page
                        localStorage.setItem('customerData', JSON.stringify({
                            $id: customerProfile.$id,
                            uid: customerProfile.uid,
                            email: customerProfile.email,
                            full_name: customerProfile.full_name,
                            phone_number: customerProfile.phone_number,
                            user_type: customerProfile.user_type
                        }));

                        // Also store as userProfile for compatibility
                        const userProfileData = {
                            $id: customerProfile.$id,
                            uid: customerProfile.uid,
                            email: customerProfile.email,
                            name: customerProfile.full_name,
                            full_name: customerProfile.full_name,
                            phone1: customerProfile.phone_number,
                            phone_number: customerProfile.phone_number,
                            type: customerProfile.user_type
                        };

                        localStorage.setItem('userProfile', JSON.stringify(userProfileData));

                        // Update cache manager if available
                        if (window.cacheManager) {
                            window.cacheManager.setCache('user_profile', userProfileData);
                            console.log('💾 User profile cached with fresh database data');
                        }

                        // Also store as currentUserId
                        localStorage.setItem('currentUserId', customerProfile.$id);

                        console.log(' Customer data loaded:', orderData.customer);
                        console.log(' Customer data stored in localStorage for schedule history');

                        // Update "You" display fields
                        const youNameDisplay = document.getElementById('youNameDisplay');
                        const youPhoneDisplay = document.getElementById('youPhoneDisplay');
                        const youEmailDisplay = document.getElementById('youEmailDisplay');

                        if (youNameDisplay) youNameDisplay.textContent = customerProfile.full_name;
                        if (youPhoneDisplay) youPhoneDisplay.textContent = customerProfile.phone_number;
                        if (youEmailDisplay) youEmailDisplay.textContent = customerProfile.email;
                    } else {
                        console.error('❌ No customer profile found for user:', user.$id);
                        // Try to create a customer record if none exists
                        await createCustomerRecord(user);
                    }
                } else {
                    console.error('❌ Appwrite account not available');
                }
            } catch (error) {
                console.error('❌ Error loading customer data:', error);
                // Show user-friendly error
                showError('Unable to load your profile. Please refresh the page and log in again.');
            }
        }

        // Create customer record if it doesn't exist
        async function createCustomerRecord(user) {
            try {
                console.log('🔧 Creating customer record for user:', user.$id);
                const newCustomer = await window.databases.createDocument(
                    window.appwriteConfig.DATABASE_ID,
                    window.appwriteConfig.CUSTOMER_TABLE,
                    window.ID.unique(),
                    {
                        full_name: user.name || 'User',
                        email: user.email,
                        phone_number: '',
                        user_type: 'individual',
                        uid: user.$id
                    }
                );

                console.log('✅ Customer record created:', newCustomer);

                // Reload customer data after creating record
                await loadCustomerData();
            } catch (createError) {
                console.error('❌ Error creating customer record:', createError);
            }
        }

        // Get customer profile from database
        async function getCustomerProfile(uid) {
            try {
                const response = await window.databases.listDocuments(
                    window.appwriteConfig.DATABASE_ID,
                    window.appwriteConfig.CUSTOMER_TABLE,
                    [window.Query.equal('uid', uid)]
                );

                if (response.documents.length > 0) {
                    return response.documents[0];
                }
                return null;
            } catch (error) {
                console.error('❌ Error fetching customer profile:', error);
                return null;
            }
        }

        // Load saved recipients from database
        async function loadSavedRecipients() {
            // Show loading state
            const savedList = document.getElementById('savedRecipientsList');
            savedList.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-8 h-8 border-2 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-3"></div>
                    <p class="text-gray-400 text-sm">Loading saved recipients...</p>
                </div>
            `;

            try {
                // Get current user
                const user = await window.account.get();
                console.log('🔍 Current user:', user.$id);

                // Fetch saved recipients from database
                if (window.OrderManager) {
                    const orderManager = new window.OrderManager();
                    const recipients = await orderManager.getSavedRecipients(user.$id);

                    console.log('📋 Retrieved recipients:', recipients);

                    // Update global savedRecipients array
                    savedRecipients = recipients || [];

                    // Update the UI
                    updateSavedRecipientsList();
                } else {
                    console.error('❌ OrderManager not available');
                    savedRecipients = [];
                    updateSavedRecipientsList();
                }
            } catch (error) {
                console.error('❌ Error loading saved recipients:', error);
                savedRecipients = [];
                updateSavedRecipientsList();
            }
        }

        // Update saved recipients list
        function updateSavedRecipientsList() {
            const savedList = document.getElementById('savedRecipientsList');
            const savedContainer = document.getElementById('savedRecipientsContainer');

            savedList.innerHTML = '';

            if (savedRecipients.length === 0) {
                // Hide container when no saved recipients
                savedContainer.classList.add('hidden');
                return;
            }

            // Show container when there are saved recipients
            savedContainer.classList.remove('hidden');

            savedRecipients.forEach(recipient => {
                const recipientItem = document.createElement('div');
                recipientItem.className = 'saved-recipient-item';
                recipientItem.style.position = 'relative';

                recipientItem.innerHTML = `
                    <button onclick="deleteSavedRecipient(${recipient.id})" class="delete-recipient-btn" title="Delete recipient">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            <path d="M10 11v6"/>
                            <path d="M14 11v6"/>
                        </svg>
                    </button>
                    <div onclick="selectSavedRecipient(${recipient.id})" class="recipient-content">
                        <div class="saved-recipient-name">${recipient.name}</div>
                        <div class="saved-recipient-info">${recipient.phone} • ${recipient.address}</div>
                    </div>
                `;

                savedList.appendChild(recipientItem);
            });
        }

        // Select saved recipient
        function selectSavedRecipient(recipientId) {
            const recipient = savedRecipients.find(r => r.id === recipientId);
            if (!recipient) return;

            selectedSavedRecipient = recipient;

            // Update UI
            document.querySelectorAll('.saved-recipient-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.closest('.saved-recipient-item').classList.add('selected');

            // Fill form fields
            document.getElementById('recipientName').value = recipient.name;
            document.getElementById('recipientPhone').value = recipient.phone;
            document.getElementById('recipientEmail').value = recipient.email;
            document.getElementById('recipientAddress').value = recipient.address;

            if (recipient.type === 'business') {
                document.getElementById('businessType').value = recipient.businessType;
                document.getElementById('businessName').value = recipient.businessName;
            }

            // Set recipient type
            selectRecipientType(recipient.type);
        }

        // Delete saved recipient
        async function deleteSavedRecipient(recipientId) {
            if (confirm('Are you sure you want to delete this saved recipient?')) {
                try {
                    if (!window.OrderManager) {
                        showError('Unable to delete recipient. Please try again.');
                        return;
                    }

                    const orderManager = new window.OrderManager();

                    // Delete from database
                    await orderManager.deleteRecipient(recipientId);

                    // Remove from local array
                    savedRecipients = savedRecipients.filter(r => r.id !== recipientId);

                    // Update UI
                    updateSavedRecipientsList();

                    // Show success message
                    showSuccess('Recipient deleted successfully');

                    // If this was the selected recipient, clear selection
                    if (selectedSavedRecipient && selectedSavedRecipient.id === recipientId) {
                        selectedSavedRecipient = null;
                    }

                    console.log('✅ Recipient deleted from database:', recipientId);
                } catch (error) {
                    console.error('❌ Error deleting recipient:', error);
                    showError('Failed to delete recipient. Please try again.');
                }
            }

            // Prevent event bubbling to avoid selecting the recipient
            event.stopPropagation();
        }

        // Save recipient to database
        async function saveRecipient() {
            if (!window.OrderManager || !orderData.customer || !orderData.customer.id) {
                showError('Unable to save recipient. Please make sure you are logged in.');
                return;
            }

            try {
                const orderManager = new window.OrderManager();

                // Prepare recipient data
                const recipientData = {
                    type: recipientType,
                    name: document.getElementById('recipientName').value,
                    phone: document.getElementById('recipientPhone').value,
                    email: document.getElementById('recipientEmail').value,
                    address: document.getElementById('recipientAddress').value,
                    businessName: document.getElementById('businessName').value || '',
                    businessType: document.getElementById('businessType').value || ''
                };

                // Save to database
                const result = await orderManager.saveRecipient(orderData.customer.id, recipientData);

                // Reload saved recipients
                await loadSavedRecipients();

                // Show success message
                showSuccess('Recipient saved successfully');

                console.log('✅ Recipient saved to database:', result.$id);
            } catch (error) {
                console.error('❌ Error saving recipient:', error);
                showError('Failed to save recipient. Please try again.');
            }
        }

        // Update date and time step
        function updateDateTimeStep() {
            console.log('🔍 Updating date/time step...');
            console.log('🔍 Selected company:', selectedCompany);
            console.log('🔍 Services loaded:', services.length > 0);

            // Display company working hours
            const company = services.find(service => service.name === selectedCompany);
            const workingHoursDisplay = document.getElementById('workingHoursDisplay');
            const workingHoursText = document.getElementById('workingHoursText');

            if (company && company.working_days && company.working_days.length > 0) {
                console.log('🔍 Company working days:', company.working_days);
                // Format working days display
                const workingDaysList = company.working_days.map(wd =>
                    `${wd.day}: ${wd.time}`
                ).join(', ');

                workingHoursText.textContent = workingDaysList;
                workingHoursDisplay.style.display = 'block';
            } else {
                console.log('🔍 No working days found for company');
                workingHoursDisplay.style.display = 'none';
            }

            // Generate time slots
            generateTimeSlots();
            console.log('🔍 Time slots generated');

            // If we already have date and time data, pre-fill the form
            if (orderData.deliveryDate) {
                document.getElementById('deliveryDate').value = orderData.deliveryDate;
            }

            if (orderData.deliveryTime) {
                document.getElementById('deliveryTime').value = orderData.deliveryTime;

                // Also select the corresponding time slot button
                const timeSlots = document.querySelectorAll('.time-slot-btn');
                timeSlots.forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent.includes(orderData.deliveryTime.replace(':00', ''))) {
                        btn.classList.add('selected');
                    }
                });
            }
        }

        // Update recipient step
        function updateRecipientStep() {
            console.log('🔍 Updating recipient step...');
            console.log('🔍 Current recipientType:', recipientType);

            // Initialize the recipient type to 'you' if not set
            if (!recipientType) {
                recipientType = 'you';
                orderData.purchase_recipient_type = 'you';
            }

            // Set the correct button state
            document.querySelectorAll('.recipient-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById('recipient' + recipientType.charAt(0).toUpperCase() + recipientType.slice(1));
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // Initialize field visibility based on recipient type
            const youInfo = document.getElementById('youRecipientInfo');
            const nameContainer = document.getElementById('recipientNameContainer');
            const phoneContainer = document.getElementById('recipientPhoneContainer');
            const emailContainer = document.getElementById('recipientEmailContainer');
            const businessTypeContainer = document.getElementById('businessTypeContainer');
            const businessNameContainer = document.getElementById('businessNameContainer');

            console.log('🔍 Elements found:', {
                youInfo: !!youInfo,
                nameContainer: !!nameContainer,
                phoneContainer: !!phoneContainer,
                emailContainer: !!emailContainer,
                businessTypeContainer: !!businessTypeContainer,
                businessNameContainer: !!businessNameContainer
            });

            if (recipientType === 'individual') {
                // Hide "You" info
                youInfo.style.display = 'none';
                // Show individual fields
                nameContainer.classList.remove('hidden');
                phoneContainer.classList.remove('hidden');
                emailContainer.classList.remove('hidden');
                // Hide business fields
                businessTypeContainer.classList.add('hidden');
                businessNameContainer.classList.add('hidden');
                console.log('🔍 Set up for individual recipient');
            } else if (recipientType === 'business') {
                // Hide "You" info
                youInfo.style.display = 'none';
                // Show individual fields
                nameContainer.classList.remove('hidden');
                phoneContainer.classList.remove('hidden');
                emailContainer.classList.remove('hidden');
                // Show business fields
                businessTypeContainer.classList.remove('hidden');
                businessNameContainer.classList.remove('hidden');
                console.log('🔍 Set up for business recipient');
            } else { // 'you'
                // Show "You" info
                youInfo.style.display = 'block';
                // Hide individual fields
                nameContainer.classList.add('hidden');
                phoneContainer.classList.add('hidden');
                emailContainer.classList.add('hidden');
                // Hide business fields
                businessTypeContainer.classList.add('hidden');
                businessNameContainer.classList.add('hidden');
                console.log('🔍 Set up for "you" recipient');
                loadUserProfileData();
            }

            console.log('🔍 Field visibility after update:', {
                youInfoDisplay: youInfo.style.display,
                nameContainerHidden: nameContainer.classList.contains('hidden'),
                phoneContainerHidden: phoneContainer.classList.contains('hidden'),
                emailContainerHidden: emailContainer.classList.contains('hidden'),
                businessTypeContainerHidden: businessTypeContainer.classList.contains('hidden'),
                businessNameContainerHidden: businessNameContainer.classList.contains('hidden')
            });

            // If we already have recipient data, pre-fill form
            if (orderData.recipient) {
                if (recipientType !== 'you') {
                    document.getElementById('recipientName').value = orderData.recipient.name || '';
                    document.getElementById('businessName').value = orderData.recipient.businessName || '';
                    document.getElementById('recipientPhone').value = orderData.recipient.phone || '';
                    document.getElementById('recipientEmail').value = orderData.recipient.email || '';
                    document.getElementById('recipientAddress').value = orderData.recipient.address || '';

                    if (orderData.recipient.type === 'business' && orderData.recipient.businessType) {
                        document.getElementById('businessType').value = orderData.recipient.businessType;
                    }
                } else {
                    document.getElementById('recipientAddress').value = orderData.recipient.address || '';
                }
            }
        }

        // Update quantity step with selected products
        function updateQuantityStep() {
            console.log('🔍 Updating quantity step...');
            console.log('🔍 Selected products:', selectedProducts);
            console.log('🔍 Selected company:', selectedCompany);

            const selectedContainer = document.getElementById('selectedProductsContainer');
            console.log('🔍 Container element:', selectedContainer);

            // Clear existing content
            selectedContainer.innerHTML = '';

            // Show selected products with quantity controls
            if (selectedProducts.length > 0) {
                console.log('🔍 Displaying', selectedProducts.length, 'products');
                selectedProducts.forEach((product, index) => {
                    console.log(`🔍 Product ${index}:`, product);

                    // Handle missing images
                    const productImage = product.image ||
                        (product.type === 'large-bottle' ? 'images/products/large-bottle.jpg' :
                            product.type === 'dispenser' ? 'images/products/dispenser.jpg' : null);

                    const imageHtml = productImage ?
                        `<img src="${productImage}" alt="${product.name}" class="selected-product-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNDA0NDRCIi8+CjxwYXRoIGQ9Ik0yMCAyNEw0NCA0ME0yMCA0MEw0NCAyNCIgc3Ryb2tlPSIjODA4MDgwIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iMzIiIGN5PSIyOCIgcj0iNCIgZmlsbD0iIzgwODA4MCIvPgo8L3N2Zz4K'">` :
                        `<div class="selected-product-image-placeholder">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#808080" stroke-width="2">
                                <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>`;

                    const selectedItem = document.createElement('div');
                    selectedItem.className = 'selected-product-item';
                    selectedItem.innerHTML = `
                        ${imageHtml}
                        <div class="selected-product-details">
                            <div class="selected-product-name">${product.name || product.product_name || 'Unknown Product'}</div>
                            <div class="selected-product-price">GHS ${parseFloat(product.price).toFixed(2)} each</div>
                        </div>
                        <div class="selected-product-quantity">
                            <button onclick="changeProductQuantity(${index}, -1)" class="quantity-btn-small">-</button>
                            <span class="quantity-display-small">${product.quantity || 1}</span>
                            <button onclick="changeProductQuantity(${index}, 1)" class="quantity-btn-small">+</button>
                        </div>
                    `;
                    selectedContainer.appendChild(selectedItem);
                });
            } else {
                console.log('🔍 No products selected, showing message');
                const noProducts = document.createElement('div');
                noProducts.className = 'no-products-selected';
                noProducts.textContent = 'No products selected. Please go back and select products.';
                selectedContainer.appendChild(noProducts);
            }

            updateQuantityCalculations();
        }

        // Add more products (go back to service selection)
        function addMoreProducts() {
            // Close bottom sheet
            closeScheduleFlow();

            // Show success message
            showSuccess('You can now select more products from the service cards');

            // Scroll to the selected company's card
            setTimeout(() => {
                const companyCard = document.querySelector(`h3:contains('${selectedCompany}')`)?.closest('.card-bg');
                if (companyCard) {
                    companyCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // Change product quantity
        function changeProductQuantity(productIndex, amount) {
            if (selectedProducts[productIndex]) {
                const product = selectedProducts[productIndex];
                const newQuantity = product.quantity + amount;

                // Find the original product to get minQuantity
                const originalProduct = services.find(service =>
                    service.products.some(p => p.name === product.name && p.type === product.type)
                )?.products.find(p => p.name === product.name && p.type === product.type);

                const minQuantity = originalProduct?.minQuantity || 1;

                // Validate minimum quantity
                if (newQuantity < minQuantity) {
                    showError(`Minimum quantity for ${product.name || product.product_name || 'Unknown Product'} is ${minQuantity} item${minQuantity > 1 ? 's' : ''}`);
                    return;
                }

                // Validate maximum quantity (reasonable limit)
                if (newQuantity > 100) {
                    showError(`Maximum quantity per product is 100 items`);
                    return;
                }

                // Update quantity
                selectedProducts[productIndex].quantity = newQuantity;

                // Update the product in serviceProducts as well
                const serviceIndex = serviceProducts[product.company].findIndex(p => p.name === product.name);
                if (serviceIndex > -1) {
                    serviceProducts[product.company][serviceIndex].quantity = newQuantity;

                    // Update quantity indicator in UI
                    if (viewSwipe) {
                        // Update swipe view
                        renderSwipeCard(currentCardIndex);
                    } else {
                        // Update list view
                        updateProductQuantityInListView(product.company, product.name, newQuantity);
                    }
                }

                updateQuantityStep();
            }
        }

        // Check if company is open at selected date and time
        function isCompanyOpen(companyName, date, time) {
            const company = services.find(service => service.name === companyName);
            if (!company || !company.openingHours) return false;

            // Get day of week (0 = Sunday, 1 = Monday, etc.)
            const selectedDate = new Date(date);
            const dayOfWeek = selectedDate.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = dayNames[dayOfWeek];

            // Get opening hours for this day
            const dayHours = company.openingHours[today];

            // Check if company is closed on this day
            if (!dayHours || dayHours.open === 'closed') {
                return false;
            }

            // Parse times
            const selectedTime24 = convertTo24Hour(time);
            const openTime24 = convertTo24Hour(dayHours.open);
            const closeTime24 = convertTo24Hour(dayHours.close);

            // Check if selected time is within opening hours
            return selectedTime24 >= openTime24 && selectedTime24 <= closeTime24;
        }

        // Convert time to 24-hour format for comparison
        function convertTo24Hour(timeString) {
            if (!timeString) return 0;

            // Handle 24-hour format (HH:MM)
            if (timeString.includes(':') && !timeString.includes('AM') && !timeString.includes('PM')) {
                const [hours, minutes] = timeString.split(':');
                return parseInt(hours) + parseInt(minutes) / 60;
            }

            // Handle 12-hour format with AM/PM
            const [time, period] = timeString.split(' ');
            const [hours, minutes] = time.split(':');
            let hours24 = parseInt(hours);

            if (period === 'PM' && hours24 !== 12) {
                hours24 += 12;
            } else if (period === 'AM' && hours24 === 12) {
                hours24 = 0;
            }

            return hours24 + parseInt(minutes) / 60;
        }

        // Get company opening hours info
        function getCompanyHoursInfo(companyName, date) {
            const company = services.find(service => service.name === companyName);
            if (!company || !company.openingHours) return null;

            const selectedDate = new Date(date);
            const dayOfWeek = selectedDate.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = dayNames[dayOfWeek];

            const dayHours = company.openingHours[today];

            if (!dayHours || dayHours.open === 'closed') {
                return {
                    isOpen: false,
                    message: `${companyName} is closed on ${dayNames[dayOfWeek].charAt(0).toUpperCase() + dayNames[dayOfWeek].slice(1)}s`
                };
            }

            return {
                isOpen: true,
                open: dayHours.open,
                close: dayHours.close,
                message: `${companyName} is open from ${dayHours.open} to ${dayHours.close} on ${dayNames[dayOfWeek].charAt(0).toUpperCase() + dayNames[dayOfWeek].slice(1)}s`
            };
        }

        // Validate date and time selection
        function validateDateTimeSelection() {
            if (!selectedDate || !selectedTime) {
                showError('Please select both date and time for delivery');
                return false;
            }

            const company = services.find(service => service.name === selectedCompany);
            if (!company) {
                showError('Company information not found');
                return false;
            }

            // Check if company is open
            if (!isCompanyOpen(selectedCompany, selectedDate, selectedTime)) {
                const hoursInfo = getCompanyHoursInfo(selectedCompany, selectedDate);
                const errorMessage = hoursInfo && hoursInfo.message
                    ? hoursInfo.message
                    : `${selectedCompany} is closed at the selected time. Please choose a different time.`;
                showError(errorMessage);
                return false;
            }

            // Check if selected date is in the past
            const selectedDateTime = new Date(`${selectedDate} ${selectedTime}`);
            const now = new Date();

            if (selectedDateTime <= now) {
                showError('Please select a future date and time for delivery');
                return false;
            }

            // Check if selected date is too far in the future (more than 30 days)
            const maxFutureDate = new Date();
            maxFutureDate.setDate(maxFutureDate.getDate() + 30);

            if (selectedDateTime > maxFutureDate) {
                showError('Please select a date within the next 30 days');
                return false;
            }

            return true;
        }

        // Update product quantity in list view
        function updateProductQuantityInListView(companyName, productName, quantity) {
            // Find the product item in list view and update its quantity indicator
            const serviceCards = document.querySelectorAll('#listView > .card-bg');
            serviceCards.forEach(card => {
                const cardCompany = card.querySelector('h3 a').textContent;
                if (cardCompany === companyName) {
                    const productItems = card.querySelectorAll('.product-item');
                    productItems.forEach(item => {
                        // We need to match the product somehow - this is a simplified version
                        // In a real app, you would have a data attribute to identify the product
                        if (item.classList.contains('selected')) {
                            const quantityIndicator = item.querySelector('.product-item-quantity');
                            if (quantityIndicator) {
                                quantityIndicator.textContent = quantity;
                            }
                        }
                    });
                }
            });
        }

        // Calculate service fee: GHS 0.2 per item
        function calculateServiceFee() {
            const totalItems = selectedProducts.reduce((sum, product) => sum + product.quantity, 0);
            return totalItems * SERVICE_FEE_PER_ITEM;
        }

        // Update quantity calculations
        function updateQuantityCalculations() {
            const subtotal = selectedProducts.reduce((sum, product) => sum + (parseFloat(product.price) * product.quantity), 0);
            const serviceFee = calculateServiceFee();
            const total = subtotal + serviceFee;

            document.getElementById('quantitySubtotal').textContent = `GHS ${subtotal.toFixed(2)}`;
            document.getElementById('serviceFeeDisplay').textContent = `GHS ${serviceFee.toFixed(2)}`;
            document.getElementById('quantityTotal').textContent = `GHS ${total.toFixed(2)}`;
        }

        // Update order review
        function updateOrderReview() {
            if (selectedProducts.length === 0) return;

            const subtotal = selectedProducts.reduce((sum, product) => sum + (parseFloat(product.price) * product.quantity), 0);
            const serviceFee = calculateServiceFee();
            const total = subtotal + serviceFee;

            // Update products list
            const productsList = document.getElementById('reviewProductsList');
            productsList.innerHTML = '';

            selectedProducts.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'review-product-item';
                productItem.innerHTML = `
                    <img src="${product.image}" alt="${product.name || product.product_name || 'Unknown Product'}" class="review-product-image">
                    <div class="review-product-details">
                        <div class="review-product-name">${product.quantity}x ${product.name || product.product_name || 'Unknown Product'}</div>
                        <div class="review-product-price">GHS ${(parseFloat(product.price) * product.quantity).toFixed(2)}</div>
                    </div>
                `;
                productsList.appendChild(productItem);
            });

            // Update delivery information
            document.getElementById('reviewDeliveryDate').textContent = formatDate(selectedDate);
            document.getElementById('reviewDeliveryTime').textContent = formatTime(selectedTime);
            document.getElementById('reviewDeliveryAddress').textContent = orderData.recipient.address || '';

            // Update delivery instructions
            const instructions = document.getElementById('deliveryInstructions').value || 'None provided';
            document.getElementById('reviewDeliveryInstructions').textContent = instructions;

            // Update payment summary
            document.getElementById('reviewSubtotal').textContent = `GHS ${subtotal.toFixed(2)}`;
            document.getElementById('reviewServiceFee').textContent = `GHS ${serviceFee.toFixed(2)}`;
            document.getElementById('reviewTotal').textContent = `GHS ${total.toFixed(2)}`;

            // Save order data
            orderData.products = selectedProducts;
            orderData.subtotal = subtotal;
            orderData.serviceFee = serviceFee;
            orderData.total = total;
            orderData.deliveryInstructions = instructions;
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Format time for display
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;

            // Update UI
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });

            event.currentTarget.classList.add('selected');

            // If Pay on Delivery is selected, show confirmation dialog
            if (method === 'delivery') {
                showPayOnDeliveryConfirmation();
            }
        }

        function showPayOnDeliveryConfirmation() {
            const modal = document.getElementById('payOnDeliveryModal');
            modal.classList.remove('hidden');

            // Add active class after a small delay for animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function confirmPayOnDelivery() {
            const modal = document.getElementById('payOnDeliveryModal');
            modal.classList.remove('active');

            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
                // Show service fee payment modal
                showServiceFeePaymentModal();
            }, 300);
        }

        function cancelPayOnDelivery() {
            const modal = document.getElementById('payOnDeliveryModal');
            modal.classList.remove('active');

            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);

            // User cancelled - reset selection
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Service Fee Payment Functions
        function showServiceFeePaymentModal() {
            const serviceFee = calculateServiceFee();
            const subtotal = selectedProducts.reduce((sum, product) => sum + (parseFloat(product.price) * product.quantity), 0);
            const remainingBalance = subtotal; // Remaining balance is subtotal (excluding service fee)

            // Update modal displays
            document.getElementById('serviceFeeAmountDisplay').textContent = `GHS ${serviceFee.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `GHS ${remainingBalance.toFixed(2)}`;

            const modal = document.getElementById('serviceFeePaymentModal');
            modal.classList.remove('hidden');

            // Add active class after a small delay for animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function cancelServiceFeePayment() {
            const modal = document.getElementById('serviceFeePaymentModal');
            modal.classList.remove('active');

            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);

            // User cancelled - reset selection
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function payServiceFeeWithPaystack() {
            const serviceFee = calculateServiceFee();

            if (serviceFee <= 0) {
                showError('Service fee amount is invalid');
                return;
            }

            // Hide service fee modal and show processing modal
            const serviceFeeModal = document.getElementById('serviceFeePaymentModal');
            serviceFeeModal.classList.remove('active');
            setTimeout(() => {
                serviceFeeModal.classList.add('hidden');
            }, 300);

            // Show processing modal
            const processingModal = document.getElementById('paymentProcessingModal');
            processingModal.classList.remove('hidden');
            setTimeout(() => {
                processingModal.classList.add('active');
            }, 10);

            // Initialize Paystack payment
            const handler = PaystackPop.setup({
                key: 'pk_live_00d41944ffac0707f49b240150e55474e2a5c06e', // Live public key
                email: orderData.recipient.email || orderData.customer.email || 'customer@example.com',
                amount: serviceFee * 100, // Convert to kobo/cents
                currency: 'GHS',
                ref: 'SF_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                callback: function (response) {
                    handleServiceFeePaymentSuccess(response);
                },
                onClose: function () {
                    handleServiceFeePaymentClose();
                }
            });

            handler.openIframe();
        }

        function handleServiceFeePaymentSuccess(response) {
            console.log('Service fee payment successful:', response);

            // Hide processing modal
            const processingModal = document.getElementById('paymentProcessingModal');
            processingModal.classList.remove('active');
            setTimeout(() => {
                processingModal.classList.add('hidden');
            }, 300);

            // Store payment details
            orderData.serviceFeePayment = {
                paid: true,
                amount: calculateServiceFee(),
                transactionRef: response.reference,
                paidAt: new Date().toISOString()
            };

            // Show success message
            showSuccess('Service fee paid successfully! Continuing with your order...');

            // Continue to next step (bottom sheet process)
            setTimeout(() => {
                nextStep();
            }, 1500);
        }

        function handleServiceFeePaymentClose() {
            console.log('Service fee payment window closed');

            // Hide processing modal
            const processingModal = document.getElementById('paymentProcessingModal');
            processingModal.classList.remove('active');
            setTimeout(() => {
                processingModal.classList.add('hidden');
            }, 300);

            // Show error message
            showError('Service fee payment was cancelled. Please try again to continue with your order.');

            // Show service fee modal again for retry
            setTimeout(() => {
                showServiceFeePaymentModal();
            }, 2000);
        }

        function processPayment() {
            if (!validateCurrentStep()) {
                return;
            }
            nextStep();
        }

        function startPaymentProcessing() {
            let progress = 0;
            const progressBar = document.getElementById('paymentProgressBar');

            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        nextStep();
                    }, 1000);
                }
            }, 300);
        }

        function showPaymentSuccess() {
            if (selectedPaymentMethod === 'delivery') {
                // For Pay on Delivery, show order confirmation with payment breakdown
                const orderId = 'ORD' + Date.now().toString().slice(-8);
                document.getElementById('transactionIdDisplay').textContent = orderId;

                const serviceFee = calculateServiceFee();
                const subtotal = selectedProducts.reduce((sum, product) => sum + (parseFloat(product.price) * product.quantity), 0);
                const remainingBalance = subtotal;

                // Update amount display to show payment breakdown
                let paymentBreakdown = '';
                if (orderData.serviceFeePayment && orderData.serviceFeePayment.paid) {
                    paymentBreakdown = `Service Fee: GHS ${serviceFee.toFixed(2)} (Paid Online)\nRemaining Balance: GHS ${remainingBalance.toFixed(2)} (Pay on Delivery)`;
                } else {
                    paymentBreakdown = `GHS ${orderData.total.toFixed(2)} (Pay on Delivery)`;
                }

                document.getElementById('amountPaidDisplay').textContent = paymentBreakdown;

                // Update the payment success message for delivery
                const successMessage = document.querySelector('#paymentSuccessStep .section-header');
                if (successMessage) {
                    successMessage.textContent = 'Order Confirmed!';
                }

                const subMessage = document.querySelector('#paymentSuccessStep .section-subheader');
                if (subMessage) {
                    if (orderData.serviceFeePayment && orderData.serviceFeePayment.paid) {
                        subMessage.textContent = 'Service fee paid successfully. Remaining balance payable upon delivery.';
                    } else {
                        subMessage.textContent = 'Your order has been confirmed. Pay upon delivery.';
                    }
                }

                orderData.transactionId = orderId;
                orderData.paymentMethod = 'delivery';
                orderData.timestamp = new Date().toISOString();
            } else {
                // Regular mobile money payment success
                const transactionId = 'TXN' + Date.now().toString().slice(-8);
                document.getElementById('transactionIdDisplay').textContent = transactionId;
                document.getElementById('amountPaidDisplay').textContent = `GHS ${orderData.total.toFixed(2)}`;

                orderData.transactionId = transactionId;
                orderData.paymentMethod = 'mobile';
                orderData.timestamp = new Date().toISOString();
            }
        }

        function showScheduleSent() {
            const orderId = 'ORD' + Date.now().toString().slice(-8);
            document.getElementById('orderIdDisplay').textContent = orderId;
            document.getElementById('orderDateDisplay').textContent = formatDate(selectedDate);
            document.getElementById('orderTimeDisplay').textContent = formatTime(selectedTime);

            // Show total items count
            const totalItems = selectedProducts.reduce((sum, product) => sum + product.quantity, 0);
            document.getElementById('orderItemsDisplay').textContent = `${totalItems} items`;

            orderData.orderId = orderId;
            orderData.orderDate = formatDate(selectedDate);
            orderData.orderTime = formatTime(selectedTime);
        }

        function setRating(rating) {
            userRating = rating;

            // Update star display
            document.querySelectorAll('.rating-star-large').forEach((star, index) => {
                star.textContent = '☆';
                star.classList.remove('selected');

                if (index < rating) {
                    star.textContent = '★';
                    star.classList.add('selected');
                }
            });
        }

        async function submitRating() {
            const comment = document.getElementById('ratingComment').value;

            if (userRating === 0) {
                showError('Please select a rating');
                return;
            }

            orderData.rating = userRating;
            orderData.comment = comment;

            // Prefer server-side API to ensure DB save without client auth
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');
                const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                const resolvedBranchId = branchData?.branch_id || branchId;
                const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

                const payload = {
                    company_id: resolvedCompanyId,
                    branch_id: resolvedBranchId || '',
                    stars: userRating,
                    comment: comment || '',
                    product_tags: [],
                    location: orderData.recipient?.address || (window.currentCompany?.location || ''),
                    order_id: orderData.orderId || null,
                    customer_id: null
                };

                const resp = await fetch('/api/ratings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) throw new Error('Server API failed');

                const data = await resp.json();
                console.log('✅ Rating saved via server API (services)', data);
                currentStep = 11;
                goToStep('ratingSuccess');
                return;
            } catch (apiErr) {
                console.warn('API rating save failed, attempting Appwrite client save...', apiErr);
            }

            // Save rating to Appwrite DB (client-side) as secondary path
            try {
                if (window.databases && window.appwriteConfig && window.account) {
                    const user = await window.account.get();
                    const ratingId = (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 20);

                    const urlParams = new URLSearchParams(window.location.search);
                    const branchId = urlParams.get('branch_id');
                    const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                    const resolvedBranchId = branchData?.branch_id || branchId;
                    const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || '');

                    const payload = {
                        rating_id: ratingId,
                        company_id: resolvedCompanyId,
                        branch_id: resolvedBranchId || '',
                        order_id: orderData.orderId || null,
                        customer_id: user.$id,
                        stars: userRating,
                        comment: comment || '',
                        created_at: new Date().toISOString(),
                        location: orderData.recipient?.address || (window.currentCompany?.location || ''),
                        product_tags: []
                    };

                    await window.databases.createDocument(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.RATINGS_TABLE,
                        window.ID.unique(),
                        payload
                    );
                    console.log('✅ Rating saved to Appwrite (services)', payload);

                    // Proceed to success only after saving
                    currentStep = 11;
                    goToStep('ratingSuccess');
                    return;
                } else {
                    console.error('❌ Appwrite not available for ratings (services)');
                }
            } catch (err) {
                console.error('❌ Failed to save rating (services), using local fallback:', err);
            }

            // Local fallback
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const branchId = urlParams.get('branch_id');
                const branchData = window.currentCompany && window.currentCompany.branch_id ? window.currentCompany : null;
                const resolvedBranchId = branchData?.branch_id || branchId;
                const resolvedCompanyId = branchData?.company_id || (window.currentCompany?.company_id || 'unknown');

                const storageKey = `reviews_${resolvedCompanyId}_${resolvedBranchId || 'all'}`;
                const existing = localStorage.getItem(storageKey);
                const reviewsLocal = existing ? JSON.parse(existing) : [];

                const newReview = {
                    id: Date.now(),
                    name: 'You',
                    rating: userRating,
                    comment: comment || '',
                    tags: [],
                    date: new Date().toISOString()
                };

                reviewsLocal.push(newReview);
                localStorage.setItem(storageKey, JSON.stringify(reviewsLocal));
                console.log('💾 Rating saved locally (services)', { storageKey, newReview });

                currentStep = 11;
                goToStep('ratingSuccess');
                return;
            } catch (localErr) {
                console.error('❌ Local fallback failed (services):', localErr);
                showError('Failed to submit rating. Please try again later.');
                return;
            }
        }

        function showRatingSuccess() {
            document.getElementById('finalOrderId').textContent = orderData.orderId;
            document.getElementById('finalDeliveryDate').textContent = `${formatDate(selectedDate)} at ${formatTime(selectedTime)}`;
            document.getElementById('finalTotalPaid').textContent = `GHS ${orderData.total.toFixed(2)}`;

            // Show stars for rating
            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < userRating) {
                    stars += '★';
                } else {
                    stars += '☆';
                }
            }
            document.getElementById('finalRatingStars').textContent = stars;
        }

        async function completeOrderFlow() {
            // console.log('📝 Order completed with rating:', userRating);
            // console.log('💾 Order data to save:', orderData);

            // CRITICAL: Ensure products are preserved before saving
            console.log('🔍 completeOrderFlow - selectedProducts before save:', selectedProducts);
            console.log('🔍 completeOrderFlow - orderData.products before save:', orderData.products);
            
            // Make sure products are set in orderData
            if (!orderData.products || orderData.products.length === 0) {
                console.log('⚠️ Products missing in orderData, copying from selectedProducts');
                orderData.products = [...selectedProducts]; // Create a copy
                console.log('✅ Products copied to orderData:', orderData.products);
            }

            // CRITICAL: Save order to database and AWAIT completion before clearing products
            console.log('⏳ About to save order... waiting for completion');
            await saveOrderToHistory();
            console.log('✅ Order save completed');

            // Show success message (GREEN)
            showSuccess(`Thank you for your order! Order ID: ${orderData.orderId}. Your order has been confirmed and will be processed.`);

            setTimeout(() => {
                closeScheduleFlow();

                // NOW it's safe to reset products after the save is complete
                serviceProducts[selectedCompany] = [];
                selectedProducts = [];
                updateServiceProductCount(selectedCompany);

                // Reset UI selections
                if (viewSwipe) {
                    renderSwipeCard(currentCardIndex);
                } else {
                    document.querySelectorAll('.product-item').forEach(item => {
                        item.classList.remove('selected');
                        const quantityIndicator = item.querySelector('.product-item-quantity');
                        if (quantityIndicator) {
                            quantityIndicator.remove();
                        }
                    });
                }
            }, 3000);
        }

        function finishFlow() {
            // This is for the "Done" button in the last step
            completeOrderFlow();
        }

        // Save order to database with caching support
        async function saveOrderToHistory() {
            try {
                console.log('🚀 Starting to save order to database...');
                console.log('📦 Order data to save:', orderData);
                console.log('📦 selectedProducts at save time:', selectedProducts);

                // CRITICAL: Ensure products are set - use selectedProducts as ultimate fallback
                if (!orderData.products || orderData.products.length === 0) {
                    console.log('⚠️ orderData.products is empty, using selectedProducts as fallback');
                    orderData.products = selectedProducts || [];
                    console.log('📦 Products set from selectedProducts:', orderData.products);
                    
                    // Double-check that we have products
                    if (!orderData.products || orderData.products.length === 0) {
                        console.error('❌ CRITICAL: No products available to save!');
                        showError('No products selected. Please select at least one product and try again.');
                        throw new Error('Cannot save order without products');
                    }
                }

                // Ensure customer data is loaded before proceeding
                if (!orderData.customer || !orderData.customer.id) {
                    console.log('🔄 Customer data missing, reloading...');
                    await loadCustomerData();

                    // Check again after reloading
                    if (!orderData.customer || !orderData.customer.id) {
                        throw new Error('Customer data not available. Please ensure you are logged in.');
                    }
                }

                // Cache order data locally first for offline access
                if (window.cacheManager) {
                    window.cacheManager.setCache('orders', orderData, orderData.orderId);
                    console.log('💾 Order cached locally for offline access');
                }

                // Save to database using OrderManager
                console.log('🔍 Checking OrderManager availability:', !!window.OrderManager);
                console.log('🔍 Checking Appwrite config:', !!window.appwriteConfig);
                console.log('🔍 Checking databases SDK:', !!window.databases);
                console.log('🔍 Checking customer data:', !!orderData.customer);
                console.log('🔍 Customer ID:', orderData.customer?.id);

                if (window.OrderManager && window.appwriteConfig && window.databases && orderData.customer && orderData.customer.id) {
                    try {
                        const orderManager = new window.OrderManager();

                        // Prepare order data for database (orders table)
                        const selectedCompanyData = services.find(s => s.name === selectedCompany);
                        console.log('🔍 Selected company data:', selectedCompanyData);
                        console.log('🔍 Branch ID from company:', selectedCompanyData?.branch_id);

                        const dbOrderData = {
                            // Required customer field
                            customer_id: orderData.customer.id,

                            // Order details (other customer details to be added later when columns exist)
                            company_id: selectedCompanyData?.id || '',
                            branch_id: selectedCompanyData?.branch_id || '',
                            deliveryTime: orderData.deliveryTime,
                            deliveryDate: orderData.deliveryDate,
                            orderComment: orderData.deliveryInstructions || '',
                            deliveryAddress: orderData.recipient.address,
                            paymentMethod: orderData.payment?.network || selectedPaymentMethod || 'mobile',
                            transactionId: orderData.transactionId || '',
                            deliveryName: orderData.purchase_recipient_type === 'you' ? (orderData.customer?.full_name || orderData.customer?.name || 'User') : (orderData.recipient.name || ''),
                            deliveryOrgType: orderData.recipient.type || '',
                            total: Number(orderData.total || 0),
                            buyerId: orderData.customer.id
                        };

                        console.log('🔍 Final dbOrderData.branch_id:', dbOrderData.branch_id);

                        // Create order in database
                        const createdOrder = await orderManager.createOrder(dbOrderData);

                        // Create purchase recipient information
                        // Ensure recipient name and phone are not empty
                        let recipientName = orderData.purchase_recipient_type === 'you' ? (orderData.customer?.full_name || '') : (orderData.recipient.name || '');
                        let recipientPhone = orderData.purchase_recipient_type === 'you' ? (orderData.customer?.phone_number || '') : (orderData.recipient.phone || '');
                        
                        // Validate that both are not empty
                        if (!recipientName || !recipientName.trim()) {
                            console.error('❌ Recipient name is empty!');
                            showError('Recipient name is required. Please check your profile or recipient information.');
                            throw new Error('Recipient name cannot be empty');
                        }
                        
                        if (!recipientPhone || !recipientPhone.trim()) {
                            console.error('❌ Recipient phone is empty!');
                            showError('Recipient phone is required. Please check your profile or recipient information.');
                            throw new Error('Recipient phone cannot be empty');
                        }
                        
                        const recipientData = {
                            purchase_recipient_type: orderData.purchase_recipient_type,
                            recipient_name: recipientName.trim(),
                            recipient_phone: recipientPhone.trim(),
                            recipient_email: orderData.purchase_recipient_type === 'you' ? (orderData.customer?.email || '') : (orderData.recipient.email || ''),
                            recipient_address: orderData.recipient.address || '',
                            recipient_type: orderData.recipient.type || '',
                            business_name: orderData.recipient.businessName || '',
                            business_type: orderData.recipient.businessType || '',
                            self_pickup: orderData.purchase_recipient_type === 'you',
                            self_delivery_address: orderData.purchase_recipient_type === 'you' ? orderData.recipient.address : ''
                        };
                        
                        console.log('🔍 Recipient data being saved:', recipientData);

                        await orderManager.createPurchaseRecipientInfo(createdOrder.$id, recipientData);

                        // Create order items - ensure products are properly populated
                        console.log('🔍 About to create order items...');
                        console.log('🔍 orderData.products:', orderData.products);
                        console.log('🔍 selectedProducts:', selectedProducts);
                        console.log('🔍 orderData.products length:', orderData.products?.length);
                        
                        // Use selectedProducts as fallback if orderData.products is empty
                        const productsToSave = (orderData.products && orderData.products.length > 0) ? orderData.products : selectedProducts;
                        
                        console.log('🔍 Final products to save:', productsToSave);
                        console.log('🔍 Products count:', productsToSave?.length);
                        
                        if (productsToSave && productsToSave.length > 0) {
                            console.log('✅ Creating order items for', productsToSave.length, 'products');
                            await orderManager.createOrderItems(createdOrder.$id, productsToSave, dbOrderData);
                            console.log('✅ Order items created successfully');
                        } else {
                            console.error('❌ No order items to create. Both orderData.products and selectedProducts are empty!');
                            console.error('❌ orderData.products:', orderData.products);
                            console.error('❌ selectedProducts:', selectedProducts);
                            showError('No products selected. Please select at least one product.');
                            throw new Error('No order items to create - products list is empty');
                        }

                        console.log('✅ Order saved to database:', createdOrder.$id);
                        console.log('✅ Order ID:', createdOrder.$id);

                        // Store order ID for reference
                        orderData.orderId = createdOrder.$id;

                    } catch (dbError) {
                        console.error('❌ Error saving order to database:', dbError);
                        showError('Failed to save order. Please try again.');
                        throw dbError;
                    }
                } else {
                    console.error('❌ OrderManager not available or customer not logged in');
                    console.error('❌ OrderManager available:', !!window.OrderManager);
                    console.error('❌ Appwrite config available:', !!window.appwriteConfig);
                    console.error('❌ Databases SDK available:', !!window.databases);
                    console.error('❌ Customer data available:', !!orderData.customer);
                    console.error('❌ Customer ID available:', !!orderData.customer?.id);

                    if (!window.appwriteConfig || !window.databases) {
                        showError('Appwrite database system not initialized. Please refresh the page and try again.');
                    } else if (!window.OrderManager) {
                        showError('Order system not available. Please refresh the page and try again.');
                    } else if (!orderData.customer) {
                        showError('You must be logged in to place an order. Please log in and try again.');
                    } else if (!orderData.customer.id) {
                        showError('User session expired. Please log in again and try placing the order.');
                    }
                    throw new Error('OrderManager not available or customer not logged in');
                }

                console.log('✅ Order successfully saved to database');

                // Trigger storage event for schedule-history.html
                window.dispatchEvent(new Event('storage'));
                console.log('🔄 Storage event dispatched to schedule-history.html');

            } catch (error) {
                console.error('❌ Error saving order to history:', error);

                // Handle offline scenario - add to sync queue
                if (window.cacheManager && window.cacheManager.isOffline()) {
                    console.log('📴 Offline mode - adding order to sync queue');
                    const syncId = window.cacheManager.addToSyncQueue('save_order', orderData, 'high');

                    if (syncId) {
                        showSuccess('Order saved locally. Will sync to database when connection is restored.');
                        console.log('📋 Order queued for sync with ID:', syncId);
                        return;
                    }
                }

                showError('Error saving order. Please try again.');
            }
        }

        // Set greeting based on time of day
        function setGreeting() {
            const hour = new Date().getHours();

            // Try to get real user name from multiple sources (same as loadMenuUserData)
            let userName = 'User';

            // 1. Try customerSession first
            const customerSession = localStorage.getItem('customerSession');
            if (customerSession) {
                try {
                    const sessionData = JSON.parse(customerSession);
                    userName = sessionData.name || 'User';
                    console.log('🔍 Greeting - customerSession name:', userName);
                } catch (e) {
                    console.log('Error parsing customerSession for greeting:', e);
                }
            }

            // 2. Try userProfile cache
            if (userName === 'User') {
                if (window.cacheManager) {
                    const userProfile = window.cacheManager.getCache('user_profile') || {};
                    userName = userProfile.name || userProfile.full_name || 'User';
                    console.log('🔍 Greeting - userProfile name:', userName);
                } else {
                    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    userName = userProfile.name || userProfile.full_name || 'User';
                    console.log('🔍 Greeting - localStorage userProfile name:', userName);
                }
            }

            // 3. Try customerData as fallback
            if (userName === 'User') {
                const customerData = localStorage.getItem('customerData');
                if (customerData) {
                    try {
                        const customer = JSON.parse(customerData);
                        userName = customer.full_name || 'User';
                        console.log('🔍 Greeting - customerData full_name:', userName);
                    } catch (e) {
                        console.log('Error parsing customerData for greeting:', e);
                    }
                }
            }

            // Fix common name variations
            if (userName === 'Asar') {
                userName = 'Asare';
                console.log('🔧 Fixed name: Asar → Asare');
            }

            // Get first name only and capitalize properly
            const firstName = userName.split(' ')[0];
            const displayName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
            let greeting = '';

            if (hour >= 0 && hour < 12) {
                greeting = `Good Morning, ${displayName}`;
            } else if (hour >= 12 && hour < 18) {
                greeting = `Good Afternoon, ${displayName}`;
            } else {
                greeting = `Good Evening, ${displayName}`;
            }

            console.log('🎯 Final greeting:', greeting);
            document.getElementById('greetingText').textContent = greeting;
        }

        // Validate user authentication and customer data
        async function validateUserAuthentication() {
            try {
                if (!window.account) {
                    throw new Error('Authentication system not available');
                }

                const user = await window.account.get();
                console.log('🔍 Authenticated user:', user.$id);

                // Check if customer data exists
                if (!orderData.customer || !orderData.customer.id) {
                    console.log('🔄 Loading customer data...');
                    await loadCustomerData();
                }

                // Final validation
                if (!orderData.customer || !orderData.customer.id) {
                    throw new Error('Customer profile not found. Please log out and log back in.');
                }

                return true;
            } catch (error) {
                console.error('❌ Authentication validation failed:', error);
                return false;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function () {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.remove('dark-theme', 'gray-theme', 'light-theme');
            document.body.classList.add(savedTheme + '-theme');

            // Set default terms option
            selectTermsOption('schedule');

            // Initialize search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', handleSearch);

            // Load customer data from database
            await loadCustomerData();

            // Load user data for menu display
            loadMenuUserData();

            // Validate user authentication
            const isAuthenticated = await validateUserAuthentication();
            if (!isAuthenticated) {
                console.error('❌ User authentication failed during initialization');
                showError('Authentication issue detected. Please refresh the page and log in again.');
            }

            // Get user location for distance calculations
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("📍 User location obtained");
                        console.log(`📍 Current location: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`);
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        // Re-render services with calculated distances
                        renderServices();
                    },
                    (error) => {
                        console.log("🏠 Using default location (user location unavailable)");
                        userLocation = { lat: 5.6037, lng: -0.1870 }; // Default Accra location
                        // Re-render services with calculated distances
                        renderServices();
                    }
                );
            } else {
                console.log("🏠 Geolocation not available - using default location");
                userLocation = { lat: 5.6037, lng: -0.1870 }; // Default Accra location
            }

            // Load saved recipients
            loadSavedRecipients();

            // Initialize date and time inputs
            initializeDateInput();
            generateTimeSlots();

            // Set greeting
            setGreeting();
        });

        // Load service data from database
        loadServiceData();

        // Add event listener to save user address when updated
        const addressField = document.getElementById('recipientAddress');
        if (addressField) {
            addressField.addEventListener('input', saveUserAddress);
        }

        // Load user profile data
        loadUserProfileData();

        // Navigation State Management
        function saveCurrentPage() {
            localStorage.setItem('previousPage', window.location.pathname.split('/').pop());
        }

        function navigateToPage(page) {
            saveCurrentPage();
            window.location.href = page;
        }

        // Sliding Menu Functions
        function toggleMenu() {
            const menuOverlay = document.getElementById('menuOverlay');
            const slidingMenu = document.getElementById('slidingMenu');

            menuOverlay.classList.add('active');
            slidingMenu.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeMenu() {
            const menuOverlay = document.getElementById('menuOverlay');
            const slidingMenu = document.getElementById('slidingMenu');

            menuOverlay.classList.remove('active');
            slidingMenu.classList.remove('active');
            document.body.style.overflow = ''; // Restore background scrolling
        }

        // Handle browser back button
        window.addEventListener('popstate', function (event) {
            const previousPage = localStorage.getItem('previousPage');
            if (previousPage && previousPage !== window.location.pathname.split('/').pop()) {
                // Navigate back to the saved page
                window.location.href = previousPage;
            }
        });

        // Initialize navigation state on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Clear previous page when landing directly on this page
            if (!localStorage.getItem('previousPage')) {
                localStorage.setItem('previousPage', 'services.html');
            }
        });

        // Download Order PDF Function
        // Mobile-optimized PDF Download Function
        function downloadOrderPDF() {
            try {
                // Show loading state for mobile users
                const downloadBtn = event.target;
                const originalContent = downloadBtn.innerHTML;

                // Show loading state
                downloadBtn.innerHTML = '<div class="flex items-center justify-center gap-2"><svg class="animate-spin w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Generating PDF...</div>';
                downloadBtn.disabled = true;

                // Small delay for UI feedback
                setTimeout(() => {
                    generateOrderPDF().then(() => {
                        // Reset button after successful download
                        downloadBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Downloaded Successfully!';
                        setTimeout(() => {
                            downloadBtn.innerHTML = originalContent;
                            downloadBtn.disabled = false;
                        }, 2000);
                    }).catch((error) => {
                        console.error('Error generating PDF:', error);
                        downloadBtn.innerHTML = originalContent;
                        downloadBtn.disabled = false;
                        showMobileNotification('Failed to generate PDF. Please try again.', 'error');
                    });
                }, 300);

            } catch (error) {
                console.error('Error in downloadOrderPDF:', error);
                showMobileNotification('Failed to generate PDF. Please try again.', 'error');
            }
        }

        // Separate PDF generation function
        async function generateOrderPDF() {
            return new Promise((resolve, reject) => {
                try {
                    // Get order data from the displayed elements
                    const orderId = document.getElementById('orderIdDisplay')?.textContent || 'N/A';
                    const orderDate = document.getElementById('orderDateDisplay')?.textContent || 'N/A';
                    const orderTime = document.getElementById('orderTimeDisplay')?.textContent || 'N/A';
                    const orderItems = document.getElementById('orderItemsDisplay')?.textContent || 'N/A';

                    // Get additional order details from orderData object
                    const recipientName = orderData.recipient?.name || 'N/A';
                    const recipientPhone = orderData.recipient?.phone || 'N/A';
                    const recipientAddress = orderData.recipient?.address || 'N/A';
                    const deliveryInstructions = orderData.recipient?.instructions || 'None';

                    // Calculate totals from selected products - ensuring accurate calculations
                    let subtotal = 0;
                    let totalItems = 0;
                    let productsList = [];

                    if (selectedProducts && selectedProducts.length > 0) {
                        selectedProducts.forEach(product => {
                            // Ensure we have valid numeric values
                            const productPrice = parseFloat(product.price) || 0;
                            const productQuantity = parseInt(product.quantity) || 0;
                            const productTotal = parseFloat(product.total) || (productPrice * productQuantity);

                            // Use the calculated total or recalculate if needed
                            const finalTotal = product.total ? parseFloat(product.total) : (productPrice * productQuantity);

                            subtotal += finalTotal;
                            totalItems += productQuantity;
                            productsList.push({
                                name: product.name || 'Unknown Product',
                                quantity: productQuantity,
                                price: productPrice,
                                total: finalTotal
                            });
                        });
                    }

                    // Calculate service fee using the same logic as the order flow
                    const serviceFee = totalItems * SERVICE_FEE_PER_ITEM;
                    const totalAmount = subtotal + serviceFee;

                    // Create PDF content with improved design
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Page dimensions and layout
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    const contentWidth = pageWidth - (margin * 2);
                    let yPosition = 15;

                    // Helper function to check if we need a new page
                    function checkPageBreak(requiredHeight) {
                        if (yPosition + requiredHeight > pageHeight - 20) {
                            doc.addPage();
                            yPosition = 15;
                            return true;
                        }
                        return false;
                    }

                    // Header with design
                    doc.setFillColor(59, 116, 255);
                    doc.rect(0, 0, pageWidth, 50, 'F');

                    // Logo/Title area
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Phluowise', margin, 25);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Order Confirmation', margin, 35);

                    // Order ID in header
                    doc.setFontSize(10);
                    doc.text(`#${orderId}`, pageWidth - margin, 25, { align: 'right' });

                    // Reset text color and position for content
                    doc.setTextColor(0, 0, 0);
                    yPosition = 60;

                    // Current date and time
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, yPosition);
                    yPosition += 15;

                    // Delivery Information Card
                    checkPageBreak(40);

                    // Section header
                    doc.setTextColor(59, 116, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Delivery Information', margin, yPosition);
                    yPosition += 8;

                    // Underline
                    doc.setDrawColor(59, 116, 255);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPosition, margin + 60, yPosition);
                    yPosition += 12;

                    // Delivery details in two-column layout
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');

                    // Left column
                    doc.text('Date:', margin, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.text(orderDate, margin + 25, yPosition);

                    // Right column
                    doc.setFont('helvetica', 'normal');
                    doc.text('Time:', margin + 80, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.text(orderTime, margin + 100, yPosition);
                    yPosition += 10;

                    // Second row
                    doc.setFont('helvetica', 'normal');
                    doc.text('Items:', margin, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.text(orderItems, margin + 25, yPosition);

                    doc.setFont('helvetica', 'normal');
                    doc.text('Status:', margin + 80, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(16, 185, 129);
                    doc.text('Confirmed', margin + 100, yPosition);
                    doc.setTextColor(0, 0, 0);
                    yPosition += 20;

                    // Customer Information Card
                    checkPageBreak(60);

                    // Section header
                    doc.setTextColor(59, 116, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Customer Information', margin, yPosition);
                    yPosition += 8;

                    // Underline
                    doc.setDrawColor(59, 116, 255);
                    doc.line(margin, yPosition, margin + 80, yPosition);
                    yPosition += 12;

                    // Customer details
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');

                    doc.text('Name:', margin, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.text(recipientName.substring(0, 40), margin + 25, yPosition);
                    yPosition += 10;

                    doc.setFont('helvetica', 'normal');
                    doc.text('Phone:', margin, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.text(recipientPhone, margin + 25, yPosition);
                    yPosition += 10;

                    doc.setFont('helvetica', 'normal');
                    doc.text('Address:', margin, yPosition);

                    // Handle long address with text wrapping
                    const addressLines = doc.splitTextToSize(recipientAddress, contentWidth - 25);
                    doc.setFont('helvetica', 'bold');
                    addressLines.forEach((line, index) => {
                        if (index === 0) {
                            doc.text(line, margin + 25, yPosition);
                        } else {
                            doc.text(line, margin, yPosition + (index * 7));
                        }
                    });
                    yPosition += (addressLines.length * 7) + 5;

                    if (deliveryInstructions && deliveryInstructions !== 'None') {
                        doc.setFont('helvetica', 'normal');
                        doc.text('Instructions:', margin, yPosition);

                        const instructionLines = doc.splitTextToSize(deliveryInstructions, contentWidth - 25);
                        doc.setFont('helvetica', 'bold');
                        instructionLines.forEach((line, index) => {
                            if (index === 0) {
                                doc.text(line, margin + 25, yPosition);
                            } else {
                                doc.text(line, margin, yPosition + (index * 7));
                            }
                        });
                        yPosition += (instructionLines.length * 7) + 5;
                    }

                    // Order Items Section
                    checkPageBreak(80);

                    // Section header
                    doc.setTextColor(59, 116, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Order Details', margin, yPosition);
                    yPosition += 8;

                    // Underline
                    doc.setDrawColor(59, 116, 255);
                    doc.line(margin, yPosition, margin + 60, yPosition);
                    yPosition += 12;

                    // Table headers with background
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, yPosition - 7, contentWidth, 12, 'F');

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Product', margin + 3, yPosition);
                    doc.text('Qty', margin + 80, yPosition);
                    doc.text('Price', margin + 100, yPosition);
                    doc.text('Total', margin + 140, yPosition);
                    yPosition += 15;

                    // Table rows
                    doc.setFont('helvetica', 'normal');
                    productsList.forEach((product, index) => {
                        checkPageBreak(12);

                        // Alternate row background
                        if (index % 2 === 0) {
                            doc.setFillColor(248, 248, 248);
                            doc.rect(margin, yPosition - 7, contentWidth, 10, 'F');
                        }

                        const productName = product.name.substring(0, 25);
                        const quantity = product.quantity.toString();
                        const unitPrice = `GHS ${parseFloat(product.price).toFixed(2)}`;
                        const totalPrice = `GHS ${parseFloat(product.total).toFixed(2)}`;

                        doc.text(productName, margin + 3, yPosition);
                        doc.text(quantity, margin + 80, yPosition);
                        doc.text(unitPrice, margin + 100, yPosition);
                        doc.text(totalPrice, margin + 140, yPosition);
                        yPosition += 10;
                    });

                    yPosition += 10;

                    // Price Summary Card
                    checkPageBreak(50);

                    // Summary box with border and background
                    doc.setFillColor(240, 248, 255);
                    doc.rect(margin, yPosition - 5, contentWidth, 45, 'F');
                    doc.setDrawColor(59, 116, 255);
                    doc.rect(margin, yPosition - 5, contentWidth, 45);

                    doc.setTextColor(59, 116, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Price Summary', margin + 3, yPosition + 5);
                    yPosition += 15;

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Subtotal:', margin + 3, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`GHS ${subtotal.toFixed(2)}`, margin + 120, yPosition);
                    yPosition += 8;

                    doc.setFont('helvetica', 'normal');
                    doc.text(`Service Fee (${totalItems} items):`, margin + 3, yPosition);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`GHS ${serviceFee.toFixed(2)}`, margin + 120, yPosition);
                    yPosition += 10;

                    // Separator line
                    doc.setDrawColor(59, 116, 255);
                    doc.line(margin + 3, yPosition, margin + contentWidth - 3, yPosition);
                    yPosition += 8;

                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Total Amount:', margin + 3, yPosition);
                    doc.setTextColor(59, 116, 255);
                    doc.text(`GHS ${totalAmount.toFixed(2)}`, margin + 120, yPosition);

                    // Footer
                    yPosition = pageHeight - 25;
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Thank you for choosing Phluowise!', margin, yPosition);
                    doc.text('This is an automatically generated order confirmation.', margin, yPosition + 6);
                    doc.text('For inquiries, contact our customer support.', margin, yPosition + 12);

                    // Add page number
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, yPosition + 12, { align: 'right' });
                    }

                    // Mobile-optimized PDF save with fallback
                    if (isMobileDevice()) {
                        // For mobile devices, try multiple approaches
                        tryMobilePDFDownload(doc, `order_${orderId}_${Date.now()}.pdf`).then(() => {
                            resolve();
                        }).catch(() => {
                            // Fallback to standard download
                            doc.save(`order_${orderId}_${Date.now()}.pdf`);
                            resolve();
                        });
                    } else {
                        // Standard desktop download
                        doc.save(`order_${orderId}_${Date.now()}.pdf`);
                        resolve();
                    }

                } catch (error) {
                    reject(error);
                }
            });
        }

        // Mobile device detection
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                (window.innerWidth <= 768 && 'ontouchstart' in window);
        }

        // Mobile-specific PDF download with multiple fallbacks
        async function tryMobilePDFDownload(doc, filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Method 1: Try standard download first
                    doc.save(filename);

                    // Method 2: Create blob and download link (fallback)
                    setTimeout(() => {
                        try {
                            const pdfBlob = doc.output('blob');
                            const url = URL.createObjectURL(pdfBlob);
                            const downloadLink = document.createElement('a');
                            downloadLink.href = url;
                            downloadLink.download = filename;
                            downloadLink.style.display = 'none';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                            URL.revokeObjectURL(url);
                            resolve();
                        } catch (fallbackError) {
                            reject(fallbackError);
                        }
                    }, 1000);

                } catch (error) {
                    reject(error);
                }
            });
        }

        // Mobile notification system
        function showMobileNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotification = document.querySelector('.mobile-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `mobile-notification fixed top-4 left-4 right-4 z-50 p-4 rounded-lg backdrop-blur-xl border transition-all duration-300 transform translate-y-[-100px]`;

            // Style based on type
            if (type === 'error') {
                notification.className += ' bg-red-500/20 border-red-500/40 text-red-300';
            } else if (type === 'success') {
                notification.className += ' bg-green-500/20 border-green-500/40 text-green-300';
            } else {
                notification.className += ' bg-blue-500/20 border-blue-500/40 text-blue-300';
            }

            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                        ${type === 'error' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' :
                    type === 'success' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' :
                        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 p-1 hover:bg-white/10 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-y-[-100px]');
                notification.classList.add('translate-y-0');
            }, 100);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-y-[-100px]');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>

</body>

<!-- Appwrite SDK and Config -->
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
<script src="js/appwriteConfig.js"></script>
<script src="js/companyData.js"></script>
<script src="js/cacheManager.js"></script>
<script src="js/orderManager.js"></script>
<script src="js/notifications.js"></script>

<script>
    // Delete Account Confirmation function
    window.showDeleteConfirm = function () {
        // Create modal overlay following the existing pattern
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'deleteAccountModal';
        modalOverlay.className = 'fixed inset-0 z-50 flex items-center justify-center p-9';
        modalOverlay.style.cssText = 'display: flex; backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.5);';

        // Create modal content following existing modal pattern
        const modalContent = document.createElement('div');
        modalContent.className = 'rounded-[30px] w-full max-w-[350px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]';
        modalContent.style.cssText = 'background-color: var(--modal-bg); border-color: var(--modal-border);';

        modalContent.innerHTML = `
            <div class="flex flex-col items-center justify-center w-full h-full">
                <!-- Warning Icon Section -->
                <div class="flex flex-col items-center justify-center mb-6">
                    <div class="w-[80px] h-[80px] rounded-full flex items-center justify-center mb-4"
                         style="background-color: rgba(245, 125, 125, 0.1);">
                        <svg class="w-[40px] h-[40px] text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </div>
                    
                    <h2 class="text-white text-[20px] font-bold text-center mb-3">Delete Account</h2>
                    <p class="text-gray-400 text-[14px] text-center leading-[20px] mb-6">
                        Are you sure you want to delete your account? This action cannot be undone and will permanently delete:
                    </p>
                    
                    <div class="w-full text-left mb-6">
                        <div class="text-gray-400 text-[13px] space-y-2">
                            <div class="flex items-center gap-2">
                                <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="2"/>
                                </svg>
                                <span>Your profile information</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="2"/>
                                </svg>
                                <span>Order history</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="2"/>
                                </svg>
                                <span>Saved preferences</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="2"/>
                                </svg>
                                <span>All associated data</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Button Section -->
                <div class="w-full flex items-center gap-3">
                    <!-- Cancel Button -->
                    <button onclick="cancelDeleteAccount()"
                            class="h-[37px] flex-1 rounded-[100px] flex items-center justify-center border transition-all hover:opacity-80"
                            style="background-color: var(--btn-second-color); border-color: var(--btn-second-border);">
                        <span class="text-white text-base font-semibold capitalize">Cancel</span>
                    </button>
                    
                    <!-- Delete Button -->
                    <button onclick="confirmDeleteAccount()"
                            class="h-[37px] flex-1 rounded-[100px] flex items-center justify-center border transition-all hover:opacity-80"
                            style="background-color: #F57D7D; border-color: #F57D7D;">
                        <span class="text-white text-base font-semibold capitalize">Delete</span>
                    </button>
                </div>
            </div>
        `;

        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);

        // Close modal when clicking overlay
        modalOverlay.addEventListener('click', function (e) {
            if (e.target === modalOverlay) {
                cancelDeleteAccount();
            }
        });
    };

    // Show delete success modal
    window.showDeleteSuccessModal = function () {
        // Close the delete confirmation modal first
        const deleteModal = document.getElementById('deleteAccountModal');
        if (deleteModal) {
            deleteModal.remove();
        }

        // Create success modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'deleteSuccessModal';
        modalOverlay.className = 'fixed inset-0 z-50 flex items-center justify-center p-9';
        modalOverlay.style.cssText = 'display: flex; backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.5);';

        // Create modal content
        const modalContent = document.createElement('div');
        modalContent.className = 'rounded-[30px] w-full max-w-[350px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]';
        modalContent.style.cssText = 'background-color: var(--modal-bg); border-color: var(--modal-border);';

        modalContent.innerHTML = `
            <div class="flex flex-col items-center justify-center w-full h-full">
                <!-- Success Icon Section -->
                <div class="flex flex-col items-center justify-center mb-6">
                    <div class="w-[80px] h-[80px] rounded-full flex items-center justify-center mb-4"
                         style="background-color: rgba(34, 197, 94, 0.1);">
                        <svg class="w-[40px] h-[40px] text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    
                    <h2 class="text-white text-[20px] font-bold text-center mb-3">Account Deleted</h2>
                    <p class="text-gray-400 text-[14px] text-center leading-[20px] mb-4">
                        Your account has been successfully deleted.
                    </p>
                    <p class="text-gray-500 text-[13px] text-center leading-[18px]">
                        Redirecting to sign-in page...
                    </p>
                    
                    <!-- Loading indicator -->
                    <div class="flex items-center gap-1 mt-4">
                        <div class="w-[6px] h-[6px] rounded-full bg-green-500 animate-pulse"></div>
                        <div class="w-[6px] h-[6px] rounded-full bg-green-500 animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-[6px] h-[6px] rounded-full bg-green-500 animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            </div>
        `;

        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);

        // Auto-remove modal after redirect (backup cleanup)
        setTimeout(() => {
            const modal = document.getElementById('deleteSuccessModal');
            if (modal) {
                modal.remove();
            }
        }, 3000);
    };

    // Cancel delete account
    window.cancelDeleteAccount = function () {
        const modal = document.getElementById('deleteAccountModal');
        if (modal) {
            modal.remove();
        }
    };

    // Confirm delete account
    window.confirmDeleteAccount = async function () {
        try {
            // Show loading state
            const deleteBtn = document.querySelector('#deleteAccountModal button[onclick="confirmDeleteAccount()"] span');
            const originalText = deleteBtn.textContent;
            deleteBtn.textContent = 'Deleting...';
            deleteBtn.parentElement.disabled = true;

            // Get current user
            const user = await window.account.get();
            const userEmail = user.email;

            // Delete from customer_tb first
            try {
                const customerDocs = await window.databases.listDocuments(
                    window.appwriteConfig.DATABASE_ID,
                    window.appwriteConfig.CUSTOMER_TABLE,
                    [window.Query.equal('email', userEmail.toLowerCase())]
                );

                // Delete customer records
                for (const doc of customerDocs.documents) {
                    await window.databases.deleteDocument(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.CUSTOMER_TABLE,
                        doc.$id
                    );
                }
                console.log('✅ Customer data deleted from database');
            } catch (dbError) {
                console.warn('⚠️ Could not delete customer data:', dbError.message);
            }

            // Immediately logout user by deleting all sessions
            console.log('🔒 Logging out user...');
            try {
                const sessions = await window.account.listSessions();
                for (const session of sessions.sessions) {
                    await window.account.deleteSession(session.$id);
                }
                console.log('✅ User logged out - all sessions deleted');
            } catch (sessionError) {
                console.warn('⚠️ Could not delete sessions:', sessionError.message);
                // Try to delete current session as fallback
                try {
                    await window.account.deleteSession('current');
                    console.log('✅ User logged out - current session deleted');
                } catch (fallbackError) {
                    console.warn('⚠️ Could not delete current session:', fallbackError.message);
                }
            }

            // Clear local storage immediately after logout
            localStorage.clear();
            console.log('🧹 Local storage cleared');

            // Show success modal
            showDeleteSuccessModal();

            // Redirect to sign-in page after delay
            setTimeout(() => {
                window.location.href = 'signin.html';
            }, 2500);

        } catch (error) {
            console.error('❌ Error deleting account:', error);

            // Reset button
            const deleteBtn = document.querySelector('#deleteAccountModal button[onclick="confirmDeleteAccount()"] span');
            deleteBtn.textContent = 'Delete';
            deleteBtn.parentElement.disabled = false;

            // Show error message
            alert('Failed to delete account. Please try again or contact support. Error: ' + error.message);
        }
    };

    // Logout function
    async function logout() {
        // Get the logout button and show loading state
        const logoutBtn = document.querySelector('button[onclick="logout()"]');
        const originalContent = logoutBtn.innerHTML;

        // Show loading indicator
        logoutBtn.innerHTML = `
            <div class="flex flex-row items-center gap-[30px]">
                <div class="w-6 h-6 flex items-center justify-center">
                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </div>
                <span class="text-white text-lg font-semibold">Signing out...</span>
            </div>
            <div class="w-5 h-5 flex items-center justify-center">
                <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </div>
        `;
        logoutBtn.disabled = true;

        try {
            // Clear all local storage data
            localStorage.removeItem('customerSession');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userName');
            localStorage.removeItem('userEmail');

            // Try to clear Appwrite session if available
            if (typeof account !== 'undefined') {
                try {
                    await account.deleteSession('current');
                    console.log('Appwrite session cleared');
                } catch (appwriteError) {
                    console.log('Appwrite session already cleared or error:', appwriteError);
                }
            }

            // Show success briefly before redirect
            logoutBtn.innerHTML = `
                <div class="flex flex-row items-center gap-[30px]">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-white text-lg font-semibold">Signed out!</span>
                </div>
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            `;

            // Redirect to signin page after brief delay
            setTimeout(() => {
                window.location.href = 'signin.html';
            }, 500);

        } catch (error) {
            console.error('Logout error:', error);

            // Show error state
            logoutBtn.innerHTML = `
                <div class="flex flex-row items-center gap-[30px]">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span class="text-white text-lg font-semibold">Error</span>
                </div>
                <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;

            // Even if there's an error, clear storage and redirect after brief delay
            setTimeout(() => {
                localStorage.removeItem('customerSession');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userName');
                localStorage.removeItem('userEmail');
                window.location.href = 'signin.html';
            }, 1000);
        }
    }
</script>

</body>

</html>