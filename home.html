<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TRV3R43NQZ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-TRV3R43NQZ');
    </script>
    <title>Phluowise - Home</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007ACC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Phluowise">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=verified" />
    <link rel="stylesheet" href="css/notifications.css" />
    <link rel="stylesheet" href="css/mobile-responsive.css" />
    <script src="js/notifications.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007ACC',
                        tabActive: '#3B74FF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --input-field-second: #40444B66;
            --input-field-second-border: #808080;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --btn-second-color: #F57D7D4D;
            --btn-second-border: #F57D7D;
            --modal-bg: #101010;
            --modal-border: #DADADA;
        }

        body.dark-theme {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --input-field-second: #40444B66;
            --input-field-second-border: #808080;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --btn-second-color: #F57D7D4D;
            --btn-second-border: #F57D7D;
            --modal-bg: #101010;
            --modal-border: #DADADA;
        }

        body.gray-theme {
            --bg-color: #202225;
            --bg-second: #40444B;
            --bg-third: #292B2F;
            --header-bg: #292B2F;
            --tab-bg: #292B2F;
            --input-field-second: #40444B;
            --input-field-second-border: #40444B;
            --btn-color: #007ACC;
            --btn-border: #007ACC;
            --btn-second-color: #F57D7D;
            --btn-second-border: #F57D7D;
            --modal-bg: #40444B;
            --modal-border: #40444B;
        }

        body.light-theme {
            --bg-color: #202225;
            --bg-second: #40444B;
            --bg-third: #292B2F;
            --header-bg: #292B2F;
            --tab-bg: #292B2F;
            --input-field-second: #40444B;
            --input-field-second-border: #40444B;
            --btn-color: #007ACC;
            --btn-border: #007ACC;
            --btn-second-color: #F57D7D;
            --btn-second-border: #F57D7D;
            --modal-bg: #40444B;
            --modal-border: #40444B;
        }

        body {
            background-color: var(--bg-color);
            color: white;
        }

        /* Material Symbols Styles */
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .verified-checkmark {
            color: #FFD700;
            font-size: 20px;
            margin-left: 4px;
            vertical-align: middle;
        }

        .verified-checkmark-tier2 {
            color: #3B74FF;
            font-size: 20px;
            margin-left: 4px;
            vertical-align: middle;
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .verified-checkmark-tier3 {
            color: #FFD700;
            font-size: 20px;
            margin-left: 4px;
            vertical-align: middle;
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .header-bar {
            background-color: var(--header-bg);
        }

        .tab-bar {
            background-color: var(--tab-bg);
        }

        .card-bg {
            background-color: var(--bg-second);
        }

        /* Sliding Menu Styles */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sliding-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 400px;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .sliding-menu.active {
            right: 0;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }



        .pull-to-refresh-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 116, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 116, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 0 0 24px 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(59, 116, 255, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pull-to-refresh-indicator.show {
            display: flex;
            animation: slideDown 0.3s ease-out;
        }

        .pull-to-refresh-indicator.refreshing {
            background: rgba(59, 116, 255, 0.25);
            border-color: rgba(59, 116, 255, 0.5);
            box-shadow: 0 12px 40px rgba(59, 116, 255, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.15) inset;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .refresh-spinner {
            width: 36px;
            height: 36px;
            position: relative;
        }

        .refresh-spinner::before,
        .refresh-spinner::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 50%;
            box-sizing: border-box;
        }

        .refresh-spinner::before {
            border: 3px solid transparent;
            border-top-color: #3B74FF;
            border-right-color: #3B74FF;
            filter: drop-shadow(0 0 6px rgba(59, 116, 255, 0.6));
            animation: spin 0.9s linear infinite;
        }

        .refresh-spinner::after {
            inset: 6px;
            border: 3px solid transparent;
            border-bottom-color: #8BB0FF;
            border-left-color: #8BB0FF;
            animation: spinReverse 1.1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes spinReverse {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(-360deg);
            }
        }

        .search-container:focus-within {
            border-color: #3B74FF !important;
            box-shadow: 0 0 0 1px #3B74FF !important;
        }

        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-truncate-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body class="dark-theme h-screen flex flex-col overflow-hidden">

    <!-- Top Header Bar (height: 110px) -->
    <div class="header-bar w-full h-[110px] flex flex-row items-center justify-between px-5">
        <!-- Greeting Text -->
        <div class="flex-1">
            <h1 id="greetingText" class="text-white text-lg font-medium truncate max-w-[250px]">
                Greetings...
            </h1>
        </div>

        <!-- Menu Button (Hamburger) -->
        <button onclick="toggleMenu()"
            class="relative rounded-full flex items-center justify-center h-[45px] w-[45px] border-[0.5px] border-[#808080] bg-[#40444B4D] hover:bg-[#40444B] transition-colors">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <line x1="4" y1="6" x2="20" y2="6" />
                <line x1="4" y1="12" x2="20" y2="12" />
                <line x1="4" y1="18" x2="20" y2="18" />
            </svg>
        </button>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto hide-scrollbar pb-[70px]" style="background-color: var(--bg-color);">
        <!-- Menu Overlay -->
        <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
        <!-- Sliding Menu -->
        <div class="sliding-menu" id="slidingMenu">
            <!-- Avatar Section -->
            <div class="flex flex-col items-center justify-center gap-4 py-6">
                <!-- Profile Image Container -->
                <div class="relative flex items-center justify-center rounded-full border-[0.5px] border-[#292B2F]"
                    style="height: 110px; width: 110px; background-color: #292B2F;">
                    <div id="profileImageContainer" class="w-[62px] h-[62px] flex items-center justify-center">
                        <img id="profileImage" src="images/main/ProfileImage.png"
                            class="w-[62px] h-[62px] object-contain" alt="Profile" style="display: none;">
                        <div id="profileImageEmptyState"
                            class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Edit Button -->
                    <button onclick="openProfileImagePicker()"
                        class="absolute rounded-full flex items-center justify-center"
                        style="top: 2px; right: 0; height: 38px; width: 38px; background-color: #40444B;">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>

                    <!-- Hidden file input -->
                    <input type="file" id="profileImageInput" accept="image/*" style="display: none;"
                        onchange="handleProfileImageChange(event)">
                </div>

                <!-- User Name -->
                <h2 id="menuUserName" class="text-white text-xl font-semibold">Loading...</h2>
                <p id="menuUserEmail" class="text-[#808080] text-base">Loading...</p>
            </div>

            <!-- Menu Content -->
            <div class="p-4">
                <div class="rounded-[15px] overflow-hidden border-[0.5px]" style="border-color: #DADADA;">

                    <!-- History -->
                    <a href="schedule-history.html" onclick="navigateToPage('schedule-history.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span class="text-white text-lg font-semibold">History</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- About -->
                    <a href="about.html" onclick="navigateToPage('about.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">About</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- Report -->
                    <a href="report.html" onclick="navigateToPage('report.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Report</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- Theme -->
                    <button onclick="openThemeModal()"
                        class="w-full h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Theme</span>
                        </div>
                        <div class="py-2 px-4 rounded-[5px]" style="background-color: #FFFFFF1A;">
                            <span id="currentThemeDisplay" class="capitalize text-white text-sm font-medium">Dark</span>
                        </div>
                    </button>

                    <!-- Profile -->
                    <a href="profile.html" onclick="navigateToPage('profile.html')"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-b border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Profile</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- Delete Account -->
                    <button onclick="showDeleteConfirm()"
                        class="w-full h-[60px] flex flex-row justify-between items-center px-6"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Delete Account</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>

                    <!-- Visit Website -->
                    <a href="https://phluowise.com" target="_blank"
                        class="h-[60px] flex flex-row justify-between items-center px-6 border-t border-[#3A3B3F]"
                        style="background-color: #101010;">
                        <div class="flex flex-row items-center gap-[30px]">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-white text-lg font-semibold">Visit us on our website</span>
                        </div>
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                </div>

                <!-- Logout Button -->
                <button onclick="logout()"
                    class="mt-4 h-[62px] w-full rounded-[15px] flex flex-row justify-between items-center px-6 shadow-md"
                    style="background-color: #1D1D1D;">
                    <div class="flex flex-row items-center gap-[30px]">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span class="text-white text-lg font-semibold">Logout</span>
                    </div>
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- Version -->
            <div class="flex flex-col items-center gap-2 mt-4 pb-8">
                <span class="text-lg font-semibold text-[#808080]">Phluowise</span>
                <span class="text-xs font-medium text-white">version 1.0.0</span>
            </div>
        </div>

        <!-- Search Company (SearchCompany.tsx) - px-4, py-2 -->
        <div class="px-4 py-2">
            <div class="search-container border w-full h-[42px] rounded-[100px] flex flex-row items-center px-8 gap-4 mt-3"
                style="background-color: var(--input-field-second); border-color: var(--input-field-second-border);">
                <input type="text" id="searchInput" placeholder="Search"
                    class="bg-transparent border-none outline-none text-white text-xl font-medium placeholder-white"
                    style="height: 42px; width: 90%;" oninput="handleSearch()">
                <div>
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Filter Companies (FilterCompanies.tsx) - px-4, py-1 -->
        <div class="px-4 py-1 flex flex-row justify-between items-center">
            <!-- Around you button -->
            <button id="aroundBtn" onclick="setViewFilter('around')"
                class="text-center flex items-center justify-center px-4 h-[40px] rounded-[9px] border transition-all"
                style="background-color: var(--btn-color); border-color: var(--btn-border);">
                <span class="text-white text-lg font-medium">Around you</span>
            </button>

            <div class="flex flex-row gap-2 items-center">
                <!-- All button -->
                <button id="allBtn" onclick="setViewFilter('all')"
                    class="text-center flex items-center justify-center px-4 h-[40px] rounded-[9px] border border-transparent bg-transparent transition-all">
                    <span class="text-white px-4">All</span>
                </button>

                <!-- Grid/List Toggle (48x44px, bg #292B2F, border-radius 10px) -->
                <button id="toggleViewBtn" onclick="toggleCardView()"
                    class="flex items-center justify-center rounded-[10px]"
                    style="height: 48px; width: 44px; background-color: #292B2F;">
                    <!-- Icon will be set by JS -->
                    <div id="toggleIconContainer"></div>
                </button>
            </div>
        </div>

        <!-- Companies List/Grid Container -->
        <div id="companiesContainer" class="mt-2">
            <!-- Will be populated by JS based on view mode -->
        </div>

    </div>

    <!-- Bottom Tab Navigation Bar (3 Tabs - height: 64px) -->
    <div
        class="tab-bar fixed bottom-0 left-0 right-0 h-[64px] flex flex-row justify-around items-center px-4 border-t-0">

        <!-- Home Tab (Active) -->
        <a href="home.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3B74FF" stroke-width="1.5">
                <path
                    d="M9.02 2.84004L3.63 7.04004C2.73 7.74004 2 9.23004 2 10.36V17.77C2 20.09 3.89 21.99 6.21 21.99H17.79C20.11 21.99 22 20.09 22 17.78V10.5C22 9.29004 21.19 7.74004 20.2 7.05004L14.02 2.72004C12.62 1.74004 10.37 1.79004 9.02 2.84004Z"
                    stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 17.99V14.99" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="text-sm text-[#3B74FF] font-normal mt-1">Home</span>
        </a>

        <!-- Services Tab -->
        <a href="services.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path fill="#FFFFFF"
                    d="m31.696 15.098-1.75-4.376a1.742 1.742 0 0 0-1.625-1.1H23.75V8.376a.75.75 0 0 0-.75-.75H4a1.75 1.75 0 0 0-1.75 1.75v14A1.75 1.75 0 0 0 4 25.125h2.325a3.75 3.75 0 0 0 7.35 0h6.65a3.75 3.75 0 0 0 7.35 0H30a1.75 1.75 0 0 0 1.75-1.75v-8a.752.752 0 0 0-.054-.277Zm-7.946-3.973h4.573a.25.25 0 0 1 .232.158l1.337 3.342H23.75v-3.5Zm-20-1.75a.25.25 0 0 1 .25-.25h18.25v8.5H3.75v-8.25ZM10 26.625a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm10.325-3h-6.65a3.75 3.75 0 0 0-7.35 0H4a.25.25 0 0 1-.25-.25v-4.25h18.5v1.935a3.763 3.763 0 0 0-1.925 2.565Zm3.675 3a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm6.25-3.25a.25.25 0 0 1-.25.25h-2.325a3.756 3.756 0 0 0-3.675-3c-.084 0-.168 0-.25.009v-4.509h6.5v7.25Z" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Services</span>
        </a>

        <!-- Schedule History Tab -->
        <a href="schedule-history.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path d="M8 2V5" />
                <path d="M16 2V5" />
                <path d="M3.5 9.09H20.5" />
                <path
                    d="M18.2 21.4C19.9673 21.4 21.4 19.9673 21.4 18.2C21.4 16.4327 19.9673 15 18.2 15C16.4327 15 15 16.4327 15 18.2C15 19.9673 16.4327 21.4 18.2 21.4Z" />
                <path d="M22 22L21 21" />
                <path
                    d="M21 8.5V13.63C20.27 13.14 19.38 12.85 18.43 12.85C15.86 12.85 13.78 14.95 13.78 17.54C13.78 18.45 14.04 19.29 14.49 20H8C4.5 20 3 18 3 15V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Schedule History</span>
        </a>

    </div>

    <!-- Location Permission Modal -->
    <div id="locationModal" class="fixed inset-0 z-50 flex items-center justify-center p-9"
        style="display: none; backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.5);">
        <div class="rounded-[30px] w-full max-w-[350px] h-[408px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]"
            style="background-color: var(--modal-bg); border-color: var(--modal-border);">

            <div class="flex-1 w-full items-center flex-col justify-between relative">
                <!-- Image Section -->
                <div class="items-center flex-1 w-full relative flex items-center justify-center">
                    <img src="images/auth/Ellipse.png" class="w-[119px] h-[117px] object-contain">
                    <img src="images/auth/Location.png"
                        class="w-[51px] absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 object-contain">
                </div>

                <!-- Text Section -->
                <div class="w-full flex-1 flex-col items-center justify-center">
                    <div class="flex flex-col items-center justify-center">
                        <h2 class="text-white text-center"
                            style="font-size: 20.5px; font-weight: 500; text-transform: capitalize;">
                            Location Permission
                        </h2>
                        <p class="text-white text-center mt-2"
                            style="font-size: 16.5px; font-weight: 500; text-transform: capitalize;">
                            Companies want to access<br> your location for delivery.<br> Grant access
                        </p>
                    </div>
                </div>

                <!-- Buttons Section -->
                <div class="w-full flex-1 flex-col items-center justify-end mt-5">
                    <!-- Deny Button -->
                    <div class="w-full flex items-center mt-5">
                        <button onclick="closeLocationModal()"
                            class="h-[37px] w-[177px] rounded-[100px] flex items-center justify-center border mx-auto"
                            style="background-color: var(--btn-second-color); border-color: var(--btn-second-border);">
                            <span class="text-white text-base font-semibold capitalize"
                                style="font-weight: 500;">Deny</span>
                        </button>
                    </div>
                    <!-- Allow Button -->
                    <div class="w-full flex items-center mt-5">
                        <button onclick="allowLocation()"
                            class="h-[37px] w-[177px] rounded-[100px] flex items-center justify-center border mx-auto"
                            style="background-color: var(--btn-color); border-color: var(--btn-border);">
                            <span class="text-white text-base font-semibold capitalize"
                                style="font-weight: 500;">Allow</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pull to Refresh Indicator -->
    <div id="pullToRefreshIndicator" class="pull-to-refresh-indicator">
        <div class="refresh-spinner"></div>
        <span id="refreshText">Pull to refresh</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="js/appwriteConfig.js"></script>
    <script src="js/companyData.js"></script>
    <script src="js/cacheManager.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/distanceCalculator.js"></script>
    <script>
        let cardSingle = true; // true = list view, false = grid view
        let currentFilter = 'around';
        let searchQuery = '';
        let userLocation = null;
        let isRefreshing = false;
        let locationPermissionGranted = localStorage.getItem('locationPermissionGranted') === 'true';

        // Companies data will be loaded from database
        let companies = [];
        let companiesDataLoaded = false;

        // Handle search input
        async function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            searchQuery = searchInput.value.toLowerCase();
            await renderCompanies();
        }

        // Clear search input and reset results
        async function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            searchQuery = '';
            await renderCompanies();
        }

        // Calculate distance and time using advanced distance calculator
        async function calculateDistanceAndTime(fromCoords, toCoords) {
            try {
                // Validate input coordinates
                if (!fromCoords || !toCoords ||
                    !fromCoords.lat || !fromCoords.lng ||
                    !toCoords.lat || !toCoords.lng ||
                    isNaN(fromCoords.lat) || isNaN(fromCoords.lng) ||
                    isNaN(toCoords.lat) || isNaN(toCoords.lng)) {
                    console.warn('Invalid coordinates for distance calculation');
                    return {
                        distance: null,
                        time: 'Unknown distance',
                        accuracy: 'low'
                    };
                }

                if (window.distanceCalculator) {
                    const result = await window.distanceCalculator.calculateDistanceAndTime(fromCoords, toCoords, { mode: 'driving' });
                    const distance = result.distance ? result.distance.km : null;
                    return {
                        distance: distance,
                        time: result.duration ? result.duration.text : 'Unknown distance',
                        accuracy: result.accuracy || 'high'
                    };
                } else {
                    // Enhanced fallback calculation with road factors
                    const distanceKm = calculateEnhancedDistance(fromCoords, toCoords);
                    return {
                        distance: distanceKm,
                        time: distanceKm ? generateEstimatedTime(distanceKm) : 'Unknown distance',
                        accuracy: 'estimated'
                    };
                }
            } catch (error) {
                console.error('Distance calculation failed:', error);
                // Enhanced fallback calculation
                const distanceKm = calculateEnhancedDistance(fromCoords, toCoords);
                return {
                    distance: distanceKm,
                    time: distanceKm ? generateEstimatedTime(distanceKm) : 'Unknown distance',
                    accuracy: 'estimated'
                };
            }
        }

        // Enhanced distance calculation with road network factors
        function calculateEnhancedDistance(fromCoords, toCoords) {
            // Validate input coordinates
            if (!fromCoords || !toCoords ||
                !fromCoords.lat || !fromCoords.lng ||
                !toCoords.lat || !toCoords.lng ||
                isNaN(fromCoords.lat) || isNaN(fromCoords.lng) ||
                isNaN(toCoords.lat) || isNaN(toCoords.lng)) {
                console.warn('Invalid coordinates in calculateEnhancedDistance');
                return null;
            }

            // Calculate straight-line distance using Haversine
            const straightDistance = haversineDistance(fromCoords, toCoords);

            // Validate the calculated distance
            if (!straightDistance || isNaN(straightDistance) || straightDistance <= 0) {
                console.warn('Invalid distance calculated in haversine');
                return null;
            }

            // Apply road network factor (1.3 for urban areas)
            const roadFactor = 1.3;
            const enhancedDistance = straightDistance * roadFactor;

            // Final validation
            if (isNaN(enhancedDistance) || enhancedDistance <= 0) {
                console.warn('Invalid enhanced distance calculated');
                return null;
            }

            return enhancedDistance;
        }

        // Haversine distance calculation (only for fallback)
        function haversineDistance(fromCoords, toCoords) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = toRadians(toCoords.lat - fromCoords.lat);
            const dLng = toRadians(toCoords.lng - fromCoords.lng);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRadians(fromCoords.lat)) * Math.cos(toRadians(toCoords.lat)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Convert degrees to radians
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // Generate estimated time based on distance
        function generateEstimatedTime(distanceKm) {
            // Validate input
            if (!distanceKm || isNaN(distanceKm) || distanceKm <= 0) {
                return 'Unknown time';
            }

            const avgSpeed = 30; // km/h average city driving speed
            const timeMinutes = Math.round((distanceKm / avgSpeed) * 60);

            // Validate calculated time
            if (isNaN(timeMinutes) || timeMinutes <= 0) {
                return 'Unknown time';
            }

            if (timeMinutes < 5) return 'Less than 5 min';
            if (timeMinutes < 15) return `${timeMinutes} min`;
            if (timeMinutes < 60) return `${timeMinutes} min`;

            const hours = Math.floor(timeMinutes / 60);
            const minutes = timeMinutes % 60;
            return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
        }

        // Get verified icon CSS class based on verification tier
        function getVerifiedIconClass(tier) {
            console.log(`ðŸ” [DEBUG] Getting icon class for tier: ${tier}`);
            let cssClass;
            switch (tier) {
                case 2:
                    cssClass = 'verified-checkmark-tier2'; // Blue icon
                    console.log(`ðŸ” [DEBUG] Tier 2 -> Blue icon: ${cssClass}`);
                    break;
                case 3:
                    cssClass = 'verified-checkmark-tier3'; // Gold icon
                    console.log(`ðŸ” [DEBUG] Tier 3 -> Gold icon: ${cssClass}`);
                    break;
                default:
                    cssClass = 'verified-checkmark-tier2'; // Default to blue (tier2)
                    console.log(`ðŸ” [DEBUG] Default tier (${tier}) -> Blue icon: ${cssClass}`);
                    break;
            }
            return cssClass;
        }

        // Filter companies based on search query, location, and verification tier
        async function getFilteredCompanies() {
            console.log(`ðŸ” [DEBUG] Starting getFilteredCompanies with ${companies.length} companies`);
            let filtered = companies;

            // Apply verification tier filtering
            filtered = filtered.filter(company => {
                const tier = company.verification_tier || 2; // Default to tier2 if not set
                console.log(`ðŸ” [DEBUG] Company: ${company.name}, Tier: ${tier}, verification_tier field: ${company.verification_tier}`);
                // Hide tier1 companies, show tier2 and tier3
                const shouldShow = tier !== 1;
                console.log(`ðŸ” [DEBUG] Should show ${company.name}: ${shouldShow} (tier ${tier})`);
                return shouldShow;
            });

            console.log(`ðŸ” [DEBUG] After tier filtering: ${filtered.length} companies remaining`);

            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(company =>
                    company.name.toLowerCase().includes(searchQuery) ||
                    company.location.toLowerCase().includes(searchQuery)
                );
                console.log(`ðŸ” [DEBUG] After search filtering: ${filtered.length} companies remaining`);
            }

            // Apply location filter with enhanced distance calculation
            if (userLocation) {
                // Calculate distances for all companies when user location is available
                const companiesWithDistance = await Promise.all(
                    filtered.map(async (company) => {
                        if (company.coordinates) {
                            const distanceResult = await calculateDistanceAndTime(userLocation, company.coordinates);
                            return {
                                ...company,
                                distance: distanceResult.distance,
                                time: distanceResult.time,
                                accuracy: distanceResult.accuracy
                            };
                        }
                        return { ...company, distance: null, time: company.time || 'Unknown distance' };
                    })
                );

                // Apply location-based filtering only for 'around' filter
                if (currentFilter === 'around') {
                    filtered = companiesWithDistance
                        .filter(company => company.distance !== null && company.distance <= 50)
                        .sort((a, b) => a.distance - b.distance);
                } else {
                    // For 'all' filter, keep all companies but with calculated distances
                    filtered = companiesWithDistance;
                }
            }

            return filtered;
        }

        // Set filter view (Around you / All)
        async function setViewFilter(filter) {
            currentFilter = filter;
            const aroundBtn = document.getElementById('aroundBtn');
            const allBtn = document.getElementById('allBtn');

            if (filter === 'around') {
                aroundBtn.style.backgroundColor = 'var(--btn-color)';
                aroundBtn.style.borderColor = 'var(--btn-border)';
                allBtn.style.backgroundColor = 'transparent';
                allBtn.style.borderColor = 'transparent';
            } else {
                allBtn.style.backgroundColor = 'var(--btn-color)';
                allBtn.style.borderColor = 'var(--btn-border)';
                aroundBtn.style.backgroundColor = 'transparent';
                aroundBtn.style.borderColor = 'transparent';
            }
            await renderCompanies();
        }

        // Toggle card view (List / Grid)
        async function toggleCardView() {
            cardSingle = !cardSingle;
            renderToggleIcon();
            await renderCompanies();
        }

        function renderToggleIcon() {
            const container = document.getElementById('toggleIconContainer');
            if (cardSingle) {
                // List view active -> Show Icon for "Grid Switch" which is TableSwipe in RN (Grid of squares)
                container.innerHTML = `
                   <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1" />
                        <rect x="14" y="3" width="7" height="7" rx="1" />
                        <rect x="3" y="14" width="7" height="7" rx="1" />
                        <rect x="14" y="14" width="7" height="7" rx="1" />
                   </svg>
                `;
            } else {
                // Grid view active -> Show List Icon (3 lines)
                container.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3B74FF" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6" stroke-width="2" stroke-linecap="round"/>
                        <line x1="8" y1="12" x2="21" y2="12" stroke-width="2" stroke-linecap="round"/>
                        <line x1="8" y1="18" x2="21" y2="18" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="4" cy="6" r="1.5" fill="currentColor"/>
                        <circle cx="4" cy="12" r="1.5" fill="currentColor"/>
                        <circle cx="4" cy="18" r="1.5" fill="currentColor"/>
                    </svg>
                `;
            }
        }

        // Render companies based on view mode
        async function renderCompanies() {
            const container = document.getElementById('companiesContainer');

            // Show loading indicator while companies are being fetched
            const manager = window.companyDataManager;
            const isLoadingNow = manager && manager.isLoading;
            if (!companiesDataLoaded || isLoadingNow) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="refresh-spinner"></div>
                        <p class="text-white mt-3 text-base font-medium">Loading companies...</p>
                    </div>
                `;
                return;
            }

            const filteredCompanies = await getFilteredCompanies();
            let html = '';

            if (filteredCompanies.length === 0) {
                html = `
                    <div class="flex flex-col items-center justify-center py-20 px-8">
                        <div class="w-24 h-24 bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-12 h-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div class="text-white text-center">
                            <h3 class="text-xl font-medium mb-2">No Services Found</h3>
                            <p class="text-gray-400 mb-6">
                                ${searchQuery ? 'No services match your search criteria.' :
                        currentFilter === 'around' ? 'No services found within 50km of your location.' :
                            'No water services available in your area.'}
                            </p>
                            <div class="space-y-3">
                                ${searchQuery ? `
                                    <button onclick="clearSearch()" class="px-4 py-2 bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-lg hover:bg-gray-700/50 transition-all duration-300 text-sm">
                                        Clear Search
                                    </button>
                                ` : ''}
                                <button onclick="location.reload()" class="px-4 py-2 bg-blue-600/20 backdrop-blur-sm border border-blue-500/50 rounded-lg hover:bg-blue-600/30 transition-all duration-300 text-sm flex items-center gap-2 mx-auto">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Refresh Services
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (cardSingle) {
                // List View
                html = '<div class="flex flex-col gap-1">';
                filteredCompanies.forEach((company, index) => {
                    let distanceText = company.time || 'Unknown distance';
                    if (company.distance && !isNaN(company.distance) && company.distance > 0) {
                        distanceText = `${company.distance.toFixed(1)} km away`;
                    }
                    const accuracyBadge = company.accuracy === 'high' ?
                        '<span class="text-xs text-green-400 ml-1">â—</span>' :
                        company.accuracy === 'estimated' ?
                            (company.distance !== null && company.distance <= 50 ?
                                '<span class="text-xs text-green-400 ml-1">â—</span>' :
                                '<span class="text-xs text-yellow-400 ml-1">â—</span>') : '';

                    html += `
                        <a href="schedule.html?branch_id=${company.branch_id}" 
                           class="card-bg w-full flex items-center justify-center px-4"
                           style="height: 120px; margin-top: 4px;">
                            <div class="flex flex-row w-full items-center gap-3">
                                <!-- Image -->
                                <div class="rounded-[10px] bg-[#808080] overflow-hidden" style="width: 22%; height: 89px;">
                                    ${company.profile_image ?
                            `<img src="${company.profile_image}" class="w-full h-full object-cover" alt="${company.name}">` :
                            `<div class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                            </svg>
                                        </div>`
                        }
                                </div>
                                <!-- Info -->
                                <div class="flex flex-col gap-2 ml-2 text-left" style="width: 47%;">
                                    <h3 class="text-white text-xl font-medium text-truncate">
                                        ${company.name}
                                        <span class="material-symbols-outlined ${getVerifiedIconClass(company.verification_tier)}">verified</span>
                                    </h3>
                                    <p class="text-white text-lg font-medium text-truncate">${company.location}</p>
                                    <span class="text-white text-sm font-normal">${distanceText}${accuracyBadge}</span>
                                </div>
                                <!-- View Shop -->
                                <div class="flex flex-col items-center justify-center" style="width: 20%; height: 60px;">
                                    <img src="images/main/ShopImage.png" class="w-7 h-7" alt="Shop">
                                    <span class="text-white text-base font-medium whitespace-nowrap">View shop</span>
                                </div>
                            </div>
                        </a>
                    `;
                    // Ads banner after 2nd item
                    if (index === 1) html += renderAdsBanner();
                });
                html += '</div>';
            } else {
                // Grid View
                html = `<div class="grid grid-cols-2 gap-[10px] px-[10px] pt-[10px] pb-[100px]">`;
                filteredCompanies.forEach((company, index) => {
                    let distanceText = company.time || 'Unknown';
                    if (company.distance && !isNaN(company.distance) && company.distance > 0) {
                        distanceText = `${company.distance.toFixed(1)} km`;
                    }
                    const accuracyBadge = company.accuracy === 'high' ?
                        '<span class="text-xs text-green-400">â—</span>' :
                        company.accuracy === 'estimated' ?
                            (company.distance !== null && company.distance <= 50 ?
                                '<span class="text-xs text-green-400">â—</span>' :
                                '<span class="text-xs text-yellow-400">â—</span>') : '';

                    html += `
                        <a href="schedule.html?branch_id=${company.branch_id}" 
                           class="flex flex-col items-center rounded-[16px] overflow-hidden"
                           style="height: 175px; margin-bottom: 10px;">
                            <div class="w-full" style="height: 60%;">
                                ${company.header_image ?
                            `<img src="${company.header_image}" class="w-full h-full object-cover" alt="${company.name}">` :
                            `<div class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>`
                        }
                            </div>
                            <div class="card-bg relative w-full p-3" style="height: 40%;">
                                <div class="relative rounded-lg overflow-hidden p-[1px]"
                                     style="height: 52px; width: 55px; top: -35px; background-color: #40444B;">
                                    ${company.profile_image ?
                            `<img src="${company.profile_image}" class="w-full h-full object-cover" alt="Logo">` :
                            `<div class="w-full h-full bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                            </svg>
                                        </div>`
                        }
                                </div>
                                <div class="relative text-left" style="top: -30px;">
                                    <p class="text-white font-medium text-base text-truncate" style="width: 100%;">
                                        ${company.name}
                                        <span class="material-symbols-outlined ${getVerifiedIconClass(company.verification_tier)}">verified</span>
                                    </p>
                                </div>
                            </div>
                        </a>
                    `;
                    // Ads banner after 4th item (full width)
                    if (index === 3) html += `<div class="col-span-2">${renderAdsBanner()}</div>`;
                });
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function renderAdsBanner() {
            return `
                <div class="ads-banner w-full flex flex-col items-center justify-center gap-6" style="height: 125px; background: url('images/main/adsBack.png') no-repeat center center; background-size: cover;">
                    <span class="text-white text-base font-semibold">Register for Phluowise Business</span>
                    <button onclick="window.location.href='https://phluowise.com/company'" 
                            class="h-[40px] w-[150px] rounded-[100px] flex items-center justify-center border bg-white border-white">
                        <span class="text-black text-base font-semibold capitalize">Get access</span>
                    </button>
                </div>
            `;
        }

        // Location Modal Logic
        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
        }

        function allowLocation() {
            closeLocationModal();

            if (navigator.geolocation) {
                console.log("ðŸ“ Location permission granted - requesting device location...");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("âœ… Location access granted successfully");
                        console.log(`ðŸ“ Current location: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`);
                        console.log(`ðŸŽ¯ Location accuracy: Â±${Math.round(position.coords.accuracy)} meters`);

                        // Store permission granted status
                        localStorage.setItem('locationPermissionGranted', 'true');
                        locationPermissionGranted = true;

                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        renderCompanies();
                    },
                    (error) => {
                        console.error("Location access denied", error);
                        // Use default location (Accra) if location access denied
                        userLocation = { lat: 5.6037, lng: -0.1870 };
                        renderCompanies();
                    }
                );
            }
        }

        // Pull-to-refresh functionality
        let pullToRefresh = {
            startY: 0,
            currentY: 0,
            pullDistance: 0,
            isPulling: false,
            threshold: 80
        };

        function initPullToRefresh() {
            const mainContent = document.querySelector('.flex-1.overflow-y-auto');

            mainContent.addEventListener('touchstart', (e) => {
                if (mainContent.scrollTop === 0) {
                    pullToRefresh.startY = e.touches[0].clientY;
                    pullToRefresh.isPulling = true;
                }
            });

            mainContent.addEventListener('touchmove', (e) => {
                if (!pullToRefresh.isPulling) return;

                pullToRefresh.currentY = e.touches[0].clientY;
                pullToRefresh.pullDistance = Math.max(0, pullToRefresh.currentY - pullToRefresh.startY);

                if (pullToRefresh.pullDistance > 0) {
                    e.preventDefault();
                    showPullToRefreshIndicator(pullToRefresh.pullDistance);
                }
            });

            mainContent.addEventListener('touchend', () => {
                if (!pullToRefresh.isPulling) return;

                pullToRefresh.isPulling = false;

                if (pullToRefresh.pullDistance >= pullToRefresh.threshold) {
                    performRefresh();
                } else {
                    hidePullToRefreshIndicator();
                }

                pullToRefresh.pullDistance = 0;
            });
        }

        function showPullToRefreshIndicator(distance) {
            const indicator = document.getElementById('pullToRefreshIndicator');
            const refreshText = document.getElementById('refreshText');

            if (distance >= pullToRefresh.threshold) {
                refreshText.textContent = 'Release to refresh';
                indicator.classList.add('refreshing');
            } else {
                refreshText.textContent = 'Pull to refresh';
                indicator.classList.remove('refreshing');
            }

            indicator.classList.add('show');
        }

        function hidePullToRefreshIndicator() {
            const indicator = document.getElementById('pullToRefreshIndicator');
            indicator.classList.remove('show', 'refreshing');
        }

        function performRefresh() {
            if (isRefreshing) return;

            isRefreshing = true;
            const indicator = document.getElementById('pullToRefreshIndicator');
            const refreshText = document.getElementById('refreshText');

            refreshText.textContent = 'Refreshing...';
            indicator.classList.add('refreshing');

            // Store current state for comparison
            const previousState = {
                filter: currentFilter,
                searchQuery: searchQuery,
                location: userLocation,
                timestamp: Date.now()
            };

            // Enhanced refresh operation with better data management
            refreshCompaniesData(previousState)
                .then(() => {
                    // Hide indicator and reset state
                    hidePullToRefreshIndicator();
                    isRefreshing = false;

                    // Show success feedback
                    refreshText.textContent = 'Updated!';
                    setTimeout(() => {
                        if (!isRefreshing) {
                            refreshText.textContent = 'Pull to refresh';
                        }
                    }, 1000);
                })
                .catch((error) => {
                    console.error('Refresh failed:', error);
                    hidePullToRefreshIndicator();
                    isRefreshing = false;
                    refreshText.textContent = 'Failed to update';
                    setTimeout(() => {
                        if (!isRefreshing) {
                            refreshText.textContent = 'Pull to refresh';
                        }
                    }, 2000);
                });
        }

        async function handleManualRefresh() {
            try {
                console.log('ðŸ”„ Manual refresh - replacing cache with fresh data...');

                // Force refresh from database first
                const freshData = await window.companyDataManager.fetchCompanyData();

                // Replace cache with fresh data (don't just clear)
                if (window.cacheManager) {
                    window.cacheManager.setCache('companies', freshData);
                    console.log('ðŸ’¾ Cache replaced with fresh data');
                }

                // Update local companies array
                companies = freshData;
                companiesDataLoaded = true;

                // Clear service worker cache and update with fresh content
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        // Clear old entries
                        const requests = await cache.keys();
                        await Promise.all(requests.map(request => cache.delete(request)));
                        console.log(`ðŸ—‘ï¸ Cleared ${requests.length} items from ${cacheName}`);
                    }
                }

                // Re-render with current filters and search
                await renderCompanies();

                // Hide pull-to-refresh indicator
                hidePullToRefresh();

                console.log('âœ… Manual refresh completed - cache replaced');
                return { status: 'success', timestamp: Date.now() };

            } catch (error) {
                console.error('âŒ Manual refresh failed:', error);

                // Try fallback methods
                try {
                    const fallbackData = window.companyDataManager.getFallbackData();
                    companies = fallbackData;
                    companiesDataLoaded = true;

                    // Replace cache with fallback data
                    if (window.cacheManager) {
                        window.cacheManager.setCache('companies', fallbackData);
                    }

                    renderCompanies();
                    hidePullToRefresh();
                    return { status: 'partial', timestamp: Date.now() };
                } catch (fallbackError) {
                    console.error('âŒ All refresh methods failed:', fallbackError);

                    // Last resort - try existing cache
                    if (window.cacheManager) {
                        const cachedCompanies = window.cacheManager.getCache('companies');
                        if (cachedCompanies && cachedCompanies.length > 0) {
                            console.log('ðŸ“¦ Using existing cache as fallback');
                            companies = cachedCompanies;
                            companiesDataLoaded = true;
                            renderCompanies();
                            hidePullToRefresh();
                            return { status: 'fallback', timestamp: Date.now() };
                        }
                    }

                    // Final fallback
                    companies = window.companyDataManager.getFallbackData();
                    companiesDataLoaded = true;
                    renderCompanies();
                    hidePullToRefresh();
                    return { status: 'emergency', timestamp: Date.now() };
                }
            }
        }

        async function refreshCompaniesData(previousState) {
            try {
                console.log('ðŸ”„ Refresh - replacing cache with fresh data...');

                // Force refresh from database first
                const freshData = await window.companyDataManager.fetchCompanyData();

                // Replace cache with fresh data (don't just update)
                if (window.cacheManager) {
                    window.cacheManager.setCache('companies', freshData);
                    console.log('ðŸ’¾ Cache replaced with fresh data');
                }

                // Update local companies array
                companies = freshData;
                companiesDataLoaded = true;

                // Re-render with current filters and search
                renderCompanies();

                // Update distances if location is available and filter is 'around'
                if (userLocation && currentFilter === 'around') {
                    updateDistances();
                    renderCompanies();
                }

                return { status: 'success', timestamp: Date.now() };
            } catch (error) {
                console.error('âŒ Refresh failed:', error);

                // Don't break the UI - keep existing data
                if (companies.length > 0) {
                    console.log('ðŸ“¦ Keeping existing data - refresh failed but UI works');
                    return { status: 'partial', timestamp: Date.now() };
                }

                // Last resort - try cache and replace with it
                if (window.cacheManager) {
                    const cachedCompanies = window.cacheManager.getCache('companies');
                    if (cachedCompanies && cachedCompanies.length > 0) {
                        console.log('ðŸ“¦ Using cache as fallback and ensuring it\'s set');
                        companies = cachedCompanies;
                        companiesDataLoaded = true;
                        // Ensure cache is properly set
                        window.cacheManager.setCache('companies', cachedCompanies);
                        renderCompanies();
                        return { status: 'fallback', timestamp: Date.now() };
                    }
                }

                throw error;
            }
        }

        async function updateCompaniesData() {
            console.log('ðŸ”„ Loading companies with web2app cache-first strategy...');

            // STEP 1: Always try cache first for instant UI
            if (window.cacheManager) {
                const cachedCompanies = window.cacheManager.getCache('companies');
                if (cachedCompanies && cachedCompanies.length > 0) {
                    console.log('ðŸ“¦ Loading companies from cache for instant UI:', cachedCompanies.length);
                    companies = cachedCompanies;
                    companiesDataLoaded = true;
                    renderCompanies();

                    // STEP 2: Background refresh - check if cache needs update
                    setTimeout(() => refreshCompaniesInBackground(), 1000);
                    return;
                }
            }

            // STEP 3: No cache available - load from database with fallback
            console.log('ðŸ“¡ No cache available - loading from database...');
            await loadCompaniesFromDatabaseWithFallback();
        }

        // Background refresh to update cache without blocking UI
        async function refreshCompaniesInBackground() {
            if (!navigator.onLine) {
                console.log('ðŸ“´ Offline - skipping background refresh');
                return;
            }

            try {
                console.log('ðŸ”„ Background refresh - checking for new data...');
                const freshData = await window.companyDataManager.fetchCompanyData();

                // Check if data has changed
                if (hasCompaniesChanged(freshData, companies)) {
                    console.log('ðŸ†• New data detected - replacing cache and updating UI');
                    companies = freshData;
                    companiesDataLoaded = true;

                    // Replace cache with fresh data
                    if (window.cacheManager) {
                        window.cacheManager.setCache('companies', freshData);
                        console.log('ðŸ’¾ Cache replaced with fresh data');
                    }

                    // Update UI
                    renderCompanies();
                } else {
                    console.log('ðŸ“Š No new data - cache is current');
                }
            } catch (error) {
                console.error('âŒ Background refresh failed:', error);
                // Don't show error to user - UI already working with cache
            }
        }

        // Check if companies data has changed
        function hasCompaniesChanged(newData, oldData) {
            if (!oldData || oldData.length === 0) return true;
            if (!newData || newData.length === 0) return false;
            if (newData.length !== oldData.length) return true;

            // Check for updated timestamps or new companies
            for (let i = 0; i < newData.length; i++) {
                const newCompany = newData[i];
                const oldCompany = oldData.find(c => c.company_id === newCompany.company_id);

                if (!oldCompany) return true; // New company found

                // Check for updates
                if (newCompany.$updatedAt && oldCompany.$updatedAt) {
                    if (newCompany.$updatedAt !== oldCompany.$updatedAt) return true;
                }
            }

            return false;
        }

        // Load from database with multiple fallback layers
        async function loadCompaniesFromDatabaseWithFallback() {
            try {
                // Try database first
                console.log('ðŸ“¡ Loading from database...');
                companies = await window.companyDataManager.fetchCompanyData();
                companiesDataLoaded = true;

                // Replace cache with the loaded companies
                if (window.cacheManager) {
                    window.cacheManager.setCache('companies', companies);
                    console.log('ðŸ’¾ Cache replaced with fresh database data');
                }

                renderCompanies();
                console.log(`âœ… Loaded ${companies.length} companies from database`);

            } catch (error) {
                console.error('âŒ Database load failed:', error);

                // Fallback 1: Try cache manager again and ensure it's set
                if (window.cacheManager) {
                    const cachedCompanies = window.cacheManager.getCache('companies');
                    if (cachedCompanies && cachedCompanies.length > 0) {
                        console.log('ðŸ“¦ Using cache manager as fallback:', cachedCompanies.length);
                        companies = cachedCompanies;
                        companiesDataLoaded = true;
                        // Ensure cache is properly set
                        window.cacheManager.setCache('companies', cachedCompanies);
                        renderCompanies();
                        return;
                    }
                }

                // Fallback 2: Use companyDataManager fallback data and cache it
                console.log('ðŸ”„ Using companyDataManager fallback data...');
                companies = window.companyDataManager.getFallbackData();
                companiesDataLoaded = true;

                // Replace cache with fallback data
                if (window.cacheManager) {
                    window.cacheManager.setCache('companies', companies);
                    console.log('ðŸ’¾ Cache replaced with fallback data');
                }

                renderCompanies();
                console.log('âš ï¸ Using fallback data - app works offline');
            }
        }

        function updateDistances() {
            if (!userLocation) return;

            companies.forEach(company => {
                if (company.coordinates) {
                    company.distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        company.coordinates.lat, company.coordinates.lng
                    );
                }
            });

            // Re-sort companies by distance if 'around' filter is active
            if (currentFilter === 'around') {
                companies.sort((a, b) => (a.distance || 0) - (b.distance || 0));
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Theme setup
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.remove('dark-theme', 'gray-theme', 'light-theme');
            document.body.classList.add(savedTheme + '-theme');

            // Load user data for menu display
            function loadMenuUserData() {
                // Try to get data from multiple sources in priority order
                let userData = {};

                // 1. Try customerSession first (most reliable for logged-in users)
                const customerSession = localStorage.getItem('customerSession');
                if (customerSession) {
                    try {
                        const sessionData = JSON.parse(customerSession);
                        userData = {
                            name: sessionData.name,
                            email: sessionData.email
                        };
                    } catch (e) {
                        console.log('Error parsing customerSession for menu:', e);
                    }
                }

                // 2. Try userProfile cache
                if (!userData.name) {
                    if (window.cacheManager) {
                        userData = window.cacheManager.getCache('user_profile') || {};
                    } else {
                        // Fallback to regular localStorage
                        userData = JSON.parse(localStorage.getItem('userProfile')) || {};
                    }
                }

                // 3. Try customerData as fallback
                if (!userData.name) {
                    const customerData = localStorage.getItem('customerData');
                    if (customerData) {
                        try {
                            const customer = JSON.parse(customerData);
                            userData = {
                                name: customer.full_name,
                                email: customer.email
                            };
                        } catch (e) {
                            console.log('Error parsing customerData for menu:', e);
                        }
                    }
                }

                // Fix common name variations
                if (userData.name === 'Asar') {
                    userData.name = 'Asare';
                    console.log('ðŸ”§ Fixed menu name: Asar â†’ Asare');
                }

                // Update menu display with fallbacks
                const menuUserName = document.getElementById('menuUserName');
                const menuUserEmail = document.getElementById('menuUserEmail');

                if (menuUserName) {
                    menuUserName.textContent = userData.name || userData.full_name || 'Phluowiser';
                }

                if (menuUserEmail) {
                    menuUserEmail.textContent = userData.email || 'loading...';
                }

                console.log('Home menu user data loaded:', { name: userData.name || userData.full_name, email: userData.email });
            }

            // Load saved profile image
            loadSavedProfileImage();

            // Load user data for menu display
            loadMenuUserData();

            // Set greeting
            const hour = new Date().getHours();

            // Try to get real user name from multiple sources (same as services.html)
            let userName = 'User';

            // 1. Try customerSession first
            const customerSession = localStorage.getItem('customerSession');
            if (customerSession) {
                try {
                    const sessionData = JSON.parse(customerSession);
                    userName = sessionData.name || 'User';
                    console.log('ðŸ” Home greeting - customerSession name:', userName);
                } catch (e) {
                    console.log('Error parsing customerSession for greeting:', e);
                }
            }

            // 2. Try userProfile cache
            if (userName === 'User') {
                if (window.cacheManager) {
                    const userProfile = window.cacheManager.getCache('user_profile') || {};
                    userName = userProfile.name || userProfile.full_name || 'User';
                    console.log('ðŸ” Home greeting - userProfile name:', userName);
                } else {
                    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    userName = userProfile.name || userProfile.full_name || 'User';
                    console.log('ðŸ” Home greeting - localStorage userProfile name:', userName);
                }
            }

            // 3. Try customerData as fallback
            if (userName === 'User') {
                const customerData = localStorage.getItem('customerData');
                if (customerData) {
                    try {
                        const customer = JSON.parse(customerData);
                        userName = customer.full_name || 'User';
                        console.log('ðŸ” Home greeting - customerData full_name:', userName);
                    } catch (e) {
                        console.log('Error parsing customerData for greeting:', e);
                    }
                }
            }

            // 4. Fallback to old method for compatibility
            if (userName === 'User') {
                userName = localStorage.getItem('userName') || localStorage.getItem('firstName') || 'User';
            }

            // Fix common name variations
            if (userName === 'Asar') {
                userName = 'Asare';
                console.log('ðŸ”§ Fixed home name: Asar â†’ Asare');
            }

            let greeting = hour < 12 ? 'Good Morning' : (hour < 18 ? 'Good Afternoon' : 'Good Evening');
            // Get first name only and capitalize properly
            const firstName = userName.split(' ')[0];
            const displayName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
            document.getElementById('greetingText').textContent = `${greeting}, ${displayName}`;

            // Initialize pull-to-refresh functionality
            initPullToRefresh();

            // Add cache debugging function to console
            window.debugCache = function () {
                console.log('=== CACHE DEBUG INFO ===');

                // Service Worker Cache
                if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                        console.log('Service Worker Caches:', cacheNames);
                        cacheNames.forEach(name => {
                            caches.open(name).then(cache => {
                                cache.keys().then(requests => {
                                    console.log(`Cache ${name}:`, requests.length, 'items');
                                });
                            });
                        });
                    });
                }

                // LocalStorage Cache
                if (window.cacheManager) {
                    const stats = window.cacheManager.getCacheStats();
                    console.log('Cache Manager Stats:', stats);
                }

                // User Data Sources
                console.log('User Data Sources:');
                console.log('- customerSession:', localStorage.getItem('customerSession') ? 'âœ“' : 'âœ—');
                console.log('- userProfile:', localStorage.getItem('userProfile') ? 'âœ“' : 'âœ—');
                console.log('- customerData:', localStorage.getItem('customerData') ? 'âœ“' : 'âœ—');
                console.log('- userName:', localStorage.getItem('userName') ? 'âœ“' : 'âœ—');

                console.log('=== END CACHE DEBUG ===');
            };

            // Add force cache replacement function
            window.forceCacheReplace = async function () {
                console.log('ðŸ”„ Force replacing all cache...');
                try {
                    // Get fresh data
                    const freshData = await window.companyDataManager.fetchCompanyData();

                    // Replace localStorage cache
                    if (window.cacheManager) {
                        window.cacheManager.setCache('companies', freshData);
                        console.log('ðŸ’¾ LocalStorage cache replaced');
                    }

                    // Clear service worker cache
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        for (const cacheName of cacheNames) {
                            const cache = await caches.open(cacheName);
                            const requests = await cache.keys();
                            await Promise.all(requests.map(request => cache.delete(request)));
                            console.log(`ðŸ—‘ï¸ Cleared ${requests.length} items from ${cacheName}`);
                        }
                    }

                    // Update UI
                    companies = freshData;
                    companiesDataLoaded = true;
                    renderCompanies();

                    console.log('âœ… All cache replaced successfully');
                    return true;
                } catch (error) {
                    console.error('âŒ Force cache replace failed:', error);
                    return false;
                }
            };

            console.log('ðŸ’¡ Run debugCache() to check cache status');
            console.log('ðŸ’¡ Run forceCacheReplace() to force replace all cache');
            console.log('ðŸ’¡ Run testVerificationTiers() to test verification tier logic');

            // Test verification tiers function
            window.testVerificationTiers = function () {
                console.log('=== TESTING VERIFICATION TIERS ===');

                if (!window.companyDataManager) {
                    console.log('âŒ CompanyDataManager not available');
                    return;
                }

                console.log('ðŸ“‹ User Settings:', window.companyDataManager.userSettings);
                console.log('ðŸ“‹ Companies:', window.companyDataManager.companies);
                console.log('ðŸ“‹ Merged Companies:', companies);

                // Show detailed user settings
                console.log('\n--- DETAILED USER SETTINGS ---');
                window.companyDataManager.userSettings.forEach((setting, index) => {
                    console.log(`Setting ${index + 1}:`, {
                        branch_id: setting.branch_id,
                        user_id: setting.user_id,
                        verification_level: setting.verification_level,
                        $id: setting.$id
                    });
                });

                // Test each company
                companies.forEach((company, index) => {
                    console.log(`\n--- Company ${index + 1}: ${company.name} ---`);
                    console.log(`Company ID: ${company.company_id}`);
                    console.log(`Branch ID: ${company.branch_id}`);
                    console.log(`Verification Tier: ${company.verification_tier}`);
                    console.log(`Icon Class: ${getVerifiedIconClass(company.verification_tier)}`);

                    // Test the tier determination directly
                    const directTier = window.companyDataManager.getVerificationTier(company.company_id, company.branch_id);
                    console.log(`Direct Tier Test: ${directTier}`);
                });

                console.log('\n=== END VERIFICATION TEST ===');
            };

            // Load company data from database
            loadInitialCompanyData();

            // Check location permission after 5 seconds (simulating RN logic)
            setTimeout(() => {
                // Only show modal if permission hasn't been granted or denied before
                const locationPermissionGranted = localStorage.getItem('locationPermissionGranted');
                const locationModal = document.getElementById('locationModal');

                if (locationPermissionGranted === null && locationModal) {
                    console.log("ðŸ”” Showing location permission modal for the first time");
                    locationModal.style.display = 'flex';
                } else if (locationPermissionGranted === 'true') {
                    console.log("âœ… Location permission previously granted - using stored location");
                    // If permission was granted before, try to get location again
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                console.log("ðŸ“ Restored location from previous session");
                                console.log(`ðŸ“ Current location: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`);
                                userLocation = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                renderCompanies();
                            },
                            (error) => {
                                console.log("ðŸ  Using default location (previous session location unavailable)");
                                userLocation = { lat: 5.6037, lng: -0.1870 };
                                renderCompanies();
                            }
                        );
                    }
                } else if (locationPermissionGranted === 'false') {
                    console.log("âŒ Location permission previously denied - using default location");
                    userLocation = { lat: 5.6037, lng: -0.1870 };
                    renderCompanies();
                }
            }, 5000);

            renderToggleIcon();
            renderCompanies();
        });

        // Load initial company data from database
        async function loadInitialCompanyData() {
            try {
                // Check if user is authenticated
                if (!window.account) {
                    console.log('â³ Waiting for Appwrite account to initialize...');
                    setTimeout(() => loadInitialCompanyData(), 1000);
                    return;
                }

                // Try to get current user
                let user = null;
                try {
                    user = await window.account.get();
                    console.log('âœ… User authenticated:', user.email);
                } catch (authError) {
                    console.log('âš ï¸ No authenticated user - using fallback data');
                    companies = window.companyDataManager.getFallbackData();
                    companiesDataLoaded = true;
                    renderCompanies();
                    return;
                }

                // Wait for Appwrite to be available
                if (!window.appwriteConfig || !window.databases) {
                    console.log('â³ Waiting for Appwrite to initialize...');
                    // Wait a bit and retry
                    setTimeout(() => loadInitialCompanyData(), 1000);
                    return;
                }

                // Wait for companyDataManager to be available
                if (!window.companyDataManager) {
                    console.log('â³ Waiting for CompanyDataManager to initialize...');
                    setTimeout(() => loadInitialCompanyData(), 500);
                    return;
                }

                console.log('ðŸ”„ Loading initial company data from database...');
                console.log('ðŸ” CompanyDataManager available:', typeof window.companyDataManager);
                console.log('ðŸ” fetchCompanyData method available:', typeof window.companyDataManager.fetchCompanyData);

                companies = await window.companyDataManager.fetchCompanyData();
                companiesDataLoaded = true;
                console.log(`âœ… Loaded ${companies.length} companies from database`);
                renderCompanies();
            } catch (error) {
                console.error('âŒ Error loading initial company data:', error);
                // Use fallback data if database fails
                if (window.companyDataManager && typeof window.companyDataManager.getFallbackData === 'function') {
                    companies = window.companyDataManager.getFallbackData();
                } else {
                    // Return empty array for professional empty state
                    companies = [];
                }
                companiesDataLoaded = true;
                renderCompanies();
            }
        }

        // Sliding Menu Functions
        function toggleMenu() {
            const menuOverlay = document.getElementById('menuOverlay');
            const slidingMenu = document.getElementById('slidingMenu');

            if (menuOverlay.classList.contains('active')) {
                closeMenu();
            } else {
                openMenu();
            }
        }

        function openMenu() {
            const menuOverlay = document.getElementById('menuOverlay');
            const slidingMenu = document.getElementById('slidingMenu');

            menuOverlay.classList.add('active');
            slidingMenu.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeMenu() {
            const menuOverlay = document.getElementById('menuOverlay');
            const slidingMenu = document.getElementById('slidingMenu');

            menuOverlay.classList.remove('active');
            slidingMenu.classList.remove('active');
            document.body.style.overflow = ''; // Restore background scrolling
        }

        // Profile image functions (from menu.html)
        function openProfileImagePicker() {
            document.getElementById('profileImageInput').click();
        }

        function handleProfileImageChange(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Update the profile image src
                    const profileImg = document.getElementById('profileImage');
                    const emptyState = document.getElementById('profileImageEmptyState');
                    if (profileImg && emptyState) {
                        profileImg.src = e.target.result;
                        profileImg.style.display = 'block';
                        emptyState.style.display = 'none';
                        // Save to localStorage
                        localStorage.setItem('profileImage', e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // Load saved profile image on page load
        function loadSavedProfileImage() {
            const savedImage = localStorage.getItem('profileImage');
            if (savedImage) {
                const profileImg = document.getElementById('profileImage');
                const emptyState = document.getElementById('profileImageEmptyState');
                if (profileImg && emptyState) {
                    profileImg.src = savedImage;
                    profileImg.style.display = 'block';
                    emptyState.style.display = 'none';
                }
            }
        }

        // Logout function
        async function logout() {
            // Get the logout button and show loading state
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            const originalContent = logoutBtn.innerHTML;

            // Show loading indicator
            logoutBtn.innerHTML = `
                <div class="flex flex-row items-center gap-[30px]">
                    <div class="w-6 h-6 flex items-center justify-center">
                        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <span class="text-white text-lg font-semibold">Signing out...</span>
                </div>
                <div class="w-5 h-5 flex items-center justify-center">
                    <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </div>
            `;
            logoutBtn.disabled = true;

            try {
                // Clear all local storage data
                localStorage.removeItem('customerSession');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userName');
                localStorage.removeItem('userEmail');

                // Try to clear Appwrite session if available
                if (typeof account !== 'undefined') {
                    try {
                        await account.deleteSession('current');
                        console.log('Appwrite session cleared');
                    } catch (appwriteError) {
                        console.log('Appwrite session already cleared or error:', appwriteError);
                    }
                }

                // Show success briefly before redirect
                logoutBtn.innerHTML = `
                    <div class="flex flex-row items-center gap-[30px]">
                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-white text-lg font-semibold">Signed out!</span>
                    </div>
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                `;

                // Redirect to signin page after brief delay
                setTimeout(() => {
                    window.location.href = 'signin.html';
                }, 500);

            } catch (error) {
                console.error('Logout error:', error);

                // Show error state
                logoutBtn.innerHTML = `
                    <div class="flex flex-row items-center gap-[30px]">
                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <span class="text-white text-lg font-semibold">Error</span>
                    </div>
                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                `;

                // Even if there's an error, clear storage and redirect after brief delay
                setTimeout(() => {
                    localStorage.removeItem('customerSession');
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userEmail');
                    window.location.href = 'signin.html';
                }, 1000);
            }
        }

        // Delete Account Confirmation function
        window.showDeleteConfirm = function () {
            // Create modal overlay following the existing pattern
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'deleteAccountModal';
            modalOverlay.className = 'fixed inset-0 z-50 flex items-center justify-center p-9';
            modalOverlay.style.cssText = 'display: flex; backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.5);';

            // Create modal content following existing modal pattern
            const modalContent = document.createElement('div');
            modalContent.className = 'rounded-[30px] w-full max-w-[350px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]';
            modalContent.style.cssText = 'background-color: var(--modal-bg); border-color: var(--modal-border);';

            modalContent.innerHTML = `
                <div class="flex flex-col items-center justify-center w-full h-full">
                    <!-- Warning Icon Section -->
                    <div class="flex flex-col items-center justify-center mb-6">
                        <div class="w-[80px] h-[80px] rounded-full flex items-center justify-center mb-4"
                             style="background-color: rgba(245, 125, 125, 0.1);">
                            <svg class="w-[40px] h-[40px] text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </div>
                        
                        <h2 class="text-white text-[20px] font-bold text-center mb-3">Delete Account</h2>
                        <p class="text-gray-400 text-[14px] text-center leading-[20px] mb-6">
                            Are you sure you want to delete your account? This action cannot be undone and will permanently delete:
                        </p>
                        
                        <div class="w-full text-left mb-6">
                            <div class="text-gray-400 text-[13px] space-y-2">
                                <div class="flex items-center gap-2">
                                    <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="2"/>
                                    </svg>
                                    <span>Your profile information</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="2"/>
                                    </svg>
                                    <span>Order history</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="2"/>
                                    </svg>
                                    <span>Saved preferences</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <svg class="w-[4px] h-[4px] text-red-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="2"/>
                                    </svg>
                                    <span>All associated data</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Button Section -->
                    <div class="w-full flex items-center gap-3">
                        <!-- Cancel Button -->
                        <button onclick="cancelDeleteAccount()"
                                class="h-[37px] flex-1 rounded-[100px] flex items-center justify-center border transition-all hover:opacity-80"
                                style="background-color: var(--btn-second-color); border-color: var(--btn-second-border);">
                            <span class="text-white text-base font-semibold capitalize">Cancel</span>
                        </button>
                        
                        <!-- Delete Button -->
                        <button onclick="confirmDeleteAccount()"
                                class="h-[37px] flex-1 rounded-[100px] flex items-center justify-center border transition-all hover:opacity-80"
                                style="background-color: #F57D7D; border-color: #F57D7D;">
                            <span class="text-white text-base font-semibold capitalize">Delete</span>
                        </button>
                    </div>
                </div>
            `;

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Close modal when clicking overlay
            modalOverlay.addEventListener('click', function (e) {
                if (e.target === modalOverlay) {
                    cancelDeleteAccount();
                }
            });
        };

        // Show delete success modal
        window.showDeleteSuccessModal = function () {
            // Close the delete confirmation modal first
            const deleteModal = document.getElementById('deleteAccountModal');
            if (deleteModal) {
                deleteModal.remove();
            }

            // Create success modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'deleteSuccessModal';
            modalOverlay.className = 'fixed inset-0 z-50 flex items-center justify-center p-9';
            modalOverlay.style.cssText = 'display: flex; backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.5);';

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'rounded-[30px] w-full max-w-[350px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]';
            modalContent.style.cssText = 'background-color: var(--modal-bg); border-color: var(--modal-border);';

            modalContent.innerHTML = `
                <div class="flex flex-col items-center justify-center w-full h-full">
                    <!-- Success Icon Section -->
                    <div class="flex flex-col items-center justify-center mb-6">
                        <div class="w-[80px] h-[80px] rounded-full flex items-center justify-center mb-4"
                             style="background-color: rgba(34, 197, 94, 0.1);">
                            <svg class="w-[40px] h-[40px] text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        
                        <h2 class="text-white text-[20px] font-bold text-center mb-3">Account Deleted</h2>
                        <p class="text-gray-400 text-[14px] text-center leading-[20px] mb-4">
                            Your account has been successfully deleted.
                        </p>
                        <p class="text-gray-500 text-[13px] text-center leading-[18px]">
                            Redirecting to sign-in page...
                        </p>
                        
                        <!-- Loading indicator -->
                        <div class="flex items-center gap-1 mt-4">
                            <div class="w-[6px] h-[6px] rounded-full bg-green-500 animate-pulse"></div>
                            <div class="w-[6px] h-[6px] rounded-full bg-green-500 animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-[6px] h-[6px] rounded-full bg-green-500 animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
            `;

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Auto-remove modal after redirect (backup cleanup)
            setTimeout(() => {
                const modal = document.getElementById('deleteSuccessModal');
                if (modal) {
                    modal.remove();
                }
            }, 3000);
        };

        // Cancel delete account
        window.cancelDeleteAccount = function () {
            const modal = document.getElementById('deleteAccountModal');
            if (modal) {
                modal.remove();
            }
        };

        // Confirm delete account
        window.confirmDeleteAccount = async function () {
            try {
                // Show loading state
                const deleteBtn = document.querySelector('#deleteAccountModal button[onclick="confirmDeleteAccount()"] span');
                const originalText = deleteBtn.textContent;
                deleteBtn.textContent = 'Deleting...';
                deleteBtn.parentElement.disabled = true;

                // Get current user
                const user = await window.account.get();
                const userEmail = user.email;

                // Delete from customer_tb first
                try {
                    const customerDocs = await window.databases.listDocuments(
                        window.appwriteConfig.DATABASE_ID,
                        window.appwriteConfig.CUSTOMER_TABLE,
                        [window.Query.equal('email', userEmail.toLowerCase())]
                    );

                    // Delete customer records
                    for (const doc of customerDocs.documents) {
                        await window.databases.deleteDocument(
                            window.appwriteConfig.DATABASE_ID,
                            window.appwriteConfig.CUSTOMER_TABLE,
                            doc.$id
                        );
                    }
                    console.log('âœ… Customer data deleted from database');
                } catch (dbError) {
                    console.warn('âš ï¸ Could not delete customer data:', dbError.message);
                }

                // Immediately logout user by deleting all sessions
                console.log('ðŸ”’ Logging out user...');
                try {
                    const sessions = await window.account.listSessions();
                    for (const session of sessions.sessions) {
                        await window.account.deleteSession(session.$id);
                    }
                    console.log('âœ… User logged out - all sessions deleted');
                } catch (sessionError) {
                    console.warn('âš ï¸ Could not delete sessions:', sessionError.message);
                    // Try to delete current session as fallback
                    try {
                        await window.account.deleteSession('current');
                        console.log('âœ… User logged out - current session deleted');
                    } catch (fallbackError) {
                        console.warn('âš ï¸ Could not delete current session:', fallbackError.message);
                    }
                }

                // Clear local storage immediately after logout
                localStorage.clear();
                console.log('ðŸ§¹ Local storage cleared');

                // Show success modal
                showDeleteSuccessModal();

                // Redirect to sign-in page after delay
                setTimeout(() => {
                    window.location.href = 'signin.html';
                }, 2500);

            } catch (error) {
                console.error('âŒ Error deleting account:', error);

                // Reset button
                const deleteBtn = document.querySelector('#deleteAccountModal button[onclick="confirmDeleteAccount()"] span');
                deleteBtn.textContent = 'Delete';
                deleteBtn.parentElement.disabled = false;

                // Show error message
                alert('Failed to delete account. Please try again or contact support. Error: ' + error.message);
            }
        };

        // Navigation State Management
        function saveCurrentPage() {
            localStorage.setItem('previousPage', window.location.pathname.split('/').pop());
        }

        function navigateToPage(page) {
            saveCurrentPage();
            window.location.href = page;
        }

        // Handle browser back button
        window.addEventListener('popstate', function (event) {
            const previousPage = localStorage.getItem('previousPage');
            if (previousPage && previousPage !== window.location.pathname.split('/').pop()) {
                // Navigate back to the saved page
                window.location.href = previousPage;
            }
        });

        // Initialize navigation state on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Clear previous page when landing directly on this page
            if (!localStorage.getItem('previousPage')) {
                localStorage.setItem('previousPage', 'home.html');
            }
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw-improved.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>


</html>
