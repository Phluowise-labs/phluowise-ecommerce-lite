<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rating Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
        }
        body {
            background-color: var(--bg-color);
            color: white;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <div class="p-8">
        <h1 class="text-2xl font-bold mb-4">Rating Tab Functionality Test</h1>
        
        <!-- Rating Summary -->
        <div class="p-4 rounded-xl mb-4" style="min-height: 200px;">
            <div class="flex flex-row justify-between items-center">
                <span class="text-white font-bold text-xl">3.0 rating</span>
                <span class="text-white font-semibold text-lg">200 reviews</span>
            </div>
            <!-- Rating bars -->
            <div class="mt-4 flex flex-col gap-2">
                <div class="flex flex-row items-center gap-2">
                    <span class="text-white font-semibold text-xl">5</span>
                    <div class="flex flex-row items-center gap-2 flex-grow">
                        <div class="w-[86%] rounded-[100px] bg-[#40444B] overflow-hidden" style="height: 13px;">
                            <div class="bg-white h-full" style="width: 80%"></div>
                        </div>
                        <span class="text-white font-medium text-lg">80%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Input -->
        <div class="p-4 relative mb-[150px]" style="z-index: 5; height: 200px;">
            <!-- Rating Popup -->
            <div id="ratingPopup" class="absolute left-0 right-0 hidden bg-transparent" style="top: -60px; z-index: 10;">
                <div class="flex flex-row items-center gap-4 py-2 overflow-x-auto justify-center">
                    <!-- Stars -->
                    <div class="flex flex-row items-center justify-center gap-4 ml-2 rounded-[100px] bg-black" style="height: 45px; width: 216px;">
                        <button onclick="setStarRating(1)" class="w-6 h-6 star-rating-btn">
                            <svg fill="#666" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                        </button>
                        <button onclick="setStarRating(2)" class="w-6 h-6 star-rating-btn">
                            <svg fill="#666" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                        </button>
                        <button onclick="setStarRating(3)" class="w-6 h-6 star-rating-btn">
                            <svg fill="#666" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                        </button>
                        <button onclick="setStarRating(4)" class="w-6 h-6 star-rating-btn">
                            <svg fill="#666" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                        </button>
                        <button onclick="setStarRating(5)" class="w-6 h-6 star-rating-btn">
                            <svg fill="#666" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Tags -->
                    <button onclick="toggleTag(this)" class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent" style="height: 35px; padding: 0 24px;">
                        Sachets
                    </button>
                    <button onclick="toggleTag(this)" class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent" style="height: 35px; padding: 0 24px;">
                        Bottle
                    </button>
                    <button onclick="toggleTag(this)" class="flex items-center justify-center rounded-[100px] bg-[#40444B] text-white text-lg font-semibold capitalize border border-transparent" style="height: 35px; padding: 0 24px;">
                        Dispenser
                    </button>
                </div>
            </div>

            <!-- Input Row -->
            <div class="flex flex-row items-center gap-4">
                <div class="border flex flex-row items-center px-5 gap-4 mt-3 rounded-[46px]" style="height: 43px; background-color: #292B2FCC; border-color: #40444B; width: calc(100% - 60px);">
                    <input type="text" id="reviewInput" placeholder="Write a review.." class="bg-transparent border-none outline-none text-white text-lg flex-grow placeholder-white/60">
                    <button onclick="toggleRatingPopup()">
                        <svg class="w-5 h-5 opacity-50 hover:opacity-100" fill="gold" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                        </svg>
                    </button>
                </div>
                <button onclick="submitReview()" class="mt-3 border rounded-full flex items-center justify-center" style="background-color: var(--btn-color); border-color: var(--btn-border); height: 43px; width: 43px;">
                    <svg class="w-6 h-6" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Reviews Display -->
        <div id="reviewsContainer" class="flex flex-col gap-4">
            <!-- Reviews will be displayed here -->
        </div>
    </div>

    <script>
        let currentRating = 0;
        let selectedTags = new Set();
        let reviews = [
            {
                id: 1,
                name: 'Anonymous name',
                rating: 5,
                comment: 'Lorem ipsum dolor sit amet consectetur adipisicing elit.',
                tags: ['Sachets'],
                date: new Date('2024-01-15')
            },
            {
                id: 2,
                name: 'John Doe',
                rating: 4,
                comment: 'Great service and fast delivery. Highly recommend!',
                tags: ['Bottle'],
                date: new Date('2024-01-10')
            }
        ];

        function setStarRating(rating) {
            currentRating = rating;
            updateStarDisplay();
        }

        function updateStarDisplay() {
            const stars = document.querySelectorAll('#ratingPopup .star-rating-btn svg path');
            stars.forEach((star, index) => {
                if (index < currentRating) {
                    star.setAttribute('fill', 'gold');
                } else {
                    star.setAttribute('fill', '#666');
                }
            });
        }

        function toggleTag(btn) {
            const tagText = btn.textContent.trim();
            
            if (selectedTags.has(tagText)) {
                selectedTags.delete(tagText);
                btn.style.backgroundColor = '#40444B';
                btn.style.borderColor = 'transparent';
            } else {
                selectedTags.add(tagText);
                btn.style.backgroundColor = 'var(--btn-color)';
                btn.style.borderColor = 'var(--btn-border)';
            }
        }

        function toggleRatingPopup() {
            const popup = document.getElementById('ratingPopup');
            popup.classList.toggle('hidden');
        }

        async function submitReview() {
            const commentInput = document.getElementById('reviewInput');
            const comment = commentInput.value.trim();

            if (currentRating === 0) {
                alert('Please select a star rating');
                return;
            }

            if (!comment) {
                alert('Please write a review');
                return;
            }

            try {
                // Save to database via API
                const response = await fetch('/api/ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        company_id: 'test-company',
                        branch_id: 'test-branch',
                        stars: currentRating,
                        comment: comment,
                        product_tags: Array.from(selectedTags),
                        location: 'Test Location',
                        customer_id: null,
                        order_id: null
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save rating to database');
                }

                const result = await response.json();
                console.log('Rating saved to database:', result);

                // Add to local reviews array for immediate display
                const newReview = {
                    id: result.document.$id || Date.now(),
                    name: 'You',
                    rating: currentRating,
                    comment: comment,
                    tags: Array.from(selectedTags),
                    date: new Date()
                };

                reviews.push(newReview);
                renderReviews();

                currentRating = 0;
                selectedTags.clear();
                commentInput.value = '';
                updateStarDisplay();
                
                document.querySelectorAll('#ratingPopup button').forEach(btn => {
                    if (btn.textContent.includes('Sachets') || btn.textContent.includes('Bottle') || btn.textContent.includes('Dispenser')) {
                        btn.style.backgroundColor = '#40444B';
                        btn.style.borderColor = 'transparent';
                    }
                });

                toggleRatingPopup();
                alert('Thank you for your review!');
            } catch (error) {
                console.error('Error saving rating:', error);
                alert('Failed to submit review. Please try again.');
            }
        }

        function renderReviews() {
            const container = document.getElementById('reviewsContainer');
            container.innerHTML = '';
            
            reviews.slice().reverse().forEach(review => {
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                const dateStr = review.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                const reviewElement = document.createElement('div');
                reviewElement.className = 'flex flex-col gap-4 p-4 rounded-xl';
                reviewElement.style.backgroundColor = '#292B2FCC';
                
                reviewElement.innerHTML = `
                    <div class="flex flex-row gap-4">
                        <div class="rounded-full border" style="height: 63px; width: 63px; background-color: #292B2F99; border-color: #DADADA;">
                            <div class="w-full h-full rounded-full flex items-center justify-center text-white text-xl font-bold">
                                ${review.name.charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div class="flex flex-col justify-between py-1">
                            <span class="text-white font-medium text-lg pl-8">${review.name}</span>
                            <div class="flex flex-row gap-2">
                                <span class="text-white text-base">${stars}</span>
                                <span class="text-white font-medium text-lg">${dateStr}</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full rounded-[12px] p-2" style="background-color: #292B2FCC;">
                        <p class="text-white px-5 py-2 text-lg font-normal">${review.comment}</p>
                    </div>
                    ${review.tags.length > 0 ? `
                        <div class="flex flex-row gap-2">
                            ${review.tags.map(tag => `
                                <span class="px-3 py-1 rounded-full text-sm font-medium" style="background-color: #40444B; color: white;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(reviewElement);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderReviews();
        });
    </script>
</body>
</html>
